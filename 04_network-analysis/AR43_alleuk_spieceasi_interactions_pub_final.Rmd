---
title: "ar43-spieceasi-networks-interactions"
author: "Nina Yang, Postdoctoral Investigator, WHOI"
created date: "2024-01-19"
last updated: "2024-02-03"
output: html_document
editor_options: 
  chunk_output_type: console
---

# 1. Background
This document outlines the steps taken to conduct network analyses for positive and negative interactions using the SpiecEasi package in R. Networks were generated on WHOI's HPC using SPIEC-EASI and positive and negative interactions were parsed out. The samples was collected via CTD from the AR43 Cruise (Armstrong, March 2020) and multi-marker metabarcoding with 18S V9 and 12S MiFish were conducted. 

## 1.1 Set up Environment

### 1.1.1 Install and load packages
```{r install-pkgs, include=FALSE}

if(!require(BiocManager)){install.packages("BiocManager")}
if(!require(devtools)){install.packages("devtools")}
if(!require(phyloseq)){install.packages("phyloseq")}
if(!require(patchwork)){install.packages("patchwork")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(scales)){install.packages("scales")}
if(!require(SpiecEasi)){install_github("zdk123/SpiecEasi")}
if(!require(ggnetwork)){install.packages("ggnetwork")}
if(!require(intergraph)){install.packages("intergraph")}
if(!require(brainGraph)){install.packages("brainGraph")}
if(!require(circlize)){install.packages("circlize")}
if(!require(ComplexHeatmap)){install.packages("ComplexHeatmap")}
if(!require(gridBase)){install.packages("gridBase")}

```

```{r load-pkgs, include=FALSE}
# load packages
library(devtools); packageVersion("devtools")
library(phyloseq); packageVersion("phyloseq")
library(tidyverse); packageVersion("tidyverse")
library(patchwork); packageVersion("patchwork")
library(SpiecEasi); packageVersion("SpiecEasi")
library(ggnetwork); packageVersion("ggnetwork")
library(intergraph); packageVersion("intergraph")
library(brainGraph); packageVersion("brainGraph")
library(foreach)
library(doParallel)
library(data.table)
library(circlize)
library(igraph); packageVersion("igraph")
library(ComplexHeatmap); packageVersion("ComplexHeatmap")
library(gridBase); packageVersion("gridBase")

```

```{r robust-random-fxn, eval = TRUE, message = FALSE, warning = FALSE}

# Load the robustness function from the file
# https://github.com/cwatson/brainGraph/issues/25
source("robustness_random.R")
ls() # check to make sure the function is there

# Set up parallel backend
numCores <- parallel::detectCores()
cl <- parallel::makeCluster(numCores)
doParallel::registerDoParallel(cl)

```

### 1.1.2 Setup Environment

```{r theme_ggplot2, echo = FALSE}
theme_custom_ppt <- function() {
  theme_bw(
    base_size = 14) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent'),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.5),
      # axes
      axis.text.y = element_blank(), 
      axis.text.x = element_blank(), 
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      # legend
      legend.text = element_text(colour ="black"), 
      legend.position = "right",
      legend.title = element_text(colour = "black", size = 12), 
      legend.background = element_rect(color = NA, fill='transparent'), 
      legend.box.background = element_rect(color = NA, fill='transparent'),
      # faceting
      strip.background.y = element_rect(color = "black", fill = "#ededed", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 12)
      )
}
theme_custom_ppt_blkbg <- function() {
  theme_bw(
    base_size = 14) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent', color = 'transparent'),
      panel.border = element_rect(linewidth = 1, color = "white"),
      # axes
      axis.text.y = element_text(color = "white", size = 14), 
      axis.text.x = element_text(color = "white", size = 14), 
      axis.ticks.x = element_line(color = "white"),
      axis.ticks.y = element_line(color = "white"),
      axis.title.x = element_text(color = "white", size = 16),
      axis.title.y = element_text(color = "white", size = 16),
      # legend
      legend.text = element_text(colour ="white"), 
      legend.position = "right",
      legend.title = element_text(colour = "white", size = 14), 
      legend.background = element_rect(color = NA, fill='transparent'), 
      legend.box.background = element_rect(color = NA, fill='transparent'),
      # faceting
      strip.background.y = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 12)
      )
}
theme_custom_poster <- function() {
  theme_bw(
    base_size = 30) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(), 
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.5),
      # axes
      axis.text.y = element_text(colour = "black"), 
      axis.text.x = element_text(colour = "black"), 
      # legend
      legend.text = element_text(colour ="black"), 
      legend.position = "right",
      legend.title = element_text(colour = "black"), 
      # faceting
      strip.background.y = element_rect(color = "black", fill = "#ededed", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = "white", linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 30)
      )
}

theme_custom_paper <- function() {
  theme_bw(
    base_size = 10) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent'),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
      # axes
      axis.text.y = element_text(colour = "black"), 
      axis.text.x = element_text(colour = "black"), 
      # legend
      legend.text = element_text(colour ="black"), 
      legend.position = "right",
      legend.title = element_text(colour = "black"), 
      legend.background = element_rect(color = NA, fill='transparent'), 
      legend.box.background = element_rect(color = NA, fill='transparent'),
      # faceting
      strip.background.y = element_rect(color = "black", fill = "#ededed", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 7)
      )
}

# Changing the default theme
theme_set(theme_custom_paper())

```

# 2. Network Correlation - Set up

I am evaluating the networks for the epipelagic, the upper mesopelagic, and the lower mesopelagic using prevalence-filtered datasets (core).

## Load SPIEC-EASI outputs

```{r spieceasi-epi-core, eval = TRUE, message = FALSE, warning = FALSE}

load("./hpc-outputs/epi-spieceasi-output-core-20250410.RData", verbose = T)

load("./hpc-outputs/epi-spieceasi-output-core-prot-20250410.RData", verbose = T)

load("./hpc-outputs/epi-spieceasi-output-core-met-fish-20250410.RData", verbose = T)

# load phyloseq objects
load("./hpc-inputs/curated_physeq_forSpiecEasi_epi_core_network_20250410.RData", verbose = T)


```

```{r spieceasi-meso-up-core, eval = TRUE, message = FALSE, warning = FALSE}


load("./hpc-outputs/meso-up-spieceasi-output-core-20250410.RData", verbose = T)

load("./hpc-outputs/meso-up-spieceasi-output-core-prot-20250410.RData", verbose = T)

load("./hpc-outputs/meso-up-spieceasi-output-core-met-fish-20250410.RData", verbose = T)

# load phyloseq objects
load("./hpc-inputs/curated_physeq_forSpiecEasi_meso_up_core_network_20250410.RData", verbose = T)


```

```{r spieceasi-meso-low-core, eval = TRUE, message = FALSE, warning = FALSE}

load("./hpc-outputs/meso-low-spieceasi-output-core-20250410.RData", verbose = T)

load("./hpc-outputs/meso-low-spieceasi-output-core-prot-20250410.RData", verbose = T)

load("./hpc-outputs/meso-low-spieceasi-output-core-met-fish-20250410.RData", verbose = T)

# load phyloseq objects
load("./hpc-inputs/curated_physeq_forSpiecEasi_meso_low_core_network_20250410.RData", verbose = T)


```

```{r asv-tables, eval = TRUE, message = FALSE, warning = FALSE}
# these are the asv files with taxa, rarefied, prevalence filtered

load("./R-outputs/alleuk_asv_melt_tax_tables_network.RData", verbose = T)

```

# 3. Network Correlations 

## 3.1. Positive Interactions

### 3.1.1 Epipelagic

```{r analysis-epi-core-pos, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_epi_core) # 0.04986209

sum(getRefit(se_epi_core))/2 #12279

se_epi_core$select$stars$summary

## Extract adjaency matrix
adj_mat_epi_core <- getRefit(se_epi_core)
table(as.numeric(adj_mat_epi_core))

se_beta_epi_core <- as.matrix(symBeta(getOptBeta(se_epi_core)))
weighted_adj_epi_core <- se_beta_epi_core*adj_mat_epi_core

merged_physeq_epi_core = merge_phyloseq(prot_phy_epi_core, met_phy_epi_core, fish_phy_epi_core)
merged_physeq_epi_core

ig2_epi_core <- adj2igraph(weighted_adj_epi_core)
V(ig2_epi_core)$name <- taxa_names(merged_physeq_epi_core)

graph_components <- components(ig2_epi_core)
graph_components$csize

#dev.new()
plot(density((E(ig2_epi_core)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_epi_core)$weight)~(E(ig2_epi_core)$weight<0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_epi_core <- ig2_epi_core

# let's delete the negative weights and then delete those vertices
# these are only positive interactions
grph_pos_epi_core <- delete_edges(grph_all_epi_core, which(E(grph_all_epi_core)$weight<0))
grph_pos_epi_core <- delete_vertices(grph_pos_epi_core,which(igraph::degree(grph_pos_epi_core)<1))

# For negative interactions - convert to abs value to plot
#E(grph_pos_epi_core)$weight <- abs(E(grph_pos_epi_core)$weight)

# plot
set.seed(1)
plot(grph_pos_epi_core, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_pos_epi_core))
# set weight threshold
V(grph_pos_epi_core) # vertices
E(grph_pos_epi_core) # edges
gsize(grph_pos_epi_core) # total # of edges

# histograph of weights
hist(E(grph_pos_epi_core)$weight, main="Histogram of weight")
modules_epi_core_pos = cluster_leading_eigen(grph_pos_epi_core, weights = NA)
print(modules_epi_core_pos) # modularity = 0.41; groups = 5
modularity(modules_epi_core_pos)
class(modules_epi_core_pos)
deg_epi_core_pos <- igraph::degree(grph_pos_epi_core)

# histogram node degree
hist(deg_epi_core_pos, main="Histogram of node degree")

# betweenness
btwn_epi_core_pos <- betweenness(grph_pos_epi_core, directed=F, weights=NA) %>% data.frame()
head(btwn_epi_core_pos) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_epi_core_pos)[1] <- "betweenness"
head(btwn_epi_core_pos) # Nodes with higher betweenness centrality scores are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_epi_core_pos %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_epi_core_pos_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_epi_core_pos_df)

is_connected(grph_pos_epi_core) # TRUE = strongly connected
count_components(grph_pos_epi_core) # just one component
components(grph_pos_epi_core)
#v_con_epi_core_pos <- vertex_connectivity(grph_pos_epi_core)
v_con_epi_core_pos # 3
e_con_epi_core_pos <- edge_connectivity(grph_pos_epi_core)
e_con_epi_core_pos # 3

edge_density_epi_core_pos <- edge_density(grph_pos_epi_core)
avg_path_length_epi_core_pos <- mean_distance(grph_pos_epi_core, weights = NA, directed = FALSE)
avg_path_length_epi_core_pos

v.cent.epi.core.pos <- robustness(grph_pos_epi_core, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.epi.core.pos
v.deg.epi.core.pos <- robustness(grph_pos_epi_core, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.epi.core.pos

#v.random.epi.core.pos <- robustness_random(grph_pos_epi_core, type = c("vertex"), measure = c("random"), N = 1000)
v.random.epi.core.pos

```

```{r plot-epi-core-pos, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_pos_epi_core, layout = igraph::with_fr())

set.seed(123)
epi_core_pos_df <- ggnetwork(grph_pos_epi_core, layout = igraph::with_fr())
head(epi_core_pos_df)
tail(epi_core_pos_df)
class(epi_core_pos_df) # this is a dataframe!

# let's add taxa
epi_core_pos_df$taxa <- ifelse(startsWith(epi_core_pos_df$name, "p"), "Protists",
                      ifelse(startsWith(epi_core_pos_df$name, "f"), "Vertebrates", "Invertebrates"))

head(epi_core_pos_df)
tail(epi_core_pos_df)

# let's add in membership
member <- modules_epi_core_pos$membership
name <- modules_epi_core_pos$names
mod_epi_core_pos_df <- cbind(name, member) %>% data.frame()
head(mod_epi_core_pos_df)
tail(mod_epi_core_pos_df)
class(mod_epi_core_pos_df)

epi_core_pos_df <- left_join(epi_core_pos_df, mod_epi_core_pos_df, by = "name")
head(epi_core_pos_df)
tail(epi_core_pos_df)

# I think we can add in taxa?
colnames(epi_core_pos_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)
tail(tax_short)

epi_core_pos_df_tax <- epi_core_pos_df %>%
  left_join(tax_short, by = "OTUid")
head(epi_core_pos_df_tax)

#let's add in degree
deg_epi_core_pos <- igraph::degree(grph_pos_epi_core) %>% as.data.frame()
head(deg_epi_core_pos)
colnames(deg_epi_core_pos)[1] <- "degree"
rownames(deg_epi_core_pos)
deg_epi_core_pos$OTUid <- rownames(deg_epi_core_pos)
deg_epi_core_pos <- select(deg_epi_core_pos, OTUid, degree)
head(deg_epi_core_pos)
unique(epi_core_pos_df_tax$TAX_SHORT)
head(epi_core_pos_df_tax)

epi_core_pos_df_tax <- left_join(epi_core_pos_df_tax, deg_epi_core_pos, by = "OTUid")
head(epi_core_pos_df_tax)

epi_core_pos_df_tax <- left_join(epi_core_pos_df_tax, btwn_epi_core_pos_df, by = "OTUid")
head(epi_core_pos_df_tax)

member_count <- mod_epi_core_pos_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

epi_core_pos_df_tax$member <- factor(epi_core_pos_df_tax$member, levels = 1:12)
epi_core_pos_df_tax <- epi_core_pos_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(epi_core_pos_df_tax)
tail(epi_core_pos_df_tax)

epi_core_pos_node <- ggplot(epi_core_pos_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
epi_core_pos_node

epi_core_pos_inter <- ggplot(epi_core_pos_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(), color = "#ff0065", linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
epi_core_pos_inter

epi_core_pos_plot_mod <- ggplot(epi_core_pos_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Epipelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + 
  theme(panel.border = element_rect(linewidth = 0.5),
    legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
epi_core_pos_plot_mod

```

```{r epi-core-stats-pos, eval = TRUE, message = FALSE, warning = FALSE}

head(epi_core_pos_df_tax)

epi_core_pos_stats_df <- epi_core_pos_df_tax %>% 
  select(OTUid, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(epi_core_pos_stats_df)

epi_pos_degree_df <- epi_core_pos_stats_df %>% unique() %>% arrange(desc(degree)) 
epi_pos_degree_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

epi_pos_degree_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((epi_pos_degree_df %>% unique() %>% arrange(desc(degree))), n = 10)

quantile(epi_pos_degree_df$degree, probs = c(.25,.5,.75, 0.8, 0.9))
quantile(epi_pos_degree_df$betweenness, probs = c(.25,.5,.75, 0.8, 0.9))

degperc <- quantile(epi_pos_degree_df$degree, probs = 0.9)
btwnperc <- quantile(epi_pos_degree_df$betweenness, probs = 0.9)

epi_pos_mod <- epi_pos_degree_df %>% select(OTUid, taxa, TAX_SHORT, member, degree, betweenness) %>% 
  filter(degree >= degperc & betweenness > btwnperc) %>%
  group_by(TAX_SHORT) %>%
  mutate(sum_OTU = n()) %>% 
  select(TAX_SHORT, sum_OTU, taxa) %>% unique() %>%
  ungroup()

head(epi_pos_mod)
tail(epi_pos_mod)
dim(epi_pos_mod)

epi_pos_mod$depth <- "Epipelagic"

epi_pos_mod$TAX_SHORT = forcats::fct_rev(factor(epi_pos_mod$TAX_SHORT)) #arrange terms in alphabetical order

epi_pos_dotplot <- ggplot(data = epi_pos_mod, aes(x = as.factor(depth), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

epi_pos_dotplot


```

### 3.1.2. Upper Mesopelagic

```{r analysis-meso-up-core-pos, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_up_core) # 0.04992624

sum(getRefit(se_meso_up_core))/2 #23338

se_meso_up_core$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_up_core <- getRefit(se_meso_up_core)
table(as.numeric(adj_mat_meso_up_core))

se_beta_meso_up_core <- as.matrix(symBeta(getOptBeta(se_meso_up_core)))
weighted_adj_meso_up_core <- se_beta_meso_up_core*adj_mat_meso_up_core

merged_physeq_meso_up_core = merge_phyloseq(prot_phy_meso_up_core, met_phy_meso_up_core, fish_phy_meso_up_core)
merged_physeq_meso_up_core

ig2_meso_up_core <- adj2igraph(weighted_adj_meso_up_core)
V(ig2_meso_up_core)$name <- taxa_names(merged_physeq_meso_up_core)

graph_components <- components(ig2_meso_up_core)
graph_components$csize

plot(density((E(ig2_meso_up_core)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_up_core)$weight)~(E(ig2_meso_up_core)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_pos_meso_up_core <- ig2_meso_up_core

# let's delete the negative weights and then delete those vertices
# these are only positive interactions
grph_pos_meso_up_core <- delete_edges(grph_pos_meso_up_core, which(E(grph_pos_meso_up_core)$weight<0))
grph_pos_meso_up_core <- delete_vertices(grph_pos_meso_up_core,which(igraph::degree(grph_pos_meso_up_core)<1))

# let's convert the edges to positive numbers so that we can plot...
#E(grph_pos_meso_up_core)$weight <- abs(E(grph_pos_meso_up_core)$weight)

# plot
plot(grph_pos_meso_up_core, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_pos_meso_up_core))
# set weight threshold
V(grph_pos_meso_up_core) # vertices
E(grph_pos_meso_up_core) # edges
gsize(grph_pos_meso_up_core)

modules_meso_up_core_pos = cluster_leading_eigen(grph_pos_meso_up_core, weights = NA)
print(modules_meso_up_core_pos) # modularity = 0.33; groups = 5
modularity(modules_meso_up_core_pos)
class(modules_meso_up_core_pos)
deg_meso_up_core_pos <- igraph::degree(grph_pos_meso_up_core)

# histogram node degree
hist(deg_meso_up_core_pos, main="Histogram of node degree")

# betweenness
btwn_meso_up_core_pos <- betweenness(grph_pos_meso_up_core, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_up_core_pos) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_up_core_pos)[1] <- "betweenness"
head(btwn_meso_up_core_pos) # Nodes with higher betweenness centrality scores are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_up_core_pos %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_up_core_pos_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_up_core_pos_df)
dim(btwn_meso_up_core_pos_df)

is_connected(grph_pos_meso_up_core) # TRUE = strongly connected
count_components(grph_pos_meso_up_core) # just one component
components(grph_pos_meso_up_core)
#v_con_meso_up_core_pos <- vertex_connectivity(grph_pos_meso_up_core)
v_con_meso_up_core_pos # 3
e_con_meso_up_core_pos <- edge_connectivity(grph_pos_meso_up_core) 
e_con_meso_up_core_pos # 3

edge_density_meso_up_core_pos <- edge_density(grph_pos_meso_up_core)
edge_density_meso_up_core_pos
avg_path_length_meso_up_core_pos <- mean_distance(grph_pos_meso_up_core, weights = NA, directed = FALSE)
avg_path_length_meso_up_core_pos

v.cent.meso.up.core.pos <- robustness(grph_pos_meso_up_core, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.up.core.pos
v.deg.meso.up.core.pos <- robustness(grph_pos_meso_up_core, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.up.core.pos
v.random.meso.up.core.pos <- robustness_random(grph_pos_meso_up_core, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.up.core.pos

```

```{r plot-meso-up-core-pos, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_pos_meso_up_core, layout = igraph::with_fr())

set.seed(123)
meso_up_core_pos_df <- ggnetwork(grph_pos_meso_up_core, layout = igraph::with_fr())
head(meso_up_core_pos_df)
class(meso_up_core_pos_df) # this is a dataframe!

# let's add taxa
meso_up_core_pos_df$taxa <- ifelse(startsWith(meso_up_core_pos_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_up_core_pos_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_up_core_pos_df)
tail(meso_up_core_pos_df)

# let's add in membership
member <- modules_meso_up_core_pos$membership
name <- modules_meso_up_core_pos$names
mod_meso_up_core_pos_df <- cbind(name, member) %>% data.frame()
head(mod_meso_up_core_pos_df)
tail(mod_meso_up_core_pos_df)
class(mod_meso_up_core_pos_df)

meso_up_core_pos_df <- left_join(meso_up_core_pos_df, mod_meso_up_core_pos_df, by = "name")
head(meso_up_core_pos_df)
tail(meso_up_core_pos_df)

# I think we can add in taxa?
colnames(meso_up_core_pos_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)
tail(tax_short)

meso_up_core_pos_df_tax <- meso_up_core_pos_df %>%
  left_join(tax_short, by = "OTUid")
head(meso_up_core_pos_df_tax)

#let's add in degree
deg_meso_up_core_pos <- igraph::degree(grph_pos_meso_up_core) %>% as.data.frame()
head(deg_meso_up_core_pos)
colnames(deg_meso_up_core_pos)[1] <- "degree"
rownames(deg_meso_up_core_pos)
deg_meso_up_core_pos$OTUid <- rownames(deg_meso_up_core_pos)
deg_meso_up_core_pos <- select(deg_meso_up_core_pos, OTUid, degree)
head(deg_meso_up_core_pos)
unique(meso_up_core_pos_df_tax$TAX_SHORT)
head(meso_up_core_pos_df_tax)

meso_up_core_pos_df_tax <- left_join(meso_up_core_pos_df_tax, deg_meso_up_core_pos, by = "OTUid")
head(meso_up_core_pos_df_tax)

meso_up_core_pos_df_tax <- left_join(meso_up_core_pos_df_tax, btwn_meso_up_core_pos_df, by = "OTUid")
head(meso_up_core_pos_df_tax)

member_count <- mod_meso_up_core_pos_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_up_core_pos_df_tax$member <- factor(meso_up_core_pos_df_tax$member, levels = 1:12)
meso_up_core_pos_df_tax <- meso_up_core_pos_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_up_core_pos_df_tax)
tail(meso_up_core_pos_df_tax)

meso_up_core_pos_node <- ggplot(meso_up_core_pos_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Upper Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_up_core_pos_node  

meso_up_core_pos_inter <- ggplot(meso_up_core_pos_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(), color = "#ff0065", linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
meso_up_core_pos_inter

meso_up_core_pos_plot_mod <- ggplot(meso_up_core_pos_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Upper Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + theme(legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
meso_up_core_pos_plot_mod

```

```{r meso-up-core-stats-pos, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_up_core_pos_df_tax)

meso_up_core_pos_stats_df <- meso_up_core_pos_df_tax %>% 
  select(OTUid, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_up_core_pos_stats_df)

meso_up_pos_degree_df <- meso_up_core_pos_stats_df %>% unique() %>% arrange(desc(degree)) 
meso_up_pos_degree_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_up_pos_degree_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_up_pos_degree_df %>% unique() %>% arrange(desc(degree))), n = 10)

quantile(meso_up_pos_degree_df$degree, probs = c(.25,.5,.75, 0.8, 0.9))
quantile(meso_up_pos_degree_df$betweenness, probs = c(.25,.5,.75, 0.8, 0.9))

degperc <- quantile(meso_up_pos_degree_df$degree, probs = 0.9)
btwnperc <- quantile(meso_up_pos_degree_df$betweenness, probs = 0.9)

meso_up_pos_mod <- meso_up_pos_degree_df %>% select(OTUid, taxa, TAX_SHORT, member, degree, betweenness) %>% 
  filter(degree >= degperc & betweenness > btwnperc) %>%
  group_by(TAX_SHORT) %>%
  mutate(sum_OTU = n()) %>% 
  select(TAX_SHORT, sum_OTU, taxa) %>% unique() %>%
  ungroup()

head(meso_up_pos_mod)
meso_up_pos_mod$depth <- "Upper Mesopelagic"

meso_up_pos_mod$TAX_SHORT = forcats::fct_rev(factor(meso_up_pos_mod$TAX_SHORT)) #arrange terms in alphabetical order

meso_up_pos_dotplot <- ggplot(data = meso_up_pos_mod, aes(x = as.factor(depth), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_up_pos_dotplot


```

### 3.1.3. Lower Mesopelagic

```{r analysis-meso-low-core-pos, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_low_core) # 0.04999279

sum(getRefit(se_meso_low_core))/2 #21807

se_meso_low_core$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_low_core <- getRefit(se_meso_low_core)
table(as.numeric(adj_mat_meso_low_core))

se_beta_meso_low_core <- as.matrix(symBeta(getOptBeta(se_meso_low_core)))
weighted_adj_meso_low_core <- se_beta_meso_low_core*adj_mat_meso_low_core

merged_physeq_meso_low_core = merge_phyloseq(prot_phy_meso_low_core, met_phy_meso_low_core, fish_phy_meso_low_core)
merged_physeq_meso_low_core

ig2_meso_low_core <- adj2igraph(weighted_adj_meso_low_core)
V(ig2_meso_low_core)$name <- taxa_names(merged_physeq_meso_low_core)

graph_components <- components(ig2_meso_low_core)
graph_components$csize

plot(density((E(ig2_meso_low_core)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_low_core)$weight)~(E(ig2_meso_low_core)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_pos_meso_low_core <- ig2_meso_low_core

# let's delete the negative weights and then delete those vertices
# these are only positive interactions
grph_pos_meso_low_core <- delete_edges(grph_pos_meso_low_core, which(E(grph_pos_meso_low_core)$weight<0))
grph_pos_meso_low_core <- delete_vertices(grph_pos_meso_low_core,which(igraph::degree(grph_pos_meso_low_core)<1))

# let's convert the edges to positive numbers so that we can plot...
#E(grph_pos_meso_low_core)$weight <- abs(E(grph_pos_meso_low_core)$weight)

# plot
plot(grph_pos_meso_low_core, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_pos_meso_low_core))
# set weight threshold
V(grph_pos_meso_low_core) # vertices
E(grph_pos_meso_low_core) # edges
gsize(grph_pos_meso_low_core)

modules_meso_low_core_pos = cluster_leading_eigen(grph_pos_meso_low_core, weights = NA)
print(modules_meso_low_core_pos) # modularity = 0.31; groups = 5
modularity(modules_meso_low_core_pos)
class(modules_meso_low_core_pos)
deg_meso_low_core_pos <- igraph::degree(grph_pos_meso_low_core)

# histogram node degree
hist(deg_meso_low_core_pos, main="Histogram of node degree")

# betweenness
btwn_meso_low_core_pos <- betweenness(grph_pos_meso_low_core, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_low_core_pos) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_low_core_pos)[1] <- "betweenness"
head(btwn_meso_low_core_pos) # Nodes with higher betweenness centrality scores are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_low_core_pos %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_low_core_pos_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_low_core_pos_df)
dim(btwn_meso_low_core_pos_df)

is_connected(grph_pos_meso_low_core) # TRUE = strongly connected
count_components(grph_pos_meso_low_core) # just one component
components(grph_pos_meso_low_core)
#v_con_meso_low_core_pos <- vertex_connectivity(grph_pos_meso_low_core)
v_con_meso_low_core_pos # 2
e_con_meso_low_core_pos <- edge_connectivity(grph_pos_meso_low_core) 
e_con_meso_low_core_pos # 2

edge_density_meso_low_core_pos <- edge_density(grph_pos_meso_low_core)
edge_density_meso_low_core_pos
avg_path_length_meso_low_core_pos <- mean_distance(grph_pos_meso_low_core, weights = NA, directed = FALSE)
avg_path_length_meso_low_core_pos

v.cent.meso.low.core.pos <- robustness(grph_pos_meso_low_core, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.low.core.pos
v.deg.meso.low.core.pos <- robustness(grph_pos_meso_low_core, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.low.core.pos
#v.random.meso.low.core.pos <- robustness_random(grph_pos_meso_low_core, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.low.core.pos

```

```{r plot-meso-low-core-pos, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_pos_meso_low_core, layout = igraph::with_fr())

set.seed(123)
meso_low_core_pos_df <- ggnetwork(grph_pos_meso_low_core, layout = igraph::with_fr())
head(meso_low_core_pos_df)
class(meso_low_core_pos_df) # this is a dataframe!

# let's add taxa
meso_low_core_pos_df$taxa <- ifelse(startsWith(meso_low_core_pos_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_low_core_pos_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_low_core_pos_df)
tail(meso_low_core_pos_df)

# let's add in membership
member <- modules_meso_low_core_pos$membership
name <- modules_meso_low_core_pos$names
mod_meso_low_core_pos_df <- cbind(name, member) %>% data.frame()
head(mod_meso_low_core_pos_df)
tail(mod_meso_low_core_pos_df)
class(mod_meso_low_core_pos_df)

meso_low_core_pos_df <- left_join(meso_low_core_pos_df, mod_meso_low_core_pos_df, by = "name")
head(meso_low_core_pos_df)
tail(meso_low_core_pos_df)

# I think we can add in taxa?
colnames(meso_low_core_pos_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)
tail(tax_short)
meso_low_core_pos_df_tax <- meso_low_core_pos_df %>%
  left_join(tax_short, by = "OTUid", relationship = "many-to-many")
head(meso_low_core_pos_df_tax)

#let's add in degree
deg_meso_low_core_pos <- igraph::degree(grph_pos_meso_low_core) %>% as.data.frame()
head(deg_meso_low_core_pos)
colnames(deg_meso_low_core_pos)[1] <- "degree"
rownames(deg_meso_low_core_pos)
deg_meso_low_core_pos$OTUid <- rownames(deg_meso_low_core_pos)
deg_meso_low_core_pos <- select(deg_meso_low_core_pos, OTUid, degree)
head(deg_meso_low_core_pos)
unique(meso_low_core_pos_df_tax$TAX_SHORT)
head(meso_low_core_pos_df_tax)

meso_low_core_pos_df_tax <- left_join(meso_low_core_pos_df_tax, deg_meso_low_core_pos, by = "OTUid")
head(meso_low_core_pos_df_tax)

meso_low_core_pos_df_tax <- left_join(meso_low_core_pos_df_tax, btwn_meso_low_core_pos_df, by = "OTUid")
head(meso_low_core_pos_df_tax)

member_count <- mod_meso_low_core_pos_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_low_core_pos_df_tax$member <- factor(meso_low_core_pos_df_tax$member, levels = 1:12)
meso_low_core_pos_df_tax <- meso_low_core_pos_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_low_core_pos_df_tax)
tail(meso_low_core_pos_df_tax)

meso_low_core_pos_node <- ggplot(meso_low_core_pos_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Lower Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_low_core_pos_node  

meso_low_core_pos_inter <- ggplot(meso_low_core_pos_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(), color = "#ff0065", linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
meso_low_core_pos_inter

meso_low_core_pos_plot_mod <- ggplot(meso_low_core_pos_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Lower Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + theme(legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
meso_low_core_pos_plot_mod

```

```{r meso-low-core-stats-pos, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_low_core_pos_df_tax)

meso_low_core_pos_stats_df <- meso_low_core_pos_df_tax %>% 
  select(OTUid, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_low_core_pos_stats_df)

meso_low_pos_degree_df <- meso_low_core_pos_stats_df %>% unique() %>% arrange(desc(degree)) 
meso_low_pos_degree_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_low_pos_degree_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_low_pos_degree_df %>% unique() %>% arrange(desc(degree))), n = 10)

quantile(meso_low_pos_degree_df$degree, probs = c(.25,.5,.75, 0.8, 0.9))
quantile(meso_low_pos_degree_df$betweenness, probs = c(.25,.5,.75, 0.8, 0.9))

degperc <- quantile(meso_low_pos_degree_df$degree, probs = 0.9)
degbtwn <- quantile(meso_low_pos_degree_df$betweenness, probs = 0.9)

meso_low_pos_mod <- meso_low_pos_degree_df %>% select(OTUid, taxa, TAX_SHORT, member, degree, betweenness) %>% 
  filter(degree >= degperc & betweenness > degbtwn) %>%
  group_by(TAX_SHORT) %>%
  mutate(sum_OTU = n()) %>% 
  select(TAX_SHORT, sum_OTU, taxa) %>% unique() %>%
  ungroup()

head(meso_low_pos_mod)
meso_low_pos_mod$depth <- "Lower Mesopelagic"

meso_low_pos_mod$TAX_SHORT = forcats::fct_rev(factor(meso_low_pos_mod$TAX_SHORT)) #arrange terms in alphabetical order

meso_low_pos_dotplot <- ggplot(data = meso_low_pos_mod, aes(x = as.factor(depth), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_low_pos_dotplot

```

### 3.1.4. All Depths Combined

```{r analysis-panel-depth-core-pos-save eval = TRUE, message = FALSE, warning = FALSE}

# save plot inputs

save(grph_pos_epi_core, grph_pos_meso_up_core, grph_pos_meso_low_core, file = "R-outputs/network_pos.RData")

save(v_con_epi_core_pos, e_con_epi_core_pos, v_con_meso_up_core_pos, e_con_meso_up_core_pos, v_con_meso_low_core_pos, e_con_meso_low_core_pos, file = "R-outputs/connectivity_calculations_pos.RData")

save(epi_core_pos_df_tax, meso_up_core_pos_df_tax, meso_low_core_pos_df_tax, file = "./ggnetwork-inputs/ggnetwork_plot_inputs_core_pos_20250410.RData")

save(v.random.epi.core.pos, v.random.meso.up.core.pos, v.random.meso.low.core.pos, file = "./R-outputs/robustness_core_pos.RData")

panel_pos_node <- epi_core_pos_node + meso_up_core_pos_node + meso_low_core_pos_node +
  plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.50), 
        legend.key.spacing.x = unit(0.5, "mm"),
        legend.key.spacing.y = unit(-0.25, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 0)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 10, b = 0, l = 10), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 1)))

panel_pos_node

#ggsave("./network-plots/depthsplit_network_panel_core_pos.pdf", plot = panel_pos_node, height = 34, width = 80, units = "mm", dpi=300)

panel_pos_inter <- epi_core_pos_inter + meso_up_core_pos_inter + meso_low_core_pos_inter +
    plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.5), 
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(-2, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 5, b = 0, l = -5), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 0.5)))

panel_pos_inter

#ggsave("./network-plots/depthsplit_network_panel_interactions_pos.pdf", plot = panel_pos_inter, height = 34, width = 80, units = "mm", dpi=300)

panel_pos_mod <- epi_core_pos_plot_mod + meso_up_core_pos_plot_mod + meso_low_core_pos_plot_mod +
    plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.5), 
        legend.key.spacing.x = unit(0, "mm"),
        legend.key.spacing.y = unit(-2, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = -0.2)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 5, b = 0, l = -5), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 0.5)))

panel_pos_mod

#ggsave("./network-plots/depthsplit_network_panel_module_pos.pdf", plot = panel_pos_mod, height = 34, width = 80, units = "mm", dpi=300)


## all panels

panel_pos_node / panel_pos_mod / panel_pos_inter 

#ggsave("./network-plots/depthsplit_network_panel_all_pos.pdf", height = 100, width = 80, units = "mm", dpi=300)


###
epi_pos_mod$depth <- "Epipelagic"
meso_up_pos_mod$depth <- "Upper Mesopelagic"
meso_low_pos_mod$depth <- "Lower Mesopelagic"

depth_pos_mod_df <- rbind(epi_pos_mod, meso_up_pos_mod, meso_low_pos_mod) %>% arrange()
head(depth_pos_mod_df)

depth_pos_mod_df$depth <- fct_relevel(depth_pos_mod_df$depth, "Lower Mesopelagic", after = Inf)
tail(depth_pos_mod_df)

list <- depth_pos_mod_df %>% select(taxa, TAX_SHORT) %>% unique() %>% sort() %>% data.frame()

list

depth_pos_mod_df$TAX_SHORT <- fct_relevel(depth_pos_mod_df$TAX_SHORT,
                                      "Alveolata-Apicomplexa",
                                      "Alveolata-Ciliates",
                                      "Alveolata-Dinoflagellates",
                                      "Alveolata-Syndiniales",
                                      "Alveolata-Other",
                                      "Amoebozoa",
                                      "Archaeplastida-Picozoa",
                                      "Archaeplastida-Streptophyta",
                                      "Chlorophyta",
                                      #"Cryptophyta",
                                      "Excavata",
                                      "Haptophyta",
                                      #"Haptista-Other",
                                      "Obazoa-Choanoflagellata",
                                      "Obazoa-Fungi",
                                      "Obazoa-Opisthokonta",
                                      "Rhizaria-Cercozoa",
                                      "Rhizaria-Radiolaria",
                                      "Rhizaria-Other",
                                      #"Rhodophyta",
                                      "Stramenopiles-Diatoms",  
                                      "Stramenopiles-MAST",
                                      "Stramenopiles-Other",
                                      "TSAR-Telonemia",
                                      "TSAR-Unassigned",
                                      #"Annelida-Phyllodocida",
                                      "Arthropoda-Calanoida",
                                      "Arthropoda-Cyclopoida",
                                      "Cnidaria-Narcomedusae",
                                      "Cnidaria-Siphonophorae",
                                      #"Ctenophora-Cydippida",
                                      #"Ctenophora-Other",
                                      "Ctenophora-Unassigned",
                                    #  "Tunicata-Copelata",
                                    "Unassigned Metazoa",
                                      "Alepisauridae-Alepisaurus",
                                    #"Caristiidae-Caristius",
                                    "Delphinidae-Grampus",
                                    #"Derichthyidae-Nessorhamphus",
                                   #   "Coryphaenidae-Coryphaena",
                                      "Gonostomatidae-Cyclothone",
                                   "Melamphaidae-Melamphaes",
                                      "Melamphaidae-Scopeloberyx",
                                      "Myctophidae-Hygophum",
                                      "Sternoptychidae-Sternoptyx",
                                   "Stomiidae-Chauliodus",
                                   "Unassigned Actinopterygii")
                            
mod_pos_dotplot <- 
  ggplot(data = depth_pos_mod_df, aes(y = fct_rev(depth), x = (TAX_SHORT))) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~depth) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa",
                             order = 1),
         size = guide_legend(title="ASV Count",
                             order = 2,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
        panel.background = element_rect(linewidth = 0.5),
        plot.background = element_blank(),
        axis.text.x = element_text(colour = "black", size = 9, angle = 60, hjust = 0, vjust = 0),
        axis.text.y = element_text(colour = "black", size = 8),
        strip.text.x = element_text(size = 5, color = "black", face = "bold"),
        strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"),
    legend.text = element_text(size = 8, margin = margin(l = 1)),
    legend.title = element_text(size = 8),
    legend.key.size = unit(3, 'mm'),
    legend.box.margin = unit(-3.4, 'mm'),
    plot.margin = unit(c(t = 0.5, r = 0.5, b = 0.5, l = 0.5), "lines"))
  
mod_pos_dotplot

ggsave("./network-plots/depthsplit_network_module_dotplot_pos_pub.pdf", width = 8.25, height = 4, units = "in", dpi=300)


# let's merge the attack robustness files 

#betweenness
head(v.cent.epi.core.pos)
head(v.cent.meso.up.core.pos)
head(v.cent.meso.low.core.pos)

## create a column for ype of attack
v.cent.epi.core.pos$depth <- "Epipelagic"
v.cent.meso.up.core.pos$depth <- "Upper Mesopelagic"
v.cent.meso.low.core.pos$depth <- "Lower Mesopelagic"

v.cent.core.pos <- rbind(v.cent.epi.core.pos, v.cent.meso.up.core.pos, v.cent.meso.low.core.pos)

# Degree
head(v.deg.epi.core.pos)
head(v.deg.meso.up.core.pos)
head(v.deg.meso.low.core.pos)

v.deg.epi.core.pos$depth <- "Epipelagic"
v.deg.meso.up.core.pos$depth <- "Upper Mesopelagic"
v.deg.meso.low.core.pos$depth <- "Lower Mesopelagic"

v.deg.core.pos <- rbind(v.deg.epi.core.pos, v.deg.meso.up.core.pos, v.deg.meso.low.core.pos)

head(v.random.epi.core.pos)
head(v.random.meso.up.core.pos)
head(v.random.meso.low.core.pos)

v.random.epi.core.pos$depth <- "Epipelagic"
v.random.meso.up.core.pos$depth <- "Upper Mesopelagic"
v.random.meso.low.core.pos$depth <- "Lower Mesopelagic"

v.random.core.pos <- rbind(v.random.epi.core.pos, v.random.meso.up.core.pos, v.random.meso.low.core.pos)

v.cent.core.pos$depth <- fct_relevel(v.cent.core.pos$depth, "Lower Mesopelagic", after = Inf)
v.deg.core.pos$depth <- fct_relevel(v.deg.core.pos$depth, "Lower Mesopelagic", after = Inf)
v.random.core.pos$depth <- fct_relevel(v.random.core.pos$depth, "Lower Mesopelagic", after = Inf)

v.cent.core.pos.plot <- v.cent.core.pos %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Betweenness", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.pos.plot <- v.deg.core.pos %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Degree", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.pos.plot

v.random.core.pos.plot <- v.random.core.pos %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Random", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.random.core.pos.plot


v.core.pos.plot <- v.cent.core.pos.plot + v.deg.core.pos.plot + v.random.core.pos.plot + 
  plot_layout(guides = 'collect') &
    theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8, hjust = 0.5),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.position = "bottom", 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 6))

v.core.pos.plot

#ggsave("./network-plots/depthsplit_network_robust_pos_pub.pdf", height = 75, width = 180, units = "mm", dpi=300)

```

## 3.2. Negative Interactions

### 3.2.1. Epipelagic

```{r analysis-epi-core-neg, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_epi_core) # 0.04986209

sum(getRefit(se_epi_core))/2 #12279

se_epi_core$select$stars$summary

## Extract adjaency matrix
adj_mat_epi_core <- getRefit(se_epi_core)
table(as.numeric(adj_mat_epi_core))

se_beta_epi_core <- as.matrix(symBeta(getOptBeta(se_epi_core)))
weighted_adj_epi_core <- se_beta_epi_core*adj_mat_epi_core

merged_physeq_epi_core = merge_phyloseq(prot_phy_epi_core, met_phy_epi_core, fish_phy_epi_core)
merged_physeq_epi_core

ig2_epi_core <- adj2igraph(weighted_adj_epi_core)
V(ig2_epi_core)$name <- taxa_names(merged_physeq_epi_core)

graph_components <- components(ig2_epi_core)
graph_components$csize

dev.new()
plot(density((E(ig2_epi_core)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_epi_core)$weight)~(E(ig2_epi_core)$weight<0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_epi_core <- ig2_epi_core

# let's delete the negative weights and then delete those vertices
# these are only Negative interactions
grph_neg_epi_core <- delete_edges(grph_all_epi_core, which(E(grph_all_epi_core)$weight>0))
grph_neg_epi_core <- delete_vertices(grph_neg_epi_core,which(igraph::degree(grph_neg_epi_core)<1))

# For negative interactions - convert to abs value to plot
E(grph_neg_epi_core)$weight <- abs(E(grph_neg_epi_core)$weight)

# plot
set.seed(1)
plot(grph_neg_epi_core, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_neg_epi_core))
# set weight threshold
V(grph_neg_epi_core) # vertices
E(grph_neg_epi_core) # edges
gsize(grph_neg_epi_core) # total # of edges

# histograph of weights
hist(E(grph_neg_epi_core)$weight, main="Histogram of weight")
modules_epi_core_neg = cluster_leading_eigen(grph_neg_epi_core, weights = NA)
print(modules_epi_core_neg) # modularity = 0.29; groups = 7
modularity(modules_epi_core_neg)
class(modules_epi_core_neg)
deg_epi_core_neg <- igraph::degree(grph_neg_epi_core)

# histogram node degree
hist(deg_epi_core_neg, main="Histogram of node degree")

# betweenness
btwn_epi_core_neg <- betweenness(grph_neg_epi_core, directed=F, weights=NA) %>% data.frame()
head(btwn_epi_core_neg) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_epi_core_neg)[1] <- "betweenness"
head(btwn_epi_core_neg) # Nodes with higher betweenness centrality scores are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_epi_core_neg %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_epi_core_neg_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_epi_core_neg_df)

is_connected(grph_neg_epi_core) # TRUE = strongly connected
count_components(grph_neg_epi_core) # just one component
components(grph_neg_epi_core)

v_con_epi_core_neg <- vertex_connectivity(grph_neg_epi_core)
v_con_epi_core_neg # 1
e_con_epi_core_neg <- edge_connectivity(grph_neg_epi_core)
e_con_epi_core_neg # 1

edge_density_epi_core_neg <- edge_density(grph_neg_epi_core)
avg_path_length_epi_core_neg <- mean_distance(grph_neg_epi_core, weights = NA, directed = FALSE)
avg_path_length_epi_core_neg

v.cent.epi.core.neg <- robustness(grph_neg_epi_core, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.epi.core.neg
v.deg.epi.core.neg <- robustness(grph_neg_epi_core, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.epi.core.neg

#v.random.epi.core.neg <- robustness_random(grph_neg_epi_core, type = c("vertex"), measure = c("random"), N = 1000)
v.random.epi.core.neg

```

```{r plot-epi-core-neg, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_neg_epi_core, layout = igraph::with_fr())

set.seed(123)
epi_core_neg_df <- ggnetwork(grph_neg_epi_core, layout = igraph::with_fr())
head(epi_core_neg_df)
tail(epi_core_neg_df)
class(epi_core_neg_df) # this is a dataframe!

# let's add taxa
epi_core_neg_df$taxa <- ifelse(startsWith(epi_core_neg_df$name, "p"), "Protists",
                      ifelse(startsWith(epi_core_neg_df$name, "f"), "Vertebrates", "Invertebrates"))

head(epi_core_neg_df)
tail(epi_core_neg_df)

# let's add in membership
member <- modules_epi_core_neg$membership
name <- modules_epi_core_neg$names
mod_epi_core_neg_df <- cbind(name, member) %>% data.frame()
head(mod_epi_core_neg_df)
tail(mod_epi_core_neg_df)
class(mod_epi_core_neg_df)

epi_core_neg_df <- left_join(epi_core_neg_df, mod_epi_core_neg_df, by = "name")
head(epi_core_neg_df)
tail(epi_core_neg_df)

# I think we can add in taxa?
colnames(epi_core_neg_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

epi_core_neg_df_tax <- epi_core_neg_df %>%
  left_join(tax_short, by = "OTUid")
head(epi_core_neg_df_tax)

#let's add in degree
deg_epi_core_neg <- igraph::degree(grph_neg_epi_core) %>% as.data.frame()
head(deg_epi_core_neg)
colnames(deg_epi_core_neg)[1] <- "degree"
rownames(deg_epi_core_neg)
deg_epi_core_neg$OTUid <- rownames(deg_epi_core_neg)
deg_epi_core_neg <- select(deg_epi_core_neg, OTUid, degree)
head(deg_epi_core_neg)
unique(epi_core_neg_df_tax$TAX_SHORT)
head(epi_core_neg_df_tax)

epi_core_neg_df_tax <- left_join(epi_core_neg_df_tax, deg_epi_core_neg, by = "OTUid")
head(epi_core_neg_df_tax)

epi_core_neg_df_tax <- left_join(epi_core_neg_df_tax, btwn_epi_core_neg_df, by = "OTUid")
head(epi_core_neg_df_tax)

member_count <- mod_epi_core_neg_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

epi_core_neg_df_tax$member <- factor(epi_core_neg_df_tax$member, levels = 1:12)
epi_core_neg_df_tax <- epi_core_neg_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(epi_core_neg_df_tax)
tail(epi_core_neg_df_tax)

epi_core_neg_node <- ggplot(epi_core_neg_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
epi_core_neg_node

epi_core_neg_inter <- ggplot(epi_core_neg_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(), color = "#0065ff", linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
epi_core_neg_inter


mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F",
                "#DCB0F2","#C9DB74","#8BE0A4")

epi_core_neg_plot_mod <- ggplot(epi_core_neg_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Epipelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + 
  theme(panel.border = element_rect(linewidth = 0.5),
    legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
epi_core_neg_plot_mod

```

```{r epi-core-stats-neg, eval = TRUE, message = FALSE, warning = FALSE}

head(epi_core_neg_df_tax)

epi_core_neg_stats_df <- epi_core_neg_df_tax %>% 
  select(OTUid, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(epi_core_neg_stats_df)

epi_neg_degree_df <- epi_core_neg_stats_df %>% unique() %>% arrange(desc(degree)) 
epi_neg_degree_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

epi_neg_degree_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((epi_neg_degree_df %>% unique() %>% arrange(desc(degree))), n = 10)

quantile(epi_neg_degree_df$degree, probs = c(.25,.5,.75, 0.8, 0.9))
quantile(epi_neg_degree_df$betweenness, probs = c(.25,.5,.75, 0.8, 0.9))

degperc <- quantile(epi_neg_degree_df$degree, probs = 0.9)
degbtwn <- quantile(epi_neg_degree_df$betweenness, probs = 0.9)

epi_neg_mod <- epi_neg_degree_df %>% select(OTUid, taxa, TAX_SHORT, member, degree, betweenness) %>% 
  filter(degree >= degperc & betweenness > degbtwn) %>%
  group_by(TAX_SHORT) %>%
  mutate(sum_OTU = n()) %>% 
  select(TAX_SHORT, sum_OTU, taxa) %>% unique() %>%
  ungroup()

head(epi_neg_mod)
epi_neg_mod$depth <- "Epipelagic"

epi_neg_mod$TAX_SHORT = forcats::fct_rev(factor(epi_neg_mod$TAX_SHORT)) #arrange terms in alphabetical order

epi_neg_dotplot <- ggplot(data = epi_neg_mod, aes(x = as.factor(depth), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

epi_neg_dotplot

```

### 3.2.2. Upper Mesopelagic
```{r analysis-meso-up-core-neg, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_up_core) # 0.04992624

sum(getRefit(se_meso_up_core))/2 #23338

se_meso_up_core$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_up_core <- getRefit(se_meso_up_core)
table(as.numeric(adj_mat_meso_up_core))

se_beta_meso_up_core <- as.matrix(symBeta(getOptBeta(se_meso_up_core)))
weighted_adj_meso_up_core <- se_beta_meso_up_core*adj_mat_meso_up_core

merged_physeq_meso_up_core = merge_phyloseq(prot_phy_meso_up_core, met_phy_meso_up_core, fish_phy_meso_up_core)
merged_physeq_meso_up_core

ig2_meso_up_core <- adj2igraph(weighted_adj_meso_up_core)
V(ig2_meso_up_core)$name <- taxa_names(merged_physeq_meso_up_core)

graph_components <- components(ig2_meso_up_core)
graph_components$csize

plot(density((E(ig2_meso_up_core)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_up_core)$weight)~(E(ig2_meso_up_core)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_neg_meso_up_core <- ig2_meso_up_core

# let's delete the positive weights and then delete those vertices
# these are only Negative interactions
grph_neg_meso_up_core <- delete_edges(grph_neg_meso_up_core, which(E(grph_neg_meso_up_core)$weight>0))
grph_neg_meso_up_core <- delete_vertices(grph_neg_meso_up_core,which(igraph::degree(grph_neg_meso_up_core)<1))

# let's convert the edges to negative numbers so that we can plot...
E(grph_neg_meso_up_core)$weight <- abs(E(grph_neg_meso_up_core)$weight)

# plot
plot(grph_neg_meso_up_core, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_neg_meso_up_core))
# set weight threshold
V(grph_neg_meso_up_core) # vertices
E(grph_neg_meso_up_core) # edges
gsize(grph_neg_meso_up_core)

modules_meso_up_core_neg = cluster_leading_eigen(grph_neg_meso_up_core, weights = NA)
print(modules_meso_up_core_neg) # modularity = 0.21; groups = 5
modularity(modules_meso_up_core_neg)
class(modules_meso_up_core_neg)
deg_meso_up_core_neg <- igraph::degree(grph_neg_meso_up_core)

# histogram node degree
hist(deg_meso_up_core_neg, main="Histogram of node degree")

# betweenness
btwn_meso_up_core_neg <- betweenness(grph_neg_meso_up_core, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_up_core_neg) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_up_core_neg)[1] <- "betweenness"
head(btwn_meso_up_core_neg) # Nodes with higher betweenness centrality scores are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_up_core_neg %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_up_core_neg_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_up_core_neg_df)
dim(btwn_meso_up_core_neg_df)

is_connected(grph_neg_meso_up_core) # TRUE = strongly connected
count_components(grph_neg_meso_up_core) # just one component
components(grph_neg_meso_up_core)
v_con_meso_up_core_neg <- vertex_connectivity(grph_neg_meso_up_core)
v_con_meso_up_core_neg # 1
e_con_meso_up_core_neg <- edge_connectivity(grph_neg_meso_up_core) 
e_con_meso_up_core_neg # 1

edge_density_meso_up_core_neg <- edge_density(grph_neg_meso_up_core)
edge_density_meso_up_core_neg
avg_path_length_meso_up_core_neg <- mean_distance(grph_neg_meso_up_core, weights = NA, directed = FALSE)
avg_path_length_meso_up_core_neg

v.cent.meso.up.core.neg <- robustness(grph_neg_meso_up_core, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.up.core.neg
v.deg.meso.up.core.neg <- robustness(grph_neg_meso_up_core, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.up.core.neg
#v.random.meso.up.core.neg <- robustness_random(grph_neg_meso_up_core, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.up.core.neg


```

```{r plot-meso-up-core-neg, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_neg_meso_up_core, layout = igraph::with_fr())

set.seed(123)
meso_up_core_neg_df <- ggnetwork(grph_neg_meso_up_core, layout = igraph::with_fr())
head(meso_up_core_neg_df)
class(meso_up_core_neg_df) # this is a dataframe!

# let's add taxa
meso_up_core_neg_df$taxa <- ifelse(startsWith(meso_up_core_neg_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_up_core_neg_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_up_core_neg_df)
tail(meso_up_core_neg_df)

# let's add in membership
member <- modules_meso_up_core_neg$membership
name <- modules_meso_up_core_neg$names
mod_meso_up_core_neg_df <- cbind(name, member) %>% data.frame()
head(mod_meso_up_core_neg_df)
tail(mod_meso_up_core_neg_df)
class(mod_meso_up_core_neg_df)

meso_up_core_neg_df <- left_join(meso_up_core_neg_df, mod_meso_up_core_neg_df, by = "name")
head(meso_up_core_neg_df)
tail(meso_up_core_neg_df)

# I think we can add in taxa?
colnames(meso_up_core_neg_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_up_core_neg_df_tax <- meso_up_core_neg_df %>%
  left_join(tax_short, by = "OTUid")
head(meso_up_core_neg_df_tax)

#let's add in degree
deg_meso_up_core_neg <- igraph::degree(grph_neg_meso_up_core) %>% as.data.frame()
head(deg_meso_up_core_neg)
colnames(deg_meso_up_core_neg)[1] <- "degree"
rownames(deg_meso_up_core_neg)
deg_meso_up_core_neg$OTUid <- rownames(deg_meso_up_core_neg)
deg_meso_up_core_neg <- select(deg_meso_up_core_neg, OTUid, degree)
head(deg_meso_up_core_neg)
unique(meso_up_core_neg_df_tax$TAX_SHORT)
head(meso_up_core_neg_df_tax)

meso_up_core_neg_df_tax <- left_join(meso_up_core_neg_df_tax, deg_meso_up_core_neg, by = "OTUid")
head(meso_up_core_neg_df_tax)

meso_up_core_neg_df_tax <- left_join(meso_up_core_neg_df_tax, btwn_meso_up_core_neg_df, by = "OTUid")
head(meso_up_core_neg_df_tax)

member_count <- mod_meso_up_core_neg_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_up_core_neg_df_tax$member <- factor(meso_up_core_neg_df_tax$member, levels = 1:12)
meso_up_core_neg_df_tax <- meso_up_core_neg_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_up_core_neg_df_tax)
tail(meso_up_core_neg_df_tax)

meso_up_core_neg_node <- ggplot(meso_up_core_neg_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Upper Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_up_core_neg_node  

meso_up_core_neg_inter <- ggplot(meso_up_core_neg_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(), color = "#0065ff", linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
meso_up_core_neg_inter

meso_up_core_neg_plot_mod <- ggplot(meso_up_core_neg_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Upper Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + theme(legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
meso_up_core_neg_plot_mod

```

```{r meso-up-core-stats-neg, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_up_core_neg_df_tax)

meso_up_core_neg_stats_df <- meso_up_core_neg_df_tax %>% 
  select(OTUid, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_up_core_neg_stats_df)

meso_up_neg_degree_df <- meso_up_core_neg_stats_df %>% unique() %>% arrange(desc(degree)) 
meso_up_neg_degree_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_up_neg_degree_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_up_neg_degree_df %>% unique() %>% arrange(desc(degree))), n = 10)

quantile(meso_up_neg_degree_df$degree, probs = c(.25,.5,.75, 0.8, 0.9))
quantile(meso_up_neg_degree_df$betweenness, probs = c(.25,.5,.75, 0.8, 0.9))

degperc <- quantile(meso_up_neg_degree_df$degree, probs = 0.9)
btwnperc <- quantile(meso_up_neg_degree_df$betweenness, probs = 0.9)

meso_up_neg_mod <- meso_up_neg_degree_df %>% select(OTUid, taxa, TAX_SHORT, member, degree, betweenness) %>% 
  filter(degree >= degperc & betweenness > btwnperc) %>%
  group_by(TAX_SHORT) %>%
  mutate(sum_OTU = n()) %>% 
  select(TAX_SHORT, sum_OTU, taxa) %>% unique() %>%
  ungroup()

head(meso_up_neg_mod)
meso_up_neg_mod$depth <- "Upper Mesopelagic"

meso_up_neg_mod$TAX_SHORT = forcats::fct_rev(factor(meso_up_neg_mod$TAX_SHORT)) #arrange terms in alphabetical order

meso_up_neg_dotplot <- ggplot(data = meso_up_neg_mod, aes(x = as.factor(depth), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_up_neg_dotplot


```

### 3.2.3. Lower Mesopelagic

```{r analysis-meso-low-core-neg, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_low_core) # 0.04999279

sum(getRefit(se_meso_low_core))/2 #21807

se_meso_low_core$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_low_core <- getRefit(se_meso_low_core)
table(as.numeric(adj_mat_meso_low_core))

se_beta_meso_low_core <- as.matrix(symBeta(getOptBeta(se_meso_low_core)))
weighted_adj_meso_low_core <- se_beta_meso_low_core*adj_mat_meso_low_core

merged_physeq_meso_low_core = merge_phyloseq(prot_phy_meso_low_core, met_phy_meso_low_core, fish_phy_meso_low_core)
merged_physeq_meso_low_core

ig2_meso_low_core <- adj2igraph(weighted_adj_meso_low_core)
V(ig2_meso_low_core)$name <- taxa_names(merged_physeq_meso_low_core)

graph_components <- components(ig2_meso_low_core)
graph_components$csize

plot(density((E(ig2_meso_low_core)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_low_core)$weight)~(E(ig2_meso_low_core)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_neg_meso_low_core <- ig2_meso_low_core

# let's delete the negative weights and then delete those vertices
# these are only Negative interactions
grph_neg_meso_low_core <- delete_edges(grph_neg_meso_low_core, which(E(grph_neg_meso_low_core)$weight>0))
grph_neg_meso_low_core <- delete_vertices(grph_neg_meso_low_core,which(igraph::degree(grph_neg_meso_low_core)<1))

# let's convert the edges to negative numbers so that we can plot...
E(grph_neg_meso_low_core)$weight <- abs(E(grph_neg_meso_low_core)$weight)

# plot
plot(grph_neg_meso_low_core, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_neg_meso_low_core))
# set weight threshold
V(grph_neg_meso_low_core) # vertices
E(grph_neg_meso_low_core) # edges
gsize(grph_neg_meso_low_core)

modules_meso_low_core_neg = cluster_leading_eigen(grph_neg_meso_low_core, weights = NA)
print(modules_meso_low_core_neg) # modularity = 0.19; groups = 5
modularity(modules_meso_low_core_neg)
class(modules_meso_low_core_neg)
deg_meso_low_core_neg <- igraph::degree(grph_neg_meso_low_core)

# histogram node degree
hist(deg_meso_low_core_neg, main="Histogram of node degree")

# betweenness
btwn_meso_low_core_neg <- betweenness(grph_neg_meso_low_core, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_low_core_neg) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_low_core_neg)[1] <- "betweenness"
head(btwn_meso_low_core_neg) # Nodes with higher betweenness centrality scores are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_low_core_neg %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_low_core_neg_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_low_core_neg_df)
dim(btwn_meso_low_core_neg_df)

is_connected(grph_neg_meso_low_core) # TRUE = strongly connected
count_components(grph_neg_meso_low_core) # just one component
components(grph_neg_meso_low_core)
#v_con_meso_low_core_neg <- vertex_connectivity(grph_neg_meso_low_core)
v_con_meso_low_core_neg # 2
e_con_meso_low_core_neg <- edge_connectivity(grph_neg_meso_low_core) 
e_con_meso_low_core_neg # 2

edge_density_meso_low_core_neg <- edge_density(grph_neg_meso_low_core)
edge_density_meso_low_core_neg
avg_path_length_meso_low_core_neg <- mean_distance(grph_neg_meso_low_core, weights = NA, directed = FALSE)
avg_path_length_meso_low_core_neg

v.cent.meso.low.core.neg <- robustness(grph_neg_meso_low_core, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.low.core.neg
v.deg.meso.low.core.neg <- robustness(grph_neg_meso_low_core, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.low.core.neg
v.random.meso.low.core.neg <- robustness_random(grph_neg_meso_low_core, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.low.core.neg

```

```{r plot-meso-low-core-neg, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_neg_meso_low_core, layout = igraph::with_fr())

set.seed(123)
meso_low_core_neg_df <- ggnetwork(grph_neg_meso_low_core, layout = igraph::with_fr())
head(meso_low_core_neg_df)
class(meso_low_core_neg_df) # this is a dataframe!

# let's add taxa
meso_low_core_neg_df$taxa <- ifelse(startsWith(meso_low_core_neg_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_low_core_neg_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_low_core_neg_df)
tail(meso_low_core_neg_df)

# let's add in membership
member <- modules_meso_low_core_neg$membership
name <- modules_meso_low_core_neg$names
mod_meso_low_core_neg_df <- cbind(name, member) %>% data.frame()
head(mod_meso_low_core_neg_df)
tail(mod_meso_low_core_neg_df)
class(mod_meso_low_core_neg_df)

meso_low_core_neg_df <- left_join(meso_low_core_neg_df, mod_meso_low_core_neg_df, by = "name")
head(meso_low_core_neg_df)
tail(meso_low_core_neg_df)

# I think we can add in taxa?
colnames(meso_low_core_neg_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)
tail(tax_short)

meso_low_core_neg_df_tax <- meso_low_core_neg_df %>%
  left_join(tax_short, by = "OTUid", relationship = "many-to-many")
head(meso_low_core_neg_df_tax)

#let's add in degree
deg_meso_low_core_neg <- igraph::degree(grph_neg_meso_low_core) %>% as.data.frame()
head(deg_meso_low_core_neg)
colnames(deg_meso_low_core_neg)[1] <- "degree"
rownames(deg_meso_low_core_neg)
deg_meso_low_core_neg$OTUid <- rownames(deg_meso_low_core_neg)
deg_meso_low_core_neg <- select(deg_meso_low_core_neg, OTUid, degree)
head(deg_meso_low_core_neg)
unique(meso_low_core_neg_df_tax$TAX_SHORT)
head(meso_low_core_neg_df_tax)

meso_low_core_neg_df_tax <- left_join(meso_low_core_neg_df_tax, deg_meso_low_core_neg, by = "OTUid")
head(meso_low_core_neg_df_tax)

meso_low_core_neg_df_tax <- left_join(meso_low_core_neg_df_tax, btwn_meso_low_core_neg_df, by = "OTUid")
head(meso_low_core_neg_df_tax)

member_count <- mod_meso_low_core_neg_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F", "#DCB0F2","#C9DB74","#D3B484","#B3B3B3")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_low_core_neg_df_tax$member <- factor(meso_low_core_neg_df_tax$member, levels = 1:12)
meso_low_core_neg_df_tax <- meso_low_core_neg_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_low_core_neg_df_tax)
tail(meso_low_core_neg_df_tax)

meso_low_core_neg_node <- ggplot(meso_low_core_neg_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Lower Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_low_core_neg_node  

meso_low_core_neg_inter <- ggplot(meso_low_core_neg_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(), color = "#0065ff", linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
meso_low_core_neg_inter

meso_low_core_neg_plot_mod <- ggplot(meso_low_core_neg_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Lower Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + theme(legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
meso_low_core_neg_plot_mod

```

```{r meso-low-core-stats-neg, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_low_core_neg_df_tax)

meso_low_core_neg_stats_df <- meso_low_core_neg_df_tax %>% 
  select(OTUid, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_low_core_neg_stats_df)

meso_low_neg_degree_df <- meso_low_core_neg_stats_df %>% unique() %>% arrange(desc(degree)) 
meso_low_neg_degree_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_low_neg_degree_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_low_neg_degree_df %>% unique() %>% arrange(desc(degree))), n = 10)

quantile(meso_low_neg_degree_df$degree, probs = c(.25,.5,.75, 0.8, 0.9))
quantile(meso_low_neg_degree_df$betweenness, probs = c(.25,.5,.75, 0.8, 0.9))

degperc <- quantile(meso_low_neg_degree_df$degree, probs = 0.9)
btwnperc <- quantile(meso_low_neg_degree_df$betweenness, probs = 0.9)

meso_low_neg_mod <- meso_low_neg_degree_df %>% select(OTUid, taxa, TAX_SHORT, member, degree, betweenness) %>% 
  filter(degree >= degperc & betweenness > btwnperc) %>%
  group_by(TAX_SHORT) %>%
  mutate(sum_OTU = n()) %>% 
  select(TAX_SHORT, sum_OTU, taxa) %>% unique() %>%
  ungroup()

head(meso_low_neg_mod)
meso_low_neg_mod$depth <- "Lower Mesopelagic"

meso_low_neg_mod$TAX_SHORT = forcats::fct_rev(factor(meso_low_neg_mod$TAX_SHORT)) #arrange terms in alphabetical order

meso_low_neg_dotplot <- ggplot(data = meso_low_neg_mod, aes(x = as.factor(depth), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_low_neg_dotplot

```

## 3.3. All Depths Combined

```{r analysis-panel-depth-core-neg-save eval = TRUE, message = FALSE, warning = FALSE}

# save plot inputs

save(grph_neg_epi_core, grph_neg_meso_up_core, grph_neg_meso_low_core, file = "R-outputs/network_neg.RData")

save(v_con_epi_core_neg, e_con_epi_core_neg, v_con_meso_up_core_neg, e_con_meso_up_core_neg, v_con_meso_low_core_neg, e_con_meso_low_core_neg, file = "R-outputs/connectivity_calculations_neg.RData")

save(epi_core_neg_df_tax, meso_up_core_neg_df_tax, meso_low_core_neg_df_tax, file = "./ggnetwork-inputs/ggnetwork_plot_inputs_core_neg_20250410.RData")

save(v.random.epi.core.neg, v.random.meso.up.core.neg, v.random.meso.low.core.neg, file = "./ggnetwork-inputs/robustness_core_neg.RData")

panel_neg_node <- epi_core_neg_node + meso_up_core_neg_node + meso_low_core_neg_node +
  plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.50), 
        legend.key.spacing.x = unit(0.5, "mm"),
        legend.key.spacing.y = unit(-0.25, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 0)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 10, b = 0, l = 10), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 1)))

panel_neg_node

#ggsave("./network-plots/depthsplit_network_panel_core_neg.pdf", plot = panel_neg_node, height = 34, width = 80, units = "mm", dpi=300)

panel_neg_inter <- epi_core_neg_inter + meso_up_core_neg_inter + meso_low_core_neg_inter +
    plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.5), 
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(-2, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 5, b = 0, l = -5), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 0.5)))

panel_neg_inter

#ggsave("./network-plots/depthsplit_network_panel_interactions_neg.pdf", plot = panel_neg_inter, height = 34, width = 80, units = "mm", dpi=300)

panel_neg_mod <- epi_core_neg_plot_mod + meso_up_core_neg_plot_mod + meso_low_core_neg_plot_mod +
    plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.5), 
        legend.key.spacing.x = unit(0, "mm"),
        legend.key.spacing.y = unit(-2, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = -0.2)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 5, b = 0, l = -5), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 0.5)))

panel_neg_mod

#ggsave("./network-plots/depthsplit_network_panel_module_neg.pdf", plot = panel_neg_mod, height = 34, width = 80, units = "mm", dpi=300)


## all panels

panel_neg_node / panel_neg_mod / panel_neg_inter 

#ggsave("./network-plots/depthsplit_network_panel_all_neg.pdf", height = 100, width = 80, units = "mm", dpi=300)


###
epi_neg_mod$depth <- "Epipelagic"
meso_up_neg_mod$depth <- "Upper Mesopelagic"
meso_low_neg_mod$depth <- "Lower Mesopelagic"

depth_neg_mod_df <- rbind(epi_neg_mod, meso_up_neg_mod, meso_low_neg_mod) %>% arrange()
head(depth_neg_mod_df)

depth_neg_mod_df$depth <- fct_relevel(depth_neg_mod_df$depth, "Epipelagic", "Upper Mesopelagic", "Lower Mesopelagic")


list <- depth_neg_mod_df %>% select(taxa, TAX_SHORT) %>% unique() %>% sort() %>% data.frame()
list

depth_neg_mod_df$TAX_SHORT <- fct_relevel(depth_neg_mod_df$TAX_SHORT,
                                          "Alveolata-Apicomplexa",
                                          "Alveolata-Ciliates",
                                          "Alveolata-Dinoflagellates",
                                          "Alveolata-Syndiniales",
                                          "Alveolata-Other",
                                          #"Amoebozoa",
                                          "Archaeplastida-Picozoa",
                                          "Chlorophyta",
                                          "Cryptophyta",
                                         # "Cryptista-Kathablepharida",
                                          "Excavata",
                                          "Haptophyta",
                                          #"Haptista-Other",
                                          "Obazoa-Breviatea",
                                          "Obazoa-Choanoflagellata",
                                          "Obazoa-Fungi",
                                          "Obazoa-Opisthokonta",
                                          "Rhizaria-Cercozoa",
                                          "Rhizaria-Radiolaria",
                                        #  "Rhizaria-Other",
                                          "Rhodophyta",
                                          "Stramenopiles-Diatoms",  
                                          "Stramenopiles-MAST",
                                          "Stramenopiles-Other",
                                          "TSAR-Telonemia",
                                        "TSAR-Unassigned",
                                        "Annelida",
                                          #"Annelida-Phyllodocida",
                                          "Arthropoda-Calanoida",
                                          "Arthropoda-Cyclopoida",
                                          #"Cnidaria-Coronatae",
                                          #"Cnidaria-Narcomedusae",
                                          "Cnidaria-Siphonophorae",
                                          "Cnidaria-Trachymedusae",
                                         # "Cnidaria-Trachylinae",
                                          #"Cnidaria-Semaeostomeae",
                                          "Ctenophora-Cydippida",
                                          "Tunicata-Salpida",
                                          "Coryphaenidae-Coryphaena",
                                          "Gonostomatidae-Cyclothone",
                                          "Gonostomatidae-Sigmops",
                                        "Melamphaidae-Melamphaes",
                                          "Melamphaidae-Scopeloberyx",
                                          "Myctophidae-Benthosema",
                                          #"Nemichthyidae-Nemichthys",
                                          #"Sternoptychidae-Sternoptyx",
                                          #"Stomiidae-Chauliodus"
                                          ) 

                            
mod_neg_dotplot <- 
  ggplot(data = depth_neg_mod_df, aes(y = fct_rev(depth), x = (TAX_SHORT))) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa",
                             order = 1),
         size = guide_legend(title="ASV Count",
                             order = 2,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
        panel.background = element_rect(linewidth = 0.5),
        plot.background = element_blank(),
        axis.text.x = element_text(colour = "black", size = 9, angle = 60, hjust = 0, vjust = 0),
        axis.text.y = element_text(colour = "black", size = 8),
        strip.text.x = element_text(size = 5, color = "black", face = "bold"),
        strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"),
    legend.text = element_text(size = 8, margin = margin(l = 1)),
    legend.title = element_text(size = 8),
    legend.key.size = unit(3, 'mm'),
    legend.box.margin = unit(-3.4, 'mm'),
    plot.margin = unit(c(t = 0.5, r = 0.5, b = 0.5, l = 0.5), "lines"))

mod_neg_dotplot

ggsave("./network-plots/depthsplit_network_module_dotplot_neg_pub.pdf", width = 8.25, height = 4, units = "in", dpi=300)


head(depth_pos_mod_df)
depth_pos_mod_df$interaction <- "Positive"
head(depth_neg_mod_df)
depth_neg_mod_df$interaction <- "Negative"
check <- rbind(depth_pos_mod_df, depth_neg_mod_df)


mod_all_dotplot <- 
  ggplot(data = check, aes(y = fct_rev(depth), x = (TAX_SHORT))) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
  facet_wrap(.~interaction) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa",
                             order = 1),
         size = guide_legend(title="ASV Count",
                             order = 2,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
        panel.background = element_rect(linewidth = 0.5),
        plot.background = element_blank(),
        axis.text.x = element_text(colour = "black", size = 7, angle = 45, hjust = 0, vjust = 0),
        axis.text.y = element_text(colour = "black", size = 7),
        strip.text.x = element_text(size = 5, color = "black", face = "bold"),
        strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"),
    legend.text = element_text(size = 7, margin = margin(l = 1)),
    legend.title = element_text(size = 7),
    legend.key.size = unit(3, 'mm'),
    legend.box.margin = unit(-3.4, 'mm'),
    plot.margin = unit(c(t = 0.5, r = 0.5, b = 0.5, l = 0.5), "lines"))
  
mod_all_dotplot

# let's merge the attack robustness files

#betweenness
head(v.cent.epi.core.neg)
head(v.cent.meso.up.core.neg)
head(v.cent.meso.low.core.neg)

## create a column for ype of attack
v.cent.epi.core.neg$depth <- "Epipelagic"
v.cent.meso.up.core.neg$depth <- "Upper Mesopelagic"
v.cent.meso.low.core.neg$depth <- "Lower Mesopelagic"

v.cent.core.neg <- rbind(v.cent.epi.core.neg, v.cent.meso.up.core.neg, v.cent.meso.low.core.neg)

# Degree
head(v.deg.epi.core.neg)
head(v.deg.meso.up.core.neg)
head(v.deg.meso.low.core.neg)

v.deg.epi.core.neg$depth <- "Epipelagic"
v.deg.meso.up.core.neg$depth <- "Upper Mesopelagic"
v.deg.meso.low.core.neg$depth <- "Lower Mesopelagic"

v.deg.core.neg <- rbind(v.deg.epi.core.neg, v.deg.meso.up.core.neg, v.deg.meso.low.core.neg)

head(v.random.epi.core.neg)
head(v.random.meso.up.core.neg)
head(v.random.meso.low.core.neg)

v.random.epi.core.neg$depth <- "Epipelagic"
v.random.meso.up.core.neg$depth <- "Upper Mesopelagic"
v.random.meso.low.core.neg$depth <- "Lower Mesopelagic"

v.random.core.neg <- rbind(v.random.epi.core.neg, v.random.meso.up.core.neg, v.random.meso.low.core.neg)

v.cent.core.neg$depth <- fct_relevel(v.cent.core.neg$depth, "Lower Mesopelagic", after = Inf)
v.deg.core.neg$depth <- fct_relevel(v.deg.core.neg$depth, "Lower Mesopelagic", after = Inf)
v.random.core.neg$depth <- fct_relevel(v.random.core.neg$depth, "Lower Mesopelagic", after = Inf)

v.cent.core.neg.plot <- v.cent.core.neg %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Betweenness", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.neg.plot <- v.deg.core.neg %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Degree", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.neg.plot

v.random.core.neg.plot <- v.random.core.neg %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Random", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.random.core.neg.plot


v.core.neg.plot <- v.cent.core.neg.plot + v.deg.core.neg.plot + v.random.core.neg.plot + 
  plot_layout(guides = 'collect') &
    theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 10, hjust = 0.5),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8, margin = margin(l = 1)),
        legend.position = "bottom", 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 8),
        axis.title = element_text(size = 8))

v.core.neg.plot

#ggsave("./network-plots/depthsplit_network_robust_neg.pdf", height = 75, width = 180, units = "mm", dpi=300)

v.cent.core.pos$interaction <- "Positive"
v.deg.core.pos$interaction <- "Positive"
v.random.core.pos$interaction <- "Positive"
v.cent.core.neg$interaction <- "Negative"
v.deg.core.neg$interaction <- "Negative"
v.random.core.neg$interaction <- "Negative"

v.cent.core.allinter <- rbind(v.cent.core.pos, v.cent.core.neg)
v.deg.core.allinter <- rbind(v.deg.core.pos, v.deg.core.neg)
v.random.core.allinter <- rbind(v.random.core.pos, v.random.core.neg)

v.cent.core.allinter.plot <- v.cent.core.allinter %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth, linetype = interaction), linewidth = 0.5, alpha = 1) + 
  labs(title = "Betweenness", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  scale_linetype_manual(values=c("dotted", "solid")) +
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)",
                              nrow = 3,
                              order = 1),
         linetype = guide_legend(title = "Interaction",
                                 nrow = 3,
                                 order = 2)) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.cent.core.allinter.plot

v.deg.core.allinter.plot <- v.deg.core.allinter %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth, linetype = interaction), linewidth = 0.5, alpha = 1) + 
  labs(title = "Degree", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  scale_linetype_manual(values=c("dotted", "solid")) +
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)",
                              nrow = 3,
                              order = 1),
         linetype = guide_legend(title = "Interaction",
                                 nrow = 3,
                                 order = 2)) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.allinter.plot

v.random.core.allinter.plot <- v.random.core.allinter %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth, linetype = interaction), linewidth = 0.5, alpha = 1) + 
  labs(title = "Random", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  scale_linetype_manual(values=c("dotted", "solid")) +
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)",
                              nrow = 3,
                              order = 1),
         linetype = guide_legend(title = "Interaction",
                                 nrow = 3,
                                 order = 2)) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.random.core.allinter.plot

v.core.allinter.panel.plot <- v.cent.core.allinter.plot + v.deg.core.allinter.plot + v.random.core.allinter.plot + 
  plot_layout(guides = 'collect') &
    theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 10, hjust = 0.5),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8, margin = margin(l = 1)),
        legend.position = "bottom", 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 8),
        axis.title = element_text(size = 8))

v.core.allinter.panel.plot

ggsave("./network-plots/depthsplit_network_robust_pos_neg_interactions_pub.pdf", height = 75, width = 180, units = "mm", dpi=300)

```


# 4. Strongest Component

## 4.1. Positive Interactions

### 4.1.1. Epipelagic

```{r analysis-epi-strong-pos, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
# histograph of weights
hist(E(grph_pos_epi_core)$weight, main="Histogram of weight")
mean(E(grph_pos_epi_core)$weight)
quantile(E(grph_pos_epi_core)$weight, probs = c(.25,.5,.75, 0.8, 0.9))

threshold = quantile(E(grph_pos_epi_core)$weight, probs = .9)
threshold

# let's delete the negative weights and then delete those vertices
# these are only Negative interactions
grph_pos_epi1 <- delete_edges(grph_pos_epi_core, which(E(grph_pos_epi_core)$weight<threshold))
grph_pos_epi1 <- delete_vertices(grph_pos_epi1,which(igraph::degree(grph_pos_epi1)<1))
# plot
plot(grph_pos_epi1, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_pos_epi1))

# set weight threshold
V(grph_pos_epi1) # vertices (861)
E(grph_pos_epi1) # edges (712)

graph_components <- components(grph_pos_epi1)
graph_components$csize

plot(density((E(grph_pos_epi1)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(grph_pos_epi1)$weight)~(E(grph_pos_epi1)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_largest_component_epi_pos <- induced_subgraph(grph_pos_epi1,V(grph_pos_epi1)[which(graph_components$membership == which.max(graph_components$csize))])

V(grph_largest_component_epi_pos)$size = igraph::degree(grph_largest_component_epi_pos)*1
E(grph_largest_component_epi_pos)$width <- abs(E(grph_largest_component_epi_pos)$weight)*1

plot(grph_largest_component_epi_pos, layout=layout_with_fr(grph_largest_component_epi_pos),
     vertex.label.dist=0.5, vertex.label = NA,
     vertex.label.cex=0.2,
     vertex.label.color="black")

V(grph_largest_component_epi_pos) # vertices (78)
E(grph_largest_component_epi_pos) # edges (78)

is_connected(grph_largest_component_epi_pos) # TRUE = strongly connected
v_con_grph_largest_component_epi_pos <- vertex_connectivity(grph_largest_component_epi_pos) # 1
v_con_grph_largest_component_epi_pos
e_con_grph_largest_component_epi_pos <- edge_connectivity(grph_largest_component_epi_pos) # 1
e_con_grph_largest_component_epi_pos

edge_density_grph_largest_component_epi_pos <- edge_density(grph_largest_component_epi_pos)
edge_density_grph_largest_component_epi_pos
avg_path_grph_largest_component_epi_pos <- mean_distance(grph_largest_component_epi_pos, weights = NA, directed = FALSE)
avg_path_grph_largest_component_epi_pos

set.seed(123)

# all epi - strong
epi_df1_pos <- ggnetwork(grph_pos_epi1, layout = igraph::with_fr())
head(epi_df1_pos)

### largest component
epi_df1_pos_comp <- ggnetwork(grph_largest_component_epi_pos, layout = igraph::with_fr())
head(epi_df1_pos_comp)
class(epi_df1_pos_comp) # this is a dataframe!

```

```{r plot-epi-core-strong-pos, eval = TRUE, message = FALSE, warning = FALSE}

# let's add taxa
epi_df1_pos$taxa <- ifelse(startsWith(epi_df1_pos$name, "p"), "Protists",
                       ifelse(startsWith(epi_df1_pos$name, "f"), "Vertebrates", "Invertebrates"))

head(epi_df1_pos)
tail(epi_df1_pos)

# I think we can add in taxa?
colnames(epi_df1_pos)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

epi_core_df1_tax_pos <- epi_df1_pos %>%
  left_join(tax_short, by = "OTUid")
head(epi_core_df1_tax_pos)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

epi_core_df1_tax_pos <- epi_core_df1_tax_pos %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(epi_core_df1_tax_pos)
tail(epi_core_df1_tax_pos)

epi_core_node_pos <- ggplot(epi_core_df1_tax_pos, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))

epi_core_node_pos


# let's add taxa
epi_df1_pos_comp$taxa <- ifelse(startsWith(epi_df1_pos_comp$name, "p"), "Protists",
                            ifelse(startsWith(epi_df1_pos_comp$name, "f"), "Vertebrates", "Invertebrates"))

head(epi_df1_pos_comp)
tail(epi_df1_pos_comp)

# I think we can add in taxa?
colnames(epi_df1_pos_comp)[3] <- "OTUid"

epi_core_df1_comp_tax_pos <- epi_df1_pos_comp %>%
  left_join(tax_short, by = "OTUid")

head(epi_core_df1_comp_tax_pos)
tail(epi_core_df1_comp_tax_pos)
dim(epi_core_df1_comp_tax_pos)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

epi_core_df1_comp_tax_pos <- epi_core_df1_comp_tax_pos %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

epi_core_df1_comp_tax_pos <- epi_core_df1_comp_tax_pos %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates"))
head(epi_core_df1_comp_tax_pos)
tail(epi_core_df1_comp_tax_pos)

epi_core_node_comp_pos <- ggplot(epi_core_df1_comp_tax_pos, aes(x, y, xend = xend, yend = yend)) + 
    geom_edges(color = "black", linewidth = 0.1, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 1, alpha = 0.9, color = "black", stroke = 0.25) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
epi_core_node_comp_pos


```


### 4.1.2. Upper Mesopelagic

```{r analysis-meso-up-strong-pos, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
# histograph of weights
hist(E(grph_pos_meso_up_core)$weight, main="Histogram of weight")
mean(E(grph_pos_meso_up_core)$weight)
quantile(E(grph_pos_meso_up_core)$weight, probs = c(.25,.5,.75, 0.8, 0.9))

threshold = quantile(E(grph_pos_meso_up_core)$weight, probs = .9)
threshold

# let's delete the negative weights and then delete those vertices
# these are only Negative interactions
grph_pos_meso_up1 <- delete_edges(grph_pos_meso_up_core, which(E(grph_pos_meso_up_core)$weight<threshold))
grph_pos_meso_up1 <- delete_vertices(grph_pos_meso_up1,which(igraph::degree(grph_pos_meso_up1)<1))
# plot
plot(grph_pos_meso_up1, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_pos_meso_up1))

# set weight threshold
V(grph_pos_meso_up1) # vertices (1236)
E(grph_pos_meso_up1) # edges (1331)

graph_components <- components(grph_pos_meso_up1)
graph_components$csize

plot(density((E(grph_pos_meso_up1)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(grph_pos_meso_up1)$weight)~(E(grph_pos_meso_up1)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_largest_component_meso_up_pos <- induced_subgraph(grph_pos_meso_up1,V(grph_pos_meso_up1)[which(graph_components$membership == which.max(graph_components$csize))])

V(grph_largest_component_meso_up_pos)$size = igraph::degree(grph_largest_component_meso_up_pos)*1
E(grph_largest_component_meso_up_pos)$width <- abs(E(grph_largest_component_meso_up_pos)$weight)*1

plot(grph_largest_component_meso_up_pos, layout=layout_with_fr(grph_largest_component_meso_up_pos),
     vertex.label.dist=0.5, vertex.label = NA,
     vertex.label.cex=0.2,
     vertex.label.color="black")

V(grph_largest_component_meso_up_pos) # vertices (983)
E(grph_largest_component_meso_up_pos) # edges (1162)

is_connected(grph_largest_component_meso_up_pos) # TRUE = strongly connected
v_con_grph_largest_component_meso_up_pos <- vertex_connectivity(grph_largest_component_meso_up_pos) # 1
v_con_grph_largest_component_meso_up_pos
e_con_grph_largest_component_meso_up_pos <- edge_connectivity(grph_largest_component_meso_up_pos) # 1
e_con_grph_largest_component_meso_up_pos

edge_density_grph_largest_component_meso_up_pos <- edge_density(grph_largest_component_meso_up_pos)
edge_density_grph_largest_component_meso_up_pos
avg_path_grph_largest_component_meso_up_pos <- mean_distance(grph_largest_component_meso_up_pos, weights = NA, directed = FALSE)
avg_path_grph_largest_component_meso_up_pos

set.seed(123)

# all meso_up - strong
meso_up_df1_pos <- ggnetwork(grph_pos_meso_up1, layout = igraph::with_fr())
head(meso_up_df1_pos)

### largest component
meso_up_df1_pos_comp <- ggnetwork(grph_largest_component_meso_up_pos, layout = igraph::with_fr())
head(meso_up_df1_pos_comp)
class(meso_up_df1_pos_comp) # this is a dataframe!

```

```{r plot-meso-up-core-strong-pos, eval = TRUE, message = FALSE, warning = FALSE}

# let's add taxa
meso_up_df1_pos$taxa <- ifelse(startsWith(meso_up_df1_pos$name, "p"), "Protists",
                       ifelse(startsWith(meso_up_df1_pos$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_up_df1_pos)
tail(meso_up_df1_pos)

# I think we can add in taxa?
colnames(meso_up_df1_pos)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_up_core_df1_tax_pos <- meso_up_df1_pos %>%
  left_join(tax_short, by = "OTUid")
head(meso_up_core_df1_tax_pos)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_up_core_df1_tax_pos <- meso_up_core_df1_tax_pos %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_up_core_df1_tax_pos)
tail(meso_up_core_df1_tax_pos)

meso_up_core_node_pos <- ggplot(meso_up_core_df1_tax_pos, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))

meso_up_core_node_pos


# let's add taxa
meso_up_df1_pos_comp$taxa <- ifelse(startsWith(meso_up_df1_pos_comp$name, "p"), "Protists",
                            ifelse(startsWith(meso_up_df1_pos_comp$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_up_df1_pos_comp)
tail(meso_up_df1_pos_comp)

# I think we can add in taxa?
colnames(meso_up_df1_pos_comp)[3] <- "OTUid"

meso_up_core_df1_comp_tax_pos <- meso_up_df1_pos_comp %>%
  left_join(tax_short, by = "OTUid")

head(meso_up_core_df1_comp_tax_pos)
dim(meso_up_core_df1_comp_tax_pos)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_up_core_df1_comp_tax_pos <- meso_up_core_df1_comp_tax_pos %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_up_core_df1_comp_tax_pos)
tail(meso_up_core_df1_comp_tax_pos)

meso_up_core_node_comp_pos <- ggplot(meso_up_core_df1_comp_tax_pos, aes(x, y, xend = xend, yend = yend)) + 
    geom_edges(color = "black", linewidth = 0.1, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 1, alpha = 0.9, color = "black", stroke = 0.25) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
meso_up_core_node_comp_pos


```

### 4.1.3. Lower Mesopelagic

```{r analysis-meso-low-strong-pos, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
# histograph of weights
hist(E(grph_pos_meso_low_core)$weight, main="Histogram of weight")
mean(E(grph_pos_meso_low_core)$weight)
quantile(E(grph_pos_meso_low_core)$weight, probs = c(.25,.5,.75, 0.8, 0.9))

threshold = quantile(E(grph_pos_meso_low_core)$weight, probs = .9)
threshold

# let's delete the negative weights and then delete those vertices
# these are only Negative interactions
grph_pos_meso_low1 <- delete_edges(grph_pos_meso_low_core, which(E(grph_pos_meso_low_core)$weight<threshold))
grph_pos_meso_low1 <- delete_vertices(grph_pos_meso_low1,which(igraph::degree(grph_pos_meso_low1)<1))
# plot
plot(grph_pos_meso_low1, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_pos_meso_low1))

# set weight threshold
V(grph_pos_meso_low1) # vertices (1167)
E(grph_pos_meso_low1) # edges (1162)

graph_components <- components(grph_pos_meso_low1)
graph_components$csize

plot(density((E(grph_pos_meso_low1)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(grph_pos_meso_low1)$weight)~(E(grph_pos_meso_low1)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_largest_component_meso_low_pos <- induced_subgraph(grph_pos_meso_low1,V(grph_pos_meso_low1)[which(graph_components$membership == which.max(graph_components$csize))])

V(grph_largest_component_meso_low_pos)$size = igraph::degree(grph_largest_component_meso_low_pos)*1
E(grph_largest_component_meso_low_pos)$width <- abs(E(grph_largest_component_meso_low_pos)$weight)*1

plot(grph_largest_component_meso_low_pos, layout=layout_with_fr(grph_largest_component_meso_low_pos),
     vertex.label.dist=0.5, vertex.label = NA,
     vertex.label.cex=0.2,
     vertex.label.color="black")

V(grph_largest_component_meso_low_pos) # vertices (804)
E(grph_largest_component_meso_low_pos) # edges (903)

is_connected(grph_largest_component_meso_low_pos) # TRUE = strongly connected
v_con_grph_largest_component_meso_low_pos <- vertex_connectivity(grph_largest_component_meso_low_pos) # 1
v_con_grph_largest_component_meso_low_pos
e_con_grph_largest_component_meso_low_pos <- edge_connectivity(grph_largest_component_meso_low_pos) # 1
e_con_grph_largest_component_meso_low_pos

edge_density_grph_largest_component_meso_low_pos <- edge_density(grph_largest_component_meso_low_pos)
edge_density_grph_largest_component_meso_low_pos
avg_path_grph_largest_component_meso_low_pos <- mean_distance(grph_largest_component_meso_low_pos, weights = NA, directed = FALSE)
avg_path_grph_largest_component_meso_low_pos

set.seed(123)

# all meso_low - strong
meso_low_df1_pos <- ggnetwork(grph_pos_meso_low1, layout = igraph::with_fr())
head(meso_low_df1_pos)

### largest component
meso_low_df1_pos_comp <- ggnetwork(grph_largest_component_meso_low_pos, layout = igraph::with_fr())
head(meso_low_df1_pos_comp)
class(meso_low_df1_pos_comp) # this is a dataframe!

```

```{r plot-meso-low-core-strong-pos, eval = TRUE, message = FALSE, warning = FALSE}

# let's add taxa
meso_low_df1_pos$taxa <- ifelse(startsWith(meso_low_df1_pos$name, "p"), "Protists",
                       ifelse(startsWith(meso_low_df1_pos$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_low_df1_pos)
tail(meso_low_df1_pos)

# I think we can add in taxa?
colnames(meso_low_df1_pos)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_low_core_df1_tax_pos <- meso_low_df1_pos %>%
  left_join(tax_short, by = "OTUid")
head(meso_low_core_df1_tax_pos)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_low_core_df1_tax_pos <- meso_low_core_df1_tax_pos %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_low_core_df1_tax_pos)
tail(meso_low_core_df1_tax_pos)

meso_low_core_node_pos <- ggplot(meso_low_core_df1_tax_pos, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))

meso_low_core_node_pos


# let's add taxa
meso_low_df1_pos_comp$taxa <- ifelse(startsWith(meso_low_df1_pos_comp$name, "p"), "Protists",
                            ifelse(startsWith(meso_low_df1_pos_comp$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_low_df1_pos_comp)
tail(meso_low_df1_pos_comp)

# I think we can add in taxa?
colnames(meso_low_df1_pos_comp)[3] <- "OTUid"

meso_low_core_df1_comp_tax_pos <- meso_low_df1_pos_comp %>%
  left_join(tax_short, by = "OTUid")

head(meso_low_core_df1_comp_tax_pos)
dim(meso_low_core_df1_comp_tax_pos)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_low_core_df1_comp_tax_pos <- meso_low_core_df1_comp_tax_pos %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_low_core_df1_comp_tax_pos)
tail(meso_low_core_df1_comp_tax_pos)

meso_low_core_node_comp_pos <- ggplot(meso_low_core_df1_comp_tax_pos, aes(x, y, xend = xend, yend = yend)) + 
    geom_edges(color = "black", linewidth = 0.1, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 1, alpha = 0.9, color = "black", stroke = 0.25) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
meso_low_core_node_comp_pos


```


## 4.2. Negative Interactions

### 4.2.1. Epipelagic
```{r analysis-epi-strong-neg, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
# histograph of weights
hist(E(grph_neg_epi_core)$weight, main="Histogram of weight")
mean(E(grph_neg_epi_core)$weight)
quantile(E(grph_neg_epi_core)$weight, probs = c(.25,.5,.75, 0.8, 0.9))

threshold = quantile(E(grph_neg_epi_core)$weight, probs = .9)
threshold

# let's delete the negative weights and then delete those vertices
# these are only Negative interactions
grph_neg_epi1 <- delete_edges(grph_neg_epi_core, which(E(grph_neg_epi_core)$weight<threshold))
grph_neg_epi1 <- delete_vertices(grph_neg_epi1,which(igraph::degree(grph_neg_epi1)<1))
# plot
plot(grph_neg_epi1, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_neg_epi1))

# set weight threshold
V(grph_neg_epi1) # vertices (582)
E(grph_neg_epi1) # edges (517)

graph_components <- components(grph_neg_epi1)
graph_components$csize

plot(density((E(grph_neg_epi1)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(grph_neg_epi1)$weight)~(E(grph_neg_epi1)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_largest_component_epi_neg <- induced_subgraph(grph_neg_epi1,V(grph_neg_epi1)[which(graph_components$membership == which.max(graph_components$csize))])

V(grph_largest_component_epi_neg)$size = igraph::degree(grph_largest_component_epi_neg)*1
E(grph_largest_component_epi_neg)$width <- abs(E(grph_largest_component_epi_neg)$weight)*1

plot(grph_largest_component_epi_neg, layout=layout_with_fr(grph_largest_component_epi_neg),
     vertex.label.dist=0.5, vertex.label = NA,
     vertex.label.cex=0.2,
     vertex.label.color="black")

V(grph_largest_component_epi_neg) # vertices (354)
E(grph_largest_component_epi_neg) # edges (370)

is_connected(grph_largest_component_epi_neg) # TRUE = strongly connected
v_con_grph_largest_component_epi_neg <- vertex_connectivity(grph_largest_component_epi_neg) # 1
v_con_grph_largest_component_epi_neg
e_con_grph_largest_component_epi_neg <- edge_connectivity(grph_largest_component_epi_neg) # 1
e_con_grph_largest_component_epi_neg

edge_density_grph_largest_component_epi_neg <- edge_density(grph_largest_component_epi_neg)
edge_density_grph_largest_component_epi_neg
avg_path_grph_largest_component_epi_neg <- mean_distance(grph_largest_component_epi_neg, weights = NA, directed = FALSE)
avg_path_grph_largest_component_epi_neg


set.seed(123)

# all epi - strong
epi_df1_neg <- ggnetwork(grph_neg_epi1, layout = igraph::with_fr())
head(epi_df1_neg)

### largest component
epi_df1_neg_comp <- ggnetwork(grph_largest_component_epi_neg, layout = igraph::with_fr())
head(epi_df1_neg_comp)
class(epi_df1_neg_comp) # this is a dataframe!

```

```{r plot-epi-core-strong-neg, eval = TRUE, message = FALSE, warning = FALSE}

# let's add taxa
epi_df1_neg$taxa <- ifelse(startsWith(epi_df1_neg$name, "p"), "Protists",
                       ifelse(startsWith(epi_df1_neg$name, "f"), "Vertebrates", "Invertebrates"))

head(epi_df1_neg)
tail(epi_df1_neg)

# I think we can add in taxa?
colnames(epi_df1_neg)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

epi_core_df1_tax_neg <- epi_df1_neg %>%
  left_join(tax_short, by = "OTUid")
head(epi_core_df1_tax_neg)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

epi_core_df1_tax_neg <- epi_core_df1_tax_neg %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(epi_core_df1_tax_neg)
tail(epi_core_df1_tax_neg)

epi_core_node_neg <- ggplot(epi_core_df1_tax_neg, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))

epi_core_node_neg


# let's add taxa
epi_df1_neg_comp$taxa <- ifelse(startsWith(epi_df1_neg_comp$name, "p"), "Protists",
                            ifelse(startsWith(epi_df1_neg_comp$name, "f"), "Vertebrates", "Invertebrates"))

head(epi_df1_neg_comp)
tail(epi_df1_neg_comp)

# I think we can add in taxa?
colnames(epi_df1_neg_comp)[3] <- "OTUid"

epi_core_df1_comp_tax_neg <- epi_df1_neg_comp %>%
  left_join(tax_short, by = "OTUid")

head(epi_core_df1_comp_tax_neg)
dim(epi_core_df1_comp_tax_neg)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

epi_core_df1_comp_tax_neg <- epi_core_df1_comp_tax_neg %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(epi_core_df1_comp_tax_neg)
tail(epi_core_df1_comp_tax_neg)

epi_core_node_comp_neg <- ggplot(epi_core_df1_comp_tax_neg, aes(x, y, xend = xend, yend = yend)) + 
    geom_edges(color = "black", linewidth = 0.1, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 1, alpha = 0.9, color = "black", stroke = 0.25) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
epi_core_node_comp_neg


```

### 4.2.2. Upper Mesopelagic

```{r analysis-meso-up-strong-neg, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
# histograph of weights
hist(E(grph_neg_meso_up_core)$weight, main="Histogram of weight")
mean(E(grph_neg_meso_up_core)$weight)
quantile(E(grph_neg_meso_up_core)$weight, probs = c(.25,.5,.75, 0.8, 0.9))

threshold = quantile(E(grph_neg_meso_up_core)$weight, probs = .9)
threshold

# let's delete the negative weights and then delete those vertices
# these are only Negative interactions
grph_neg_meso_up1 <- delete_edges(grph_neg_meso_up_core, which(E(grph_neg_meso_up_core)$weight<threshold))
grph_neg_meso_up1 <- delete_vertices(grph_neg_meso_up1,which(igraph::degree(grph_neg_meso_up1)<1))
# plot
plot(grph_neg_meso_up1, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_neg_meso_up1))

# set weight threshold
V(grph_neg_meso_up1) # vertices (978)
E(grph_neg_meso_up1) # edges (1004)

graph_components <- components(grph_neg_meso_up1)
graph_components$csize

plot(density((E(grph_neg_meso_up1)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(grph_neg_meso_up1)$weight)~(E(grph_neg_meso_up1)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_largest_component_meso_up_neg <- induced_subgraph(grph_neg_meso_up1,V(grph_neg_meso_up1)[which(graph_components$membership == which.max(graph_components$csize))])

V(grph_largest_component_meso_up_neg)$size = igraph::degree(grph_largest_component_meso_up_neg)*1
E(grph_largest_component_meso_up_neg)$width <- abs(E(grph_largest_component_meso_up_neg)$weight)*1

plot(grph_largest_component_meso_up_neg, layout=layout_with_fr(grph_largest_component_meso_up_neg),
     vertex.label.dist=0.5, vertex.label = NA,
     vertex.label.cex=0.2,
     vertex.label.color="black")

V(grph_largest_component_meso_up_neg) # vertices (782)
E(grph_largest_component_meso_up_neg) # edges (872)

is_connected(grph_largest_component_meso_up_neg) # TRUE = strongly connected
v_con_grph_largest_component_meso_up_neg <- vertex_connectivity(grph_largest_component_meso_up_neg) # 1
v_con_grph_largest_component_meso_up_neg
e_con_grph_largest_component_meso_up_neg <- edge_connectivity(grph_largest_component_meso_up_neg) # 1
e_con_grph_largest_component_meso_up_neg

edge_density_grph_largest_component_meso_up_neg <- edge_density(grph_largest_component_meso_up_neg)
edge_density_grph_largest_component_meso_up_neg
avg_path_grph_largest_component_meso_up_neg <- mean_distance(grph_largest_component_meso_up_neg, weights = NA, directed = FALSE)
avg_path_grph_largest_component_meso_up_neg

set.seed(123)

# all meso_up - strong
meso_up_df1_neg <- ggnetwork(grph_neg_meso_up1, layout = igraph::with_fr())
head(meso_up_df1_neg)

### largest component
meso_up_df1_neg_comp <- ggnetwork(grph_largest_component_meso_up_neg, layout = igraph::with_fr())
head(meso_up_df1_neg_comp)
class(meso_up_df1_neg_comp) # this is a dataframe!

```

```{r plot-meso-up-core-strong-neg, eval = TRUE, message = FALSE, warning = FALSE}

# let's add taxa
meso_up_df1_neg$taxa <- ifelse(startsWith(meso_up_df1_neg$name, "p"), "Protists",
                       ifelse(startsWith(meso_up_df1_neg$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_up_df1_neg)
tail(meso_up_df1_neg)

# I think we can add in taxa?
colnames(meso_up_df1_neg)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_up_core_df1_tax_neg <- meso_up_df1_neg %>%
  left_join(tax_short, by = "OTUid")
head(meso_up_core_df1_tax_neg)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_up_core_df1_tax_neg <- meso_up_core_df1_tax_neg %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_up_core_df1_tax_neg)
tail(meso_up_core_df1_tax_neg)

meso_up_core_node_neg <- ggplot(meso_up_core_df1_tax_neg, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))

meso_up_core_node_neg


# let's add taxa
meso_up_df1_neg_comp$taxa <- ifelse(startsWith(meso_up_df1_neg_comp$name, "p"), "Protists",
                            ifelse(startsWith(meso_up_df1_neg_comp$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_up_df1_neg_comp)
tail(meso_up_df1_neg_comp)

# I think we can add in taxa?
colnames(meso_up_df1_neg_comp)[3] <- "OTUid"

meso_up_core_df1_comp_tax_neg <- meso_up_df1_neg_comp %>%
  left_join(tax_short, by = "OTUid")

head(meso_up_core_df1_comp_tax_neg)
dim(meso_up_core_df1_comp_tax_neg)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_up_core_df1_comp_tax_neg <- meso_up_core_df1_comp_tax_neg %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_up_core_df1_comp_tax_neg)
tail(meso_up_core_df1_comp_tax_neg)

meso_up_core_node_comp_neg <- ggplot(meso_up_core_df1_comp_tax_neg, aes(x, y, xend = xend, yend = yend)) + 
    geom_edges(color = "black", linewidth = 0.1, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 1, alpha = 0.9, color = "black", stroke = 0.25) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
meso_up_core_node_comp_neg


```

### 4.2.3. Lower Mesopelagic

```{r analysis-meso-low-strong-neg, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
# histograph of weights
hist(E(grph_neg_meso_low_core)$weight, main="Histogram of weight")
mean(E(grph_neg_meso_low_core)$weight)
quantile(E(grph_neg_meso_low_core)$weight, probs = c(.25,.5,.75, 0.8, 0.9))

threshold = quantile(E(grph_neg_meso_low_core)$weight, probs = .9)
threshold

# let's delete the negative weights and then delete those vertices
# these are only Negative interactions
grph_neg_meso_low1 <- delete_edges(grph_neg_meso_low_core, which(E(grph_neg_meso_low_core)$weight<threshold))
grph_neg_meso_low1 <- delete_vertices(grph_neg_meso_low1,which(igraph::degree(grph_neg_meso_low1)<1))
# plot
plot(grph_neg_meso_low1, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_neg_meso_low1))

# set weight threshold
V(grph_neg_meso_low1) # vertices (1063)
E(grph_neg_meso_low1) # edges (1020)

graph_components <- components(grph_neg_meso_low1)
graph_components$csize

plot(density((E(grph_neg_meso_low1)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(grph_neg_meso_low1)$weight)~(E(grph_neg_meso_low1)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_largest_component_meso_low_neg <- induced_subgraph(grph_neg_meso_low1,V(grph_neg_meso_low1)[which(graph_components$membership == which.max(graph_components$csize))])

V(grph_largest_component_meso_low_neg)$size = igraph::degree(grph_largest_component_meso_low_neg)*1
E(grph_largest_component_meso_low_neg)$width <- abs(E(grph_largest_component_meso_low_neg)$weight)*1

plot(grph_largest_component_meso_low_neg, layout=layout_with_fr(grph_largest_component_meso_low_neg),
     vertex.label.dist=0.5, vertex.label = NA,
     vertex.label.cex=0.2,
     vertex.label.color="black")

V(grph_largest_component_meso_low_neg) # vertices (782)
E(grph_largest_component_meso_low_neg) # edges (827)

is_connected(grph_largest_component_meso_low_neg) # TRUE = strongly connected
v_con_grph_largest_component_meso_low_neg <- vertex_connectivity(grph_largest_component_meso_low_neg) # 1
v_con_grph_largest_component_meso_low_neg
e_con_grph_largest_component_meso_low_neg <- edge_connectivity(grph_largest_component_meso_low_neg) # 1
e_con_grph_largest_component_meso_low_neg

edge_density_grph_largest_component_meso_low_neg <- edge_density(grph_largest_component_meso_low_neg)
edge_density_grph_largest_component_meso_low_neg
avg_path_grph_largest_component_meso_low_neg <- mean_distance(grph_largest_component_meso_low_neg, weights = NA, directed = FALSE)
avg_path_grph_largest_component_meso_low_neg

set.seed(123)

# all meso_low - strong
meso_low_df1_neg <- ggnetwork(grph_neg_meso_low1, layout = igraph::with_fr())
head(meso_low_df1_neg)

### largest component
meso_low_df1_neg_comp <- ggnetwork(grph_largest_component_meso_low_neg, layout = igraph::with_fr())
head(meso_low_df1_neg_comp)
class(meso_low_df1_neg_comp) # this is a dataframe!

```

```{r plot-meso-low-core-strong-neg, eval = TRUE, message = FALSE, warning = FALSE}

# let's add taxa
meso_low_df1_neg$taxa <- ifelse(startsWith(meso_low_df1_neg$name, "p"), "Protists",
                       ifelse(startsWith(meso_low_df1_neg$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_low_df1_neg)
tail(meso_low_df1_neg)

# I think we can add in taxa?
colnames(meso_low_df1_neg)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
  #  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
  #  group_by(OTUid) %>%
  #  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_low_core_df1_tax_neg <- meso_low_df1_neg %>%
  left_join(tax_short, by = "OTUid")
head(meso_low_core_df1_tax_neg)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_low_core_df1_tax_neg <- meso_low_core_df1_tax_neg %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_low_core_df1_tax_neg)
tail(meso_low_core_df1_tax_neg)

meso_low_core_node_neg <- ggplot(meso_low_core_df1_tax_neg, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))

meso_low_core_node_neg


# let's add taxa
meso_low_df1_neg_comp$taxa <- ifelse(startsWith(meso_low_df1_neg_comp$name, "p"), "Protists",
                            ifelse(startsWith(meso_low_df1_neg_comp$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_low_df1_neg_comp)
tail(meso_low_df1_neg_comp)

# I think we can add in taxa?
colnames(meso_low_df1_neg_comp)[3] <- "OTUid"

meso_low_core_df1_comp_tax_neg <- meso_low_df1_neg_comp %>%
  left_join(tax_short, by = "OTUid")

head(meso_low_core_df1_comp_tax_neg)
dim(meso_low_core_df1_comp_tax_neg)

taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_low_core_df1_comp_tax_neg <- meso_low_core_df1_comp_tax_neg %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_low_core_df1_comp_tax_neg)
tail(meso_low_core_df1_comp_tax_neg)

meso_low_core_node_comp_neg <- ggplot(meso_low_core_df1_comp_tax_neg, aes(x, y, xend = xend, yend = yend)) + 
    geom_edges(color = "black", linewidth = 0.1, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 1, alpha = 0.9, color = "black", stroke = 0.25) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
  theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                               legend.position = "bottom",
                               axis.text.y = element_blank(),
                               axis.text.x = element_blank(), 
                               axis.ticks.x = element_blank(),
                               axis.ticks.y = element_blank(),
                               axis.title.x = element_blank(),
                               axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
meso_low_core_node_comp_neg


```

## 4.3 All Depths Combined

```{r analysis-panel-strongest-component-save eval = TRUE, message = FALSE, warning = FALSE}

# save plot inputs

save(epi_core_df1_comp_tax_pos, meso_up_core_df1_comp_tax_pos, meso_low_core_df1_comp_tax_pos, epi_core_df1_comp_tax_neg, meso_up_core_df1_comp_tax_neg, meso_low_core_df1_comp_tax_neg, file = "./R-outputs/spieceasi_strongcomponent_plot_inputs_core.RData")

save(se_epi_core, se_meso_up_core, se_meso_low_core, file = "./R-outputs/spieceasi_core_inputs.RData") # note that this is the same as if I were importing all the spieceasi networks from the HPC, but this makes things easier!

panel_pos <- epi_core_node_comp_pos + meso_up_core_node_comp_pos + meso_low_core_node_comp_pos +
  plot_layout(guides = 'collect') & 
  theme(
    panel.border = element_rect(linewidth = 0.66),
    panel.spacing = unit(0.25, "mm"), 
    plot.title = element_text(size = 8),
    legend.position = "right", 
    legend.spacing.y = unit(0, "mm"), 
    legend.margin = margin(0, 0, 0, 0),
    legend.key.size = unit(2, 'mm'), 
    legend.key.height = unit(2, "mm"),
    legend.key.spacing.x = unit(2, "mm"),
    legend.key.spacing.y = unit(0.25, "mm"),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 6, margin = margin(l = 2)))

panel_pos

ggsave("./network-plots/depthsplit_network_panel_taxa_strong_pos.pdf", plot = panel_pos, height = 60, width = 180, units = "mm", dpi=300)


panel_neg <- epi_core_node_comp_neg + meso_up_core_node_comp_neg + meso_low_core_node_comp_neg +
  plot_layout(guides = 'collect') & 
  theme(
    panel.border = element_rect(linewidth = 0.66),
    panel.spacing = unit(0.25, "mm"), 
    plot.title = element_text(size = 8),
    legend.position = "right", 
    legend.spacing.y = unit(0, "mm"), 
    legend.margin = margin(0, 0, 0, 0),
    legend.key.size = unit(2, 'mm'), 
    legend.key.height = unit(2, "mm"),
    legend.key.spacing.x = unit(2, "mm"),
    legend.key.spacing.y = unit(0.25, "mm"),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 6, margin = margin(l = 2)))

panel_neg

ggsave("./network-plots/depthsplit_network_panel_taxa_strong_neg.pdf", plot = panel_neg, height = 60, width = 180, units = "mm", dpi=300)

```

# 5. Pairwise Interactions

## 5.1. Set up
```{r setup-chord-fxn eval = TRUE, message = FALSE, warning = FALSE}

objs_to_remove <- ls(pattern = "^adj")
objs_to_remove <- ls(pattern = "^df")
objs_to_remove <- ls(pattern = "^weighted")
rm(list = objs_to_remove)
#rm(list=ls())

load("./R-outputs/spieceasi_core_inputs.RData", verbose = T)
load("./R-outputs/network_pos.RData", verbose = T)
load("./R-outputs/network_neg.RData", verbose = T)
load("./R-outputs/alleuk_asv_melt_tax_tables_network.RData", verbose = T)
load("./R-outputs/alleuk_asv_se_epi.RData", verbose = T)
load("./R-outputs/alleuk_asv_se_meso_up.RData", verbose = T)
load("./R-outputs/alleuk_asv_se_meso_low.RData", verbose = T)


reformat_se_cross <- function(df_in) {
  interaction <- c("PROT-INVERT", "PROT-VERT", 
                 "INVERT-PROT", "INVERT-VERT", 
                 "VERT-PROT", "VERT-INVERT")
  df_in %>% 
  rownames_to_column(var = "SIDEA") %>% 
  pivot_longer(cols = starts_with(c("prot", "met", "fish")), names_to = "SIDEB") %>% 
  mutate(domain_a = case_when(grepl("prot", SIDEA) ~ "PROT", grepl("met", SIDEA) ~ "INVERT", grepl("fish", SIDEA) ~ "VERT"), domain_b = case_when(grepl("prot", 
        SIDEB) ~ "PROT", grepl("met", SIDEB) ~ "INVERT", grepl("fish", SIDEB) ~ "VERT")) %>%
  mutate(COMBO = paste(domain_a, domain_b, sep = "-")) %>% 
  mutate(COMBO_TYPE = case_when(COMBO %in% interaction ~ 
        "cross", TRUE ~ "same"), SIG_ID = paste(SIDEA, SIDEB, sep = "-")) %>%
  select(-starts_with("domain")) %>%
  left_join(select(alleuk_tax_key_se, TAX_SIDEA = TAX_full, everything()), by = c(SIDEA = "OTUid")) %>% 
  left_join(select(alleuk_tax_key_se, TAX_SIDEB = TAX_full, everything()), by = c(SIDEB = "OTUid"), suffix = c(".A", ".B")) %>% data.frame()
}

# let's set up colors based on taxa
taxa_colors <- c(
  "Alveolata-Apicomplexa" = "#a1c2fd",
  "Alveolata-Ciliates" = "#56C4F0",
  "Alveolata-Dinoflagellates" = "#399dff",
  "Alveolata-Other" = "#0b62fb",
  "Alveolata-Syndiniales" = "#0344b7",
  Chlorophyta = "#9CDC46",
  Cryptophyta = "#dafa0f",
  "Cryptista-Other" = "#a2bd09",
  "Archaeplastida-Other" = "#48FB48",
  "Archaeplastida-Picozoa" = "#90EE90",
  Excavata = "#efdf48",
  Haptophyta = "#ff9d3a",
  "Haptista-Other" = "#d05900",
  "Rhizaria-Cercozoa" = "#ceceff",
  "Rhizaria-Other" = "#a7a7ff",
  "Rhizaria-Radiolaria" = "#7474ff",
  Rhodophyta = "#ff9aa5",
  "Stramenopiles-Diatoms" = "#009a4d",
  "Stramenopiles-MAST" = "#1ec38c",
  "Stramenopiles-Other" = "#90eebf",
  Obazoa = "#910096",
  "TSAR-Telonemia" = "#ff1a53",
  "TSAR-Unassigned" = "#FF69B4",
  Amoebozoa = "#ff5b4d",
  Annelida = "#b9a2ff",
  "Arthropoda-Calanoida" = "#fc996c",
  "Arthropoda-Cyclopoida" = "#ffce5c",
  "Arthropoda-Other" = "#fdfb9b",
  "Arthropoda-Unassigned" = "#FDFBD4",
  #  CnidariaOther = "#0344b7",
  "Cnidaria-Anthoathecata" = "#002cb3",
  "Cnidaria-Coronatae" = "#003fff",
  "Cnidaria-Leptothecata" = "#c7f0ff",
  "Cnidaria-Narcomedusae" = "#0b6ab6",
  "Cnidaria-Semaeostomeae" = "#8de4f8", 
  "Cnidaria-Siphonophorae" = "#84b7ff",
  "Cnidaria-Trachylinae" = "#047de9",
  "Cnidaria-Trachymedusae" = "#5260ff",
  "Cnidaria-Unassigned" = "#d1e4ff",
  "Unassigned Metazoa" = "#82A4E3",
  "Ctenophora-Cydippida" = "#fa9db8",
  "Ctenophora-Unassigned" = "#ff61b6",
  "Tunicata-Copelata" = "#96fac6",
  "Tunicata-Salpida" = "#1ec38c",
  Alepisauridae = "#fa8016",
  Caristiidae = "#1ea9c3",
  Coryphaenidae = "#116b4c",
  Delphinidae = "#FF746C",
  Derichthyidae = "#f4c6e5",
  Gonostomatidae = "#56C4F0",
  Melamphaidae = "#a1f1d6",
  Myctophidae = "#f5eb8e",
  Nemichthyidae = "#d5d2f8",
  Serrivomeridae = "#9790ee",
  Sternoptychidae =  "#367eff",
  Stomiidae = "#034dd1",
"Unassigned Actinopterygii" = "#82A4E3",
"Unassigned Perciformes" = "#cddcf7"
)


rename_taxa_forplots <- function(df){
  annelid <- c("Annelida-Capitellida", "Annelida-Eunicida", "Annelida-Phyllodocida")
#  copepod <- c("Arthropoda-Calanoida", "Arthropoda-Cyclopoida")
  arthro <- c("Arthropoda-Halocyprida", "Arthropoda-Peracarida", "Arthropoda-Poecilostomatoida")
#  cnidaria <- c("Cnidaria-Anthoathecata", "Cnidaria-Narcomedusae", "Cnidaria-Trachylinae", "Cnidaria-Unassigned", "Cnidaria-Coronatae", "Cnidaria-Trachymedusae", "Cnidaria-Semaeostomeae")
#  cten <- c("Ctenophora-Cydippida", "Ctenophora-Unassigned")
  oba <- c("Obazoa", "Obazoa-Breviatea", "Obazoa-Opisthokonta", "Obazoa-Fungi", "Obazoa-Choanoflagellata")
#  tunicate <- c("Tunicata-Copelata", "Tunicata-Salpida")
  unass <- c("Unassigned-Unassigned", "uncultured-uncultured", "Vertebrata-Unassigned", "Vertebrata-Teleostei")
  gon <- c("Gonostomatidae-Cyclothone", "Gonostomatidae-Sigmops")
  mel <- c("Melamphaidae-Poromitra", "Melamphaidae-Scopeloberyx","Melamphaidae-Scopelogadus", "Melamphaidae-Melamphaes")
  mollusk <- c("Mollusca-Heterobranchia")
  myctophid <- c("Myctophidae-Benthosema", "Myctophidae-Bolinichthys", "Myctophidae-Diaphus", "Myctophidae-Hygophum", "Myctophidae-Lampadena", "Myctophidae-Lampanyctus", "Myctophidae-Myctophum", "Myctophidae-Nannobrachium", "Myctophidae-Notoscopelus")
  stomid <- c("Stomiidae-Astronesthes", "Stomiidae-Chauliodus", "Stomiidae-Leptostomias", "Stomiidae-Photostomias", "Stomiidae-Stomias")
  cetacean <- c("Balaenopteridae-Balaenoptera", "Delphinidae-Grampus")
#  ang <- c("Derichthyidae-Nessorhamphus", "Nemichthyidae-Nemichthys",
#         "Eurypharyngidae-Eurypharynx", "Serrivomeridae-Serrivomer")  
  tuna <- c("Scombridae-Katsuwonus", "Scombridae-Thunnus")
  hatchet <- c("Sternoptychidae-Polyipnus", "Sternoptychidae-Sternoptyx")
  df %>%
  # rename inverts & protists
    mutate(TAX_SHORT.A = case_when(
      #TAX_SHORT.A %in% annelid ~ "Annelida",
      #TAX_SHORT.A %in% copepod ~ "Arthropoda-Copepoda",
      TAX_SHORT.A %in% arthro ~ "Arthropoda-Other",
    #  TAX_SHORT.A %in% cnidaria ~ "Cnidaria-Other",
      #TAX_SHORT.A %in% cten ~ "Ctenophora",
      TAX_SHORT.A == "Gastrotricha-Chaetonotida" ~ "Gastrotricha",
      TAX_SHORT.A %in% oba ~ "Obazoa",
      #TAX_SHORT.A == "TSAR-Other" ~ "Telonemia",
      TAX_SHORT.A == "Haptista-Centroplasthelida" ~ "Haptista-Other",
      TAX_SHORT.A == "Cryptista-Kathablepharida" ~ "Cryptista-Other",
      #TAX_SHORT.A %in% tunicate ~ "Tunicata",
      TRUE ~ TAX_SHORT.A)) %>%
    mutate(TAX_SHORT.B = case_when(
      TAX_SHORT.B %in% annelid ~ "Annelida",
      #TAX_SHORT.B %in% copepod ~ "Arthropoda-Copepoda",
      TAX_SHORT.B %in% arthro ~ "Arthropoda-Other",
    #  TAX_SHORT.B %in% cnidaria ~ "Cnidaria-Other",
      #TAX_SHORT.B %in% cten ~ "Ctenophora",
      TAX_SHORT.B == "Gastrotricha-Chaetonotida" ~ "Gastrotricha",
      #TAX_SHORT.B %in% tunicate ~ "Tunicata",
      TRUE ~ TAX_SHORT.B)) %>%
  # rename verts
    mutate(TAX_SHORT.B = case_when(
      TAX_SHORT.B == "Alepisauridae-Alepisaurus" ~ "Alepisauridae",
      TAX_SHORT.B == "Alepocephalidae-Bajacalifornia" ~ "Alepocephalidae",
      TAX_SHORT.B == "Caristiidae-Caristius" ~ "Caristiidae",
      TAX_SHORT.B == "Coryphaenidae-Coryphaena" ~ "Coryphaenidae",
      TAX_SHORT.B == "Derichthyidae-Nessorhamphus" ~ "Derichthyidae",
      TAX_SHORT.B %in% gon ~ "Gonostomatidae",
      TAX_SHORT.B %in% mel ~ "Melamphaidae",
      TAX_SHORT.B %in% myctophid ~ "Myctophidae",
      TAX_SHORT.B %in% stomid ~ "Stomiidae",
      TAX_SHORT.B == "Gempylidae-Nealotus" ~ "Gempylidae",
      TAX_SHORT.B == "Microstomatidae-Nansenia" ~ "Microstomatidae",
      TAX_SHORT.B == "Molidae-Mola" ~ "Molidae",  
      TAX_SHORT.B == "Nemichthyidae-Nemichthys" ~ "Nemichthyidae",
      TAX_SHORT.B %in% tuna ~ "Scombridae",
      TAX_SHORT.B %in% hatchet ~ "Sternoptychidae",
      TAX_SHORT.B == "Zoarcidae-Melanostigma" ~ "Zoarcidae",
      TAX_SHORT.B == "Eurypharyngidae-Eurypharynx" ~ "Eurypharyngidae",
      TAX_SHORT.B == "Serrivomeridae-Serrivomer" ~ "Serrivomeridae",
      TAX_SHORT.B == "Balaenopteridae-Balaenoptera" ~ "Balaenopteridae",
      TAX_SHORT.B == "Delphinidae-Grampus" ~ "Delphinidae",
      TAX_SHORT.B == "Stromateidae-Peprilus" ~ "Stromateidae",
      TRUE ~ TAX_SHORT.B))
}

update_domain <- function(df) {
  df %>% 
  mutate(domain = case_when(
    domain == "prot" ~ "Protist",
    domain == "met" ~ "Invertebrate",
    domain == "fish" ~ "Vertebrate")) %>%
  mutate(domain2 = case_when(
    domain2 == "prot" ~ "Protist",
    domain2 == "met" ~ "Invertebrate",
    domain2 == "fish" ~ "Vertebrate"))
}

plot_chord_df <- function(df){data.frame(from = paste(df[[2]], df[[1]], sep = "|"),
                 to = paste(df[[4]], df[[3]], sep = "|"),
                 group1 = df[[2]], group2 = df[[4]],
                 value = df[[6]], stringsAsFactors = FALSE)
}

circlize_plot <- function(){
  
  circos.par(start.degree = 75)
  gap = rep(1, length(order))
  gap[which(!duplicated(combined2$domain, fromLast = TRUE))] = 10
  circos.par(gap.degree = gap)
  
  chordDiagram(chord_df,
               directional = 1, direction.type = c("diffHeight", "arrows"),
               link.arr.type = "big.arrow", diffHeight = -mm_h(1.5),
               annotationTrack = NULL,
               grid.col = grid.col,
               transparency = 0.66, order = order,
              #transparency = 0.25, order = order,
               preAllocateTracks = list(list(track.height = 0.1,
                                      track.margin = c(0.01, 0)),
                                      list(track.height = 0.075)
                                      )
             )

  for(taxa in unique(combined2$taxa)) {
    l = combined2$taxa == taxa
    sn = paste(combined2$taxa[l], combined2$domain[l], sep = "|")
    highlight.sector(sn, track.index = 2, col = color_taxa[taxa], 
        text = NULL, niceFacing = TRUE)
    }
  
  for(domain in unique(combined2$domain)) {
    l = combined2$domain == domain
    sn = paste(combined2$taxa[l], combined2$domain[l], sep = "|")
    highlight.sector(sn, track.index = 1, col = color_domain[domain], 
        text = NULL, facing = "clockwise", niceFacing = TRUE)
    }
  
  circos.clear()
  
  lgd_taxa = Legend(
    labels = names(color_taxa),
    title_position = "topleft",
    labels_gp = gpar(col = "black", fontsize = 5),
    legend_gp = gpar(fill = color_taxa, title = "Taxa"),
    legend_width = unit(2, "cm"),
    legend_height = unit(5, "cm"))
  
  lgd_domain = Legend(
    labels = names(color_domain),
    title_position = "topleft", 
    labels_gp = gpar(col = "black", fontsize = 5),
    legend_gp = gpar(fill = color_domain, nrow = 1, title = "Domain"),
    legend_width = unit(2, "cm"),
    legend_height = unit(6, "mm"))
  
  lgd_list = packLegend(lgd_domain, lgd_taxa)

}

```

```{r setup-chord-df, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_epi_core) # 0.04986209
sum(getRefit(se_epi_core))/2 #12279

se_epi_core$select$stars$summary

## Extract weighted matrix 
se_beta_epi_core <- as.matrix(symBeta(getOptBeta(se_epi_core)))
df_beta_epi_core <- as.data.frame(se_beta_epi_core)

## Extract adjacency matrix 
adj_mat_epi_core <- getRefit(se_epi_core) 
table(as.numeric(adj_mat_epi_core))
df_adj_epi_core <- as.data.frame(as.matrix(adj_mat_epi_core))

## Assign names from original dataframes 
colnames(df_beta_epi_core) <- colnames(se_epi_core$est$data) 
colnames(df_adj_epi_core) <- colnames(se_epi_core$est$data)
row.names(df_adj_epi_core) <- colnames(se_epi_core$est$data) 
row.names(df_beta_epi_core) <- colnames(se_epi_core$est$data)

prot_tax_se_epi <- prot_asv_se_epi %>% select(OTUid, TAX_full) %>%
  separate(OTUid,  c("domain", "OTU"), sep = "_", remove = FALSE) %>%
  left_join(select(melt_prot_tax, OTU, TAX_SHORT = TAX_SHORT)) %>% 
  select(OTUid, TAX_full, TAX_SHORT) %>%
  distinct() %>% data.frame

met_tax_se_epi <- select(met_asv_se_epi, OTUid, TAX_full) %>%
  separate(OTUid,  c("domain", "OTU"), sep = "_", remove = FALSE) %>%
  left_join(select(melt_met_tax, OTU, TAX_SHORT = TAX_SHORT)) %>% 
  select(OTUid, TAX_full, TAX_SHORT) %>%
  distinct() %>% data.frame

fish_tax_se_epi <- select(fish_asv_se_epi, OTUid, TAX_full) %>%
  separate(OTUid,  c("domain", "OTU"), sep = "_", remove = FALSE) %>%
  left_join(select(melt_fish_tax, OTU, TAX_SHORT = TAX_SHORT)) %>% 
  select(OTUid, TAX_full, TAX_SHORT) %>%
  distinct() %>% data.frame

alleuk_tax_key_se <- bind_rows(prot_tax_se_epi, met_tax_se_epi, fish_tax_se_epi)
dim(alleuk_tax_key_se)
head(alleuk_tax_key_se)

df_adj_long_epi_core <- reformat_se_cross(df_adj_epi_core)
df_beta_long_epi_core <- reformat_se_cross(df_beta_epi_core)

# Get list of these parameters Adjacency matrix - binary, where 1 = significant interaction Boot strapped pvalue, showing weight of each correlation

unique(df_adj_long_epi_core$COMBO)

# these are the interactions that I want
interaction <- c("PROT-VERT", "PROT-INVERT", "INVERT-VERT")
#interaction <- c("INVERT-INVERT", "VERT-VERT")

adj_sig_epi_core <- df_adj_long_epi_core %>% filter(value == 1) %>% 
#  filter(COMBO_TYPE == "cross") %>% 
  filter(COMBO %in% interaction) %>%
  select(everything(), Adjacency = value) %>% 
  left_join(select(df_beta_long_epi_core, SIG_ID, Weight = value)) %>% 
  data.frame

dim(adj_sig_epi_core) # 1350 significant interactions total
head(adj_sig_epi_core)

#Check output 
getStability(se_meso_up_core) # 0.04992624
sum(getRefit(se_meso_up_core))/2 #21359

se_meso_up_core$select$stars$summary

## Extract weighted matrix 
se_beta_meso_up_core <- as.matrix(symBeta(getOptBeta(se_meso_up_core)))
df_beta_meso_up_core <- as.data.frame(se_beta_meso_up_core)

## Extract adjacency matrix 
adj_mat_meso_up_core <- getRefit(se_meso_up_core) 
table(as.numeric(adj_mat_meso_up_core))
df_adj_meso_up_core <- as.data.frame(as.matrix(adj_mat_meso_up_core))

## Assign names from original dataframes 
colnames(df_beta_meso_up_core) <- colnames(se_meso_up_core$est$data) 
colnames(df_adj_meso_up_core) <- colnames(se_meso_up_core$est$data)
row.names(df_adj_meso_up_core) <- colnames(se_meso_up_core$est$data) 
row.names(df_beta_meso_up_core) <- colnames(se_meso_up_core$est$data)

prot_tax_se_meso_up <- prot_asv_se_meso_up %>% select(OTUid, TAX_full) %>%
  separate(OTUid,  c("domain", "OTU"), sep = "_", remove = FALSE) %>%
  left_join(select(melt_prot_tax, OTU, TAX_SHORT = TAX_SHORT)) %>% 
  select(OTUid, TAX_full, TAX_SHORT) %>%
  distinct() %>% data.frame

met_tax_se_meso_up <- select(met_asv_se_meso_up, OTUid, TAX_full) %>%
  separate(OTUid,  c("domain", "OTU"), sep = "_", remove = FALSE) %>%
  left_join(select(melt_met_tax, OTU, TAX_SHORT = TAX_SHORT)) %>% 
  select(OTUid, TAX_full, TAX_SHORT) %>%
  distinct() %>% data.frame

fish_tax_se_meso_up <- select(fish_asv_se_meso_up, OTUid, TAX_full) %>%
  separate(OTUid,  c("domain", "OTU"), sep = "_", remove = FALSE) %>%
  left_join(select(melt_fish_tax, OTU, TAX_SHORT = TAX_SHORT)) %>% 
  select(OTUid, TAX_full, TAX_SHORT) %>%
  distinct() %>% data.frame

alleuk_tax_key_se <- bind_rows(prot_tax_se_meso_up, met_tax_se_meso_up, fish_tax_se_meso_up)
dim(alleuk_tax_key_se)
head(alleuk_tax_key_se)

df_adj_long_meso_up_core <- reformat_se_cross(df_adj_meso_up_core)
df_beta_long_meso_up_core <- reformat_se_cross(df_beta_meso_up_core)

# Get list of these parameters Adjacency matrix - binary, where 1 = significant interaction Boot strapped pvalue, showing weight of each correlation

unique(df_adj_long_meso_up_core$COMBO)

# these are the interactions that I want
interaction <- c("PROT-VERT", "PROT-INVERT", "INVERT-VERT")
#interaction <- c("VERT-VERT", "INVERT-INVERT")

adj_sig_meso_up_core <- df_adj_long_meso_up_core %>% filter(value == 1) %>% 
#  filter(COMBO_TYPE == "cross") %>% 
  filter(COMBO %in% interaction) %>%
  select(everything(), Adjacency = value) %>% 
  left_join(select(df_beta_long_meso_up_core, SIG_ID, Weight = value)) %>% 
  data.frame

dim(adj_sig_meso_up_core) # 2715 significant interactions total
head(adj_sig_meso_up_core)

#Check output 
getStability(se_meso_low_core) # 0.04999279
sum(getRefit(se_meso_low_core))/2 #21807

se_meso_low_core$select$stars$summary

## Extract weighted matrix 
se_beta_meso_low_core <- as.matrix(symBeta(getOptBeta(se_meso_low_core)))
df_beta_meso_low_core <- as.data.frame(se_beta_meso_low_core)

## Extract adjacency matrix 
adj_mat_meso_low_core <- getRefit(se_meso_low_core) 
table(as.numeric(adj_mat_meso_low_core))
df_adj_meso_low_core <- as.data.frame(as.matrix(adj_mat_meso_low_core))

## Assign names from original dataframes 
colnames(df_beta_meso_low_core) <- colnames(se_meso_low_core$est$data) 
colnames(df_adj_meso_low_core) <- colnames(se_meso_low_core$est$data)
row.names(df_adj_meso_low_core) <- colnames(se_meso_low_core$est$data) 
row.names(df_beta_meso_low_core) <- colnames(se_meso_low_core$est$data)

prot_tax_se_meso_low <- prot_asv_se_meso_low %>% select(OTUid, TAX_full) %>%
  separate(OTUid,  c("domain", "OTU"), sep = "_", remove = FALSE) %>%
  left_join(select(melt_prot_tax, OTU, TAX_SHORT = TAX_SHORT)) %>% 
  select(OTUid, TAX_full, TAX_SHORT) %>%
  distinct() %>% data.frame

met_tax_se_meso_low <- select(met_asv_se_meso_low, OTUid, TAX_full) %>%
  separate(OTUid,  c("domain", "OTU"), sep = "_", remove = FALSE) %>%
  left_join(select(melt_met_tax, OTU, TAX_SHORT = TAX_SHORT)) %>% 
  select(OTUid, TAX_full, TAX_SHORT) %>%
  distinct() %>% data.frame

fish_tax_se_meso_low <- select(fish_asv_se_meso_low, OTUid, TAX_full) %>%
  separate(OTUid,  c("domain", "OTU"), sep = "_", remove = FALSE) %>%
  left_join(select(melt_fish_tax, OTU, TAX_SHORT = TAX_SHORT)) %>% 
  select(OTUid, TAX_full, TAX_SHORT) %>%
  distinct() %>% data.frame

alleuk_tax_key_se <- bind_rows(prot_tax_se_meso_low, met_tax_se_meso_low, fish_tax_se_meso_low)
dim(alleuk_tax_key_se)
head(alleuk_tax_key_se)

df_adj_long_meso_low_core <- reformat_se_cross(df_adj_meso_low_core)
df_beta_long_meso_low_core <- reformat_se_cross(df_beta_meso_low_core)

# Get list of these parameters Adjacency matrix - binary, where 1 = significant interaction Boot strapped pvalue, showing weight of each correlation

unique(df_adj_long_meso_low_core$COMBO)

# these are the interactions that I want
interaction <- c("PROT-VERT", "PROT-INVERT", "INVERT-VERT")
#interaction <- c("VERT-VERT", "INVERT-INVERT")
adj_sig_meso_low_core <- df_adj_long_meso_low_core %>% filter(value == 1) %>% 
 # filter(COMBO_TYPE == "cross") %>% 
  filter(COMBO %in% interaction) %>%
  select(everything(), Adjacency = value) %>% 
  left_join(select(df_beta_long_meso_low_core, SIG_ID, Weight = value)) %>% 
  data.frame

dim(adj_sig_meso_low_core) # 2481 significant interactions total
head(adj_sig_meso_low_core)

```

## 5.2. Chord Diagrams - Positive

```{r pos-chord, eval = TRUE, message = FALSE, warning = FALSE}

# check threshold
threshold = quantile(E(grph_pos_epi_core)$weight, probs = .9)
threshold

adj_sig_epi_core_pos <- adj_sig_epi_core %>% filter(Weight > 0) %>%
  filter(Weight >= threshold)

dim(adj_sig_epi_core_pos) # 47 x 11
head(adj_sig_epi_core_pos)

adj_sig_epi_core %>% filter(Weight > 0) %>% count() # this gives the total # of interactions before threshold
  
threshold = quantile(E(grph_pos_meso_up_core)$weight, probs = .9)
threshold

adj_sig_meso_up_core_pos <- adj_sig_meso_up_core %>% filter(Weight > 0) %>%
  filter(Weight >= threshold)

dim(adj_sig_meso_up_core_pos)
head(adj_sig_meso_up_core_pos)

adj_sig_meso_up_core %>% filter(Weight > 0) %>% count() # this gives the total # of interactions before threshold

threshold = quantile(E(grph_pos_meso_low_core)$weight, probs = .9)
threshold

adj_sig_meso_low_core_pos <- adj_sig_meso_low_core %>% filter(Weight > 0) %>%
  filter(Weight >= threshold)

dim(adj_sig_meso_low_core_pos) # 132 x 11
head(adj_sig_meso_low_core_pos)

adj_sig_meso_low_core %>% filter(Weight > 0) %>% count() # this gives the total # of interactions before threshold

taxa_sum_inter_epi_pos <- adj_sig_epi_core_pos %>% 
  separate(SIDEA, c("domain", "ASV_A"), sep = "_") %>% separate(SIDEB, c("domain2", "ASV_B"), sep = "_") %>% 
  select(-COMBO, -COMBO_TYPE, -SIG_ID, -Adjacency) %>%
  unite(INTERACTION, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  add_column(COUNT = 1) %>% # creates a new column to add 1 indicating a significant interaction
  data.frame

head(taxa_sum_inter_epi_pos)
tail(taxa_sum_inter_epi_pos)

length(unique(taxa_sum_inter_epi_pos$INTERACTION)) #38 unique interactions

unique(taxa_sum_inter_epi_pos$TAX_SHORT.A) # 16
unique(taxa_sum_inter_epi_pos$TAX_SHORT.B) # 19

taxa_sum_inter_epi_pos

sum_sig_inter_epi_pos <- rename_taxa_forplots(taxa_sum_inter_epi_pos) %>%
  unite(INT_SHORT, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  select(domain, TAX_SHORT.A, domain2, TAX_SHORT.B, INT_SHORT, COUNT) %>%
  group_by(INT_SHORT) %>%
  mutate(sum_inter = sum(COUNT)) %>% 
  select(-COUNT) %>%
  unique() %>%
  update_domain()


head(sum_sig_inter_epi_pos)
tail(sum_sig_inter_epi_pos)

taxa_sum_inter_meso_up_pos <- adj_sig_meso_up_core_pos %>% 
  separate(SIDEA, c("domain", "ASV_A"), sep = "_") %>% separate(SIDEB, c("domain2", "ASV_B"), sep = "_") %>% 
  select(-COMBO, -COMBO_TYPE, -SIG_ID, -Adjacency) %>%
  unite(INTERACTION, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  add_column(COUNT = 1) %>% # creates a new column to add 1 indicating a significant interaction
  data.frame

head(taxa_sum_inter_meso_up_pos)
tail(taxa_sum_inter_meso_up_pos)

length(unique(taxa_sum_inter_meso_up_pos$INTERACTION)) # 76 unique interactions

unique(taxa_sum_inter_meso_up_pos$TAX_SHORT.A) # 18
unique(taxa_sum_inter_meso_up_pos$TAX_SHORT.B) # 24

taxa_sum_inter_meso_up_pos

sum_sig_inter_meso_up_pos <- rename_taxa_forplots(taxa_sum_inter_meso_up_pos) %>%
  unite(INT_SHORT, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  select(domain, TAX_SHORT.A, domain2, TAX_SHORT.B, INT_SHORT, COUNT) %>%
  group_by(INT_SHORT) %>%
  mutate(sum_inter = sum(COUNT)) %>% 
  select(-COUNT) %>%
  unique() %>%
  update_domain()

head(sum_sig_inter_meso_up_pos)
tail(sum_sig_inter_meso_up_pos)

taxa_sum_inter_meso_low_pos <- adj_sig_meso_low_core_pos %>% 
  separate(SIDEA, c("domain", "ASV_A"), sep = "_") %>% separate(SIDEB, c("domain2", "ASV_B"), sep = "_") %>% 
  select(-COMBO, -COMBO_TYPE, -SIG_ID, -Adjacency) %>%
  unite(INTERACTION, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  add_column(COUNT = 1) %>% # creates a new column to add 1 indicating a significant interaction
  data.frame

head(taxa_sum_inter_meso_low_pos)
tail(taxa_sum_inter_meso_low_pos)

length(unique(taxa_sum_inter_meso_low_pos$INTERACTION)) #88 unique interactions

unique(taxa_sum_inter_meso_low_pos$TAX_SHORT.A) # 18
unique(taxa_sum_inter_meso_low_pos$TAX_SHORT.B) # 25

taxa_sum_inter_meso_low_pos

sum_sig_inter_meso_low_pos <- rename_taxa_forplots(taxa_sum_inter_meso_low_pos) %>%
  unite(INT_SHORT, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  select(domain, TAX_SHORT.A, domain2, TAX_SHORT.B, INT_SHORT, COUNT) %>%
  group_by(INT_SHORT) %>%
  mutate(sum_inter = sum(COUNT)) %>% 
  select(-COUNT) %>%
  unique() %>%
  update_domain()

head(sum_sig_inter_meso_low_pos)
tail(sum_sig_inter_meso_low_pos)

```

```{r pos-epi-chorddiag, eval = TRUE, message = FALSE, warning = FALSE}

# this sets the colors for the chord diagram              
combined <- function(df){unique(data.frame(taxa = c(df[[2]], df[[4]]),
    domain = c(df[[1]], df[[3]]), sum_inter = df[[6]],
    stringsAsFactors = FALSE)) %>% group_by(taxa, domain) %>%
    summarise(sum_counts = sum(sum_inter))
}

combined2 <- combined(sum_sig_inter_epi_pos)
combined2

combined2 <- combined2[order(combined2$domain, combined2$taxa), ]

order = paste(combined2$taxa, combined2$domain, sep = "|")

all_tax <- unique(c(combined2$taxa))
all_tax

swatch_epi_pos <- taxa_colors[c(
  "Calanoida", "Cyclopoida", "ArthropodaUnassigned", 
  "Siphonophorae", "Trachymedusae",
  "Cydippida", "CtenophoraUnassigned", 
  "Copelata", "Salpida", 
  "UnassignedMetazoa", 
  "Apicomplexa", "Ciliates", "Dinoflagellates", "AlveolataOther",
  "Syndiniales", "Chlorophyta", "Cryptophyta", "Obazoa", "Radiolaria", "Diatoms", "MAST",
  "StramenopilesOther", "Telonemia", "Caristiidae", "Coryphaenidae", "Delphinidae", "Gonostomatidae", "Melamphaidae", 
  "Myctophidae", "UnassignedActinopterygii", "UnassignedPerciformes")]

color_taxa <- structure(swatch_epi_pos, names = all_tax)
color_taxa

all_domain = unique(combined2$domain)
color_domain  <- c(structure(c("#FE869B", "#78C18A", "#1986be"), names = all_domain))


#grid.col = structure(color_domain[combined2$domain], names = order)
grid.col = structure(color_taxa[combined2$taxa], names = order)


# plot the chord diagram

chord_df <- plot_chord_df(sum_sig_inter_epi_pos)
circlize_plot()

#library(gridBase)

#dev.new()
pdf(file="./network-plots/plot_chord_pos_epi.pdf", width = 2.5, height = 2.5)
circlize_plot()
dev.off()


```

```{r pos-meso-up-chorddiag, eval = TRUE, message = FALSE, warning = FALSE}

# this sets the colors for the chord diagram              
combined2 <- combined(sum_sig_inter_meso_up_pos)
combined2

combined2 <- combined2[order(combined2$domain, combined2$taxa), ]

order = paste(combined2$taxa, combined2$domain, sep = "|")

all_tax <- unique(c(combined2$taxa))
all_tax

swatch_meso_up_pos <- taxa_colors[c(
  "Annelida", "Calanoida", "Cyclopoida", "ArthropodaOther", 
  "Anthoathecata", "Coronatae", "Leptothecata", "Narcomedusae", "Semaeostomeae", 
  "Siphonophorae", "Trachymedusae", "CnidariaUnassigned", 
  "Cydippida", "CtenophoraUnassigned", "Copelata", "Salpida", "UnassignedMetazoa",
  "Apicomplexa", "Ciliates", "Dinoflagellates", "AlveolataOther", "Syndiniales", 
  "Amoebozoa", "Excavata", "Obazoa", 
  "RhizariaOther", "Radiolaria", "Rhodophyta", 
  "Diatoms", "MAST", "StramenopilesOther",
  "Telonemia", "TSARUnassigned", "Gonostomatidae", "Melamphaidae", "Myctophidae", "Nemichthyidae", "Sternoptychidae",
  "UnassignedActinopterygii"
)]

# color check
barplot(rep(1, length(swatch_meso_up_pos)), col = swatch_meso_up_pos, border = NA, space = 0, axes = FALSE)
title("Swatch for Epi Pos")

color_taxa <- structure(swatch_meso_up_pos, names = all_tax)
color_taxa

all_domain = unique(combined2$domain)
color_domain  <- c(structure(c("#FE869B", "#78C18A", "#1986be"), names = all_domain))

grid.col = structure(color_taxa[combined2$taxa], names = order)

# plot the chord diagram
chord_df <- plot_chord_df(sum_sig_inter_meso_up_pos)
circlize_plot()

pdf(file="./network-plots/plot_chord_pos_meso_up.pdf", width = 2.5, height = 2.5)
circlize_plot()
dev.off()

```

```{r pos-meso-low-chorddiag, eval = TRUE, message = FALSE, warning = FALSE}

# this sets the colors for the chord diagram              
combined2 <- combined(sum_sig_inter_meso_low_pos)
combined2

combined2 <- combined2[order(combined2$domain, combined2$taxa), ]

order = paste(combined2$taxa, combined2$domain, sep = "|")

all_tax <- unique(c(combined2$taxa))
all_tax

swatch_meso_low_pos <- taxa_colors[c(
  "Annelida", "Calanoida", "Cyclopoida", 
  "Anthoathecata", "Coronatae", "Leptothecata", "Narcomedusae", "Semaeostomeae", "Siphonophorae", "Trachylinae", "Trachymedusae","CnidariaUnassigned",
  "Cydippida", "CtenophoraUnassigned", 
  "Copelata", "Salpida", "UnassignedMetazoa",
  "Apicomplexa", "Ciliates", "Dinoflagellates", "Syndiniales", "AlveolataOther", "Amoebozoa", "Excavata", "Haptophyta", "Obazoa", "RhizariaOther", "Radiolaria", "Rhodophyta", 
  "Diatoms", "MAST", "StramenopilesOther", "TSARUnassigned", "Alepisauridae", "Coryphaenidae", "Derichthyidae", 
  "Gonostomatidae", "Melamphaidae", "Serrivomeridae", "UnassignedActinopterygii"
)]

color_taxa <- structure(swatch_meso_low_pos, names = all_tax)
color_taxa

all_domain = unique(combined2$domain)
color_domain  <- c(structure(c("#FE869B", "#78C18A", "#1986be"), names = all_domain))


#grid.col = structure(color_domain[combined2$domain], names = order)
grid.col = structure(color_taxa[combined2$taxa], names = order)

# plot the chord diagram
chord_df <- plot_chord_df(sum_sig_inter_meso_low_pos)
circlize_plot()

pdf(file="./network-plots/plot_chord_pos_meso_low.pdf", width = 2.5, height = 2.5)
circlize_plot()
dev.off()

```

## 5.2. Chord Diagrams - Negative

```{r neg-chord, eval = TRUE, message = FALSE, warning = FALSE}

# check threshold

threshold = quantile(E(grph_neg_epi_core)$weight, probs = .9)
threshold

adj_sig_epi_core_neg <- adj_sig_epi_core %>% filter(Weight < 0) %>%
  filter(abs(Weight) >= threshold)

dim(adj_sig_epi_core_neg) # 78 x 11
head(adj_sig_epi_core_neg)
tail(adj_sig_epi_core_neg)

adj_sig_epi_core %>% filter(Weight < 0) %>% count() # this gives the total # of interactions before threshold # 582

threshold = quantile(E(grph_neg_meso_up_core)$weight, probs = .9)
threshold

adj_sig_meso_up_core_neg <- adj_sig_meso_up_core %>% filter(Weight < 0) %>%
  filter(abs(Weight) >= threshold)

dim(adj_sig_meso_up_core_neg) # 119 x 11
head(adj_sig_meso_up_core_neg)
tail(adj_sig_meso_up_core_neg)

adj_sig_meso_up_core %>% filter(Weight < 0) %>% count() # this gives the total # of interactions before threshold # 1193


threshold = quantile(E(grph_neg_meso_low_core)$weight, probs = .9)
threshold

adj_sig_meso_low_core_neg <- adj_sig_meso_low_core %>% filter(Weight < 0) %>%
  filter(abs(Weight) >= threshold)

dim(adj_sig_meso_low_core_neg) # 108 x 11
head(adj_sig_meso_low_core_neg)

adj_sig_meso_low_core %>% filter(Weight < 0) %>% count() # this gives the total # of interactions before threshold # 1088

taxa_sum_inter_epi_neg <- adj_sig_epi_core_neg %>% 
  separate(SIDEA, c("domain", "ASV_A"), sep = "_") %>% separate(SIDEB, c("domain2", "ASV_B"), sep = "_") %>% 
  select(-COMBO, -COMBO_TYPE, -SIG_ID, -Adjacency) %>%
  unite(INTERACTION, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  add_column(COUNT = 1) %>% # creates a new column to add 1 indicating a significant interaction
  data.frame

head(taxa_sum_inter_epi_neg)
tail(taxa_sum_inter_epi_neg)

length(unique(taxa_sum_inter_epi_neg$INTERACTION)) # 56 unique interactions

unique(taxa_sum_inter_epi_neg$TAX_SHORT.A) # 18
unique(taxa_sum_inter_epi_neg$TAX_SHORT.B) # 19

taxa_sum_inter_epi_neg

sum_sig_inter_epi_neg <- rename_taxa_forplots(taxa_sum_inter_epi_neg) %>%
  unite(INT_SHORT, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  select(domain, TAX_SHORT.A, domain2, TAX_SHORT.B, INT_SHORT, COUNT) %>%
  group_by(INT_SHORT) %>%
  mutate(sum_inter = sum(COUNT)) %>% 
  select(-COUNT) %>%
  unique() %>%
  update_domain()

head(sum_sig_inter_epi_neg)
tail(sum_sig_inter_epi_neg)

taxa_sum_inter_meso_up_neg <- adj_sig_meso_up_core_neg %>% 
  separate(SIDEA, c("domain", "ASV_A"), sep = "_") %>% separate(SIDEB, c("domain2", "ASV_B"), sep = "_") %>% 
  select(-COMBO, -COMBO_TYPE, -SIG_ID, -Adjacency) %>%
  unite(INTERACTION, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  add_column(COUNT = 1) %>% # creates a new column to add 1 indicating a significant interaction
  data.frame

head(taxa_sum_inter_meso_up_neg)
tail(taxa_sum_inter_meso_up_neg)

length(unique(taxa_sum_inter_meso_up_neg$INTERACTION)) # 73 unique interactions

unique(taxa_sum_inter_meso_up_neg$TAX_SHORT.A) # 16
unique(taxa_sum_inter_meso_up_neg$TAX_SHORT.B) # 23

taxa_sum_inter_meso_up_neg

sum_sig_inter_meso_up_neg <- rename_taxa_forplots(taxa_sum_inter_meso_up_neg) %>%
  unite(INT_SHORT, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  select(domain, TAX_SHORT.A, domain2, TAX_SHORT.B, INT_SHORT, COUNT) %>%
  group_by(INT_SHORT) %>%
  mutate(sum_inter = sum(COUNT)) %>% 
  select(-COUNT) %>%
  unique() %>%
  update_domain()

head(sum_sig_inter_meso_up_neg)
tail(sum_sig_inter_meso_up_neg)

taxa_sum_inter_meso_low_neg <- adj_sig_meso_low_core_neg %>% 
  separate(SIDEA, c("domain", "ASV_A"), sep = "_") %>% separate(SIDEB, c("domain2", "ASV_B"), sep = "_") %>% 
  select(-COMBO, -COMBO_TYPE, -SIG_ID, -Adjacency) %>%
  unite(INTERACTION, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  add_column(COUNT = 1) %>% # creates a new column to add 1 indicating a significant interaction
  data.frame

head(taxa_sum_inter_meso_low_neg)
tail(taxa_sum_inter_meso_low_neg)

length(unique(taxa_sum_inter_meso_low_neg$INTERACTION)) #77 unique interactions

unique(taxa_sum_inter_meso_low_neg$TAX_SHORT.A) # 21
unique(taxa_sum_inter_meso_low_neg$TAX_SHORT.B) # 26

taxa_sum_inter_meso_low_neg

sum_sig_inter_meso_low_neg <- rename_taxa_forplots(taxa_sum_inter_meso_low_neg) %>%
  unite(INT_SHORT, TAX_SHORT.A, TAX_SHORT.B, sep = "_", remove = FALSE) %>%
  select(domain, TAX_SHORT.A, domain2, TAX_SHORT.B, INT_SHORT, COUNT) %>%
  group_by(INT_SHORT) %>%
  mutate(sum_inter = sum(COUNT)) %>% 
  select(-COUNT) %>%
  unique() %>%
  update_domain()

head(sum_sig_inter_meso_low_neg)
tail(sum_sig_inter_meso_low_neg)

```

```{r neg-epi-chorddiag, eval = TRUE, message = FALSE, warning = FALSE}

# this sets the colors for the chord diagram              
combined <- function(df){unique(data.frame(taxa = c(df[[2]], df[[4]]),
    domain = c(df[[1]], df[[3]]), sum_inter = df[[6]],
    stringsAsFactors = FALSE)) %>% group_by(taxa, domain) %>%
    summarise(sum_counts = sum(sum_inter))
}

combined2 <- combined(sum_sig_inter_epi_neg)
combined2

combined2 <- combined2[order(combined2$domain, combined2$taxa), ]

# Get unique taxa in the order you need for plotting
all_tax <- unique(combined2$taxa)

# Subset taxa_colors only to taxa that appear in your data
swatch_epi_neg <- taxa_colors[all_tax]
swatch_epi_neg

# Name the color vector explicitly and safely
color_taxa <- setNames(swatch_epi_neg, all_tax)

# Construct order for chord diagram node names
order <- paste(combined2$taxa, combined2$domain, sep = "|")

# Build final grid.col  coloring each node by its taxon color
grid.col <- setNames(color_taxa[combined2$taxa], order)
grid.col

all_domain = unique(combined2$domain)
color_domain  <- c(structure(c("#FE869B", "#78C18A", "#1986be"), names = all_domain))

# plot the chord diagram

chord_df <- plot_chord_df(sum_sig_inter_epi_neg)
circlize_plot()

pdf(file="./network-plots/plot_chord_neg_epi.pdf", width = 2.5, height = 2.5)
circlize_plot()
dev.off()

```

```{r neg-meso-up-chorddiag, eval = TRUE, message = FALSE, warning = FALSE} 

# this sets the colors for the chord diagram              
combined2 <- combined(sum_sig_inter_meso_up_neg)
combined2

combined2 <- combined2[order(combined2$domain, combined2$taxa), ]

# Get unique taxa in the order you need for plotting
all_tax <- unique(combined2$taxa)
all_tax

# Subset taxa_colors only to taxa that appear in your data
swatch_meso_up_neg <- taxa_colors[all_tax]
swatch_meso_up_neg

# Name the color vector explicitly and safely
color_taxa <- setNames(swatch_meso_up_neg, all_tax)

# Construct order for chord diagram node names
order <- paste(combined2$taxa, combined2$domain, sep = "|")

# Build final grid.col  coloring each node by its taxon color
grid.col <- setNames(color_taxa[combined2$taxa], order)
grid.col

all_domain = unique(combined2$domain)
color_domain  <- c(structure(c("#FE869B", "#78C18A", "#1986be"), names = all_domain))

# plot the chord diagram
chord_df <- plot_chord_df(sum_sig_inter_meso_up_neg)
circlize_plot()

pdf(file="./network-plots/plot_chord_neg_meso_up.pdf", width = 2.5, height = 2.5)
circlize_plot()
dev.off()

```

```{r neg-meso-low-chorddiag, eval = TRUE, message = FALSE, warning = FALSE}

# this sets the colors for the chord diagram              
combined2 <- combined(sum_sig_inter_meso_low_neg)
combined2

combined2 <- combined2[order(combined2$domain, combined2$taxa), ]

# Get unique taxa in the order you need for plotting
all_tax <- unique(combined2$taxa)
all_tax

# Subset taxa_colors only to taxa that appear in your data
swatch_meso_low_neg <- taxa_colors[all_tax]
swatch_meso_low_neg

# Name the color vector explicitly and safely
color_taxa <- setNames(swatch_meso_low_neg, all_tax)

# Construct order for chord diagram node names
order <- paste(combined2$taxa, combined2$domain, sep = "|")

# Build final grid.col  coloring each node by its taxon color
grid.col <- setNames(color_taxa[combined2$taxa], order)
grid.col

all_domain = unique(combined2$domain)
color_domain  <- c(structure(c("#FE869B", "#78C18A", "#1986be"), names = all_domain))

# plot the chord diagram
chord_df <- plot_chord_df(sum_sig_inter_meso_low_neg)
circlize_plot()

pdf(file="./network-plots/plot_chord_neg_meso_low.pdf", width = 2.5, height = 2.5)
circlize_plot()
dev.off()


```
