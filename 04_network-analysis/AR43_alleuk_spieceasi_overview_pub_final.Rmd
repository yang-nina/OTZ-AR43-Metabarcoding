---
title: "ar43-spieceasi-networks"
author: "Nina Yang, Postdoctoral Investigator, WHOI"
created date: "2024-01-19"
last updated: "2025-05-15"
output: html_document
editor_options: 
  chunk_output_type: console
---

# 1. Background
This document outlines the steps taken to conduct network analyses using the SpiecEasi package in R. Networks were generated on WHOI's HPC using SPIEC-EASI. The samples was collected via CTD from the AR43 Cruise (Armstrong, March 2020) and multi-marker metabarcoding with 18S V9 and 12S MiFish were conducted. 

## 1.1 Set up Environment

### 1.1.1 Install and load packages
```{r install-pkgs, include=FALSE}

if(!require(BiocManager)){install.packages("BiocManager")}
if(!require(devtools)){install.packages("devtools")}
if(!require(phyloseq)){install.packages("phyloseq")}
if(!require(patchwork)){install.packages("patchwork")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(scales)){install.packages("scales")}
if(!require(SpiecEasi)){install_github("zdk123/SpiecEasi")}
if(!require(ggnetwork)){install.packages("ggnetwork")}
if(!require(intergraph)){install.packages("intergraph")}
if(!require(braingRaph)){install.packages("brainGraph")}

```

```{r load-pkgs, include=FALSE}
# load packages
library(devtools); packageVersion("devtools")
library(phyloseq); packageVersion("phyloseq")
library(tidyverse); packageVersion("tidyverse")
library(patchwork); packageVersion("patchwork")
library(SpiecEasi); packageVersion("SpiecEasi")
library(igraph); packageVersion("igraph")
library(ggnetwork); packageVersion("ggnetwork")
library(intergraph); packageVersion("intergraph")
library(brainGraph); packageVersion("brainGraph")
library(foreach); packageVersion("foreach")
library(doParallel); packageVersion("doParallel")
library(data.table); packageVersion("data.table")

```

### 1.1.2 Setup Environment

```{r theme_ggplot2, echo = FALSE}
theme_custom_ppt <- function() {
  theme_bw(
    base_size = 0.54) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent'),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.5),
      # axes
      axis.text.y = element_blank(), 
      axis.text.x = element_blank(), 
      axis.ticks.x = element_blank(),
      axis.ticks.y = element_blank(),
      # legend
      legend.text = element_text(colour ="black"), 
      legend.position = "right",
      legend.title = element_text(colour = "black", size = 12), 
      legend.background = element_rect(color = NA, fill='transparent'), 
      legend.box.background = element_rect(color = NA, fill='transparent'),
      # faceting
      strip.background.y = element_rect(color = "black", fill = "#ededed", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 12)
      )
}
theme_custom_ppt_blkbg <- function() {
  theme_bw(
    base_size = 14) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent', color = 'transparent'),
      panel.border = element_rect(linewidth = 1, color = "white"),
      # axes
      axis.text.y = element_text(color = "white", size = 14), 
      axis.text.x = element_text(color = "white", size = 14), 
      axis.ticks.x = element_line(color = "white"),
      axis.ticks.y = element_line(color = "white"),
      axis.title.x = element_text(color = "white", size = 16),
      axis.title.y = element_text(color = "white", size = 16),
      # legend
      legend.text = element_text(colour ="white"), 
      legend.position = "right",
      legend.title = element_text(colour = "white", size = 14), 
      legend.background = element_rect(color = NA, fill='transparent'), 
      legend.box.background = element_rect(color = NA, fill='transparent'),
      # faceting
      strip.background.y = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 12)
      )
}
theme_custom_poster <- function() {
  theme_bw(
    base_size = 30) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(), 
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.5),
      # axes
      axis.text.y = element_text(colour = "black"), 
      axis.text.x = element_text(colour = "black"), 
      # legend
      legend.text = element_text(colour ="black"), 
      legend.position = "right",
      legend.title = element_text(colour = "black"), 
      # faceting
      strip.background.y = element_rect(color = "black", fill = "#ededed", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = "white", linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 30)
      )
}
theme_custom_paper <- function() {
  theme_bw(
    base_size = 12) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent'),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
      # axes
      axis.text.y = element_text(colour = "black"), 
      axis.text.x = element_text(colour = "black"), 
      # legend
      legend.text = element_text(colour ="black"), 
      legend.position = "right",
      legend.title = element_text(colour = "black"), 
      legend.background = element_rect(color = NA, fill='transparent'), 
      legend.box.background = element_rect(color = NA, fill='transparent'),
      # faceting
      strip.background.y = element_rect(color = "black", fill = "#ededed", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 10)
      )
}

# Changing the default theme
theme_set(theme_custom_paper())

```

# 2. Network Correlation - Set up

I am evaluating the networks for the epipelagic, the upper mesopelagic, and the lower mesopelagic using prevalence-filtered datasets (core).

## Load SPIEC-EASI outputs

```{r spieceasi-epi-core, eval = TRUE, message = FALSE, warning = FALSE}

load("./hpc-outputs/epi-spieceasi-output-core-20250410.RData", verbose = T)

load("./hpc-outputs/epi-spieceasi-output-core-prot-20250410.RData", verbose = T)

load("./hpc-outputs/epi-spieceasi-output-core-met-fish-20250410.RData", verbose = T)

# load phyloseq objects
load("./hpc-inputs/curated_physeq_forSpiecEasi_epi_core_network_20250410.RData", verbose = T)

```

```{r spieceasi-meso-up-core, eval = TRUE, message = FALSE, warning = FALSE}


load("./hpc-outputs/meso-up-spieceasi-output-core-20250410.RData", verbose = T)

load("./hpc-outputs/meso-up-spieceasi-output-core-prot-20250410.RData", verbose = T)

load("./hpc-outputs/meso-up-spieceasi-output-core-met-fish-20250410.RData", verbose = T)

# load phyloseq objects
load("./hpc-inputs/curated_physeq_forSpiecEasi_meso_up_core_network_20250410.RData", verbose = T)

```

```{r spieceasi-meso-low-core, eval = TRUE, message = FALSE, warning = FALSE}

load("./hpc-outputs/meso-low-spieceasi-output-core-20250410.RData", verbose = T)

load("./hpc-outputs/meso-low-spieceasi-output-core-prot-20250410.RData", verbose = T)

load("./hpc-outputs/meso-low-spieceasi-output-core-met-fish-20250410.RData", verbose = T)

# load phyloseq objects
load("./hpc-inputs/curated_physeq_forSpiecEasi_meso_low_core_network_20250410.RData", verbose = T)

```

```{r robust-random-fxn, eval = TRUE, message = FALSE, warning = FALSE}

# Load the robustness function from the file
# https://github.com/cwatson/brainGraph/issues/25
source("robustness_random.R")
ls() # check to make sure the function is there

# Set up parallel backend
numCores <- parallel::detectCores()
cl <- parallel::makeCluster(numCores)
doParallel::registerDoParallel(cl)

```

```{r asv-tables, eval = TRUE, message = FALSE, warning = FALSE}
# these are the asv files with taxa, rarefied, prevalence filtered

load("./R-outputs/alleuk_asv_melt_tax_tables_network.RData", verbose = T)

```

# 3. Network Correlation - Analysis

## 3.1 Core - All Taxa

### 3.1.1. Epipelagic

```{r analysis-epi-core, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_epi_core) # 0.04986209

sum(getRefit(se_epi_core))/2 #12279

se_epi_core$select$stars$summary

## Extract adjaency matrix
adj_mat_epi_core <- getRefit(se_epi_core)
table(as.numeric(adj_mat_epi_core))

se_beta_epi_core <- as.matrix(symBeta(getOptBeta(se_epi_core)))
weighted_adj_epi_core <- se_beta_epi_core*adj_mat_epi_core

merged_physeq_epi_core = merge_phyloseq(prot_phy_epi_core, met_phy_epi_core, fish_phy_epi_core)
merged_physeq_epi_core # 1040 ASVs x 15 samples
ig2_epi_core <- adj2igraph(weighted_adj_epi_core)
V(ig2_epi_core)$name <- taxa_names(merged_physeq_epi_core)

graph_components <- components(ig2_epi_core)
graph_components$csize

#dev.new()
plot(density((E(ig2_epi_core)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_epi_core)$weight)~(E(ig2_epi_core)$weight<0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_epi_core <- ig2_epi_core

# create a category for weights
E(grph_all_epi_core)$weight_value[E(grph_all_epi_core)$weight<0] <- "negative"
E(grph_all_epi_core)$weight_value[E(grph_all_epi_core)$weight>0] <- "positive"
E(grph_all_epi_core)$weight_value[E(grph_all_epi_core)$weight==0] <- "neutral" # don't think we have any of these

# let's convert the edges to positive numbers so that we can plot...
E(grph_all_epi_core)$weight <- abs(E(grph_all_epi_core)$weight)

# plot
set.seed(1)
plot(grph_all_epi_core, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_all_epi_core))
# set weight threshold
V(grph_all_epi_core) # vertices
E(grph_all_epi_core) # edges
gsize(grph_all_epi_core) # total # of edges

# histograph of weights
hist(E(grph_all_epi_core)$weight, main="Histogram of weight")
modules_epi_core = cluster_leading_eigen(grph_all_epi_core, weights = NA)
print(modules_epi_core) # modularity = 0.26; groups = 4
modularity(modules_epi_core)
class(modules_epi_core)
deg_epi_core <- igraph::degree(grph_all_epi_core)

# histogram node degree
hist(deg_epi_core, main="Histogram of node degree")

# betweenness
btwn_epi_core <- betweenness(grph_all_epi_core, directed=F, weights=NA) %>% data.frame()
head(btwn_epi_core) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_epi_core)[1] <- "betweenness"
head(btwn_epi_core) # Nodes with higher betweenness centrality scores are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_epi_core %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_epi_core_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_epi_core_df)

is_connected(grph_all_epi_core) # TRUE = strongly connected
count_components(grph_all_epi_core) # just one component
components(grph_all_epi_core)
#v_con_epi_core <- vertex_connectivity(grph_all_epi_core)
v_con_epi_core # 3
e_con_epi_core <- edge_connectivity(grph_all_epi_core)
e_con_epi_core # 3

avg_path_length_epi_core <- mean_distance(grph_all_epi_core, weights = NA, directed = FALSE)
avg_path_length_epi_core # 2.649463

v.cent.epi.core <- robustness(grph_all_epi_core, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.epi.core
v.deg.epi.core <- robustness(grph_all_epi_core, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.epi.core

#v.random.epi.core <- robustness_random(grph_all_epi_core, type = c("vertex"), measure = c("random"), N = 1000)
v.random.epi.core

```

```{r plot-epi-core, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_all_epi_core, layout = igraph::with_fr())

set.seed(123)
epi_core_df <- ggnetwork(grph_all_epi_core, layout = igraph::with_fr())
head(epi_core_df)
tail(epi_core_df)
class(epi_core_df) # this is a dataframe!

# let's add taxa
epi_core_df$taxa <- ifelse(startsWith(epi_core_df$name, "p"), "Protists",
                      ifelse(startsWith(epi_core_df$name, "f"), "Vertebrates", "Invertebrates"))

head(epi_core_df)
tail(epi_core_df)

# let's add in membership
member <- modules_epi_core$membership
name <- modules_epi_core$names
mod_epi_core_df <- cbind(name, member) %>% data.frame()
head(mod_epi_core_df)
tail(mod_epi_core_df)
class(mod_epi_core_df)

epi_core_df <- left_join(epi_core_df, mod_epi_core_df, by = "name")
head(epi_core_df)
tail(epi_core_df)

# I think we can add in taxa?
colnames(epi_core_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax  %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

epi_core_df_tax <- epi_core_df %>%
  left_join(tax_short, by = "OTUid")
head(epi_core_df_tax)

#let's add in degree
deg_epi_core <- igraph::degree(grph_all_epi_core) %>% as.data.frame()
head(deg_epi_core)
colnames(deg_epi_core)[1] <- "degree"
rownames(deg_epi_core)
deg_epi_core$OTUid <- rownames(deg_epi_core)
deg_epi_core <- select(deg_epi_core, OTUid, degree)
head(deg_epi_core)
unique(epi_core_df_tax$TAX_SHORT)
head(epi_core_df_tax)

epi_core_df_tax <- left_join(epi_core_df_tax, deg_epi_core, by = "OTUid")
head(epi_core_df_tax)

epi_core_df_tax <- left_join(epi_core_df_tax, btwn_epi_core_df, by = "OTUid")
head(epi_core_df_tax)

member_count <- mod_epi_core_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

epi_core_df_tax$member <- factor(epi_core_df_tax$member, levels = 1:12)
epi_core_df_tax <- epi_core_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(epi_core_df_tax)
tail(epi_core_df_tax)
write.csv(epi_core_df_tax, "./ggnetwork-inputs/ggnetwork_epi_inputs_core.csv")

epi_core_node <- ggplot(epi_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
epi_core_node

epi_core_node_blkbg <- ggplot(epi_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 3, alpha = 0.75, color = "black", stroke = 0.3) +
  labs(title = NULL,
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_ppt_blkbg() + theme(panel.border = element_blank(),
                                 legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
epi_core_node_blkbg

ggsave("./network-plots/plots-blkbg/epi_core_node_blkbg.pdf", plot = epi_core_node_blkbg, height = 3.25, width = 3.25, units = "in", dpi=300)


epi_core_inter <- ggplot(epi_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(color = weight_value), linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = c("#0065ff", "#ff0065")) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
epi_core_inter

epi_core_plot_mod <- ggplot(epi_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Epipelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + 
  theme(panel.border = element_rect(linewidth = 0.5),
    legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
epi_core_plot_mod

epi_core_plot_mod <- ggplot(epi_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Epipelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + 
  theme(panel.border = element_rect(linewidth = 0.5),
    legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
epi_core_plot_mod

```

```{r epi-core-stats, eval = TRUE, message = FALSE, warning = FALSE}

head(epi_core_df_tax)

epi_core_stats_df <- epi_core_df_tax %>% 
  select(OTUid, weight_value, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(epi_core_stats_df)

epi_degree_df <- epi_core_stats_df %>% select(-weight_value) %>% unique() %>% arrange(desc(degree)) 
epi_degree_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

epi_degree_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((epi_degree_df %>% unique() %>% arrange(desc(degree))), n = 10)

quantile(epi_degree_df$degree, probs = c(.25,.5,.75, 0.8, 0.9))
quantile(epi_degree_df$betweenness, probs = c(.25,.5,.75, 0.8, 0.9))

# lets's go with 90% percentile

degperc <- quantile(epi_degree_df$degree, probs = c(0.9))
btwnprc <- quantile(epi_degree_df$betweenness, probs = c(0.9))

epi_mod <- epi_degree_df %>% select(OTUid, taxa, TAX_SHORT, member, degree, betweenness) %>% 
  filter(degree > degperc & betweenness > btwnprc) %>%
  group_by(TAX_SHORT) %>%
  mutate(sum_OTU = n()) %>% 
  select(TAX_SHORT, sum_OTU, taxa) %>% unique() %>%
  ungroup()

head(epi_mod)
epi_mod$depth <- "Epipelagic"

epi_mod$TAX_SHORT = forcats::fct_rev(factor(epi_mod$TAX_SHORT)) #arrange terms in alphabetical order

epi_dotplot <- ggplot(data = epi_mod, aes(x = as.factor(depth), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

epi_dotplot

```

### 3.1.2. Upper Mesopelagic
```{r analysis-meso-up-core, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_up_core) # 0.04992624

sum(getRefit(se_meso_up_core))/2 #23338

se_meso_up_core$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_up_core <- getRefit(se_meso_up_core)
table(as.numeric(adj_mat_meso_up_core))

se_beta_meso_up_core <- as.matrix(symBeta(getOptBeta(se_meso_up_core)))
weighted_adj_meso_up_core <- se_beta_meso_up_core*adj_mat_meso_up_core

merged_physeq_meso_up_core = merge_phyloseq(prot_phy_meso_up_core, met_phy_meso_up_core, fish_phy_meso_up_core)
merged_physeq_meso_up_core # 1424 x 21

ig2_meso_up_core <- adj2igraph(weighted_adj_meso_up_core)
V(ig2_meso_up_core)$name <- taxa_names(merged_physeq_meso_up_core)

graph_components <- components(ig2_meso_up_core)
graph_components$csize

plot(density((E(ig2_meso_up_core)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_up_core)$weight)~(E(ig2_meso_up_core)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_meso_up_core <- ig2_meso_up_core

# create a category for weights
E(grph_all_meso_up_core)$weight_value[E(grph_all_meso_up_core)$weight<0] <- "negative"
E(grph_all_meso_up_core)$weight_value[E(grph_all_meso_up_core)$weight>0] <- "positive"
E(grph_all_meso_up_core)$weight_value[E(grph_all_meso_up_core)$weight==0] <- "neutral" # don't think we have any of these

# let's convert the edges to positive numbers so that we can plot...
E(grph_all_meso_up_core)$weight <- abs(E(grph_all_meso_up_core)$weight)

# plot
plot(grph_all_meso_up_core, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_all_meso_up_core))
# set weight threshold
V(grph_all_meso_up_core) # vertices
E(grph_all_meso_up_core) # edges
gsize(grph_all_meso_up_core)

modules_meso_up_core = cluster_leading_eigen(grph_all_meso_up_core, weights = NA)
print(modules_meso_up_core) # modularity = 0.2080317; groups = 3
modularity(modules_meso_up_core)
class(modules_meso_up_core)
deg_meso_up_core <- igraph::degree(grph_all_meso_up_core)

# histogram node degree
hist(deg_meso_up_core, main="Histogram of node degree")

# betweenness
btwn_meso_up_core <- betweenness(grph_all_meso_up_core, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_up_core) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_up_core)[1] <- "betweenness"
head(btwn_meso_up_core) # Nodes with higher betweenness centrality scores are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_up_core %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_up_core_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_up_core_df)
dim(btwn_meso_up_core_df)

is_connected(grph_all_meso_up_core) # TRUE = strongly connected
count_components(grph_all_meso_up_core) # just one component
components(grph_all_meso_up_core)

#v_con_meso_up_core <- vertex_connectivity(grph_all_meso_up_core)
v_con_meso_up_core # 4
e_con_meso_up_core <- edge_connectivity(grph_all_meso_up_core) 
e_con_meso_up_core # 4

edge_density_meso_up_core <- edge_density(grph_all_meso_up_core)
edge_density_meso_up_core
avg_path_length_meso_up_core <- mean_distance(grph_all_meso_up_core, weights = NA, directed = FALSE)
avg_path_length_meso_up_core

v.cent.meso.up.core <- robustness(grph_all_meso_up_core, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.up.core
v.deg.meso.up.core <- robustness(grph_all_meso_up_core, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.up.core
#v.random.meso.up.core <- robustness_random(grph_all_meso_up_core, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.up.core

```

```{r plot-meso-up-core, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_all_meso_up_core, layout = igraph::with_fr())

set.seed(123)
meso_up_core_df <- ggnetwork(grph_all_meso_up_core, layout = igraph::with_fr())
head(meso_up_core_df)
class(meso_up_core_df) # this is a dataframe!

# let's add taxa
meso_up_core_df$taxa <- ifelse(startsWith(meso_up_core_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_up_core_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_up_core_df)
tail(meso_up_core_df)

# let's add in membership
member <- modules_meso_up_core$membership
name <- modules_meso_up_core$names
mod_meso_up_core_df <- cbind(name, member) %>% data.frame()
head(mod_meso_up_core_df)
tail(mod_meso_up_core_df)
class(mod_meso_up_core_df)

meso_up_core_df <- left_join(meso_up_core_df, mod_meso_up_core_df, by = "name")
head(meso_up_core_df)
tail(meso_up_core_df)

# I think we can add in taxa?
colnames(meso_up_core_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_up_core_df_tax <- meso_up_core_df %>%
  left_join(tax_short, by = "OTUid")
head(meso_up_core_df_tax)

#let's add in degree
deg_meso_up_core <- igraph::degree(grph_all_meso_up_core) %>% as.data.frame()
head(deg_meso_up_core)
colnames(deg_meso_up_core)[1] <- "degree"
rownames(deg_meso_up_core)
deg_meso_up_core$OTUid <- rownames(deg_meso_up_core)
deg_meso_up_core <- select(deg_meso_up_core, OTUid, degree)
head(deg_meso_up_core)
unique(meso_up_core_df_tax$TAX_SHORT)
head(meso_up_core_df_tax)

meso_up_core_df_tax <- left_join(meso_up_core_df_tax, deg_meso_up_core, by = "OTUid")
head(meso_up_core_df_tax)

meso_up_core_df_tax <- left_join(meso_up_core_df_tax, btwn_meso_up_core_df, by = "OTUid")
head(meso_up_core_df_tax)

member_count <- mod_meso_up_core_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_up_core_df_tax$member <- factor(meso_up_core_df_tax$member, levels = 1:12)
meso_up_core_df_tax <- meso_up_core_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

write.csv(meso_up_core_df_tax, "./ggnetwork-inputs/ggnetwork_meso_up_inputs_core.csv")
head(meso_up_core_df_tax)
tail(meso_up_core_df_tax)

meso_up_core_node <- ggplot(meso_up_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Upper Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_up_core_node  


meso_up_core_node_blkbg <- ggplot(meso_up_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 3, alpha = 0.75, color = "black", stroke = 0.3) +
  labs(title = NULL,
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_ppt_blkbg() + theme(panel.border = element_blank(),
                                 legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_up_core_node_blkbg

ggsave("./network-plots/plots-blkbg/meso_up_core_node_blkbg.pdf", plot = meso_up_core_node_blkbg, height = 3.25, width = 3.25, units = "in", dpi=300)

meso_up_core_inter <- ggplot(meso_up_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(color = weight_value), linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = c("#0065ff", "#ff0065")) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
meso_up_core_inter

meso_up_core_plot_mod <- ggplot(meso_up_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Upper Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + theme(legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
meso_up_core_plot_mod

```

```{r meso-up-core-stats, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_up_core_df_tax)

meso_up_core_stats_df <- meso_up_core_df_tax %>% 
  select(OTUid, weight_value, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_up_core_stats_df, n = 25)

meso_up_degree_df <- meso_up_core_stats_df %>% select(-weight_value) %>% unique() %>% arrange(desc(degree)) 
meso_up_degree_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_up_degree_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_up_degree_df %>% unique() %>% arrange(desc(degree))), n = 50)

quantile(meso_up_degree_df$degree, probs = c(.25,.5,.75, 0.8, 0.9))
quantile(meso_up_degree_df$betweenness, probs = c(.25,.5,.75, 0.8, 0.9))

# 90%

degperc <- quantile(meso_up_degree_df$degree, probs = c(0.9))
btwnperc <- quantile(meso_up_degree_df$betweenness, probs = c(0.9))

meso_up_mod <- meso_up_core_stats_df %>% 
  select(OTUid, taxa, TAX_SHORT, member, degree, betweenness) %>% 
  filter(degree > degperc & betweenness > btwnperc) %>%
  group_by(TAX_SHORT) %>%
  mutate(sum_OTU = n()) %>% 
  select(TAX_SHORT, sum_OTU, taxa) %>% unique() %>%
  ungroup()

head(meso_up_mod)
meso_up_mod$depth <- "Upper Mesopelagic"

meso_up_mod$TAX_SHORT = forcats::fct_rev(factor(meso_up_mod$TAX_SHORT)) #arrange terms in alphabetical order

meso_up_dotplot <- ggplot(data = meso_up_mod, aes(x = depth, y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_up_dotplot


```

### 3.1.3. Lower Mesopelagic

```{r analysis-meso-low-core, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_low_core) # 0.04999279

sum(getRefit(se_meso_low_core))/2 #21807

se_meso_low_core$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_low_core <- getRefit(se_meso_low_core)
table(as.numeric(adj_mat_meso_low_core))

se_beta_meso_low_core <- as.matrix(symBeta(getOptBeta(se_meso_low_core)))
weighted_adj_meso_low_core <- se_beta_meso_low_core*adj_mat_meso_low_core

merged_physeq_meso_low_core = merge_phyloseq(prot_phy_meso_low_core, met_phy_meso_low_core, fish_phy_meso_low_core)
merged_physeq_meso_low_core # 1397 x 22

ig2_meso_low_core <- adj2igraph(weighted_adj_meso_low_core)
V(ig2_meso_low_core)$name <- taxa_names(merged_physeq_meso_low_core)

graph_components <- components(ig2_meso_low_core)
graph_components$csize

plot(density((E(ig2_meso_low_core)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_low_core)$weight)~(E(ig2_meso_low_core)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_meso_low_core <- ig2_meso_low_core

# create a category for weights
E(grph_all_meso_low_core)$weight_value[E(grph_all_meso_low_core)$weight<0] <- "negative"
E(grph_all_meso_low_core)$weight_value[E(grph_all_meso_low_core)$weight>0] <- "positive"
E(grph_all_meso_low_core)$weight_value[E(grph_all_meso_low_core)$weight==0] <- "neutral" # don't think we have any of these

# let's convert the edges to positive numbers so that we can plot...
E(grph_all_meso_low_core)$weight <- abs(E(grph_all_meso_low_core)$weight)

# plot
plot(grph_all_meso_low_core, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_all_meso_low_core))
# set weight threshold
V(grph_all_meso_low_core) # vertices
E(grph_all_meso_low_core) # edges
gsize(grph_all_meso_low_core)

modules_meso_low_core = cluster_leading_eigen(grph_all_meso_low_core, weights = NA)
print(modules_meso_low_core) # modularity = 0.1777415; groups = 4
modularity(modules_meso_low_core)
class(modules_meso_low_core)
deg_meso_low_core <- igraph::degree(grph_all_meso_low_core)

# histogram node degree
hist(deg_meso_low_core, main="Histogram of node degree")

# betweenness
btwn_meso_low_core <- betweenness(grph_all_meso_low_core, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_low_core) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_low_core)[1] <- "betweenness"
head(btwn_meso_low_core) # Nodes with higher betweenness centrality scores are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_low_core %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_low_core_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_low_core_df)
dim(btwn_meso_low_core_df)

is_connected(grph_all_meso_low_core) # TRUE = strongly connected
count_components(grph_all_meso_low_core) # just one component
components(grph_all_meso_low_core)
#v_con_meso_low_core <- vertex_connectivity(grph_all_meso_low_core)
v_con_meso_low_core # 13
e_con_meso_low_core <- edge_connectivity(grph_all_meso_low_core) 
e_con_meso_low_core # 13

edge_density_meso_low_core <- edge_density(grph_all_meso_low_core)
edge_density_meso_low_core
avg_path_length_meso_low_core <- mean_distance(grph_all_meso_low_core, weights = NA, directed = FALSE)
avg_path_length_meso_low_core

v.cent.meso.low.core <- robustness(grph_all_meso_low_core, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.low.core
v.deg.meso.low.core <- robustness(grph_all_meso_low_core, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.low.core
#v.random.meso.low.core <- robustness_random(grph_all_meso_low_core, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.low.core

```

```{r plot-meso-low-core, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_all_meso_low_core, layout = igraph::with_fr())

set.seed(123)
meso_low_core_df <- ggnetwork(grph_all_meso_low_core, layout = igraph::with_fr())
head(meso_low_core_df)
class(meso_low_core_df) # this is a dataframe!

# let's add taxa
meso_low_core_df$taxa <- ifelse(startsWith(meso_low_core_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_low_core_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_low_core_df)
tail(meso_low_core_df)

# let's add in membership
member <- modules_meso_low_core$membership
name <- modules_meso_low_core$names
mod_meso_low_core_df <- cbind(name, member) %>% data.frame()
head(mod_meso_low_core_df)
tail(mod_meso_low_core_df)
class(mod_meso_low_core_df)

meso_low_core_df <- left_join(meso_low_core_df, mod_meso_low_core_df, by = "name")
head(meso_low_core_df)
tail(meso_low_core_df)

# I think we can add in taxa?
colnames(meso_low_core_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>%
  unique()

tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_low_core_df_tax <- meso_low_core_df %>%
  left_join(tax_short, by = "OTUid", relationship = "many-to-many")
head(meso_low_core_df_tax)

#let's add in degree
deg_meso_low_core <- igraph::degree(grph_all_meso_low_core) %>% as.data.frame()
head(deg_meso_low_core)
colnames(deg_meso_low_core)[1] <- "degree"
rownames(deg_meso_low_core)
deg_meso_low_core$OTUid <- rownames(deg_meso_low_core)
deg_meso_low_core <- select(deg_meso_low_core, OTUid, degree)
head(deg_meso_low_core)
unique(meso_low_core_df_tax$TAX_SHORT)
head(meso_low_core_df_tax)

meso_low_core_df_tax <- left_join(meso_low_core_df_tax, deg_meso_low_core, by = "OTUid")
head(meso_low_core_df_tax)

meso_low_core_df_tax <- left_join(meso_low_core_df_tax, btwn_meso_low_core_df, by = "OTUid")
head(meso_low_core_df_tax)

member_count <- mod_meso_low_core_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_low_core_df_tax$member <- factor(meso_low_core_df_tax$member, levels = 1:12)
meso_low_core_df_tax <- meso_low_core_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

write.csv(meso_low_core_df_tax, "./ggnetwork-inputs/ggnetwork_meso_low_inputs_core.csv")
head(meso_low_core_df_tax)
tail(meso_low_core_df_tax)

meso_low_core_node <- ggplot(meso_low_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Lower Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_low_core_node  


meso_low_core_node_blkbg <- ggplot(meso_low_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 3, alpha = 0.75, color = "black", stroke = 0.3) +
  labs(title = NULL,
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_ppt_blkbg() + theme(panel.border = element_blank(),
                                 legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_low_core_node_blkbg

ggsave("./network-plots/plots-blkbg/meso_low_core_node_blkbg.pdf", plot = meso_low_core_node_blkbg, height = 3.25, width = 3.25, units = "in", dpi=300)


meso_low_core_inter <- ggplot(meso_low_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(color = weight_value), linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = c("#0065ff", "#ff0065")) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
meso_low_core_inter

meso_low_core_plot_mod <- ggplot(meso_low_core_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Lower Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + theme(legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
meso_low_core_plot_mod

```

```{r meso-low-core-stats, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_low_core_df_tax)

meso_low_core_stats_df <- meso_low_core_df_tax %>% 
  select(OTUid, weight_value, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_low_core_stats_df, n = 25)
tail(meso_low_core_stats_df, n = 25)

meso_low_degree_df <- meso_low_core_stats_df %>% select(-weight_value) %>% unique() %>% arrange(desc(degree)) 

meso_low_degree_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_low_degree_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_low_degree_df %>% unique() %>% arrange(desc(degree))), n = 50)

quantile(meso_low_degree_df$degree, probs = c(.25,.5,.75, 0.8, 0.9))
quantile(meso_low_degree_df$betweenness, probs = c(.25,.5,.75, 0.8, 0.9))

degperc <- quantile(meso_low_degree_df$degree, probs = c(0.9))
btwnperc <- quantile(meso_low_degree_df$betweenness, probs = c(0.9))

meso_low_mod <- meso_low_core_stats_df %>% 
  select(OTUid, taxa, TAX_SHORT, member, degree, betweenness) %>% 
  filter(degree > degperc & betweenness > btwnperc) %>%
  group_by(TAX_SHORT) %>%
  mutate(sum_OTU = n()) %>% 
  select(TAX_SHORT, sum_OTU, taxa) %>% unique() %>%
  ungroup()

head(meso_low_mod)
meso_low_mod$depth <- "Lower Mesopelagic"


meso_low_mod$TAX_SHORT = forcats::fct_rev(factor(meso_low_mod$TAX_SHORT)) #arrange terms in alphabetical order

meso_low_dotplot <- ggplot(data = meso_low_mod, aes(x = as.factor(depth), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_low_dotplot


```

### 3.1.4. All Depths Combined

```{r analysis-panel-depth-core-save eval = TRUE, message = FALSE, warning = FALSE}

# save plot inputs

save(v_con_epi_core, e_con_epi_core, v_con_meso_up_core, e_con_meso_up_core, v_con_meso_low_core, e_con_meso_low_core, file = "./R-outputs/connectivity_calculations.RData")

#load("./R-outputs/connectivity_calculations.RData", verbose = TRUE)

save(epi_core_df_tax, meso_up_core_df_tax, meso_low_core_df_tax, file = "./ggnetwork-inputs/ggnetwork_plot_inputs_core_20250410.RData")

save(v.random.epi.core, v.random.meso.up.core, v.random.meso.low.core, v.deg.epi.core, v.deg.meso.up.core, v.deg.meso.low.core, v.cent.epi.core, v.cent.meso.up.core, v.cent.meso.low.core, file = "./R-outputs/robustness_alltaxa.RData")

#load("./R-outputs/robustness_alltaxa.RData", verbose = TRUE)

panel_node <- epi_core_node + meso_up_core_node + meso_low_core_node +
  plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.50), 
        legend.key.spacing.x = unit(0.5, "mm"),
        legend.key.spacing.y = unit(-0.25, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 0)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 10, b = 0, l = 10), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 1)))

panel_node

#ggsave("./network-plots/depthsplit_network_panel_core.pdf", plot = panel_node, height = 34, width = 80, units = "mm", dpi=300)

panel_inter <- epi_core_inter + meso_up_core_inter + meso_low_core_inter +
    plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.5), 
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(-2, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 5, b = 0, l = -5), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 0.5)))

panel_inter

#ggsave("./network-plots/depthsplit_network_panel_interactions.pdf", plot = panel_inter, height = 34, width = 80, units = "mm", dpi=300)

panel_mod <- epi_core_plot_mod + meso_up_core_plot_mod + meso_low_core_plot_mod +
    plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.5), 
        legend.key.spacing.x = unit(0, "mm"),
        legend.key.spacing.y = unit(-2, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = -0.2)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 5, b = 0, l = -5), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 0.5)))

panel_mod

#ggsave("./network-plots/depthsplit_network_panel_module.pdf", plot = panel_mod, height = 34, width = 80, units = "mm", dpi=300)


## all panels

panel_node / panel_mod / panel_inter 

#ggsave("./network-plots/depthsplit_network_panel_all.pdf", height = 100, width = 80, units = "mm", dpi=300)


###
depth_mod_df <- rbind(epi_mod, meso_up_mod, meso_low_mod) %>% arrange(TAX_SHORT)
head(depth_mod_df)

depth_mod_df$depth <- fct_relevel(depth_mod_df$depth, "Epipelagic", "Upper Mesopelagic", "Lower Mesopelagic")

list <- depth_mod_df %>% select(taxa, TAX_SHORT) %>% unique() %>% sort() %>% data.frame()

list

depth_mod_df$TAX_SHORT <- fct_relevel(depth_mod_df$TAX_SHORT,
                                      "Alveolata-Apicomplexa",
                                      "Alveolata-Ciliates",
                                      "Alveolata-Dinoflagellates",
                                      "Alveolata-Syndiniales",
                                      "Alveolata-Other",
                                      "Amoebozoa",
                                      "Archaeplastida-Picozoa",
                                      "Archaeplastida-Streptophyta",
                                      "Chlorophyta",
                                     # "Cryptophyta",
                                      "Excavata",
                                      "Haptophyta",
                                      "Obazoa-Choanoflagellata",
                                      "Obazoa-Fungi",
                                      "Obazoa-Opisthokonta",
                                      "Rhizaria-Cercozoa",
                                      "Rhizaria-Radiolaria",
                                      "Rhizaria-Other",
                                      "Rhodophyta",
                                      "Stramenopiles-Diatoms",  
                                      "Stramenopiles-MAST",
                                      "Stramenopiles-Other",
                                      "TSAR-Telonemia",
                                      #"Annelida-Phyllodocida",
                                      "Arthropoda-Calanoida",
                                      "Arthropoda-Cyclopoida",
                                      "Cnidaria-Narcomedusae",
                                      "Cnidaria-Siphonophorae",
                                     "Cnidaria-Trachymedusae",
                                      "Ctenophora-Cydippida",
                                      #"Tunicata-Copelata",
                                      "Alepisauridae-Alepisaurus",
                                      "Coryphaenidae-Coryphaena",
                                      "Gonostomatidae-Cyclothone",
                                      "Melamphaidae-Melamphaes",
                                      "Myctophidae-Hygophum",
                                      "Unassigned Actinopterygii") 

mod_dotplot <- ggplot(data = depth_mod_df, aes(x = (TAX_SHORT), y = fct_rev(depth))) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
#  facet_wrap(~taxa) +
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 size = 2,
                                                 alpha = 1,
                                                 stroke = 0.5)),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(angle = 45, colour = "black", size = 9,  hjust = 0, vjust = 5),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 7, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
    legend.key.size = unit(2, 'mm'), 
    legend.key.height = unit(3, "mm"),
    legend.key.spacing.x = unit(2, "mm"))

mod_dotplot

#ggsave("./network-plots/depthsplit_network_module_dotplot.pdf", height = 4, width = 8.5, units = "in", dpi=300)

epi_dotplot + meso_up_dotplot + meso_low_dotplot

# let's merge the attack robustness files for alltaxa

#betweenness
head(v.cent.epi.core)
head(v.cent.meso.up.core)
head(v.cent.meso.low.core)

## create a column for type of attack
v.cent.epi.core$depth <- "Epipelagic"
v.cent.meso.up.core$depth <- "Upper Mesopelagic"
v.cent.meso.low.core$depth <- "Lower Mesopelagic"

v.cent.core <- rbind(v.cent.epi.core, v.cent.meso.up.core, v.cent.meso.low.core)

# Degree
head(v.deg.epi.core)
head(v.deg.meso.up.core)
head(v.deg.meso.low.core)

v.deg.epi.core$depth <- "Epipelagic"
v.deg.meso.up.core$depth <- "Upper Mesopelagic"
v.deg.meso.low.core$depth <- "Lower Mesopelagic"

v.deg.core <- rbind(v.deg.epi.core, v.deg.meso.up.core, v.deg.meso.low.core)

head(v.random.epi.core)
head(v.random.meso.up.core)
head(v.random.meso.low.core)

v.random.epi.core$depth <- "Epipelagic"
v.random.meso.up.core$depth <- "Upper Mesopelagic"
v.random.meso.low.core$depth <- "Lower Mesopelagic"

v.random.core <- rbind(v.random.epi.core, v.random.meso.up.core, v.random.meso.low.core)

v.cent.core$depth <- fct_relevel(v.cent.core$depth, "Lower Mesopelagic", after = Inf)
v.deg.core$depth <- fct_relevel(v.deg.core$depth, "Lower Mesopelagic", after = Inf)
v.random.core$depth <- fct_relevel(v.random.core$depth, "Lower Mesopelagic", after = Inf)

v.cent.core.plot <- v.cent.core %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Betweenness", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.plot <- v.deg.core %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Degree", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.plot

v.random.core.plot <- v.random.core %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Random", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.random.core.plot


v.core.plot <- v.cent.core.plot + v.deg.core.plot + v.random.core.plot + 
  plot_layout(guides = 'collect') &
    theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8, hjust = 0.5),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.position = "bottom", 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 6))

v.core.plot


v.core.plot <- v.cent.core.plot + v.deg.core.plot + v.random.core.plot + 
  plot_layout(guides = 'collect') &
    theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8, hjust = 0.5),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.position = "bottom", 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 6))

v.core.plot


```

## 4.2 Core - Taxa

### 4.2.1. Epipelagic Core - Protists

```{r analysis-epi-core-prot, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_epi_core_prot) # 0.04987193

sum(getRefit(se_epi_core_prot))/2 #11245

se_epi_core_prot$select$stars$summary

## Extract adjaency matrix
adj_mat_epi_core_prot <- getRefit(se_epi_core_prot)
table(as.numeric(adj_mat_epi_core_prot))

se_beta_epi_core_prot <- as.matrix(symBeta(getOptBeta(se_epi_core_prot)))
weighted_adj_epi_core_prot <- se_beta_epi_core_prot*adj_mat_epi_core_prot

ig2_epi_core_prot <- adj2igraph(weighted_adj_epi_core_prot)
V(ig2_epi_core_prot)$name <- taxa_names(prot_phy_epi_core) # only need prot here

graph_components <- components(ig2_epi_core_prot)
graph_components$csize

plot(density((E(ig2_epi_core_prot)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_epi_core_prot)$weight)~(E(ig2_epi_core_prot)$weight<0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_epi_core_prot <- ig2_epi_core_prot

# create a category for weights
E(grph_all_epi_core_prot)$weight_value[E(grph_all_epi_core_prot)$weight<0] <- "negative"
E(grph_all_epi_core_prot)$weight_value[E(grph_all_epi_core_prot)$weight>0] <- "positive"
E(grph_all_epi_core_prot)$weight_value[E(grph_all_epi_core_prot)$weight==0] <- "neutral" # don't think we have any of these

# let's convert the edges to positive numbers so that we can plot...
E(grph_all_epi_core_prot)$weight <- abs(E(grph_all_epi_core_prot)$weight)

# plot
set.seed(1)
#dev.new()
plot(grph_all_epi_core_prot, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_all_epi_core_prot))
# set weight threshold
V(grph_all_epi_core_prot) # vertices
E(grph_all_epi_core_prot) # edges
gsize(grph_all_epi_core_prot) # total # of edges

modules_epi_core_prot = cluster_leading_eigen(grph_all_epi_core_prot, weights = NA)
print(modules_epi_core_prot) # modularity = 0.26; groups = 4
modularity(modules_epi_core_prot)
class(modules_epi_core_prot)
deg_epi_core_prot <- igraph::degree(grph_all_epi_core_prot)

# histogram node degree
hist(deg_epi_core_prot, main="Histogram of node degree")


# betweenness
btwn_epi_core_prot <- betweenness(grph_all_epi_core_prot, directed=F, weights=NA) %>% data.frame()
head(btwn_epi_core_prot) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_epi_core_prot)[1] <- "betweenness"
head(btwn_epi_core_prot) # Nodes with higher betweenness centrality sprots are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_epi_core_prot %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_epi_core_prot_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_epi_core_prot_df)

is_connected(grph_all_epi_core_prot) # TRUE = strongly connected
count_components(grph_all_epi_core_prot) # just one component
components(grph_all_epi_core_prot)
#v_con_epi_core_prot <- vertex_connectivity(grph_all_epi_core_prot) 
v_con_epi_core_prot # 3
e_con_epi_core_prot <- edge_connectivity(grph_all_epi_core_prot)
e_con_epi_core_prot # 3

edge_density_epi_core_prot <- edge_density(grph_all_epi_core_prot)
avg_path_length_epi_core_prot <- mean_distance(grph_all_epi_core_prot, weights = NA, directed = FALSE)
avg_path_length_epi_core_prot

v.cent.epi.core.prot <- robustness(grph_all_epi_core_prot, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.epi.core.prot
v.deg.epi.core.prot <- robustness(grph_all_epi_core_prot, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.epi.core.prot

#v.random.epi.core.prot <- robustness_random(grph_all_epi_core_prot, type = c("vertex"), measure = c("random"), N = 1000)
v.random.epi.core.prot

```

```{r plot-epi-core-prot, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_all_epi_core_prot, layout = igraph::with_fr())

set.seed(123)
epi_core_prot_df <- ggnetwork(grph_all_epi_core_prot, layout = igraph::with_fr())
head(epi_core_prot_df)
tail(epi_core_prot_df)
class(epi_core_prot_df) # this is a dataframe!

# let's add taxa
epi_core_prot_df$taxa <- ifelse(startsWith(epi_core_prot_df$name, "p"), "Protists",
                      ifelse(startsWith(epi_core_prot_df$name, "f"), "Vertebrates", "Invertebrates"))

head(epi_core_prot_df)
tail(epi_core_prot_df)

# let's add in membership
member <- modules_epi_core_prot$membership
name <- modules_epi_core_prot$names
mod_epi_core_prot_df <- cbind(name, member) %>% data.frame()
head(mod_epi_core_prot_df)
tail(mod_epi_core_prot_df)
class(mod_epi_core_prot_df)

epi_core_prot_df <- left_join(epi_core_prot_df, mod_epi_core_prot_df, by = "name")
head(epi_core_prot_df)
tail(epi_core_prot_df)

# I think we can add in taxa?
colnames(epi_core_prot_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

epi_core_prot_df_tax <- epi_core_prot_df %>%
  left_join(tax_short, by = "OTUid")
head(epi_core_prot_df_tax)

#let's add in degree
deg_epi_core_prot <- igraph::degree(grph_all_epi_core_prot) %>% as.data.frame()
head(deg_epi_core_prot)
colnames(deg_epi_core_prot)[1] <- "degree"
rownames(deg_epi_core_prot)
deg_epi_core_prot$OTUid <- rownames(deg_epi_core_prot)
deg_epi_core_prot <- select(deg_epi_core_prot, OTUid, degree)
head(deg_epi_core_prot)
unique(epi_core_prot_df_tax$TAX_SHORT)
head(epi_core_prot_df_tax)

epi_core_prot_df_tax <- left_join(epi_core_prot_df_tax, deg_epi_core_prot, by = "OTUid")
head(epi_core_prot_df_tax)

epi_core_prot_df_tax <- left_join(epi_core_prot_df_tax, btwn_epi_core_prot_df, by = "OTUid")
head(epi_core_prot_df_tax)

member_count <- mod_epi_core_prot_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

epi_core_prot_df_tax$member <- factor(epi_core_prot_df_tax$member, levels = 1:12)
epi_core_prot_df_tax <- epi_core_prot_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists"))

head(epi_core_prot_df_tax)
tail(epi_core_prot_df_tax)
write.csv(epi_core_prot_df_tax, "./ggnetwork-inputs/ggnetwork_epi_inputs_core_prot.csv")

epi_core_prot_node <- ggplot(epi_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
#  geom_edges(color = "black", linewidth = 0.1, alpha = 0.05, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
epi_core_prot_node

epi_core_prot_node_blkbg <- ggplot(epi_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 3, alpha = 0.75, color = "black", stroke = 0.3) +
  labs(title = NULL,
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors[c(1)]) + 
    theme_custom_ppt_blkbg() + theme(panel.border = element_blank(),
                                 legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
epi_core_prot_node_blkbg

#ggsave("./network-plots/epi_core_prot_node_blkbg.pdf", plot = epi_core_prot_node_blkbg, height = 3.25, width = 3.25, units = "in", dpi=300)


epi_core_prot_inter <- ggplot(epi_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(color = weight_value), linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = c("#0065ff", "#ff0065")) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
epi_core_prot_inter

epi_core_prot_plot_mod <- ggplot(epi_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Epipelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + 
  theme(panel.border = element_rect(linewidth = 0.5),
    legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
epi_core_prot_plot_mod

epi_core_prot_plot_mod <- ggplot(epi_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Epipelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + 
  theme(panel.border = element_rect(linewidth = 0.5),
    legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
epi_core_prot_plot_mod

```

```{r epi-core-prot-stats, eval = TRUE, message = FALSE, warning = FALSE}

head(epi_core_prot_df_tax)

epi_core_prot_stats_df <- epi_core_prot_df_tax %>% 
  select(OTUid, weight_value, taxa, member, TAX_SHORT, depth_group, degree) %>%
#  select(-weight_value) %>% 
  unique()

head(epi_core_prot_stats_df)

epi_degree_prot_df <- epi_core_prot_stats_df %>% select(-weight_value) %>% unique() %>% arrange(desc(degree)) 

epi_degree_prot_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

epi_degree_prot_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((epi_degree_prot_df %>% unique() %>% arrange(desc(degree))), n = 10)

epi_degree_df_prot <- epi_degree_prot_df %>% filter(taxa == "Protists") %>% unique() %>% arrange(desc(degree)) 
head(epi_degree_df_prot, n = 10)

epi_mod_prot <- epi_core_prot_stats_df %>% select(OTUid, taxa, TAX_SHORT, member) %>% unique() %>%
  group_by(TAX_SHORT, member) %>%
  mutate(sum_OTU = n()) %>% 
  select(-OTUid) %>% unique() %>%
  ungroup()

head(epi_mod_prot)

epi_mod_prot$TAX_SHORT = forcats::fct_rev(factor(epi_mod_prot$TAX_SHORT)) #arrange terms in alphabetical order

epi_prot_dotplot <- ggplot(data = epi_mod_prot, aes(x = as.factor(member), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

epi_prot_dotplot

```

### 4.2.2. Epipelagic Core - Metazoans

```{r analysis-epi-core-met-fish, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_epi_core_met_fish) # 0.04614422

sum(getRefit(se_epi_core_met_fish))/2 #21

se_epi_core_met_fish$select$stars$summary

## Extract adjaency matrix
adj_mat_epi_core_met_fish <- getRefit(se_epi_core_met_fish)
table(as.numeric(adj_mat_epi_core_met_fish))

se_beta_epi_core_met_fish <- as.matrix(symBeta(getOptBeta(se_epi_core_met_fish)))
weighted_adj_epi_core_met_fish <- se_beta_epi_core_met_fish*adj_mat_epi_core_met_fish

merged_physeq_epi_core_met_fish = merge_phyloseq(met_phy_epi_core, fish_phy_epi_core)
merged_physeq_epi_core_met_fish

ig2_epi_core_met_fish <- adj2igraph(weighted_adj_epi_core_met_fish)
V(ig2_epi_core_met_fish)$name <- taxa_names(merged_physeq_epi_core_met_fish) # only need met_fish here

graph_components <- components(ig2_epi_core_met_fish)
graph_components$csize

plot(density((E(ig2_epi_core_met_fish)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_epi_core_met_fish)$weight)~(E(ig2_epi_core_met_fish)$weight<0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_epi_core_met_fish <- ig2_epi_core_met_fish

# create a category for weights
E(grph_all_epi_core_met_fish)$weight_value[E(grph_all_epi_core_met_fish)$weight<0] <- "negative"
E(grph_all_epi_core_met_fish)$weight_value[E(grph_all_epi_core_met_fish)$weight>0] <- "positive"
E(grph_all_epi_core_met_fish)$weight_value[E(grph_all_epi_core_met_fish)$weight==0] <- "neutral" # don't think we have any of these

# let's convert the edges to positive numbers so that we can plot...
E(grph_all_epi_core_met_fish)$weight <- abs(E(grph_all_epi_core_met_fish)$weight)

# plot
plot(grph_all_epi_core_met_fish, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_all_epi_core_met_fish))


# set weight threshold
V(grph_all_epi_core_met_fish) # vertices
E(grph_all_epi_core_met_fish) # edges
gsize(grph_all_epi_core_met_fish)

dev.new()
plot(density((E(grph_all_epi_core_met_fish)$weight)),xlab="Edge Weight",main="")
boxplot(abs(E(grph_all_epi_core_met_fish)$weight)~(E(grph_all_epi_core_met_fish)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

# histograph of weights
hist(E(grph_all_epi_core_met_fish)$weight, main="Histogram of weight")

modules_epi_core_met_fish = cluster_leading_eigen(grph_all_epi_core_met_fish, weights = NA)
print(modules_epi_core_met_fish) # modularity = 0.74; groups = 31
modularity(modules_epi_core_met_fish)
class(modules_epi_core_met_fish)
deg_epi_core_met_fish <- igraph::degree(grph_all_epi_core_met_fish)

# histogram node degree
hist(deg_epi_core_met_fish, main="Histogram of node degree")

# betweenness
btwn_epi_core_met_fish <- betweenness(grph_all_epi_core_met_fish, directed=F, weights=NA) %>% data.frame()
head(btwn_epi_core_met_fish) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_epi_core_met_fish)[1] <- "betweenness"
head(btwn_epi_core_met_fish) # Nodes with higher betweenness centrality smet_fishs are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_epi_core_met_fish %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_epi_core_met_fish_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_epi_core_met_fish_df)

is_connected(grph_all_epi_core_met_fish) # FALSE = not strongly connected
count_components(grph_all_epi_core_met_fish) # 8
components(grph_all_epi_core_met_fish)
v_con_epi_core_met_fish <- vertex_connectivity(grph_all_epi_core_met_fish) # 0
e_con_epi_core_met_fish <- edge_connectivity(grph_all_epi_core_met_fish) # 0

edge_density_epi_core_met_fish <- edge_density(grph_all_epi_core_met_fish)
avg_path_length_epi_core_met_fish <- mean_distance(grph_all_epi_core_met_fish, weights = NA, directed = FALSE)
avg_path_length_epi_core_met_fish

v.cent.epi.core.met.fish <- robustness(grph_all_epi_core_met_fish, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.epi.core.met.fish
v.deg.epi.core.met.fish <- robustness(grph_all_epi_core_met_fish, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.epi.core.met.fish
v.random.epi.core.met.fish <- robustness_random(grph_all_epi_core_met_fish, type = c("vertex"), measure = c("random"), N = 1000)
v.random.epi.core.met.fish

```

```{r plot-epi-core-met-fish, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_all_epi_core_met_fish, layout = igraph::with_fr())

set.seed(123)
epi_core_met_fish_df <- ggnetwork(grph_all_epi_core_met_fish, layout = igraph::with_fr())
head(epi_core_met_fish_df)
tail(epi_core_met_fish_df)
class(epi_core_met_fish_df) # this is a dataframe!

# let's add taxa
epi_core_met_fish_df$taxa <- ifelse(startsWith(epi_core_met_fish_df$name, "p"), "Protists",
                      ifelse(startsWith(epi_core_met_fish_df$name, "f"), "Vertebrates", "Invertebrates"))

head(epi_core_met_fish_df)
tail(epi_core_met_fish_df)

# let's add in membership
member <- modules_epi_core_met_fish$membership
name <- modules_epi_core_met_fish$names
mod_epi_core_met_fish_df <- cbind(name, member) %>% data.frame()
head(mod_epi_core_met_fish_df)
tail(mod_epi_core_met_fish_df)
class(mod_epi_core_met_fish_df)

epi_core_met_fish_df <- left_join(epi_core_met_fish_df, mod_epi_core_met_fish_df, by = "name")
head(epi_core_met_fish_df)
tail(epi_core_met_fish_df)

# I think we can add in taxa?
colnames(epi_core_met_fish_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "0-200") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

epi_core_met_fish_df_tax <- epi_core_met_fish_df %>%
  left_join(tax_short, by = "OTUid")
head(epi_core_met_fish_df_tax)

#let's add in degree
deg_epi_core_met_fish <- igraph::degree(grph_all_epi_core_met_fish) %>% as.data.frame()
head(deg_epi_core_met_fish)
colnames(deg_epi_core_met_fish)[1] <- "degree"
rownames(deg_epi_core_met_fish)
deg_epi_core_met_fish$OTUid <- rownames(deg_epi_core_met_fish)
deg_epi_core_met_fish <- select(deg_epi_core_met_fish, OTUid, degree)
head(deg_epi_core_met_fish)
unique(epi_core_met_fish_df_tax$TAX_SHORT)
head(epi_core_met_fish_df_tax)

epi_core_met_fish_df_tax <- left_join(epi_core_met_fish_df_tax, deg_epi_core_met_fish, by = "OTUid")
head(epi_core_met_fish_df_tax)

epi_core_met_fish_df_tax <- left_join(epi_core_met_fish_df_tax, btwn_epi_core_met_fish_df, by = "OTUid")
head(epi_core_met_fish_df_tax)

member_count <- mod_epi_core_met_fish_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

epi_core_met_fish_df_tax$member <- factor(epi_core_met_fish_df_tax$member, levels = 1:12)
epi_core_met_fish_df_tax <- epi_core_met_fish_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Invertebrates", "Vertebrates"))

head(epi_core_met_fish_df_tax)
tail(epi_core_met_fish_df_tax)
write.csv(epi_core_met_fish_df_tax, "./ggnetwork-inputs/ggnetwork_epi_inputs_core_met_fish.csv")

epi_core_met_fish_node <- ggplot(epi_core_met_fish_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(color = "black", linewidth = 0.1, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors[c(2,3)]) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
epi_core_met_fish_node

epi_core_met_fish_node_blkbg <- ggplot(epi_core_met_fish_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(color = "white", linewidth = 0.5, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 3, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = NULL,
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors[c(2,3)]) + 
    theme_custom_ppt_blkbg() + theme(panel.border = element_blank(),
                                 legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
epi_core_met_fish_node_blkbg

#ggsave("./network-plots/epi_core_met_fish_node_blkbg.pdf", plot = epi_core_met_fish_node_blkbg, height = 3.25, width = 3.25, units = "in", dpi=300)

epi_core_met_fish_inter <- ggplot(epi_core_met_fish_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(color = weight_value), linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Epipelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = c("#0065ff", "#ff0065")) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
epi_core_met_fish_inter


```

```{r epi-core-met-fish-stats, eval = TRUE, message = FALSE, warning = FALSE}

head(epi_core_met_fish_df_tax)

epi_core_met_fish_stats_df <- epi_core_met_fish_df_tax %>% 
  select(OTUid, weight_value, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(epi_core_met_fish_stats_df)

epi_degree_met_fish_df <- epi_core_met_fish_stats_df %>% select(-weight_value) %>% unique() %>% arrange(desc(degree)) 

epi_degree_met_fish_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

epi_degree_met_fish_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((epi_degree_met_fish_df %>% unique() %>% arrange(desc(degree))), n = 10)

epi_degree_df_met_fish <- epi_degree_met_fish_df %>% unique() %>% arrange(desc(degree)) 
head(epi_degree_df_met_fish, n = 10)

epi_mod_met_fish <- epi_core_met_fish_stats_df %>% select(OTUid, taxa, TAX_SHORT, member) %>% unique() %>%
  group_by(TAX_SHORT, member) %>%
  mutate(sum_OTU = n()) %>% 
  select(-OTUid) %>% unique() %>%
  ungroup()

head(epi_mod_met_fish)

epi_mod_met_fish$TAX_SHORT = forcats::fct_rev(factor(epi_mod_met_fish$TAX_SHORT)) #arrange terms in alphabetical order

epi_met_fish_dotplot <- ggplot(data = epi_mod_met_fish, aes(x = as.factor(member), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors[c(2,3)]) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

epi_met_fish_dotplot

```

### 4.2.3. Meso - Up - Core - Protists

```{r analysis-meso-up-core-prot, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_up_core_prot) # 0.0498805

sum(getRefit(se_meso_up_core_prot))/2 #21274

se_meso_up_core_prot$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_up_core_prot <- getRefit(se_meso_up_core_prot)
table(as.numeric(adj_mat_meso_up_core_prot))

se_beta_meso_up_core_prot <- as.matrix(symBeta(getOptBeta(se_meso_up_core_prot)))
weighted_adj_meso_up_core_prot <- se_beta_meso_up_core_prot*adj_mat_meso_up_core_prot

ig2_meso_up_core_prot <- adj2igraph(weighted_adj_meso_up_core_prot)
V(ig2_meso_up_core_prot)$name <- taxa_names(prot_phy_meso_up_core) # only need prot here

graph_components <- components(ig2_meso_up_core_prot)
graph_components$csize

plot(density((E(ig2_meso_up_core_prot)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_up_core_prot)$weight)~(E(ig2_meso_up_core_prot)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_meso_up_core_prot <- ig2_meso_up_core_prot

# create a category for weights
E(grph_all_meso_up_core_prot)$weight_value[E(grph_all_meso_up_core_prot)$weight<0] <- "negative"
E(grph_all_meso_up_core_prot)$weight_value[E(grph_all_meso_up_core_prot)$weight>0] <- "positive"
E(grph_all_meso_up_core_prot)$weight_value[E(grph_all_meso_up_core_prot)$weight==0] <- "neutral" # don't think we have any of these

# let's convert the edges to positive numbers so that we can plot...
E(grph_all_meso_up_core_prot)$weight <- abs(E(grph_all_meso_up_core_prot)$weight)

# plot
plot(grph_all_meso_up_core_prot, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_all_meso_up_core_prot))
# set weight threshold
V(grph_all_meso_up_core_prot) # vertices
E(grph_all_meso_up_core_prot) # edges
gsize(grph_all_meso_up_core_prot)

plot(density((E(grph_all_meso_up_core_prot)$weight)),xlab="Edge Weight",main="")
boxplot(abs(E(grph_all_meso_up_core_prot)$weight)~(E(grph_all_meso_up_core_prot)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

# histograph of weights
hist(E(grph_all_meso_up_core_prot)$weight, main="Histogram of weight")

modules_meso_up_core_prot = cluster_leading_eigen(grph_all_meso_up_core_prot, weights = NA)
print(modules_meso_up_core_prot) # modularity = 0.2085424; groups = 3
modularity(modules_meso_up_core_prot)
class(modules_meso_up_core_prot)
deg_meso_up_core_prot <- igraph::degree(grph_all_meso_up_core_prot)

# histogram node degree
hist(deg_meso_up_core_prot, main="Histogram of node degree")

# betweenness
btwn_meso_up_core_prot <- betweenness(grph_all_meso_up_core_prot, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_up_core_prot) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_up_core_prot)[1] <- "betweenness"
head(btwn_meso_up_core_prot) # Nodes with higher betweenness centrality sprots are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_up_core_prot %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_up_core_prot_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_up_core_prot_df)

is_connected(grph_all_meso_up_core_prot) # TRUE = strongly connected
count_components(grph_all_meso_up_core_prot) # just one component
components(grph_all_meso_up_core_prot)

#v_con_meso_up_core_prot <- vertex_connectivity(grph_all_meso_up_core_prot) # 4
v_con_meso_up_core_prot # 4
e_con_meso_up_core_prot <- edge_connectivity(grph_all_meso_up_core_prot) # 4
e_con_meso_up_core_prot # 4

edge_density_meso_up_core_prot <- edge_density(grph_all_meso_up_core_prot)
edge_density_meso_up_core_prot
avg_path_length_meso_up_core_prot <- mean_distance(grph_all_meso_up_core_prot, weights = NA, directed = FALSE)
avg_path_length_meso_up_core_prot


v.cent.meso.up.core.prot <- robustness(grph_all_meso_up_core_prot, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.up.core.prot
v.deg.meso.up.core.prot <- robustness(grph_all_meso_up_core_prot, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.up.core.prot
#v.random.meso.up.core.prot <- robustness_random(grph_all_meso_up_core_prot, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.up.core.prot


```

```{r plot-meso-up-core-prot, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_all_meso_up_core_prot, layout = igraph::with_fr())

set.seed(123)
meso_up_core_prot_df <- ggnetwork(grph_all_meso_up_core_prot, layout = igraph::with_fr())
head(meso_up_core_prot_df)
tail(meso_up_core_prot_df)
class(meso_up_core_prot_df) # this is a dataframe!

# let's add taxa
meso_up_core_prot_df$taxa <- ifelse(startsWith(meso_up_core_prot_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_up_core_prot_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_up_core_prot_df)
tail(meso_up_core_prot_df)

# let's add in membership
member <- modules_meso_up_core_prot$membership
name <- modules_meso_up_core_prot$names
mod_meso_up_core_prot_df <- cbind(name, member) %>% data.frame()
head(mod_meso_up_core_prot_df)
tail(mod_meso_up_core_prot_df)
class(mod_meso_up_core_prot_df)

meso_up_core_prot_df <- left_join(meso_up_core_prot_df, mod_meso_up_core_prot_df, by = "name")
head(meso_up_core_prot_df)
tail(meso_up_core_prot_df)

# Add in taxa
colnames(meso_up_core_prot_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_up_core_prot_df_tax <- meso_up_core_prot_df %>%
  left_join(tax_short, by = "OTUid")
head(meso_up_core_prot_df_tax)

#let's add in degree
deg_meso_up_core_prot <- igraph::degree(grph_all_meso_up_core_prot) %>% as.data.frame()
head(deg_meso_up_core_prot)
colnames(deg_meso_up_core_prot)[1] <- "degree"
rownames(deg_meso_up_core_prot)
deg_meso_up_core_prot$OTUid <- rownames(deg_meso_up_core_prot)
deg_meso_up_core_prot <- select(deg_meso_up_core_prot, OTUid, degree)
head(deg_meso_up_core_prot)
unique(meso_up_core_prot_df_tax$TAX_SHORT)
head(meso_up_core_prot_df_tax)

meso_up_core_prot_df_tax <- left_join(meso_up_core_prot_df_tax, deg_meso_up_core_prot, by = "OTUid")
head(meso_up_core_prot_df_tax)

meso_up_core_prot_df_tax <- left_join(meso_up_core_prot_df_tax, btwn_meso_up_core_prot_df, by = "OTUid")
head(meso_up_core_prot_df_tax)

member_count <- mod_meso_up_core_prot_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_up_core_prot_df_tax$member <- factor(meso_up_core_prot_df_tax$member, levels = 1:12)
meso_up_core_prot_df_tax <- meso_up_core_prot_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists", "Invertebrates", "Vertebrates"))

head(meso_up_core_prot_df_tax)
tail(meso_up_core_prot_df_tax)
write.csv(meso_up_core_prot_df_tax, "./ggnetwork-inputs/ggnetwork_meso_up_inputs_core_prot.csv")

meso_up_core_prot_node <- ggplot(meso_up_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
#  geom_edges(color = "black", linewidth = 0.1, alpha = 0.05, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_up_core_prot_node

meso_up_core_prot_inter <- ggplot(meso_up_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(color = weight_value), linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = c("#0065ff", "#ff0065")) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))

meso_up_core_prot_node_blkbg <- ggplot(meso_up_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 3, alpha = 0.75, color = "black", stroke = 0.3) +
  labs(title = NULL,
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors[c(1)]) + 
    theme_custom_ppt_blkbg() + theme(panel.border = element_blank(),
                                 legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_up_core_prot_node_blkbg

#ggsave("./network-plots/meso_up_core_prot_node_blkbg.pdf", plot = meso_up_core_prot_node_blkbg, height = 3.25, width = 3.25, units = "in", dpi=300)

meso_up_core_prot_inter

meso_up_core_prot_plot_mod <- ggplot(meso_up_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Upper Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + 
  theme(panel.border = element_rect(linewidth = 0.5),
    legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
meso_up_core_prot_plot_mod

```

```{r meso-up-core-prot-stats, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_up_core_prot_df_tax)

meso_up_core_prot_stats_df <- meso_up_core_prot_df_tax %>% 
  select(OTUid, weight_value, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_up_core_prot_stats_df)

meso_up_degree_prot_df <- meso_up_core_prot_stats_df %>% select(-weight_value) %>% unique() %>% arrange(desc(degree)) 

meso_up_degree_prot_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_up_degree_prot_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_up_degree_prot_df %>% unique() %>% arrange(desc(degree))), n = 10)

meso_up_degree_df_prot <- meso_up_degree_prot_df %>% filter(taxa == "Protists") %>% unique() %>% arrange(desc(degree)) 
head(meso_up_degree_df_prot, n = 10)

meso_up_mod_prot <- meso_up_core_prot_stats_df %>% select(OTUid, taxa, TAX_SHORT, member) %>% unique() %>%
  group_by(TAX_SHORT, member) %>%
  mutate(sum_OTU = n()) %>% 
  select(-OTUid) %>% unique() %>%
  ungroup()

head(meso_up_mod_prot)

meso_up_mod_prot$TAX_SHORT = forcats::fct_rev(factor(meso_up_mod_prot$TAX_SHORT)) #arrange terms in alphabetical order

meso_up_prot_dotplot <- ggplot(data = meso_up_mod_prot, aes(x = as.factor(member), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_up_prot_dotplot

```

### 4.2.4. Meso - Up - Core - Metazoans

```{r analysis-meso-up-core-met-fish, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_up_core_met_fish) # 0.04584395

sum(getRefit(se_meso_up_core_met_fish))/2 #53

se_meso_up_core_met_fish$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_up_core_met_fish <- getRefit(se_meso_up_core_met_fish)
table(as.numeric(adj_mat_meso_up_core_met_fish))

se_beta_meso_up_core_met_fish <- as.matrix(symBeta(getOptBeta(se_meso_up_core_met_fish)))
weighted_adj_meso_up_core_met_fish <- se_beta_meso_up_core_met_fish*adj_mat_meso_up_core_met_fish

merged_physeq_meso_up_core_met_fish = merge_phyloseq(met_phy_meso_up_core, fish_phy_meso_up_core)
merged_physeq_meso_up_core_met_fish

ig2_meso_up_core_met_fish <- adj2igraph(weighted_adj_meso_up_core_met_fish)
V(ig2_meso_up_core_met_fish)$name <- taxa_names(merged_physeq_meso_up_core_met_fish) # only need met_fish here

graph_components <- components(ig2_meso_up_core_met_fish)
graph_components$csize

plot(density((E(ig2_meso_up_core_met_fish)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_up_core_met_fish)$weight)~(E(ig2_meso_up_core_met_fish)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_meso_up_core_met_fish <- ig2_meso_up_core_met_fish

# create a category for weights
E(grph_all_meso_up_core_met_fish)$weight_value[E(grph_all_meso_up_core_met_fish)$weight<0] <- "negative"
E(grph_all_meso_up_core_met_fish)$weight_value[E(grph_all_meso_up_core_met_fish)$weight>0] <- "positive"
E(grph_all_meso_up_core_met_fish)$weight_value[E(grph_all_meso_up_core_met_fish)$weight==0] <- "neutral" # don't think we have any of these

# let's convert the edges to positive numbers so that we can plot...
E(grph_all_meso_up_core_met_fish)$weight <- abs(E(grph_all_meso_up_core_met_fish)$weight)

# plot
plot(grph_all_meso_up_core_met_fish, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_all_meso_up_core_met_fish))
# set weight threshold
V(grph_all_meso_up_core_met_fish) # vertices
E(grph_all_meso_up_core_met_fish) # edges
gsize(grph_all_meso_up_core_met_fish)

#dev.new()
plot(density((E(grph_all_meso_up_core_met_fish)$weight)),xlab="Edge Weight",main="")
boxplot(abs(E(grph_all_meso_up_core_met_fish)$weight)~(E(grph_all_meso_up_core_met_fish)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

# histograph of weights
hist(E(grph_all_meso_up_core_met_fish)$weight, main="Histogram of weight")

modules_meso_up_core_met_fish = cluster_leading_eigen(grph_all_meso_up_core_met_fish, weights = NA)
print(modules_meso_up_core_met_fish) # modularity = 0.83; groups = 10
modularity(modules_meso_up_core_met_fish)
class(modules_meso_up_core_met_fish)
deg_meso_up_core_met_fish <- igraph::degree(grph_all_meso_up_core_met_fish)

# histogram node degree
hist(deg_meso_up_core_met_fish, main="Histogram of node degree")

# betweenness
btwn_meso_up_core_met_fish <- betweenness(grph_all_meso_up_core_met_fish, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_up_core_met_fish) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_up_core_met_fish)[1] <- "betweenness"
head(btwn_meso_up_core_met_fish) # Nodes with higher betweenness centrality smet_fishs are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_up_core_met_fish %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_up_core_met_fish_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_up_core_met_fish_df)


is_connected(grph_all_meso_up_core_met_fish) # 
count_components(grph_all_meso_up_core_met_fish) # 
components(grph_all_meso_up_core_met_fish)
v_con_meso_up_core_met_fish <- vertex_connectivity(grph_all_meso_up_core_met_fish) # 0
v_con_meso_up_core_met_fish
e_con_meso_up_core_met_fish <- edge_connectivity(grph_all_meso_up_core_met_fish) # 0
e_con_meso_up_core_met_fish

edge_density_meso_up_core_met_fish <- edge_density(grph_all_meso_up_core_met_fish)
edge_density_meso_up_core_met_fish
avg_path_length_meso_up_core_met_fish <- mean_distance(grph_all_meso_up_core_met_fish, weights = NA, directed = FALSE)
avg_path_length_meso_up_core_met_fish

v.cent.meso.up.core.met.fish <- robustness(grph_all_meso_up_core_met_fish, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.up.core.met.fish
v.deg.meso.up.core.met.fish <- robustness(grph_all_meso_up_core_met_fish, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.up.core.met.fish
v.random.meso.up.core.met.fish <- robustness_random(grph_all_meso_up_core_met_fish, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.up.core.met.fish

```

```{r plot-meso-up-core-met-fish, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_all_meso_up_core_met_fish, layout = igraph::with_fr())

set.seed(123)
meso_up_core_met_fish_df <- ggnetwork(grph_all_meso_up_core_met_fish, layout = igraph::with_fr())
head(meso_up_core_met_fish_df)
tail(meso_up_core_met_fish_df)
class(meso_up_core_met_fish_df) # this is a dataframe!

# let's add taxa
meso_up_core_met_fish_df$taxa <- ifelse(startsWith(meso_up_core_met_fish_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_up_core_met_fish_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_up_core_met_fish_df)
tail(meso_up_core_met_fish_df)

# let's add in membership
member <- modules_meso_up_core_met_fish$membership
name <- modules_meso_up_core_met_fish$names
mod_meso_up_core_met_fish_df <- cbind(name, member) %>% data.frame()
head(mod_meso_up_core_met_fish_df)
tail(mod_meso_up_core_met_fish_df)
class(mod_meso_up_core_met_fish_df)

meso_up_core_met_fish_df <- left_join(meso_up_core_met_fish_df, mod_meso_up_core_met_fish_df, by = "name")
head(meso_up_core_met_fish_df)
tail(meso_up_core_met_fish_df)

# I think we can add in taxa?
colnames(meso_up_core_met_fish_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "300-500") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_up_core_met_fish_df_tax <- meso_up_core_met_fish_df %>%
  left_join(tax_short, by = "OTUid")
head(meso_up_core_met_fish_df_tax)

#let's add in degree
deg_meso_up_core_met_fish <- igraph::degree(grph_all_meso_up_core_met_fish) %>% as.data.frame()
head(deg_meso_up_core_met_fish)
colnames(deg_meso_up_core_met_fish)[1] <- "degree"
rownames(deg_meso_up_core_met_fish)
deg_meso_up_core_met_fish$OTUid <- rownames(deg_meso_up_core_met_fish)
deg_meso_up_core_met_fish <- select(deg_meso_up_core_met_fish, OTUid, degree)
head(deg_meso_up_core_met_fish)
unique(meso_up_core_met_fish_df_tax$TAX_SHORT)
head(meso_up_core_met_fish_df_tax)

meso_up_core_met_fish_df_tax <- left_join(meso_up_core_met_fish_df_tax, deg_meso_up_core_met_fish, by = "OTUid")
head(meso_up_core_met_fish_df_tax)

meso_up_core_met_fish_df_tax <- left_join(meso_up_core_met_fish_df_tax, btwn_meso_up_core_met_fish_df, by = "OTUid")
head(meso_up_core_met_fish_df_tax)

member_count <- mod_meso_up_core_met_fish_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_up_core_met_fish_df_tax$member <- factor(meso_up_core_met_fish_df_tax$member, levels = 1:12)
meso_up_core_met_fish_df_tax <- meso_up_core_met_fish_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Invertebrates", "Vertebrates"))

head(meso_up_core_met_fish_df_tax)
tail(meso_up_core_met_fish_df_tax)
write.csv(meso_up_core_met_fish_df_tax, "./ggnetwork-inputs/ggnetwork_meso_up_inputs_core_met_fish.csv")

meso_up_core_met_fish_node <- ggplot(meso_up_core_met_fish_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(color = "black", linewidth = 0.1, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors[c(2,3)]) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_up_core_met_fish_node

meso_up_core_met_fish_node_blkbg <- ggplot(meso_up_core_met_fish_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(color = "white", linewidth = 0.5, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 3, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = NULL,
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors[c(2,3)]) + 
    theme_custom_ppt_blkbg() + theme(panel.border = element_blank(),
                                 legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_up_core_met_fish_node_blkbg

#ggsave("./network-plots/meso_up_core_met_fish_node_blkbg.pdf", plot =  meso_up_core_met_fish_node_blkbg, height = 3.25, width = 3.25, units = "in", dpi=300)

meso_up_core_met_fish_inter <- ggplot(meso_up_core_met_fish_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(color = weight_value), linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = c("#0065ff", "#ff0065")) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
meso_up_core_met_fish_inter

```

```{r meso-up-core-met-fish-stats, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_up_core_met_fish_df_tax)

meso_up_core_met_fish_stats_df <- meso_up_core_met_fish_df_tax %>% 
  select(OTUid, weight_value, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_up_core_met_fish_stats_df)

meso_up_degree_met_fish_df <- meso_up_core_met_fish_stats_df %>% select(-weight_value) %>% unique() %>% arrange(desc(degree)) 

meso_up_degree_met_fish_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_up_degree_met_fish_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_up_degree_met_fish_df %>% unique() %>% arrange(desc(degree))), n = 10)
meso_up_degree_df_met_fish <- meso_up_degree_met_fish_df %>% unique() %>% arrange(desc(degree)) 
head(meso_up_degree_df_met_fish, n = 10)

meso_up_mod_met_fish <- meso_up_core_met_fish_stats_df %>% select(OTUid, taxa, TAX_SHORT, member) %>% unique() %>%
  group_by(TAX_SHORT, member) %>%
  mutate(sum_OTU = n()) %>% 
  select(-OTUid) %>% unique() %>%
  ungroup()

head(meso_up_mod_met_fish)

meso_up_mod_met_fish$TAX_SHORT = forcats::fct_rev(factor(meso_up_mod_met_fish$TAX_SHORT)) #arrange terms in alphabetical order

meso_up_met_fish_dotplot <- ggplot(data = meso_up_mod_met_fish, aes(x = as.factor(member), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors[c(2,3)]) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_up_met_fish_dotplot

```

### 4.2.5. Meso - Low - Core - Protists

```{r analysis-meso-low-core-prot, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_low_core_prot) # 0.04993142

sum(getRefit(se_meso_low_core_prot))/2 #19619

se_meso_low_core_prot$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_low_core_prot <- getRefit(se_meso_low_core_prot)
table(as.numeric(adj_mat_meso_low_core_prot))

se_beta_meso_low_core_prot <- as.matrix(symBeta(getOptBeta(se_meso_low_core_prot)))
weighted_adj_meso_low_core_prot <- se_beta_meso_low_core_prot*adj_mat_meso_low_core_prot

ig2_meso_low_core_prot <- adj2igraph(weighted_adj_meso_low_core_prot)
V(ig2_meso_low_core_prot)$name <- taxa_names(prot_phy_meso_low_core) # only need prot here

graph_components <- components(ig2_meso_low_core_prot)
graph_components$csize

plot(density((E(ig2_meso_low_core_prot)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_low_core_prot)$weight)~(E(ig2_meso_low_core_prot)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_meso_low_core_prot <- ig2_meso_low_core_prot

# create a category for weights
E(grph_all_meso_low_core_prot)$weight_value[E(grph_all_meso_low_core_prot)$weight<0] <- "negative"
E(grph_all_meso_low_core_prot)$weight_value[E(grph_all_meso_low_core_prot)$weight>0] <- "positive"
E(grph_all_meso_low_core_prot)$weight_value[E(grph_all_meso_low_core_prot)$weight==0] <- "neutral" # don't think we have any of these

# let's convert the edges to positive numbers so that we can plot...
E(grph_all_meso_low_core_prot)$weight <- abs(E(grph_all_meso_low_core_prot)$weight)

# plot
plot(grph_all_meso_low_core_prot, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_all_meso_low_core_prot))
# set weight threshold
V(grph_all_meso_low_core_prot) # vertices
E(grph_all_meso_low_core_prot) # edges
gsize(grph_all_meso_low_core_prot)

plot(density((E(grph_all_meso_low_core_prot)$weight)),xlab="Edge Weight",main="")
boxplot(abs(E(grph_all_meso_low_core_prot)$weight)~(E(grph_all_meso_low_core_prot)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

# histograph of weights
hist(E(grph_all_meso_low_core_prot)$weight, main="Histogram of weight")

modules_meso_low_core_prot = cluster_leading_eigen(grph_all_meso_low_core_prot, weights = NA)
print(modules_meso_low_core_prot) # modularity = 0.46; groups = 7
modularity(modules_meso_low_core_prot)
class(modules_meso_low_core_prot)
deg_meso_low_core_prot <- igraph::degree(grph_all_meso_low_core_prot)

# histogram node degree
hist(deg_meso_low_core_prot, main="Histogram of node degree")

# betweenness
btwn_meso_low_core_prot <- betweenness(grph_all_meso_low_core_prot, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_low_core_prot) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_low_core_prot)[1] <- "betweenness"
head(btwn_meso_low_core_prot) # Nodes with higher betweenness centrality sprots are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_low_core_prot %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_low_core_prot_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_low_core_prot_df)

is_connected(grph_all_meso_low_core_prot) # TRUE = strongly connected
count_components(grph_all_meso_low_core_prot) # just one component
components(grph_all_meso_low_core_prot)

#v_con_meso_low_core_prot <- vertex_connectivity(grph_all_meso_low_core_prot)
v_con_meso_low_core_prot # 10
e_con_meso_low_core_prot <- edge_connectivity(grph_all_meso_low_core_prot)
e_con_meso_low_core_prot # 10

edge_density_meso_low_core_prot <- edge_density(grph_all_meso_low_core_prot)
edge_density_meso_low_core_prot #
avg_path_length_meso_low_core_prot <- mean_distance(grph_all_meso_low_core_prot, weights = NA, directed = FALSE)
avg_path_length_meso_low_core_prot

v.cent.meso.low.core.prot <- robustness(grph_all_meso_low_core_prot, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.low.core.prot
v.deg.meso.low.core.prot <- robustness(grph_all_meso_low_core_prot, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.low.core.prot

#v.random.meso.low.core.prot <- robustness_random(grph_all_meso_low_core_prot, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.low.core.prot


```

```{r plot-meso-low-core-prot, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_all_meso_low_core_prot, layout = igraph::with_fr())

set.seed(123)
meso_low_core_prot_df <- ggnetwork(grph_all_meso_low_core_prot, layout = igraph::with_fr())
head(meso_low_core_prot_df)
tail(meso_low_core_prot_df)
class(meso_low_core_prot_df) # this is a dataframe!

# let's add taxa
meso_low_core_prot_df$taxa <- ifelse(startsWith(meso_low_core_prot_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_low_core_prot_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_low_core_prot_df)
tail(meso_low_core_prot_df)

# let's add in membership
member <- modules_meso_low_core_prot$membership
name <- modules_meso_low_core_prot$names
mod_meso_low_core_prot_df <- cbind(name, member) %>% data.frame()
head(mod_meso_low_core_prot_df)
tail(mod_meso_low_core_prot_df)
class(mod_meso_low_core_prot_df)

meso_low_core_prot_df <- left_join(meso_low_core_prot_df, mod_meso_low_core_prot_df, by = "name")
head(meso_low_core_prot_df)
tail(meso_low_core_prot_df)

# I think we can add in taxa?
colnames(meso_low_core_prot_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()


tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_low_core_prot_df_tax <- meso_low_core_prot_df %>%
  left_join(tax_short, by = "OTUid")
head(meso_low_core_prot_df_tax)

#let's add in degree
deg_meso_low_core_prot <- igraph::degree(grph_all_meso_low_core_prot) %>% as.data.frame()
head(deg_meso_low_core_prot)
colnames(deg_meso_low_core_prot)[1] <- "degree"
rownames(deg_meso_low_core_prot)
deg_meso_low_core_prot$OTUid <- rownames(deg_meso_low_core_prot)
deg_meso_low_core_prot <- select(deg_meso_low_core_prot, OTUid, degree)
head(deg_meso_low_core_prot)
unique(meso_low_core_prot_df_tax$TAX_SHORT)
head(meso_low_core_prot_df_tax)

meso_low_core_prot_df_tax <- left_join(meso_low_core_prot_df_tax, deg_meso_low_core_prot, by = "OTUid")
head(meso_low_core_prot_df_tax)

meso_low_core_prot_df_tax <- left_join(meso_low_core_prot_df_tax, btwn_meso_low_core_prot_df, by = "OTUid")
head(meso_low_core_prot_df_tax)

member_count <- mod_meso_low_core_prot_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_low_core_prot_df_tax$member <- factor(meso_low_core_prot_df_tax$member, levels = 1:12)
meso_low_core_prot_df_tax <- meso_low_core_prot_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Protists"))

head(meso_low_core_prot_df_tax)
tail(meso_low_core_prot_df_tax)
write.csv(meso_low_core_prot_df_tax, "./ggnetwork-inputs/ggnetwork_meso_low_inputs_core_prot.csv")

meso_low_core_prot_node <- ggplot(meso_low_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
#  geom_edges(color = "black", linewidth = 0.1, alpha = 0.05, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_low_core_prot_node


meso_low_core_prot_node_blkbg <- ggplot(meso_low_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_nodes(aes(fill = taxa), shape = 21, size = 3, alpha = 0.75, color = "black", stroke = 0.3) +
  labs(title = NULL,
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors[c(1)]) + 
    theme_custom_ppt_blkbg() + theme(panel.border = element_blank(),
                                 legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_low_core_prot_node_blkbg

#ggsave("./network-plots/meso_low_core_prot_node_blkbg.pdf", plot = meso_low_core_prot_node_blkbg, height = 3.25, width = 3.25, units = "in", dpi=300)


meso_low_core_prot_inter <- ggplot(meso_low_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(color = weight_value), linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = c("#0065ff", "#ff0065")) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
meso_low_core_prot_inter

meso_low_core_prot_plot_mod <- ggplot(meso_low_core_prot_df_tax, aes(x, y, xend = xend, yend = yend)) + 
   geom_nodes(aes(fill = member), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) + 
    labs(title = "Lower Mesopelagic",
       x = NULL, 
       y = NULL) +
  scale_shape_manual(values = c(23, 21, 24)) +
  scale_fill_manual(values = mod_colors) +
  theme_custom_paper() + 
  theme(panel.border = element_rect(linewidth = 0.5),
    legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) + 
      guides(fill = guide_legend(title="Module",
                                 nrow = 1,
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
  
meso_low_core_prot_plot_mod

```

```{r meso-low-core-prot-stats, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_low_core_prot_df_tax)

meso_low_core_prot_stats_df <- meso_low_core_prot_df_tax %>% 
  select(OTUid, weight_value, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_low_core_prot_stats_df)

meso_low_degree_prot_df <- meso_low_core_prot_stats_df %>% select(-weight_value) %>% unique() %>% arrange(desc(degree)) 

meso_low_degree_prot_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_low_degree_prot_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_low_degree_prot_df %>% unique() %>% arrange(desc(degree))), n = 10)

meso_low_degree_df_prot <- meso_low_degree_prot_df %>% filter(taxa == "Protists") %>% unique() %>% arrange(desc(degree)) 
head(meso_low_degree_df_prot, n = 10)

meso_low_mod_prot <- meso_low_core_prot_stats_df %>% select(OTUid, taxa, TAX_SHORT, member) %>% unique() %>%
  group_by(TAX_SHORT, member) %>%
  mutate(sum_OTU = n()) %>% 
  select(-OTUid) %>% unique() %>%
  ungroup()

head(meso_low_mod_prot)

meso_low_mod_prot$TAX_SHORT = forcats::fct_rev(factor(meso_low_mod_prot$TAX_SHORT)) #arrange terms in alphabetical order

meso_low_prot_dotplot <- ggplot(data = meso_low_mod_prot, aes(x = as.factor(member), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_low_prot_dotplot

```

### 4.2.6. Meso - Low - Core - Metazoans

```{r analysis-meso-low-core-met-fish, eval = TRUE, message = FALSE, warning = FALSE}

#Check output 
getStability(se_meso_low_core_met_fish) # 0.04396768

sum(getRefit(se_meso_low_core_met_fish))/2 #41

se_meso_low_core_met_fish$select$stars$summary

## Extract adjaency matrix
adj_mat_meso_low_core_met_fish <- getRefit(se_meso_low_core_met_fish)
table(as.numeric(adj_mat_meso_low_core_met_fish))

se_beta_meso_low_core_met_fish <- as.matrix(symBeta(getOptBeta(se_meso_low_core_met_fish)))
weighted_adj_meso_low_core_met_fish <- se_beta_meso_low_core_met_fish*adj_mat_meso_low_core_met_fish

merged_physeq_meso_low_core_met_fish = merge_phyloseq(met_phy_meso_low_core, fish_phy_meso_low_core)
merged_physeq_meso_low_core_met_fish # 83 x 22

ig2_meso_low_core_met_fish <- adj2igraph(weighted_adj_meso_low_core_met_fish)
V(ig2_meso_low_core_met_fish)$name <- taxa_names(merged_physeq_meso_low_core_met_fish) # only need met_fish here

graph_components <- components(ig2_meso_low_core_met_fish)
graph_components$csize

plot(density((E(ig2_meso_low_core_met_fish)$weight)),xlab="Edge Weight",main="")

boxplot(abs(E(ig2_meso_low_core_met_fish)$weight)~(E(ig2_meso_low_core_met_fish)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

grph_all_meso_low_core_met_fish <- ig2_meso_low_core_met_fish

# create a category for weights
E(grph_all_meso_low_core_met_fish)$weight_value[E(grph_all_meso_low_core_met_fish)$weight<0] <- "negative"
E(grph_all_meso_low_core_met_fish)$weight_value[E(grph_all_meso_low_core_met_fish)$weight>0] <- "positive"
E(grph_all_meso_low_core_met_fish)$weight_value[E(grph_all_meso_low_core_met_fish)$weight==0] <- "neutral" # don't think we have any of these

# let's convert the edges to positive numbers so that we can plot...
E(grph_all_meso_low_core_met_fish)$weight <- abs(E(grph_all_meso_low_core_met_fish)$weight)

# plot
plot(grph_all_meso_low_core_met_fish, edge_width = 0.1, vertex.size = 3, vertex.label=NA, layout = layout_with_fr(grph_all_meso_low_core_met_fish))
# set weight threshold
V(grph_all_meso_low_core_met_fish) # vertices
E(grph_all_meso_low_core_met_fish) # edges
gsize(grph_all_meso_low_core_met_fish)

dev.new()
plot(density((E(grph_all_meso_low_core_met_fish)$weight)),xlab="Edge Weight",main="")
boxplot(abs(E(grph_all_meso_low_core_met_fish)$weight)~(E(grph_all_meso_low_core_met_fish)$weight>0),
        xlab="Negative Interaction?",
        ylab="Strength of Interaction")

# histograph of weights
hist(E(grph_all_meso_low_core_met_fish)$weight, main="Histogram of weight")

modules_meso_low_core_met_fish = cluster_leading_eigen(grph_all_meso_low_core_met_fish, weights = NA)
print(modules_meso_low_core_met_fish) # modularity = 0.7242513; groups = 34
modularity(modules_meso_low_core_met_fish)
class(modules_meso_low_core_met_fish)
deg_meso_low_core_met_fish <- igraph::degree(grph_all_meso_low_core_met_fish)

# histogram node degree
hist(deg_meso_low_core_met_fish, main="Histogram of node degree")

# betweenness
btwn_meso_low_core_met_fish <- betweenness(grph_all_meso_low_core_met_fish, directed=F, weights=NA) %>% data.frame()
head(btwn_meso_low_core_met_fish) # Betweenness centrality is a measure of a node's centrality in a network, capturing the extent to which a node lies on paths between other nodes. Specifically, it quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.
colnames(btwn_meso_low_core_met_fish)[1] <- "betweenness"
head(btwn_meso_low_core_met_fish) # Nodes with higher betweenness centrality smet_fishs are those that frequently appear on the shortest paths between other nodes. It is a measure of the node's importance in facilitating communication or connectivity across the network. They are crucial for the connectivity and efficiency of the network, as they connect different parts of the network.

betweenness <- btwn_meso_low_core_met_fish %>% as.data.frame()
dim(betweenness)
head(betweenness)
betweenness$OTUid <- rownames(betweenness)
rownames(betweenness) <- NULL
btwn_meso_low_core_met_fish_df <- betweenness %>% select(OTUid, betweenness)

head(btwn_meso_low_core_met_fish_df)

is_connected(grph_all_meso_low_core_met_fish) # FALSE = strongly connected
count_components(grph_all_meso_low_core_met_fish) # just one component
components(grph_all_meso_low_core_met_fish)
v_con_meso_low_core_met_fish <- vertex_connectivity(grph_all_meso_low_core_met_fish) # 0
e_con_meso_low_core_met_fish <- edge_connectivity(grph_all_meso_low_core_met_fish) # 0

edge_density_meso_low_core_met_fish <- edge_density(grph_all_meso_low_core_met_fish)
edge_density_meso_low_core_met_fish
avg_path_length_meso_low_core_met_fish <- mean_distance(grph_all_meso_low_core_met_fish, weights = NA, directed = FALSE)
avg_path_length_meso_low_core_met_fish

v.cent.meso.low.core.met.fish <- robustness(grph_all_meso_low_core_met_fish, type = c("vertex"), measure = c("btwn.cent"), N = 1000)
v.cent.meso.low.core.met.fish
v.deg.meso.low.core.met.fish <- robustness(grph_all_meso_low_core_met_fish, type = c("vertex"), measure = c("degree"), N = 1000)
v.deg.meso.low.core.met.fish

v.random.meso.low.core.met.fish <- robustness_random(grph_all_meso_low_core_met_fish, type = c("vertex"), measure = c("random"), N = 1000)
v.random.meso.low.core.met.fish

```

```{r plot-meso-low-core-met-fish, eval = TRUE, message = FALSE, warning = FALSE}

ggnetwork(grph_all_meso_low_core_met_fish, layout = igraph::with_fr())

set.seed(123)
meso_low_core_met_fish_df <- ggnetwork(grph_all_meso_low_core_met_fish, layout = igraph::with_fr())
head(meso_low_core_met_fish_df)
tail(meso_low_core_met_fish_df)
class(meso_low_core_met_fish_df) # this is a dataframe!

# let's add taxa
meso_low_core_met_fish_df$taxa <- ifelse(startsWith(meso_low_core_met_fish_df$name, "p"), "Protists",
                      ifelse(startsWith(meso_low_core_met_fish_df$name, "f"), "Vertebrates", "Invertebrates"))

head(meso_low_core_met_fish_df)
tail(meso_low_core_met_fish_df)

# let's add in membership
member <- modules_meso_low_core_met_fish$membership
name <- modules_meso_low_core_met_fish$names
mod_meso_low_core_met_fish_df <- cbind(name, member) %>% data.frame()
head(mod_meso_low_core_met_fish_df)
tail(mod_meso_low_core_met_fish_df)
class(mod_meso_low_core_met_fish_df)

meso_low_core_met_fish_df <- left_join(meso_low_core_met_fish_df, mod_meso_low_core_met_fish_df, by = "name")
head(meso_low_core_met_fish_df)
tail(meso_low_core_met_fish_df)

# I think we can add in taxa?
colnames(meso_low_core_met_fish_df)[3] <- "OTUid"

prot_tax <- melt_prot_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

met_tax <-  melt_met_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

fish_tax <- melt_fish_tax %>% select(OTUid, Abundance, TAX_SHORT, depth_group) %>% 
  filter(depth_group == "800-1000") %>%
  filter(Abundance > 0) %>% 
  select(-Abundance) %>%
#  mutate(tax_abund = sum(Abundance)) %>% # calculate the abundance total for each taxa
#  group_by(OTUid) %>%
#  mutate(relabun = Abundance / tax_abund * 100) %>% 
  ungroup() %>% 
  unique()

tax_short <- rbind(prot_tax, met_tax, fish_tax)
head(tax_short)

meso_low_core_met_fish_df_tax <- meso_low_core_met_fish_df %>%
  left_join(tax_short, by = "OTUid")
head(meso_low_core_met_fish_df_tax)

#let's add in degree
deg_meso_low_core_met_fish <- igraph::degree(grph_all_meso_low_core_met_fish) %>% as.data.frame()
head(deg_meso_low_core_met_fish)
colnames(deg_meso_low_core_met_fish)[1] <- "degree"
rownames(deg_meso_low_core_met_fish)
deg_meso_low_core_met_fish$OTUid <- rownames(deg_meso_low_core_met_fish)
deg_meso_low_core_met_fish <- select(deg_meso_low_core_met_fish, OTUid, degree)
head(deg_meso_low_core_met_fish)
unique(meso_low_core_met_fish_df_tax$TAX_SHORT)
head(meso_low_core_met_fish_df_tax)

meso_low_core_met_fish_df_tax <- left_join(meso_low_core_met_fish_df_tax, deg_meso_low_core_met_fish, by = "OTUid")
head(meso_low_core_met_fish_df_tax)

meso_low_core_met_fish_df_tax <- left_join(meso_low_core_met_fish_df_tax, btwn_meso_low_core_met_fish_df, by = "OTUid")
head(meso_low_core_met_fish_df_tax)

member_count <- mod_meso_low_core_met_fish_df %>%
  group_by(member) %>%
  dplyr::count()

member_count

mod_colors <- c("#66C5CC","#F6CF71","#F89C74","#9EB9F3","#FE88B1","#87C55F")
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

meso_low_core_met_fish_df_tax$member <- factor(meso_low_core_met_fish_df_tax$member, levels = 1:12)
meso_low_core_met_fish_df_tax <- meso_low_core_met_fish_df_tax %>%
  mutate(taxa = fct_relevel(taxa, "Invertebrates", "Vertebrates"))

head(meso_low_core_met_fish_df_tax)
tail(meso_low_core_met_fish_df_tax)
write.csv(meso_low_core_met_fish_df_tax, "./ggnetwork-inputs/ggnetwork_meso_low_inputs_core_met_fish.csv")

meso_low_core_met_fish_node <- ggplot(meso_low_core_met_fish_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(color = "black", linewidth = 0.1, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 0.75, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = "Lower Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
    scale_fill_manual(values = taxa_colors[c(2,3)]) +  
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_low_core_met_fish_node

meso_low_core_met_fish_node_blkbg <- ggplot(meso_low_core_met_fish_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(color = "white", linewidth = 0.5, alpha = 0.75, curvature = 0.2) +
  geom_nodes(aes(fill = taxa), shape = 21, size = 3, alpha = 0.75, color = "black", stroke = 0.1) +
  labs(title = NULL,
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_fill_manual(values = taxa_colors[c(2,3)]) + 
    theme_custom_ppt_blkbg() + theme(panel.border = element_blank(),
                                 legend.position = "none",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(fill = guide_legend(title="Taxa",
                             override.aes = list(shape = 21,
                                                 alpha = 0.75,
                                                 size = 1.5,
                                                 stroke = 0.25)))
  
meso_low_core_met_fish_node_blkbg

#ggsave("./network-plots/meso_low_core_met_fish_node_blkbg.pdf", plot =  meso_low_core_met_fish_node_blkbg, height = 3.25, width = 3.25, units = "in", dpi=300)

meso_low_core_met_fish_inter <- ggplot(meso_low_core_met_fish_df_tax, aes(x, y, xend = xend, yend = yend)) + 
  geom_edges(aes(color = weight_value), linewidth = 0.1, alpha = 0.1, curvature = 0.2) +
  labs(title = "Upper Mesopelagic",
       x = NULL,
       y = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = c("#0065ff", "#ff0065")) + 
    theme_custom_paper() + theme(panel.border = element_rect(linewidth = 0.5),
                                 legend.position = "bottom",
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(), 
                                     axis.ticks.x = element_blank(),
                                     axis.ticks.y = element_blank(),
                                     axis.title.x = element_blank(),
                                     axis.title.y = element_blank(),
                               legend.title = element_text(size = 8),
                               legend.text = element_text(size = 8)) + 
  guides(color = guide_legend(title="Interactions",
                             override.aes = list(linewidth = 1,
                                                 alpha = 0.5)))
  
meso_low_core_met_fish_inter

```

```{r meso-low-core-met-fish-stats, eval = TRUE, message = FALSE, warning = FALSE}

head(meso_low_core_met_fish_df_tax)

meso_low_core_met_fish_stats_df <- meso_low_core_met_fish_df_tax %>% 
  select(OTUid, weight_value, taxa, member, TAX_SHORT, depth_group, degree, betweenness) %>%
#  select(-weight_value) %>% 
  unique()

head(meso_low_core_met_fish_stats_df)

meso_low_degree_met_fish_df <- meso_low_core_met_fish_stats_df %>% select(-weight_value) %>% unique() %>% arrange(desc(degree)) 

meso_low_degree_met_fish_df %>% 
  ggplot(aes(x=1, y = degree)) + 
  geom_jitter() + theme_light() 

meso_low_degree_met_fish_df %>% 
  ggplot(aes(x=degree)) + 
  geom_histogram(binwidth = 2) +
  coord_cartesian(xlim=c(0, 50))

head((meso_low_degree_met_fish_df %>% unique() %>% arrange(desc(degree))), n = 10)
meso_low_degree_df_met_fish <- meso_low_degree_met_fish_df %>% unique() %>% arrange(desc(degree)) 
head(meso_low_degree_df_met_fish, n = 10)

meso_low_mod_met_fish <- meso_low_core_met_fish_stats_df %>% select(OTUid, taxa, TAX_SHORT, member) %>% unique() %>%
  group_by(TAX_SHORT, member) %>%
  mutate(sum_OTU = n()) %>% 
  select(-OTUid) %>% unique() %>%
  ungroup()

head(meso_low_mod_met_fish)

meso_low_mod_met_fish$TAX_SHORT = forcats::fct_rev(factor(meso_low_mod_met_fish$TAX_SHORT)) #arrange terms in alphabetical order

meso_low_met_fish_dotplot <- ggplot(data = meso_low_mod_met_fish, aes(x = as.factor(member), y = TAX_SHORT)) + 
  geom_point(aes(size = sum_OTU, fill = taxa), color = "black", shape = 21) + 
  labs(title = NULL,
       x = NULL,
       y = NULL) +
#  facet_wrap(~taxa) + 
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = taxa_colors[c(2,3)]) + 
  guides(fill = guide_legend(title="Taxa"),
         size = guide_legend(title="ASV Count",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.grid.major = element_line(linewidth = 0.5, color = "grey", linetype = "dotted"),
    axis.text.x = element_text(colour = "black", size = 7),
    axis.text.y = element_text(colour = "black", size = 7),
    strip.text.x = element_text(size = 5, color = "black", face = "bold"),
    strip.background.x = element_rect(color = "black", fill = "#ededed", linewidth = 0.5, linetype = "solid"), 
    strip.background.y = element_rect(color = "white", fill = "white", linewidth = 0.5, linetype = "solid"))

meso_low_met_fish_dotplot

```

### 4.2.4. All Depths Combined

```{r analysis-panel-depth-core-taxa-save eval = TRUE, message = FALSE, warning = FALSE}

# save plot inputs
save(v_con_epi_core_prot, e_con_epi_core_prot, v_con_epi_core_met_fish, e_con_epi_core_met_fish, v_con_meso_up_core_prot, e_con_meso_up_core_prot, v_con_meso_up_core_met_fish, e_con_meso_up_core_met_fish, v_con_meso_low_core_prot, e_con_meso_low_core_prot, v_con_meso_low_core_met_fish, e_con_meso_low_core_met_fish, file = "./R-outputs/connectivity_calculations_taxa.RData")

load("./R-outputs/connectivity_calculations_taxa.RData", verbose = TRUE)

save(epi_core_prot_df_tax, epi_core_met_fish_df_tax, meso_up_core_prot_df_tax, meso_up_core_met_fish_df_tax, meso_low_core_prot_df_tax, meso_low_core_met_fish_df_tax, file = "./ggnetwork-inputs/ggnetwork_plot_inputs_core_taxa_20250410.RData")

save(v.random.epi.core.prot, v.random.meso.up.core.prot, v.random.meso.low.core.prot, v.deg.epi.core.prot, v.deg.meso.up.core.prot, v.deg.meso.low.core.prot, v.cent.epi.core.prot, v.cent.meso.up.core.prot, v.cent.meso.low.core.prot, file = "./R-outputs/robustness_prot.RData")

save(v.random.epi.core.met.fish, v.random.meso.up.core.met.fish, v.random.meso.low.core.met.fish, v.deg.epi.core.met.fish, v.deg.meso.up.core.met.fish, v.deg.meso.low.core.met.fish, v.cent.epi.core.met.fish, v.cent.meso.up.core.met.fish, v.cent.meso.low.core.met.fish, file = "./R-outputs/robustness_met_fish.RData")

```

```{r plot-panel-depth-core-taxa eval = TRUE, message = FALSE, warning = FALSE}

panel_node <- epi_core_prot_node + meso_up_core_prot_node + meso_low_core_prot_node +
  plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.50), 
        legend.key.spacing.x = unit(0.5, "mm"),
        legend.key.spacing.y = unit(-0.25, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 0)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 10, b = 0, l = 10), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 1)))

panel_node

#ggsave("./network-plots/depthsplit_network_panel_core_prot.pdf", plot = panel_node, height = 34, width = 80, units = "mm", dpi=300)

panel_mod <- epi_core_prot_plot_mod + meso_up_core_prot_plot_mod + meso_low_core_prot_plot_mod +
    plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.5), 
        legend.key.spacing.x = unit(0, "mm"),
        legend.key.spacing.y = unit(-2, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = -0.2)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 5, b = 0, l = -5), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 0.5)))

panel_mod

#ggsave("./network-plots/depthsplit_network_panel_prot_module.pdf", plot = panel_mod, height = 34, width = 80, units = "mm", dpi=300)



panel_node <- epi_core_met_fish_node + meso_up_core_met_fish_node + meso_low_core_met_fish_node +
  plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.50), 
        legend.key.spacing.x = unit(0.5, "mm"),
        legend.key.spacing.y = unit(-0.25, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 0)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 10, b = 0, l = 10), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 1)))

panel_node

#ggsave("./network-plots/depthsplit_network_panel_core_met_fish.pdf", plot = panel_node, height = 34, width = 80, units = "mm", dpi=300)


## all panels

panel_node_prot <- epi_core_prot_node + meso_up_core_prot_node + meso_low_core_prot_node +
  plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.50), 
        legend.key.spacing.x = unit(0.5, "mm"),
        legend.key.spacing.y = unit(-0.25, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 0)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 10, b = 0, l = 10), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 1)))

panel_node_prot


panel_node_met_fish <- epi_core_met_fish_node + meso_up_core_met_fish_node + meso_low_core_met_fish_node +
  plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.50), 
        legend.key.spacing.x = unit(0.5, "mm"),
        legend.key.spacing.y = unit(-0.25, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 0)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 10, b = 0, l = 10), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 1)))

panel_node_met_fish

(epi_core_met_fish_node + epi_core_prot_node + epi_core_node) /
  (meso_up_core_met_fish_node + meso_up_core_prot_node + meso_up_core_node) /
  (meso_low_core_met_fish_node + meso_low_core_prot_node + meso_low_core_node) + plot_layout(guides = 'collect') & 
  theme(legend.position = "bottom", 
        plot.margin = unit(c(t = 0.2, r = 0.2, b = 0.1, l = 0.1), "lines"),
        panel.spacing.x = unit(1, "mm"),
        panel.border = element_rect(color = "black", linewidth = 0.50), 
        legend.key.spacing.x = unit(0.5, "mm"),
        legend.key.spacing.y = unit(-0.25, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 0)),
        legend.title = element_text(size = 6),
        legend.margin = margin(t = -12, r = 10, b = 0, l = 10), legend.key.size = unit(4, 'mm'),
        plot.title = element_text(size = 7, margin = margin(b = 1)))

ggsave("./network-plots/depthsplit_network_panel_node_prot_met_alltaxa.pdf", height = 90, width = 80, units = "mm", dpi=300)


```

```{r analysis-panel-depth-core-taxa-robust eval = TRUE, message = FALSE, warning = FALSE}
# let's merge the attack robustness files

load("./R-outputs/robustness_prot.RData", verbose = T)
load("./R-outputs/robustness_met_fish.RData", verbose = T)
load("./R-outputs/robustness_alltaxa.RData", verbose = T)

#betweenness
head(v.cent.epi.core.prot)
head(v.cent.meso.up.core.prot)
head(v.cent.meso.low.core.prot)

## create a column for ype of attack
v.cent.epi.core.prot$depth <- "Epipelagic"
v.cent.meso.up.core.prot$depth <- "Upper Mesopelagic"
v.cent.meso.low.core.prot$depth <- "Lower Mesopelagic"

v.cent.core.prot <- rbind(v.cent.epi.core.prot, v.cent.meso.up.core.prot, v.cent.meso.low.core.prot)

# Degree
head(v.deg.epi.core.prot)
head(v.deg.meso.up.core.prot)
head(v.deg.meso.low.core.prot)

v.deg.epi.core.prot$depth <- "Epipelagic"
v.deg.meso.up.core.prot$depth <- "Upper Mesopelagic"
v.deg.meso.low.core.prot$depth <- "Lower Mesopelagic"

v.deg.core.prot <- rbind(v.deg.epi.core.prot, v.deg.meso.up.core.prot, v.deg.meso.low.core.prot)

head(v.random.epi.core.prot)
head(v.random.meso.up.core.prot)
head(v.random.meso.low.core.prot)

v.random.epi.core.prot$depth <- "Epipelagic"
v.random.meso.up.core.prot$depth <- "Upper Mesopelagic"
v.random.meso.low.core.prot$depth <- "Lower Mesopelagic"

v.random.core.prot <- rbind(v.random.epi.core.prot, v.random.meso.up.core.prot, v.random.meso.low.core.prot)

v.cent.core.prot$depth <- fct_relevel(v.cent.core.prot$depth, "Lower Mesopelagic", after = Inf)
v.deg.core.prot$depth <- fct_relevel(v.deg.core.prot$depth, "Lower Mesopelagic", after = Inf)
v.random.core.prot$depth <- fct_relevel(v.random.core.prot$depth, "Lower Mesopelagic", after = Inf)

v.cent.core.prot.plot <- v.cent.core.prot %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Betweenness", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.prot.plot <- v.deg.core.prot %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Degree", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.prot.plot

v.random.core.prot.plot <- v.random.core.prot %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Random", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.random.core.prot.plot


v.core.prot.plot <- v.cent.core.prot.plot + v.deg.core.prot.plot + v.random.core.prot.plot + 
  plot_layout(guides = 'collect') &
    theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8, hjust = 0.5),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.position = "bottom", 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 6))


#betweenness
head(v.cent.epi.core.met.fish)
head(v.cent.meso.up.core.met.fish)
head(v.cent.meso.low.core.met.fish)

## create a column for ype of attack
v.cent.epi.core.met.fish$depth <- "Epipelagic"
v.cent.meso.up.core.met.fish$depth <- "Upper Mesopelagic"
v.cent.meso.low.core.met.fish$depth <- "Lower Mesopelagic"

v.cent.core.met.fish <- rbind(v.cent.epi.core.met.fish, v.cent.meso.up.core.met.fish, v.cent.meso.low.core.met.fish)

# Degree
head(v.deg.epi.core.met.fish)
head(v.deg.meso.up.core.met.fish)
head(v.deg.meso.low.core.met.fish)

v.deg.epi.core.met.fish$depth <- "Epipelagic"
v.deg.meso.up.core.met.fish$depth <- "Upper Mesopelagic"
v.deg.meso.low.core.met.fish$depth <- "Lower Mesopelagic"

v.deg.core.met.fish <- rbind(v.deg.epi.core.met.fish, v.deg.meso.up.core.met.fish, v.deg.meso.low.core.met.fish)

head(v.random.epi.core.met.fish)
head(v.random.meso.up.core.met.fish)
head(v.random.meso.low.core.met.fish)

v.random.epi.core.met.fish$depth <- "Epipelagic"
v.random.meso.up.core.met.fish$depth <- "Upper Mesopelagic"
v.random.meso.low.core.met.fish$depth <- "Lower Mesopelagic"

v.random.core.met.fish <- rbind(v.random.epi.core.met.fish, v.random.meso.up.core.met.fish, v.random.meso.low.core.met.fish)

v.cent.core.met.fish$depth <- fct_relevel(v.cent.core.met.fish$depth, "Lower Mesopelagic", after = Inf)
v.deg.core.met.fish$depth <- fct_relevel(v.deg.core.met.fish$depth, "Lower Mesopelagic", after = Inf)
v.random.core.met.fish$depth <- fct_relevel(v.random.core.met.fish$depth, "Lower Mesopelagic", after = Inf)

v.cent.core.met.fish.plot <- v.cent.core.met.fish %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Betweenness", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.met.fish.plot <- v.deg.core.met.fish %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Degree", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.met.fish.plot

v.random.core.met.fish.plot <- v.random.core.met.fish %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth), linewidth = 0.5, alpha = 0.5) + 
  labs(title = "Random", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)")) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.random.core.met.fish.plot

# a combined plot?

head(v.random.core)
v.random.core$Taxa <- "All Taxa"
head(v.random.core.prot)
v.random.core.prot$Taxa <- "Protists"
head(v.random.core.met.fish)
v.random.core.met.fish$Taxa <- "Metazoa"

v.random.core.all <- rbind(v.random.core, v.random.core.prot, v.random.core.met.fish)
head(v.random.core.all)

head(v.cent.core)
v.cent.core$Taxa <- "All Taxa"
head(v.cent.core.prot)
v.cent.core.prot$Taxa <- "Protists"
head(v.cent.core.met.fish)
v.cent.core.met.fish$Taxa <- "Metazoa"

v.cent.core.all <- rbind(v.cent.core, v.cent.core.prot, v.cent.core.met.fish)
head(v.cent.core.all)


head(v.deg.core)
v.deg.core$Taxa <- "All Taxa"
head(v.deg.core.prot)
v.deg.core.prot$Taxa <- "Protists"
head(v.deg.core.met.fish)
v.deg.core.met.fish$Taxa <- "Metazoa"

v.deg.core.all <- rbind(v.deg.core, v.deg.core.prot, v.deg.core.met.fish)
head(v.deg.core.all)


v.cent.core.all.plot <- v.cent.core.all %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth, linetype = Taxa), linewidth = 0.5, alpha = 1) + 
  labs(title = "Betweenness", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  scale_linetype_manual(values=c("solid", "twodash", "dotted")) +
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)",
                              nrow = 3,
                              order = 1),
         linetype = guide_legend(title = "Taxa",
                                 nrow = 3,
                                 order = 2)) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.cent.core.all.plot


v.deg.core.all.plot <- v.deg.core.all %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth, linetype = Taxa), linewidth = 0.5, alpha = 1) + 
  labs(title = "Degree", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  scale_linetype_manual(values=c("solid", "twodash", "dotted")) +
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)",
                              nrow = 3,
                              order = 1),
         linetype = guide_legend(title = "Taxa",
                                 nrow = 3,
                                 order = 2)) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.deg.core.all.plot


v.random.core.all.plot <- v.random.core.all %>%
  ggplot(aes(y = comp.pct, x = removed.pct)) +
  geom_line(aes(color = depth, linetype = Taxa), linewidth = 0.5, alpha = 1) + 
  labs(title = "Random", x = "Nodes Removed", y = "Largest Component Size") + 
  scale_color_manual(values = c("#60CEAC",  "#395D9C", "#2E1E3C")) + 
  scale_linetype_manual(values=c("solid", "twodash", "dotted")) +
  theme_custom_paper() + 
  guides(color = guide_legend(title="Depth (m)",
                              nrow = 3,
                              order = 1),
         linetype = guide_legend(title = "Taxa",
                                 nrow = 3,
                                 order = 2)) + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        legend.title = element_text(size = 8))

v.random.core.all.plot

v.core.panel.plot <- v.cent.core.all.plot + v.deg.core.all.plot + v.random.core.all.plot + 
  plot_layout(guides = 'collect') &
    theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 10, hjust = 0.5),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8, margin = margin(l = 1)),
        legend.position = "bottom", 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0), 
        legend.key.size = unit(3, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 8),
        axis.title = element_text(size = 8))

v.core.panel.plot


ggsave("./network-plots/robustness_network_panel_core_prot_met_alltaxa_pub.pdf", height = 75, width = 180, units = "mm", dpi=300)


```