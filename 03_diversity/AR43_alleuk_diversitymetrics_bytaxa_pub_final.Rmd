---
title: "phyloseq-ctd-eukarya"
author: "Nina Yang, Postdoctoral Investigator, WHOI"
created date: "2023-02-04"
last updated: "2024-12-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

# 1. Background
This document outlines the steps taken to analyze the 18S V9 and 12S MiFish metabarcoding from eDNA samples collected via CTD from the AR43 Cruise (Armstrong, March 2020). 

## 1.1 Set up Environment

### 1.1.1 Install and load packages
```{r install-pkgs, include=FALSE}

if(!require(BiocManager)){install.packages("BiocManager")}
if(!require(devtools)){install.packages("devtools")}
if(!require(conflicted)){install.packages("conflicted")}
if(!require(phyloseq)){install.packages("phyloseq")}
if(!require(phylosmith)){install.packages("phylosmith")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(ggpubr)){install_github("ggpubr")}
if(!require(dplyr)){install_github("dplyr")}
if(!require(vegan)){install_github("vegan")}
if(!require(patchwork)){install.packages("patchwork")}
if(!require(Tjazi)){remotes::install_github("thomazbastiaanssen/Tjazi")}
if(!require(pairwiseAdonis)){install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")}
if(!require(betapart)){install.packages("betapart")}
if(!require(ComplexUpset)){remotes::install_github("krassowski/complex-upset")}

```

```{r load-pkgs, include=FALSE}
# load packages
library("devtools"); packageVersion("devtools")
library("conflicted"); packageVersion("conflicted")
library("tidyverse"); packageVersion("tidyverse")
library("phyloseq"); packageVersion("phyloseq")
library("phylosmith"); packageVersion("phylosmith")


#library("phylosmith"); packageVersion("phylosmith") 

library("ggpubr"); packageVersion("ggpubr")
library("dplyr"); packageVersion("dplyr")
library("vegan"); packageVersion("vegan")
library("patchwork"); packageVersion("patchwork")
library("pairwiseAdonis"); packageVersion("pairwiseAdonis")
library("Tjazi"); packageVersion("Tjazi")
library("betapart"); packageVersion("betapart")
library("ComplexUpset"); packageVersion("ComplexUpset")

```

### 1.1.2 Setup figure

```{r fig-setup, include = FALSE}
# Chunk options
knitr::opts_chunk$set(
 fig.width = 12,
 fig.asp = 0.5,
 out.width = "80%"
)

```

```{r theme_ggplot2, echo = FALSE}
theme_custom_ppt <- function() {
  theme_bw(
    base_size = 14) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent'),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.5),
      # axes
      axis.text.y = element_text(colour = "black"), 
      axis.text.x = element_text(colour = "black"), 
      # legend
      legend.text = element_text(colour ="black"), 
      legend.position = "right",
      legend.title = element_text(colour = "black"), 
      legend.background = element_rect(color = NA, fill='transparent'), 
      legend.box.background = element_rect(color = NA, fill='transparent'),
      # faceting
      strip.background.y = element_rect(color = "black", fill = "#ededed", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 12)
      )
}
theme_custom_poster <- function() {
  theme_bw(
    base_size = 30) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(), 
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.5),
      # axes
      axis.text.y = element_text(colour = "black"), 
      axis.text.x = element_text(colour = "black"), 
      # legend
      legend.text = element_text(colour ="black"), 
      legend.position = "right",
      legend.title = element_text(colour = "black"), 
      # faceting
      strip.background.y = element_rect(color = "black", fill = "#ededed", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = "white", linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 30)
      )
}
theme_custom_ppt_blkbg <- function() {
  theme_bw(
    base_size = 14) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent', color = 'transparent'),
      panel.border = element_rect(linewidth = 1, color = "white"),
      plot.title = element_text(color = "white"),
      # axes
      axis.text.y = element_text(color = "white", size = 14), 
      axis.text.x = element_text(color = "white", size = 14), 
      axis.ticks.x = element_line(color = "white"),
      axis.ticks.y = element_line(color = "white"),
      axis.title.x = element_text(color = "white", size = 16),
      axis.title.y = element_text(color = "white", size = 16),
      # legend
      legend.text = element_text(colour ="white"), 
      legend.position = "right",
      legend.title = element_text(colour = "white", size = 14), 
      legend.background = element_rect(color = NA, fill='transparent'), 
      legend.box.background = element_rect(color = NA, fill='transparent'),
      # faceting
      strip.background.y = element_rect(color = "white", fill = "transparent", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = "transparent", linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 14, color = "white")
      )
}
theme_custom_upset <- function() {
  theme_bw(
    base_size = 6) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent'),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
      # axes
      axis.text.y = element_text(colour = "black"), 
      axis.text.x = element_blank(),
      axis.text.x.bottom = element_blank(),
      axis.ticks.x = element_blank(),
      # legend
      legend.title = element_text(size = 0),
      legend.key.height = unit(0.25, "mm"),
      legend.key.width = unit(1, "mm"),
      legend.key.size = unit(2, 'mm'),
      legend.margin = margin(t = 0, r = 0, b = 0, l = -1))
}
theme_custom_paper <- function() {
  theme_bw(
    base_size = 10) + 
    theme(
      # plot background
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = 'transparent'), 
      plot.background = element_rect(fill = 'transparent'),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
      # axes
      axis.text.y = element_text(colour = "black"), 
      axis.text.x = element_text(colour = "black"), 
      # legend
      legend.text = element_text(colour ="black"), 
      legend.position = "right",
      legend.title = element_text(colour = "black"), 
      legend.background = element_rect(color = NA, fill='transparent'), 
      legend.box.background = element_rect(color = NA, fill='transparent'),
      # faceting
      strip.background.y = element_rect(color = "black", fill = "#ededed", linewidth = 1, linetype = "solid"), 
      strip.background.x = element_rect(color = "white", fill = 'transparent', linewidth = 1, linetype = "solid"),
      strip.text = element_text(size = 8)
      )
}
       
# Changing the default theme
theme_set(theme_custom_paper())

```

## 1.2 Setup Files

### 1.2.1 Protists
```{r import-files-prot, eval = TRUE, message = FALSE, warning = FALSE}

physeq_prot <- readRDS(file = "../02_phyloseq/18S/decontam-protist-ctd-phyloseq_05.rds")
physeq_prot # 9733 taxa
head(sample_data(physeq_prot))
head(tax_table(physeq_prot))

# remove ASVs that are not considered Protists or relevant for this analysis
physeq_prot <- subset_taxa(physeq_prot, Subdivision !="Metazoa")
physeq_prot # 6555 taxa
physeq_prot <- subset_taxa(physeq_prot, Domain !="Eukaryota:nucl")
physeq_prot # 6537 taxa
physeq_prot <- subset_taxa(physeq_prot, Domain !="Bacteria")
physeq_prot # 6536 taxa

# check physeq
ntaxa(physeq_prot)
nsamples(physeq_prot)
sample_names(physeq_prot)[1:5]  
rank_names(physeq_prot)  
sample_variables(physeq_prot)
tax_table(physeq_prot)[90:120, 4]

# let's remove the controls from physeq
physeq_prot_sample <- subset_samples(physeq_prot, Type=="sample")
physeq_prot_sample

# remove controls from metadata as well as other columns
# load metadata
metadata_18s <- read.table("../00_qiime2-outputs/18S/metadata_AR43_update_ctd.txt", sep='\t', header=T, row.names=1, comment = "")
head(metadata_18s)
rownames(metadata_18s) <- metadata_18s$sample
metadata_18s$uniqueID <- metadata_18s$uniqueID2

colnames(metadata_18s)
metadata_18s <- metadata_18s %>%
  select(sample, c(2:13, 15:20))

head(metadata_18s)
tail(metadata_18s)

metadata_18s <- filter(metadata_18s, Type == "sample")
colnames(metadata_18s)
summary(metadata_18s)

physeq_prot_sample # 6536
sample_data(physeq_prot_sample)

# originally wanted to remove rare reads but decided not to do this step so I am keeping the code so that it's easy to remove reads, but basically not removing anything. "physeq_xx_sample" files are the same as "physeq_xx_rr" files. 
physeq_prot_rr <- prune_taxa(taxa_sums(physeq_prot_sample) >= 0, physeq_prot_sample)
physeq_prot_rr # 6536
sample_data(physeq_prot_rr)

```

### 1.2.2 Metazoa
```{r import-files-met, eval = TRUE, message = FALSE, warning = FALSE}

# import met and protist phyloseq objects to combine later on

# the metazoa phyloseq object after decontam
physeq_met <- readRDS(file = "../02_phyloseq/18S/decontam-metazoa-ctd-phyloseq_05.rds")
physeq_met #484

# remove ASVs that do not fall under marine Metazoa
physeq_met <- subset_taxa(physeq_met, Kingdom != "Unassigned")
physeq_met #434
physeq_met <- subset_taxa(physeq_met, Kingdom != " k__Archaea")
physeq_met #433
physeq_met <- subset_taxa(physeq_met, Kingdom != " k__Fungi")
physeq_met #432
physeq_met <- subset_taxa(physeq_met, Phylum != " p__Protalveolata")
physeq_met #431
physeq_met <- subset_taxa(physeq_met, Class != " c__Arachnida")
physeq_met #429
physeq_met <- subset_taxa(physeq_met, Class != " c__Insecta")
physeq_met #425
physeq_met <- subset_taxa(physeq_met, Species != " s__Homo_sapiens")
physeq_met #422

# let's also remove the remaining vertebrates, which are all "Actinopterygii" and cannot resolve any further. We have 12S data so this will be cleaned out
physeq_met <- subset_taxa(physeq_met, Phylum != " p__Vertebrata")
physeq_met #403

# check physeq
ntaxa(physeq_met)
nsamples(physeq_met)
sample_names(physeq_met)[1:5]  
rank_names(physeq_met)  
sample_variables(physeq_met)
tax_table(physeq_met)[90:120, 2]

# let's remove the controls from physeq
physeq_met_sample <- subset_samples(physeq_met, Type=="sample")

# remove controls from metadata as well as other columns
# load metadata
metadata_18s <- read.table("../00_qiime2-outputs/18S/metadata_AR43_update_ctd.txt", sep='\t', header=T, row.names=1, comment = "")
head(metadata_18s)
rownames(metadata_18s) <- metadata_18s$sample
metadata_18s$uniqueID <- metadata_18s$uniqueID2

colnames(metadata_18s)
metadata_18s <- metadata_18s %>%
  select(sample, c(2:13, 15:20))

head(metadata_18s)
tail(metadata_18s)

metadata_18s <- filter(metadata_18s, Type == "sample")
colnames(metadata_18s)
summary(metadata_18s)

physeq_met_sample
# originally wanted to remove rare reads but decided not to do this step so I am keeping the code so that it's easy to remove reads, but basically not removing anything. "physeq_xx_sample" files are the same as "physeq_xx_rr" files. 
physeq_met_rr <- prune_taxa(taxa_sums(physeq_met_sample) >= 0, physeq_met_sample)
physeq_met_rr # 403

```

### 1.2.3 Fish
```{r import-files-fish, eval = TRUE, message = FALSE, warning = FALSE}

physeq_fish <- readRDS(file = "../02_phyloseq/12S/decontam-12s-phyloseq_05.rds")
physeq_fish # 859 taxa
head(sample_data(physeq_fish))
head(tax_table(physeq_fish))

# remove ASVs for freshwater fish (will need to remove additional mammal contaminants later)
physeq_fish <- subset_taxa(physeq_fish, Genus !="Fundulus")
physeq_fish # decontam did not remove all the Fundulus ASVs (341)
physeq_fish <- subset_taxa(physeq_fish, Genus !="Centropyge")
physeq_fish # 340

# check physeq
ntaxa(physeq_fish)
nsamples(physeq_fish)
sample_names(physeq_fish)[1:5]  
rank_names(physeq_fish)  
sample_variables(physeq_fish)
tax_table(physeq_fish)[90:120, 4]

# let's remove the controls from physeq
physeq_fish_sample <- subset_samples(physeq_fish, Type=="sample")
physeq_fish_sample

# remove controls from metadata as well as other columns (metadata imported earlier)
metadata_12s <- read.table("../00_qiime2-outputs/12S/metadata_AR43_12S_merged.txt", sep='\t', header=T, row.names=1, comment = "")
head(metadata_12s)
colnames(metadata_12s)
metadata_12s <- metadata_12s %>%
  select(sample, reads, Type, Cruise, platform, cast, deployment, depth, experiment, diel, unique_id, rep, depth_group, temp, oxy, sal, fluor)

head(metadata_12s)
colnames(metadata_12s)

colnames(metadata_12s)[11] <- "uniqueID" 
metadata_12s <- filter(metadata_12s, Cruise == "AR43")
metadata_12s <- filter(metadata_12s, Type == "sample")
colnames(metadata_12s)
summary(metadata_12s)

physeq_fish_sample # 340
sample_data(physeq_fish_sample)
# originally wanted to remove rare reads but decided not to do this step so I am keeping the code so that it's easy to remove reads, but basically not removing anything. "physeq_xx_sample" files are the same as "physeq_xx_rr" files. 
physeq_fish_rr <- prune_taxa(taxa_sums(physeq_fish_sample) >= 0, physeq_fish_sample)
physeq_fish_rr # 340
sample_data(physeq_fish_rr)

```

### 1.2.4 Set up phyloseq objects and save
```{r setup-phyloseq-save, eval = TRUE, message = FALSE, warning = FALSE}

# rename sample_id for each of these so they are exactly the same
sample_names(physeq_met_rr) <- sample_data(physeq_met_rr)$sample
sample_names(physeq_prot_rr) <- sample_data(physeq_prot_rr)$sample
sample_names(physeq_fish_rr) <- sample_data(physeq_fish_rr)$sample

physeq_fish_rr <- set_sample_order(physeq_fish_rr, "sample")
sample_names(physeq_fish_rr)

physeq_prot_rr <- set_sample_order(physeq_prot_rr, "sample")
sample_names(physeq_prot_rr)

physeq_met_rr <- set_sample_order(physeq_met_rr, "sample")
sample_names(physeq_met_rr)

# Save multiple objects, rr = rare reads removed. However, for this analysis, we did not remove rare reads.
save(physeq_met_rr, physeq_prot_rr, physeq_fish_rr, metadata_18s, metadata_12s, file = "../02_phyloseq/phyloseq_rr_fordiversityanalyses.RData")

```

```{r load-rdata, eval = TRUE, message = FALSE, warning = FALSE}

# load the data again
load("../02_phyloseq/phyloseq_rr_fordiversityanalyses.RData", verbose = T)

```

# 2. Alpha Diversity
## 2.1 Rarefaction

Rare reads were not removed. Instead, samples were rarefied based on a sampling depth threshold determined by an iterative, subsampling approach from Pat Schloss (https://journals.asm.org/doi/10.1128/msphere.00355-23). 

### 2.1.1 Setting rarefaction cut-off threshold 

```{r rarefy-subsample-fxn, eval = TRUE, message = FALSE, warning = FALSE}
subsample <- function(data, sample_size){
  data %>%
    dplyr::select(OTU, sample, Abundance) %>%
    group_by(sample) %>%
    uncount(Abundance) %>%
    sample_n(size = sample_size) %>%
    summarize(s = n_distinct(OTU))
}

# 1000 iterations
```

```{r rarefy-prot, eval = TRUE, message = FALSE, warning = FALSE}

# rarefy protists data
physeq_prot_rr
head(sample_data(physeq_prot_rr))

# let's "melt" the dataframe
melt_prot <- psmelt(physeq_prot_rr)
head(melt_prot)
colnames(melt_prot)

# let's get a sense for the distribution of reads across samples for rarefying
prot_sampling_coverage <- melt_prot %>%
  dplyr::select(sample, Abundance) %>%
  group_by(sample) %>%
  dplyr::summarize(n_seqs = sum(Abundance))

head(prot_sampling_coverage)
dim(prot_sampling_coverage) # 72 samples

# density
## curve is nice / smooth, but also this is a bad thing; don't have sense of count on y-axis
prot_sampling_coverage %>% 
  ggplot(aes(x=n_seqs)) + 
  geom_density()

# let's use histogram
## everything has at least 10,000 reads
prot_sampling_coverage %>% 
  ggplot(aes(x=n_seqs)) + 
  geom_histogram(binwidth = 500) +
  coord_cartesian(xlim=c(0, 50000))

# jitter plot - position on x is randomized so they don't overlap
# point
prot_sampling_coverage %>% 
  ggplot(aes(x=1, y = n_seqs)) + 
  geom_jitter() + theme_light() +
  scale_y_log10() # a handful of samples below 10,000 

# looks 3 samples have below ~15000

prot_sampling_coverage %>% 
  arrange(n_seqs) %>%
  ggplot(aes(x=1:nrow(.), y = n_seqs)) +
  geom_line() + theme_light() +
  coord_cartesian(xlim = c(0,10), ylim = c(0, 50000))

# cut off at 15,000
prot_sampling_coverage %>% 
  arrange(n_seqs) %>%
  print(n=10)

low_seqs_prot <- melt_prot %>%
  dplyr::select(sample, Abundance, deployment, depth) %>%
  group_by(sample) %>%
  mutate(n_seqs = sum(Abundance)) %>%
  filter(n_seqs < 15000) %>%
  distinct(sample, .keep_all = TRUE) %>%
  print()

colnames(melt_prot)

# finalize data frame for plotting - remove samples with < 15,000 reads
rare_prot <- melt_prot %>%
  dplyr::select(sample, OTU, Abundance) %>%
  group_by(sample) %>%
  mutate(n_seqs = sum(Abundance)) %>%
  filter(n_seqs >= 15000) %>%
  ungroup() %>%
  group_by(OTU) %>%
  filter(Abundance > 0) %>%
  ungroup() %>%
  print()

```

```{r rarefy-met, eval = TRUE, message = FALSE, warning = FALSE}

physeq_met_rr
head(sample_data(physeq_met_rr))
melt_met <- psmelt(physeq_met_rr)
head(melt_met)
colnames(melt_met)
dim(melt_met)

# I need to remove this sequence: 5081a2333021c38dbd6b8334bdcff438 (blast annotated as "Balaustium murorum")
melt_met <- melt_met %>% filter(OTU != "5081a2333021c38dbd6b8334bdcff438")
dim(melt_met)

met_sampling_coverage <- melt_met %>%
  dplyr::select(sample, Abundance) %>%
  dplyr::group_by(sample) %>%
  summarize(n_seqs = sum(Abundance))

head(met_sampling_coverage)
dim(met_sampling_coverage)

# density
## curve is nice / smooth, but also this is a bad thing; don't have sense of count on y-axis
met_sampling_coverage %>% 
  ggplot(aes(x=n_seqs)) + 
  geom_density()

# let's use histogram
met_sampling_coverage %>% 
  ggplot(aes(x=n_seqs)) + 
  geom_histogram(binwidth = 1000) +
  coord_cartesian(xlim=c(0, 10000))

# Use boxplot or violin as another option (not that helpful), prefer jitter
met_sampling_coverage %>% 
  ggplot(aes(x=1, y = n_seqs)) + 
  geom_boxplot() + theme_light() 
# jitter plot - position on x is randomized so they don't overlap
# point
met_sampling_coverage %>% 
  ggplot(aes(x=1, y = n_seqs)) + 
  geom_jitter() + theme_light() +
  scale_y_log10() 

# looks like 2 samples have below ~1000

met_sampling_coverage %>% 
  arrange(n_seqs) %>%
  ggplot(aes(x=1:nrow(.), y = n_seqs)) +
  geom_line() + theme_light() +
  coord_cartesian(xlim = c(0,10), ylim = c(0, 10000))

# cut off at 10,000
met_sampling_coverage %>% 
  arrange(n_seqs) %>%
  print(n=20)

low_seqs_met <- melt_met %>%
  dplyr::select(sample, Abundance, deployment, depth) %>%
  group_by(sample) %>%
  mutate(n_seqs = sum(Abundance)) %>%
  filter(n_seqs < 1000) %>%
  distinct(sample, .keep_all = TRUE) %>%
  print()

colnames(melt_met)
head(melt_met)

# finalize data frame for plotting
rare_met <- melt_met %>%
  dplyr::select(sample, OTU, Abundance) %>%
  group_by(sample) %>%
  mutate(n_seqs = sum(Abundance)) %>%
  ungroup() %>%
  filter(n_seqs >= 1000) %>%
  group_by(OTU) %>%
  filter(Abundance > 0) %>%
  ungroup() %>%
  print()

```

```{r rarefy-fish, eval = TRUE, message = FALSE, warning = FALSE}

physeq_fish_rr
head(sample_data(physeq_fish_rr))
melt_fish <- psmelt(physeq_fish_rr)
head(melt_fish)
colnames(melt_fish)

fish_sampling_coverage <- melt_fish %>%
  dplyr::select(sample, Abundance) %>%
  dplyr::group_by(sample) %>% 
  summarize(n_seqs = sum(Abundance))

head(fish_sampling_coverage)
dim(fish_sampling_coverage)

# density
## curve is nice / smooth, but also this is a bad thing; don't have sense of count on y-axis
fish_sampling_coverage %>% 
  ggplot(aes(x=n_seqs)) + 
  geom_density()

# let's use histogram
fish_sampling_coverage %>% 
  ggplot(aes(x=n_seqs)) + 
  geom_histogram(binwidth = 50) + 
  coord_cartesian(xlim=c(0, 600))

# Use boxplot or violin as another option (not that helpful), prefer jitter
fish_sampling_coverage %>% 
  ggplot(aes(x=1, y = n_seqs)) + 
  geom_boxplot() + theme_light() # a handful of samples below 10,000 

# jitter plot - position on x is randomized so they don't overlap
# point
fish_sampling_coverage %>% 
  ggplot(aes(x=1, y = n_seqs)) + 
  geom_jitter() + theme_light() +
  scale_y_log10()

fish_sampling_coverage %>% 
  arrange(n_seqs) %>%
  ggplot(aes(x=1:nrow(.), y = n_seqs)) +
  geom_line() + theme_light() +
  geom_point() +
  coord_cartesian(xlim = c(0,20), ylim = c(0, 10000))

# cut off at 10,000
fish_sampling_coverage %>% 
  arrange(n_seqs) %>%
  print(n=15)

low_seqs_fish <- melt_fish %>%
  dplyr::select(sample, Abundance, deployment, depth) %>%
  group_by(sample) %>%
  mutate(n_seqs = sum(Abundance)) %>%
  filter(n_seqs < 1000) %>%
  distinct(sample, .keep_all = TRUE) %>%
  print()

rare_fish <- melt_fish %>%
  dplyr::select(sample, OTU, Abundance) %>%
  group_by(sample) %>%
  mutate(n_seqs = sum(Abundance)) %>%
  filter(n_seqs >= 1000) %>%
  ungroup() %>%
  group_by(OTU) %>%
  filter(Abundance > 0) %>%
  ungroup() %>%
  print()

```

```{r rarefaction-prot, eval = TRUE, message = FALSE, warning = FALSE}
#remind yourself what the dataframe looked like
head(rare_prot)
dim(rare_prot)

# find the lowest # of reads which will serve as the rarefaction threshold
prot_min_seqs <- rare_prot %>% 
  group_by(sample) %>%
  summarize(n_seqs = sum(Abundance)) %>%
  summarize(min = min(n_seqs)) %>%
  pull(min)

prot_min_seqs

# min is 27,391
head(rare_prot)

prot_df <- rare_prot %>%
  dplyr::select(OTU, sample, Abundance) %>%
  pivot_wider(names_from = "OTU", values_from = "Abundance", values_fill = 0) %>%
  as.data.frame()

# set up dataframe
head(prot_df)
colnames(prot_df)
rownames(prot_df)
rownames(prot_df) <- prot_df$sample
rownames(prot_df)
prot_df <- prot_df[, -1]
str(prot_df)

# rarefied species richness (this is exact value only for richness)
exact <- rarefy(prot_df, prot_min_seqs) %>%
  as_tibble(rownames = "sample") %>%
  dplyr::select(sample, s = value)

head(exact)

# 1000 iterations for rarefaction

prot_subsamplings <- map_dfr(1:1000, ~subsample(rare_prot, prot_min_seqs), .id="iters")

empirical <- prot_subsamplings %>%
  group_by(sample) %>%
  summarize(s = mean(s))

head(empirical)

bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  ggplot(aes(x = approach, y = s, group = sample)) +
  geom_line()

# plot a line
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "s") %>%
  ggplot(aes(x = exact, y = empirical, group = sample)) +
  geom_abline(intercept = 0, slope = 1, color = "darkgreen") + 
  geom_point() + theme_light()


#error
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "s") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  ggplot(aes(x=error)) + 
  geom_density() + theme_light()

prot_mean_sd <- bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "s") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  summarize(mean = mean(error), sd = sd(error))

prot_mean_sd

```

```{r rarefaction-met, eval = TRUE, message = FALSE, warning = FALSE}

head(rare_met)
dim(rare_met)

met_min_seqs <- rare_met %>% 
  group_by(sample) %>%
  summarize(n_seqs = sum(Abundance)) %>%
  summarize(min = min(n_seqs)) %>%
  pull(min)

met_min_seqs

# min is 2549
head(rare_met)

met_df <- rare_met %>%
  dplyr::select(OTU, sample, Abundance) %>%
  pivot_wider(names_from = "OTU", values_from = "Abundance", values_fill = 0) %>%
  as.data.frame()

head(met_df)
colnames(met_df)
rownames(met_df)
rownames(met_df) <- met_df$sample
rownames(met_df)
met_df <- met_df[, -1]
str(met_df)

# rarefied species richness (this is exact? only for richness)
exact <- rarefy(met_df, met_min_seqs) %>%
  as_tibble(rownames = "sample") %>%
  dplyr::select(sample, s = value)

head(exact)

# 1000 iterations

met_subsamplings <- map_dfr(1:1000, ~subsample(rare_met, met_min_seqs), .id="iters")

empirical <- met_subsamplings %>%
  group_by(sample) %>%
  summarize(s = mean(s))

head(empirical)

bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  ggplot(aes(x = approach, y = s, group = sample)) +
  geom_line()

# plot a line
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "s") %>%
  ggplot(aes(x = exact, y = empirical, group = sample)) +
  geom_abline(intercept = 0, slope = 1, color = "darkgreen") + 
  geom_point() + theme_light()

#error
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "s") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  ggplot(aes(x=error)) + 
  geom_density() + theme_light()

met_mean_sd <- bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "s") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  summarize(mean = mean(error), sd = sd(error))

met_mean_sd

```

```{r rarefaction-fish, eval = TRUE, message = FALSE, warning = FALSE}

#remind yourself what the dataframe looked like
head(rare_fish)
dim(rare_fish)

fish_min_seqs <- rare_fish %>% 
  group_by(sample) %>%
  summarize(n_seqs = sum(Abundance)) %>%
  summarize(min = min(n_seqs)) %>%
  pull(min)

fish_min_seqs

# min is 1352
head(rare_fish)

fish_df <- rare_fish %>%
  dplyr::select(OTU, sample, Abundance) %>%
  pivot_wider(names_from = "OTU", values_from = "Abundance", values_fill = 0) %>%
  as.data.frame()

head(fish_df)
colnames(fish_df)
rownames(fish_df)
rownames(fish_df) <- fish_df$sample
fish_df <- fish_df[, -1]
str(fish_df)
 
# rarefied species richness (this is exact? only for richness)
exact <- rarefy(fish_df, fish_min_seqs) %>%
  as_tibble(rownames = "sample") %>%
  dplyr::select(sample, s = value)

fish_subsamplings <- map_dfr(1:1000, ~subsample(rare_fish, fish_min_seqs), .id="iters")

empirical <- fish_subsamplings %>%
  group_by(sample) %>%
  summarize(s = mean(s))

head(empirical)

bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  ggplot(aes(x = approach, y = s, group = sample)) +
  geom_line()

# plot a line
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "s") %>%
  ggplot(aes(x = exact, y = empirical, group = sample)) +
  geom_abline(intercept = 0, slope = 1, color = "darkgreen") + 
  geom_point() + theme_light()


#error
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "s") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  ggplot(aes(x=error)) + 
  geom_density() + theme_light()

fish_mean_sd <- bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "s") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  summarize(mean = mean(error), sd = sd(error))

fish_mean_sd

```

### 2.1.2 Save Data
```{r save-rdata, eval = TRUE, message = FALSE, warning = FALSE}

# save all subsamplings

save(prot_subsamplings, met_subsamplings, fish_subsamplings, file = "./phyloseq/taxa_subsamplings.RData")

# save rare & melt files
save(melt_prot, melt_met, melt_fish, rare_prot, rare_met, rare_fish, file = "./phyloseq/rare_melt_dataframes.RData")

```

```{r load-rdata, eval = TRUE, message = FALSE, warning = FALSE}

# load the data again

load(file = "./phyloseq/subsamplings_rr_included.RData", verbose = TRUE)
load(file = "./phyloseq/rare_melt_dataframes.RData", verbose = TRUE)

```

## 2.2 Calculate Alpha Diversity

### 2.2.1 Calculate alpha diversity indices

```{r alpha-div-fxn, eval = TRUE, message = FALSE, warning = FALSE}

# this gets rid of all the warnings when using summarise by dplyr
options(dplyr.summarize.inform = FALSE)

# functions to calculate alpha diversity metrics
shannon_vegan <- function(data, sample_size){
  data %>%
    dplyr::select(OTU, sample, Abundance) %>%
    group_by(sample) %>%
    uncount(Abundance) %>%
    sample_n(size = sample_size) %>%
    group_by(sample, OTU) %>%
    summarize(abundance = n()) %>%
    summarize(shannon = vegan::diversity(abundance, index = "shannon"))
}
invsimpson_vegan <- function(data, sample_size){
  data %>%
    dplyr::select(OTU, sample, Abundance) %>%
    group_by(sample) %>%
    uncount(Abundance) %>%
    sample_n(size = sample_size) %>%
    group_by(sample, OTU) %>%
    summarize(abundance = n()) %>%
    summarize(invsimpson = vegan::diversity(abundance, index = "invsimpson"))
}
# evenness is calculated from shannon index

```

```{r alpha-rarefy-prot, eval = TRUE, message = FALSE, warning = FALSE}

# plot different diversity metrics as a gut check
rare_prot %>%
  group_by(sample) %>%
  summarise(sobs = specnumber(Abundance), # this is the "exact" number that will be used for diversity metrics
            shannon = vegan::diversity(Abundance, index = "shannon"),
            evenness = shannon/log(sobs),
            invsimpson = vegan::diversity(Abundance, index = "invsimpson"),
            n = sum(Abundance)) %>%
  pivot_longer(cols = c(sobs, shannon, invsimpson, evenness),
                        names_to = "metric") %>%
  ggplot(aes(x = n, y = value)) + 
  geom_point() + 
  geom_smooth() + 
  facet_wrap(~metric, nrow = 4, scales = "free_y")

# save this for "exact" analysis
prot_div <- rare_prot %>%
  group_by(sample) %>%
  summarize(sobs = specnumber(Abundance),
            shannon = vegan::diversity(Abundance, index = "shannon"),
            invsimpson = vegan::diversity(Abundance, index = "invsimpson"),
            evenness = shannon/log(sobs))

head(prot_div)

set.seed(1000)

# I will eventually want to calculate those stats!
prot_shannon <- map_dfr(1:1000, ~shannon_vegan(rare_prot, prot_min_seqs), .id="iters")

# prot_div is "exact"
exact <- prot_div %>%
  group_by(sample) %>%
  summarize(shannon_mean = mean(shannon, na.rm = TRUE))

# the subsampling is empirical
empirical <- prot_shannon %>%
  group_by(sample) %>%
  summarize(shannon_mean = mean(shannon, na.rm = TRUE))

# let's compare
# plot a line
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "shannon_mean") %>%
  ggplot(aes(x = exact, y = empirical, group = sample)) +
  geom_abline(intercept = 0, slope = 1, color = "darkgreen") + 
  geom_point() + theme_light()

#error
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "shannon_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  ggplot(aes(x=error)) + 
  geom_density() + theme_light()

prot_mean_sd_shannon <- bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "shannon_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  summarize(mean = mean(error), sd = sd(error))

prot_mean_sd_shannon

## inverse simpson
prot_invsimpson <- map_dfr(1:1000, ~invsimpson_vegan(rare_prot, prot_min_seqs), .id="iters")

# prot_div is "exact"
exact <- prot_div %>%
  group_by(sample) %>%
  summarize(invsimpson_mean = mean(invsimpson, na.rm = TRUE))

# inverse simpson
empirical <- prot_invsimpson %>%
  group_by(sample) %>%
  summarize(invsimpson_mean = mean(invsimpson, na.rm = TRUE))

# let's compare
# plot a line
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "invsimpson_mean") %>%
  ggplot(aes(x = exact, y = empirical, group = sample)) +
  geom_abline(intercept = 0, slope = 1, color = "darkgreen") + 
  geom_point() + theme_light()


#error
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "invsimpson_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  ggplot(aes(x=error)) + 
  geom_density() + theme_light()

prot_mean_sd_invsimp <- bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "invsimpson_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  summarize(mean = mean(error), sd = sd(error))

prot_mean_sd_invsimp

#let's join these different dataframes

# first, rename columns to be generic: 
head(prot_div) # rarefied richness
obs_df <- dplyr::select(prot_div, sample, sobs)
head(obs_df)

invsimpson_df <- prot_invsimpson %>%
  group_by(sample) %>%
  summarize(invsimpson = mean(invsimpson, na.rm = TRUE))

shannon_df <- prot_shannon %>%
  group_by(sample) %>%
  summarize(shannon = mean(shannon, na.rm = TRUE))

prot_list = list(shannon_df, invsimpson_df, obs_df, metadata_18s)

prot_alpha_div <- prot_list %>% 
  reduce(inner_join, by='sample') %>%
  dplyr::select(sample, sobs, shannon, invsimpson, deployment, diel, depth, uniqueID, depth_group)

# let's add an organism group column
prot_alpha_div$Group <- "Protists"
head(prot_alpha_div)
dim(prot_alpha_div)

```

```{r save-rdata-load-prot, eval = TRUE, message = FALSE, warning = FALSE}

save(prot_invsimpson, prot_shannon, prot_alpha_div, prot_div, file = "./phyloseq/prot_alpha_indices_rarefied.RData")

load("./phyloseq/prot_alpha_indices_rarefied.RData", verbose = T)

```

```{r alpha-rarefy-met, eval = TRUE, message = FALSE, warning = FALSE}

# plot different diversity metrics as a gut check
rare_met %>%
  group_by(sample) %>%
  summarise(sobs = specnumber(Abundance),
            shannon = vegan::diversity(Abundance, index = "shannon"),
            evenness = shannon/log(sobs),
            invsimpson = vegan::diversity(Abundance, index = "invsimpson"),
            n = sum(Abundance)) %>%
  pivot_longer(cols = c(sobs, shannon, invsimpson, evenness),
                        names_to = "metric") %>%
  ggplot(aes(x = n, y = value)) + 
  geom_point() + 
  geom_smooth() + 
  facet_wrap(~metric, nrow = 4, scales = "free_y")

# save this for "exact" analysis
met_div <- rare_met %>%
  group_by(sample) %>%
  summarize(sobs = specnumber(Abundance),
            shannon = vegan::diversity(Abundance, index = "shannon"),
            invsimpson = vegan::diversity(Abundance, index = "invsimpson"))

head(met_div)

set.seed(1000)
# I will eventually want to calculate those stats!
met_shannon <- map_dfr(1:1000, ~shannon_vegan(rare_met, met_min_seqs), .id="iters")

# met_div is "exact"
exact <- met_div %>%
  group_by(sample) %>%
  summarize(shannon_mean = mean(shannon, na.rm = TRUE))

# the subsampling is empirical
empirical <- met_shannon %>%
  group_by(sample) %>%
  summarize(shannon_mean = mean(shannon, na.rm = TRUE))

# let's compare
# plot a line
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "shannon_mean") %>%
  ggplot(aes(x = exact, y = empirical, group = sample)) +
  geom_abline(intercept = 0, slope = 1, color = "darkgreen") + 
  geom_point() + theme_light()


#error
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "shannon_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  ggplot(aes(x=error)) + 
  geom_density() + theme_light()

met_mean_sd_shannon <- bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "shannon_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  summarize(mean = mean(error), sd = sd(error))

met_mean_sd_shannon

## inverse simpson
met_invsimpson <- map_dfr(1:1000, ~invsimpson_vegan(rare_met, met_min_seqs), .id="iters")

# met_div is "exact"
exact <- met_div %>%
  group_by(sample) %>%
  summarize(invsimpson_mean = mean(invsimpson, na.rm = TRUE))

# inverse simpson
empirical <- met_invsimpson %>%
  group_by(sample) %>%
  summarize(invsimpson_mean = mean(invsimpson, na.rm = TRUE))

# let's compare
# plot a line
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "invsimpson_mean") %>%
  ggplot(aes(x = exact, y = empirical, group = sample)) +
  geom_abline(intercept = 0, slope = 1, color = "darkgreen") + 
  geom_point() + theme_light()


#error
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "invsimpson_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  ggplot(aes(x=error)) + 
  geom_density() + theme_light()

met_mean_sd_invsimp <- bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "invsimpson_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  summarize(mean = mean(error), sd = sd(error))

met_mean_sd_invsimp

#let's join these different dataframes

# first, rename columns to be generic: 
head(met_div) # rarefied richness
obs_df <- dplyr::select(met_div, sample, sobs)
head(obs_df)

invsimpson_df <- met_invsimpson %>%
  group_by(sample) %>%
  summarize(invsimpson = mean(invsimpson, na.rm = TRUE))

shannon_df <- met_shannon %>%
  group_by(sample) %>%
  summarize(shannon = mean(shannon, na.rm = TRUE))

met_list = list(shannon_df,invsimpson_df, obs_df, metadata_18s)

met_alpha_div <- met_list %>% 
  reduce(inner_join, by='sample') %>%
  dplyr::select(sample, sobs, shannon, invsimpson, deployment, diel, depth, uniqueID, depth_group)

# let's add an organism group column
met_alpha_div$Group <- "Metazoa"

head(met_alpha_div)
summary(met_alpha_div)

```

```{r save-rdata-load-met, eval = TRUE, message = FALSE, warning = FALSE}

save(met_invsimpson, met_shannon, met_alpha_div, met_div, file = "./phyloseq/met_alpha_indices_rarefied.RData")

load("./phyloseq/met_alpha_indices_rarefied.RData", verbose = T)

```

```{r alpha-rarefy-fish, eval = TRUE, message = FALSE, warning = FALSE}

### fish
head(rare_fish)
dim(rare_fish)

# plot different diversity metrics as a gut check
rare_fish %>%
  group_by(sample) %>%
  summarise(sobs = specnumber(Abundance),
            shannon = diversity(Abundance, index = "shannon"),
            simpson = diversity(Abundance, index = "simpson"),
            invsimpson = diversity(Abundance, index = "invsimpson"),
            n = sum(Abundance)) %>%
  pivot_longer(cols = c(sobs, shannon, simpson, invsimpson),
                        names_to = "metric") %>%
  ggplot(aes(x = n, y = value)) + 
  geom_point() + 
  geom_smooth() + 
  facet_wrap(~metric, nrow = 4, scales = "free_y")

# save this for "exact" analysis
fish_div <- rare_fish %>%
  group_by(sample) %>%
  summarize(sobs = specnumber(Abundance),
            shannon = diversity(Abundance, index = "shannon"),
            simpson = diversity(Abundance, index = "simpson"),
            invsimpson = diversity(Abundance, index = "invsimpson"))

head(fish_div)

set.seed(1000)

# I will eventually want to calculate those stats!
fish_shannon <- map_dfr(1:1000, ~shannon_vegan(rare_fish, fish_min_seqs), .id="iters")

# fish_div is "exact"
exact <- fish_div %>%
  group_by(sample) %>%
  summarize(shannon_mean = mean(shannon, na.rm = TRUE))

# the subsampling is empirical
empirical <- fish_shannon %>%
  group_by(sample) %>%
  summarize(shannon_mean = mean(shannon, na.rm = TRUE))

# let's compare
# plot a line
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "shannon_mean") %>%
  ggplot(aes(x = exact, y = empirical, group = sample)) +
  geom_abline(intercept = 0, slope = 1, color = "darkgreen") + 
  geom_point() + theme_light()


#error
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "shannon_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  ggplot(aes(x=error)) + 
  geom_density() + theme_light()

# 4 samples are at 0

fish_mean_sd_shannon <- bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "shannon_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  summarize(mean = mean(error, na.rm = TRUE), sd = sd(error, na.rm = TRUE))

fish_mean_sd_shannon

## inverse simpson

fish_invsimpson <- map_dfr(1:1000, ~invsimpson_vegan(rare_fish, fish_min_seqs), .id="iters")

# fish_div is "exact"
exact <- fish_div %>%
  group_by(sample) %>%
  summarize(invsimpson_mean = mean(invsimpson, na.rm = TRUE))

# inverse simpson
empirical <- fish_invsimpson %>%
  group_by(sample) %>%
  summarize(invsimpson_mean = mean(invsimpson, na.rm = TRUE))


# let's compare
# plot a line
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "invsimpson_mean") %>%
  ggplot(aes(x = exact, y = empirical, group = sample)) +
  geom_abline(intercept = 0, slope = 1, color = "darkgreen") + 
  geom_point() + theme_light()

#error
bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "invsimpson_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  ggplot(aes(x=error)) + 
  geom_density() + theme_light()

fish_mean_sd_invsimp <- bind_rows(empirical = empirical, exact = exact, .id = "approach") %>%
  pivot_wider(names_from = "approach", values_from = "invsimpson_mean") %>%
  mutate(error = 100*(exact - empirical)/exact) %>%
  summarize(mean = mean(error), sd = sd(error))

fish_mean_sd_invsimp

#let's join these different dataframes

# first, rename columns to be generic: 
head(fish_div) # rarefied richness
obs_df <- dplyr::select(fish_div, sample, sobs)
head(obs_df)

invsimpson_df <- fish_invsimpson %>%
  group_by(sample) %>%
  summarize(invsimpson = mean(invsimpson, na.rm = TRUE))

shannon_df <- fish_shannon %>%
  group_by(sample) %>%
  summarize(shannon = mean(shannon, na.rm = TRUE))

fish_list = list(shannon_df, invsimpson_df, obs_df, metadata_12s)

fish_alpha_div <- fish_list %>% 
  reduce(inner_join, by='sample') %>%
  dplyr::select(sample, sobs, shannon, invsimpson, deployment, diel, depth, uniqueID, depth_group)

# let's add an organism group column
fish_alpha_div$Group <- "Fish"
head(fish_alpha_div)

```

```{r save-rdata-load-fish, eval = TRUE, message = FALSE, warning = FALSE}

save(fish_invsimpson, fish_shannon, fish_alpha_div, fish_div, file = "./phyloseq/fish_alpha_indices_rarefied.RData")

load("./phyloseq/fish_alpha_indices_rarefied.RData", verbose = T)

```

```{r save-rdata-rarefaction-stats, eval = TRUE, message = FALSE, warning = FALSE}

save(prot_mean_sd, prot_mean_sd_shannon, prot_mean_sd_invsimp, met_mean_sd, met_mean_sd_shannon, met_mean_sd_invsimp, fish_mean_sd, fish_mean_sd_shannon, fish_mean_sd_invsimp, file = "./phyloseq/alleuk_mean_sd_rarefaction_stats.RData")

load("./phyloseq/alleuk_mean_sd_rarefaction_stats.RData", verbose = T)

```

```{r alpha-plots-setup-save, eval = TRUE, message = FALSE, warning = FALSE}

# let's merge these
alpha_div_indice <- rbind(prot_alpha_div, met_alpha_div, fish_alpha_div)
head(alpha_div_indice)

save(alpha_div_indice, prot_alpha_div, met_alpha_div, fish_alpha_div, file = "./phyloseq/for_plotting_alpha_div_indice.RData")

load(file = "./phyloseq/for_plotting_alpha_div_indice.RData", verbose = T)

```

## 2.3 Plot Species richness

```{r asv-scan-setup, eval = TRUE, message = FALSE, warning = FALSE}

# this function plots relative abundance of ASVs
make_taxabar_asv_relabun_collapse <- function(df) {
  df %>%
    group_by(depth) %>%
    mutate(sum_obs = sum(sobs)) %>%
    mutate(RelativeAbundance = (sobs / sum_obs) * 100, na.rm = TRUE) %>%
    mutate(depth = as.factor(depth)) %>%
    ungroup() %>%
    group_by(depth, TAXA) %>%
    summarise(sum_RelativeAbundance = sum(RelativeAbundance, na.rm = TRUE), .groups = "drop") %>%
    arrange(depth, desc(sum_RelativeAbundance)) %>%
    mutate(TAXA = fct_reorder(TAXA, sum_RelativeAbundance, .desc = FALSE)) %>%
    ggplot(aes(y = fct_rev(depth), x = sum_RelativeAbundance)) +
    geom_col(aes(fill = TAXA), color = "black", width = 0.78, linewidth = 0.25) +
    labs(title = NULL,
         y = "Depth (m)",
         x = "Relative Abundance (%)") +
#    facet_wrap(. ~ deployment) + 
    scale_fill_manual(values = taxa_colors,
                      limits = taxa_sorted) +
    theme_custom_paper()# Use a manually sorted order for the legend
}

# taxa colors
taxa_colors <- c("#78C18A", "#FE869B", "#1986be")

# group colors
group_colors <- c("#78C18A", "#FE869B", "#1986be")

```

```{r alphadiv-plots, eval = TRUE, message = FALSE, warning = FALSE}

alpha_div_indice_df <- alpha_div_indice %>% 
  mutate(taxa = case_when(
    Group == "Metazoa" ~ "Invertebrates",
    Group == "Fish" ~ "Vertebrates",
    TRUE ~ Group)) %>%
  mutate(evenness = shannon / log(sobs))

head(alpha_div_indice_df)
tail(alpha_div_indice_df)
unique(alpha_div_indice_df$taxa)

alpha_div_indice_df$taxa <- fct_relevel(alpha_div_indice_df$taxa, "Invertebrates", after = 1)

# let's make a new dataframe
obs_df <- alpha_div_indice_df %>% select(sample, sobs, depth, taxa) %>%
  mutate(alpha_div = sobs) %>%
  mutate(indice = "Observed ASVs") %>%
  select(-sobs)

sha_df <- alpha_div_indice_df %>% select(sample, shannon, depth, taxa) %>%
  mutate(alpha_div = shannon) %>%
  mutate(indice = "Shannon") %>%
  select(-shannon)

even_df <- alpha_div_indice_df %>% select(sample, evenness, depth, taxa) %>%
  mutate(alpha_div = evenness) %>%
  mutate(indice = "Evenness") %>%
  filter(!is.na(evenness)) %>%
  select(-evenness)

alpha_obs <- ggplot(obs_df, aes(y = fct_rev(as.factor(depth)), x = alpha_div)) +
  geom_boxplot(aes(group = as.factor(depth), fill = taxa), alpha = 1, color ="black", size = 0.25, outlier.size = 0.1) +
  stat_summary(fun=mean, geom="point", shape=23, size=1, fill = "white", color = "black") +
  facet_grid(indice ~ taxa, scale = "free_x") +
  labs(title = NULL,
       y = "Depth (m)",
       x = NULL) +
  scale_fill_manual(values = group_colors, guide = "none") + theme_custom_paper()
   
alpha_obs

alpha_sha <- ggplot(sha_df, aes(y = fct_rev(as.factor(depth)), x = alpha_div)) +
  geom_boxplot(aes(group = as.factor(depth), fill = taxa), alpha = 1, color ="black", size = 0.25, outlier.size = 0.1) +
  stat_summary(fun=mean, geom="point", shape=23, size=1, fill = "white", color = "black") +
  facet_grid(indice ~ taxa, scale = "free_x") +
  labs(title = NULL,
       y = "Depth (m)",
       x = NULL) +
  scale_fill_manual(values = group_colors, guide = "none") + theme_custom_paper() 
   
alpha_sha

alpha_even <- ggplot(even_df, aes(y = fct_rev(as.factor(depth)), x = alpha_div)) +
  geom_boxplot(aes(group = as.factor(depth), fill = taxa), alpha = 1, color ="black", size = 0.25, outlier.size = 0.1) +
  stat_summary(fun=mean, geom="point", shape=23, size=1, fill = "white", color = "black") +
  facet_grid(indice ~ taxa, scale = "free_x") +
  labs(title = NULL,
       y = "Depth (m)",
       x = NULL) +
  scale_fill_manual(values = group_colors, guide = "none") + theme_custom_paper()
   
alpha_even

alpha_obs / alpha_sha /alpha_even + plot_annotation(tag_levels = "A") & 
  theme(plot.tag = element_text(size = 8),
        plot.margin = unit(c(t = 0.1, r = 0.05, b = 0.1, l = 0.05), "lines"),
        plot.title = element_text(size = 6),
        plot.background = element_blank(),
        panel.spacing = unit(3, "mm"), 
        panel.border = element_rect(color = "black", linewidth = 0.5),
        axis.title.y = element_text(size = 6), 
        axis.text.x = element_text(size = 6), 
        axis.text.y = element_text(size = 6), 
        strip.text.y.right = element_text(size = 6),
        strip.text.x.top = element_text(size = 6),
        strip.background.x = element_blank(),
        strip.background.y = element_rect(fill = NA, color = "black", linewidth = 0.5))

ggsave("./plots-final/alpha_div_indice_panel_pub.pdf", height = 120, width = 80, units = "mm", dpi=300)


```

```{r scan-setup, eval = TRUE, message = FALSE, warning = FALSE}

# calculate relative abundance
met_relabun <- melt_met %>%
  dplyr::select(sample, OTU, Abundance, everything(), -raw_reads) %>%
  group_by(sample) %>%
  mutate(n_seqs = sum(Abundance)) %>%
  ungroup() %>%
  filter(n_seqs >= 1000) %>%
  ungroup() %>%
  group_by(OTU) %>%
  filter(Abundance > 0) %>%
  ungroup() %>%
  print()

prot_relabun <- melt_prot %>%
  dplyr::select(sample, OTU, Abundance, everything(), -raw_reads) %>%
  group_by(sample) %>%
  mutate(n_seqs = sum(Abundance)) %>%
  ungroup() %>%
  filter(n_seqs >= 15000) %>%
  ungroup() %>%
  group_by(OTU) %>%
  filter(Abundance > 0) %>%
  ungroup() %>%
  print()

fish_relabun <- melt_fish %>%
  dplyr::select(sample, OTU, Abundance, -reads, everything()) %>%
  group_by(sample) %>%
  mutate(n_seqs = sum(Abundance)) %>%
  ungroup() %>%
  filter(n_seqs >= 1000) %>%
  ungroup() %>%
  group_by(OTU) %>%
  filter(Abundance > 0) %>%
  ungroup() %>%
  print()


# let's plot prot vs met to get relative proportion of the sequences
prot_check <- prot_relabun %>% select(sample, depth, n_seqs)
prot_check$taxa <- "Protists"
head(prot_check)

met_check <- met_relabun %>% select(sample, depth, n_seqs)
met_check$taxa <- "Invertebrates"
head(met_check)

euk_merge <- rbind(prot_check, met_check) %>% unique()

head(euk_merge)

euk_merge_calc <- euk_merge %>% group_by(sample) %>%
  mutate(sample_seqs = sum(n_seqs)) %>%
  mutate(prop_seqs = n_seqs/sample_seqs * 100) %>%

euk_merge_calc$taxa <- fct_relevel(euk_merge_calc$taxa, "Invertebrates", after = Inf)

euk_plot <- ggplot(euk_merge_calc, aes(y = fct_rev(as.factor(depth)), x = prop_seqs)) +
  geom_boxplot(aes(group = as.factor(depth), fill = taxa), alpha = 1, color ="black", size = 0.25, outlier.size = 0.1) +
  geom_jitter(aes(fill = taxa), color = "black", stroke = 0.25, size = 0.5, alpha = 0.66, shape = 21) + 
  stat_summary(fun=mean, geom="point", shape=23, size=1, fill = "white", color = "black") +
  facet_grid(~taxa) +
  labs(title = NULL,
       y = "Depth (m)",
       x = "Relative Abundance (%)") +
  scale_fill_manual(values = group_colors, guide = "none") + theme_custom_paper() + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 7))
  
euk_plot

ggsave("./plots-final/prot_met_18S_sequence_split.pdf", height = 60, width = 80, units = "mm", dpi=300)

euk_merge_calc %>% select(depth, taxa, prop_seqs) %>%
  group_by(depth, taxa) %>%
  mutate(avg_seqs = mean(prop_seqs)) %>%
  select(-prop_seqs) %>% unique() %>%
  arrange((depth))

  
```

```{r prot-asv-taxa-scan, eval = TRUE, message = FALSE, warning = FALSE}

# I want to plot the ASVs split out into major groups by Kingdom - Animalia

head(prot_relabun)
unique(prot_relabun$Division)

# let's group ASVs into main Supergroup & Division/Subdivision taxa
pr2_rename_taxa <- function(df) {
    # Add a column
    df$TAXA <- "Unassigned-Eukaryote"
    df$TAXA[df$Supergroup == "TSAR"] = "TSAR-Other"
    df$TAXA[df$Division == "Alveolata"] = "Alveolata-Other"
    df$TAXA[df$Subdivision == "Ciliophora"] = "Alveolata-Ciliates"
    df$TAXA[df$Subdivision == "Dinoflagellata"] = "Alveolata-Dinoflagellates"
    df$TAXA[df$Class == "Syndiniales"] = "Alveolata-Syndiniales"
    df$TAXA[df$Subdivision == "Apicomplexa"] = "Alveolata-Apicomplexa"
    df$TAXA[df$Supergroup == "Cryptista"] = "Cryptista-Other"
    df$TAXA[df$Division == "Cryptophyta"] = "Cryptophyta"
    df$TAXA[df$Supergroup == "Haptista"] = "Haptista-Other"
    df$TAXA[df$Division == "Haptophyta"] = "Haptophyta"
    df$TAXA[df$Division == "Breviatea"] = "Obazoa-Breviatea"
    df$TAXA[df$Division == "Opisthokonta"] = "Obazoa-Opisthokonta"
    df$TAXA[df$Division == "Apusomonada"] = "Obazoa-Apusomonada"
    df$TAXA[df$Division == "Ancyromonadida"] = "Eukaryota_X-Ancyromonadida"
    df$TAXA[df$Division == "Nibbleridia"] = "Provora-Nibbleridia"
    mast <- unique(filter(df, grepl("MAST", Family)) %>% select(Family))
    mast_list <- as.character(mast$Family)
    df$TAXA[df$Division == "Stramenopiles"] = "Stramenopiles-Other"
    df$TAXA[df$Class == "Mediophyceae"] = "Stramenopiles-Diatoms"
    df$TAXA[df$Class == "Coscinodiscophyceae"] = "Stramenopiles-Diatoms"
    df$TAXA[df$Class == "Bacillariophyceae"] = "Stramenopiles-Diatoms"
    df$TAXA[df$Family %in% mast_list] = "Stramenopiles-MAST"
    df$TAXA[df$Supergroup == "Archaeplastida"] = "Archaeplastida-Other"
    df$TAXA[df$Division == "Rhodophyta"] = "Rhodophyta"
    df$TAXA[df$Division == "Chlorophyta"] = "Chlorophyta"
    df$TAXA[df$Division == "Rhizaria"] = "Rhizaria-Other"
    df$TAXA[df$Subdivision == "Cercozoa"] = "Rhizaria-Cercozoa"
    df$TAXA[df$Subdivision == "Radiolaria"] = "Rhizaria-Radiolaria"
    df$TAXA[df$Supergroup == "Excavata"] = "Excavata"
    df$TAXA[df$Supergroup == "Amoebozoa"] = "Amoebozoa"
    df$TAXA[df$Supergroup == "Apusozoa"] = "Apusozoa"
    return(df)
}

## rename eDNA dataframe
prot_taxa <- pr2_rename_taxa(prot_relabun)
head(prot_taxa)
unique(prot_taxa$TAXA)

# simplify the plots by lumping some of the low relative abundance taxa into "Other Protists"

rename_prot_forplots <- function(df){
df %>%
    mutate(TAXA = case_when(
      TAXA == "Amoebozoa" ~ "Other Protists",
      TAXA == "Obazoa-Opisthokonta" ~ "Other Protists",
      TAXA == "Obazoa-Breviatea" ~ "Other Protists",      
      TAXA == "Provora-Nibbleridia" ~ "Other Protists",
      TAXA == "Obazoa-Apusomonada" ~ "Other Protists",
      TAXA == "Eukaryota_X-Ancyromonadida" ~ "Other Protists",
      TAXA == "Archaeplastida-Other" ~ "Other Protists",
      TAXA == "TSAR-Other" ~ "Other Protists",
      TAXA == "Cryptista-Other" ~ "Other Protists",
      TAXA == "Haptista-Other" ~ "Other Protists",
      TAXA == "Unassigned-Eukaryote" ~ "Unassigned Protists",
      TRUE ~ TAXA))
}  

prot_taxa2 <- rename_prot_forplots(prot_taxa)
# Division
unique(prot_taxa2$TAXA)

# Filter out rows where Abundance is greater than 0 and convert 'depth' to a factor
prot_asv <- 
  prot_taxa2 %>%
  filter(Abundance > 0) %>% # Keep only rows with Abundance > 0
  mutate(depth = as.factor(depth)) %>% # Convert 'depth' to a factor
  
  # Group by 'depth', 'OTU', and 'TAXA', then summarize the Abundance
  group_by(depth, OTU, TAXA) %>%
  summarise(Abund = sum(Abundance)) %>% # Sum the Abundance for each group
  ungroup() %>% # Ungroup the data
  
  # Group by 'depth' and 'TAXA', then calculate species number (sobs)
  group_by(depth, TAXA) %>%
  mutate(sobs = vegan::specnumber(Abund)) %>% # Calculate species number
  
  # Select columns excluding 'OTU' and 'Abund'
  select(-c(OTU, Abund)) %>% # Remove 'OTU' and 'Abund' columns
  unique() %>% # Remove duplicate rows
  ungroup() %>% # Ungroup the data
  
  # Group by 'TAXA' and calculate the sum of sobs for each TAXA
  group_by(TAXA) %>%
  mutate(sum_obs = sum(sobs)) %>% # Sum of sobs for each TAXA
  
  # Arrange by 'depth' and descending 'sum_obs', then remove duplicates
  arrange(depth, desc(sum_obs)) %>% # Arrange by depth and sum_obs
  
  # Reorder 'TAXA' factor based on 'sum_obs' values in ascending order
  mutate(TAXA = fct_reorder(TAXA, sum_obs, .desc = FALSE)) # Reorder TAXA


unique(prot_asv$TAXA)
prot_asv$TAXA <- fct_relevel(prot_asv$TAXA, "Other Protists", after = Inf)
taxa_sorted <- c("Alveolata-Apicomplexa", "Alveolata-Ciliates",
                             "Alveolata-Dinoflagellates", 
                             "Alveolata-Other", 
                             "Alveolata-Syndiniales", 
                             "Chlorophyta", 
                             "Cryptophyta", "Excavata",
                             "Haptophyta", "Rhizaria-Cercozoa", 
                             "Rhizaria-Other", 
                             "Rhizaria-Radiolaria", "Rhodophyta",
                 "Stramenopiles-Diatoms", "Stramenopiles-MAST", "Stramenopiles-Other", "Other Protists")

taxa_colors <- c("#a1c2fd", "#56C4F0", "#399dff","#0b62fb", "#0344b7",
                 "#9CDC46","#dafa0f","#efdf48", "#ff9d3a",
                 "#ceceff", "#a7a7ff","#7474ff",
                 "#ff9aa5",
                 "#009a4d","#1ec38c", "#90eebf",#"#82A4E3", 
                 "#d9d9d9")

prot_asv_plot <- prot_asv %>%
  ggplot(aes(y=fct_rev(depth), x=sobs)) +
  geom_col(aes(group = depth, fill = TAXA), color = "black", width = 0.78, linewidth = 0.25, alpha=1) +
  labs(title=NULL,
       y="Depth (m)",
       x="Observed ASVs - Protists") +
  scale_fill_manual(values = taxa_colors,
                   limits = taxa_sorted) + 
  guides(fill = guide_legend(title = "Protists"),
         color = "none") + theme_custom_paper() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10))

prot_asv_plot

ggsave("./plots-final/prot_obs_taxa_barplot_panel.pdf", height = 5, width = 5, units = "in", dpi=300)

prot_relabun_asv_plot <- make_taxabar_asv_relabun_collapse(prot_asv)
prot_relabun_asv_plot + 
  guides(fill = guide_legend(title = "Protists"))

ggsave("./plots-final/prot_obs_taxa_relabun_panel.pdf", height = 5, width = 10, units = "in", dpi=300)

head(prot_asv)

# let's identify the taxa that make up the largest fraction of ASV diversity. This is termed "top taxa" in the code. 
# This pipeline effectively identifies and ranks the top 5 taxa by relative abundance within each depth.

top_prot <- prot_asv %>% group_by(depth) %>% # group by depth
  mutate(sum_obs = sum(sobs)) %>% # get the total number of ASVs for each depth in a new column called "sum_obs"
  mutate(RelativeAbundance = (sobs / sum_obs) * 100, na.rm = TRUE) %>% # calculate the relative abundance of ASVs out of the total # of ASVs at each depth and create a new column. 
  mutate(depth = as.factor(depth)) %>% # change depth to a factor 
  ungroup() %>% # ungroup 
  group_by(depth, TAXA) %>% # regroup by depth and TAXA
  summarise(sum_RelativeAbundance = sum(RelativeAbundance, na.rm = TRUE), .groups = "drop") %>% # summarize to get the sum of the relative abundance of each taxa at each depth
  mutate(TAXA = fct_reorder(TAXA, sum_RelativeAbundance, .desc = FALSE)) %>% # Reorders the levels of the TAXA factor based on the sum_RelativeAbundance, maintaining the order of appearance if ties occur.
  ungroup() %>% # ungroup 
  group_by(depth) %>% # regroup by depth only 
  slice_max(order_by = sum_RelativeAbundance, n = 5, with_ties = FALSE) %>% # Selects the top 5 rows in each depth group based on sum_RelativeAbundance, excluding ties beyond the top 5.
  ungroup() # ungroup

top_prot %>% group_by(depth) %>% mutate(sum = sum(sum_RelativeAbundance)) %>% select(-TAXA, -sum_RelativeAbundance) %>% unique()

top_prot_pub <- top_prot %>% ggplot(aes(y = fct_rev(depth), x = sum_RelativeAbundance)) +
    geom_col(aes(fill = TAXA), color = "black", width = 0.78, linewidth = 0.25) +
    labs(title = NULL,
         y = "Depth (m)",
         x = "Relative Proportion (%)") +
  scale_x_continuous(limits = c(0, 100)) + 
    scale_fill_manual(values = taxa_colors,
                      limits = taxa_sorted) +
    theme_custom_paper()# Use a manually sorted order for the legend

top_prot_pub

```

```{r met-asv-taxa-scan1, eval = TRUE, message = FALSE, warning = FALSE}

# clean taxa labeling for metazoa
head(met_relabun)
dim(met_relabun) # 28140 x 31
met_relabun <- met_relabun %>%
  mutate(Domain = gsub("^d__", "", Domain)) %>%
  mutate(Kingdom = gsub("^ k__", "", Kingdom)) %>%
  mutate(Phylum = gsub("^ p__", "", Phylum)) %>%
  mutate(Class = gsub("^ c__", "", Class)) %>%
  mutate(Order = gsub("^ o__", "", Order)) %>%
  mutate(Family = gsub("^ f__", "", Family)) %>%
  mutate(Genus = gsub("^ g__", "", Genus)) %>%
  mutate(Species = gsub("^ s__", "", Species))

head(met_relabun)

# summarize the cleaned dataframe by Kingdom Phylum, and Class, which will help define groupings for renaming and plotting
summary_df <- met_relabun %>% 
  group_by(Kingdom, Phylum, Class, Order, Genus, Species) %>%
  summarise(count = n())

print(summary_df)

# note that for the species "Anthopleura elegantissima", all other taxonomic levels are labeled "Animalia" so I renamed this "TAXA" as Cnidaria-Actiniaria which was then lumped under Cnidaria-Other.
# Fix the taxonomy for aggregating anemone
met_relabun[met_relabun$Species == "Anthopleura_elegantissima", "Phylum"] <- "Cnidaria"
met_relabun[met_relabun$Species == "Anthopleura_elegantissima", "Class"] <- "Hexacorallia"
met_relabun[met_relabun$Species == "Anthopleura_elegantissima", "Order"] <- "Actiniaria"
met_relabun[met_relabun$Phylum == "Nematozoa", "Phylum"] <- "Nematoda"

# Fix the taxonomy for copepod "Poecilostomatoida" which is actually under Cyclopoida
met_relabun[met_relabun$Species == "Sapphirina_darwinii", "Order"] <- "Cyclopoida" 

summary_df <- met_relabun %>% 
  group_by(Kingdom, Phylum, Class, Order, Genus, Species) %>%
  summarise(count = n())

print(summary_df)

#rename_taxa_met_order <- function(df){
df %>%
    mutate(Order = ifelse(Phylum == "Arthropoda", paste(Phylum, Order, sep = "-"), Order)) %>%
    mutate(Order = ifelse(Phylum == "Tunicata", paste(Phylum, Order, sep = "-"), Order)) %>%
    mutate(Order = ifelse(Phylum == "Cnidaria", paste(Phylum, Order, sep = "-"), Order)) %>%
    mutate(Order = ifelse(Phylum == "Ctenophora", paste(Phylum, Order, sep = "-"), Order)) %>%
    mutate(TAXA = case_when(
      Phylum %in% other_met ~ "Other Invertebrates",
      Phylum == "Unassigned" ~ "Unassigned Metazoa",
      Phylum == "uncultured" ~ "Unassigned Metazoa",
      Order %in% other_arthro ~ "Arthropoda-Other",
      Order %in% other_cnid ~ "Cnidaria-Other",
      Order %in% other_cten ~ "Ctenophora-Other",
      Order == "Tunicata-Doliolida" ~ "Other Invertebrates",
      TRUE ~ Order))

} 

silva_met_rename_order <- function(df) {
  df$TAXA <- "Unassigned-Eukaryote"
  df$TAXA[df$Phylum == "Annelida"] = "Annelida"
  df$TAXA[df$Phylum == "uncultured"] = "Unassigned Metazoa"
  df$TAXA[df$Phylum == "Unassigned"] = "Unassigned Metazoa"
  df$TAXA[df$Phylum == "Arthropoda"] = "Arthropoda-Other"
  df$TAXA[df$Order == "Calanoida"] = "Arthropoda-Calanoida"
  df$TAXA[df$Order == "Cyclopoida"] = "Arthropoda-Cyclopoida"
  df$TAXA[df$Phylum == "Bryozoa"] = "Bryozoa"
  df$TAXA[df$Phylum == "Chaetognatha"] = "Chaetognatha"
  df$TAXA[df$Phylum == "Cnidaria"] = "Cnidaria-Other"
  df$TAXA[df$Order == "Siphonophorae"] = "Cnidaria-Siphonophorae"
  df$TAXA[df$Phylum == "Ctenophora"] = "Ctenophora-Other"
  df$TAXA[df$Order == "Cydippida"] = "Ctenophora-Cydippida"
  df$TAXA[df$Phylum == "Echinodermata"] = "Echinodermata"
  df$TAXA[df$Phylum == "Gastrotricha"] = "Gastrotricha"
  df$TAXA[df$Phylum == "Hemichordata"] = "Hemichordata"
  df$TAXA[df$Phylum == "Mollusca"] = "Mollusca"
  df$TAXA[df$Phylum == "Nematoda"] = "Nematoda"
  df$TAXA[df$Phylum == "Nemertea"] = "Nemertea"
  df$TAXA[df$Phylum == "Platyhelminthes"] = "Platyhelminthes"
  df$TAXA[df$Phylum == "Rotifera"] = "Rotifera"
  df$TAXA[df$Phylum == "Porifera"] = "Porifera"
  df$TAXA[df$Phylum == "Tunicata"] = "Tunicata-Other"
  df$TAXA[df$Order == "Salpida"] = "Tunicata-Salpida"
  df$TAXA[df$Order == "Copelata"] = "Tunicata-Copelata"
  return(df)
}

met_taxa_order <- silva_met_rename_order(met_relabun)

unique(met_taxa_order$TAXA)

rename_met_forplots <- function(df){
df %>%
    mutate(TAXA = case_when(
      TAXA == "Annelida" ~ "Other Invertebrates",
      TAXA == "Mollusca" ~ "Other Invertebrates",
      TAXA == "Gastrotricha" ~ "Other Invertebrates",      
      TAXA == "Chaetognatha" ~ "Other Invertebrates",
      TAXA == "Nemertea" ~ "Other Invertebrates",
      TAXA == "Echinodermata" ~ "Other Invertebrates",
      TAXA == "Rotifera" ~ "Other Invertebrates",
      TAXA == "Hemichordata" ~ "Other Invertebrates",
      TAXA == "Platyhelminthes" ~ "Other Invertebrates",
      TAXA == "Nematoda" ~ "Other Invertebrates",
      TAXA == "Porifera" ~ "Other Invertebrates",
      TAXA == "Bryozoa" ~ "Other Invertebrates",
      TRUE ~ TAXA))
}  

met_taxa_check <- met_taxa_order %>%
  filter(Abundance > 0) %>%
  group_by(Order,TAXA) %>%
  summarise(sum = sum(Abundance)) %>%
  arrange(by = sum) %>%
  print(n=70)

```

```{r assign-unknown-met, eval = TRUE, message = FALSE, warning = FALSE}
# There are lot's of unassigned sequences 

# filter unassigned metazoa
unass_met <- filter(met_taxa_order, TAXA == "Unassigned Metazoa") 
unass_met <- unique(unass_met$OTU)
view(unass_met) # there are 96
write.csv(unass_met, "./met_unassigned/met_unassigned.csv", row.names = TRUE)

# filter unassigned arthropoda
unass_cop <- filter(met_taxa_order, Phylum == "Arthropoda" & Order == "Unassigned") 
unass_cop <- unique(unass_cop$OTU)
view(unass_cop) # there are 45
write.csv(unass_cop, "./met_unassigned/met_copepod_unassigned.csv", row.names = TRUE)

# steps to blast and assign
# 1. convert csv to txt
# 2. run a script to extract sequences based on the list of unknown ASVs
# 3. import for blastn in Geneious Prime
# 4. Retrieve top 100 hits. Keep the top hit that is at least 95% grade (explain grade in GP), is not uncultured or other unknown. Keep top hit based on grade

metazoa_assigned <- read.csv("./met_unassigned/metazoa_assigned_geneious.csv")
head(metazoa_assigned)
dim(metazoa_assigned)
unique(metazoa_assigned$Order)
colnames(metazoa_assigned)
colnames(metazoa_assigned)[11] <- "OTU" # rename column for downstream analysis

copepod_assigned <- read.csv("./met_unassigned/copepod_assigned_geneious.csv")
head(copepod_assigned)
dim(copepod_assigned)
unique(copepod_assigned$Order)
colnames(copepod_assigned)[11] <- "OTU"

# combine unassigned dataframes 
taxa_assigned <- rbind(metazoa_assigned, copepod_assigned)
head(taxa_assigned)
tail(taxa_assigned)
dim(taxa_assigned)
unique(taxa_assigned$Order)

write.csv(taxa_assigned, file = "./met_unassigned/assigned_unknowns_all.csv")
taxa_assigned <- read.csv(file = "./met_unassigned/assigned_unknowns_all.csv")
head(taxa_assigned)

otu1 <- filter(taxa_assigned, Order == "Siphonophorae")
otu1 <- otu1$OTU
otu2 <- filter(taxa_assigned, Order == "Calanoida")
otu2 <- otu2$OTU
otu3 <- filter(taxa_assigned, Order == "Copelata")
otu3 <- otu3$OTU
otu4 <- filter(taxa_assigned, Order == "Enoplida")
otu4 <- otu4$OTU
otu5 <- filter(taxa_assigned, Order == "Leptothecata")
otu5 <- otu5$OTU
otu6 <- filter(taxa_assigned, Order == "Ploima")
otu6 <- otu6$OTU
otu7 <- filter(taxa_assigned, Order == "Spionida")
otu7 <- otu7$OTU
otu8 <- filter(taxa_assigned, Order == "Salpida")
otu8 <- otu8$OTU
otu9 <- filter(taxa_assigned, Order == "Doliolida")
otu9 <- otu9$OTU
otu10 <- filter(taxa_assigned, Order == "Phyllodocida")
otu10 <- otu10$OTU
otu11 <- filter(taxa_assigned, Order == "Mormonilloida") 
otu11 <- otu11$OTU
otu12 <- filter(taxa_assigned, Order == "Cyclopoida")
otu12 <- otu12$OTU
otu13 <- filter(taxa_assigned, Order == "Harpacticoida")
otu13 <- otu13$OTU
otu14 <- filter(taxa_assigned, Order == "Scalpellomorpha")
otu14 <- otu14$OTU
otu15 <- filter(taxa_assigned, Order == "Decapoda")
otu15 <- otu15$OTU
otu16 <- filter(taxa_assigned, Order == "Amphipoda")
otu16 <- otu16$OTU

met_unknown_rename <- function(df){
  df %>% 
  mutate(Phylum = case_when(
    OTU %in% otu1 ~ "Cnidaria",
    OTU %in% otu2 ~ "Arthropoda",
    OTU %in% otu3 ~ "Tunicata",
    OTU %in% otu4 ~ "Nematoda",
    OTU %in% otu5 ~ "Cnidaria",
    OTU %in% otu6 ~ "Rotifera",
    OTU %in% otu7 ~ "Annelida",
    OTU %in% otu8 ~ "Tunicata",
    OTU %in% otu9 ~ "Tunicata",
    OTU %in% otu10 ~ "Annelida",
    OTU %in% otu11 ~ "Arthropoda",
    OTU %in% otu12 ~ "Arthropoda",
    OTU %in% otu13 ~ "Arthropoda",
    OTU %in% otu14 ~ "Arthropoda",
    OTU %in% otu15 ~ "Arthropoda",
    OTU %in% otu16 ~ "Arthropoda",
    TRUE ~ Phylum)) %>%
  mutate(Class = case_when(
    OTU %in% otu1 ~ "Hydrozoa",
    OTU %in% otu2 ~ "Arthropoda",
    OTU %in% otu3 ~ "Appendicularia",
    OTU %in% otu4 ~ "Nematoda",
    OTU %in% otu5 ~ "Hydrozoa",
    OTU %in% otu6 ~ "Eurotatoria",
    OTU %in% otu7 ~ "Polychaeta",
    OTU %in% otu8 ~ "Thaliacea",
    OTU %in% otu9 ~ "Thaliacea",
    OTU %in% otu10 ~ "Polychaeta",
    OTU %in% otu11 ~ "Copepoda",
    OTU %in% otu12 ~ "Copepoda",
    OTU %in% otu13 ~ "Copepoda",
    OTU %in% otu14 ~ "Thecostraca",
    OTU %in% otu15 ~ "Malacostraca",
    OTU %in% otu16 ~ "Malacostraca",
    TRUE ~ Class)) %>%
  mutate(Order = case_when(
    OTU %in% otu1 ~ "Siphonophorae",
    OTU %in% otu2 ~ "Calanoida",
    OTU %in% otu3 ~ "Copelata",
    OTU %in% otu4 ~ "Enoplea",
    OTU %in% otu5 ~ "Leptothecata",
    OTU %in% otu6 ~ "Ploima",
    OTU %in% otu7 ~ "Spionida",
    OTU %in% otu8 ~ "Salpida",
    OTU %in% otu9 ~ "Doliolida",
    OTU %in% otu10 ~ "Phyllodocida",
    OTU %in% otu11 ~ "Mormonilloida",
    OTU %in% otu12 ~ "Cyclopoida",
    OTU %in% otu13 ~ "Harpacticoida",
    OTU %in% otu14 ~ "Scalpellomorpha",
    OTU %in% otu15 ~ "Decapoda",
    OTU %in% otu16 ~ "Amphipoda",
    TRUE ~ Order))
}

```

```{r met-asv-taxa-scan2, eval = TRUE, message = FALSE, warning = FALSE}
met_relabun_rename <- met_unknown_rename(met_relabun)

met_taxa_order2 <- silva_met_rename_order(met_relabun_rename)
unique(met_taxa_order2$TAXA) %>% sort()
## met taxa scan for TAXA

df_summarized_met <- met_taxa_order2 %>%
  filter(Abundance > 0) %>%
  mutate(depth = as.factor(depth)) %>%
  group_by(depth, rep, deployment, TAXA) %>%
  summarise(n_OTU = n_distinct(OTU))

# check data
head(df_summarized_met) 

rename_met_forplots <- function(df){
df %>%
    mutate(TAXA = case_when(
      TAXA == "Annelida" ~ "Other Invertebrates",
      TAXA == "Mollusca" ~ "Other Invertebrates",
      TAXA == "Gastrotricha" ~ "Other Invertebrates",      
      TAXA == "Chaetognatha" ~ "Other Invertebrates",
      TAXA == "Nemertea" ~ "Other Invertebrates",
      TAXA == "Echinodermata" ~ "Other Invertebrates",
      TAXA == "Rotifera" ~ "Other Invertebrates",
      TAXA == "Hemichordata" ~ "Other Invertebrates",
      TAXA == "Platyhelminthes" ~ "Other Invertebrates",
      TAXA == "Nematoda" ~ "Other Invertebrates",
      TAXA == "Porifera" ~ "Other Invertebrates",
      TAXA == "Bryozoa" ~ "Other Invertebrates",
      TRUE ~ TAXA))
}  

met_taxa_order3 <- rename_met_forplots(met_taxa_order2)
unique(met_taxa_order3$TAXA) %>% sort()

met_asv <- 
  met_taxa_order3 %>%
  filter(Abundance > 0) %>% # Keep only rows with Abundance > 0
  mutate(depth = as.factor(depth)) %>% # Convert 'depth' to a factor
  
  # Group by 'depth', 'OTU', and 'TAXA', then summarize the Abundance
  group_by(depth, OTU, TAXA) %>%
  summarise(Abund = sum(Abundance)) %>% # Sum the Abundance for each group
  ungroup() %>% # Ungroup the data
  
  # Group by 'depth' and 'TAXA', then calculate species number (sobs)
  group_by(depth, TAXA) %>%
  mutate(sobs = vegan::specnumber(Abund)) %>% # Calculate species number
  
  # Select columns excluding 'OTU' and 'Abund'
  select(-c(OTU, Abund)) %>% # Remove 'OTU' and 'Abund' columns
  unique() %>%
  ungroup() %>% # Ungroup the data
  
  # Group by 'TAXA' and calculate the sum of sobs for each TAXA
  group_by(TAXA) %>%
  mutate(sum_obs = sum(sobs)) %>% # Sum of sobs for each TAXA
  
  # Arrange by 'depth' and descending 'sum_obs', then remove duplicates
  arrange(depth, desc(sum_obs)) %>% # Arrange by depth and sum_obs
  
  # Reorder 'TAXA' factor based on 'sum_obs' values in ascending order
  mutate(TAXA = fct_reorder(TAXA, sum_obs, .desc = FALSE)) # Reorder TAXA


taxa_sorted <- c("Arthropoda-Calanoida", "Arthropoda-Cyclopoida",
                             "Arthropoda-Other", 
                             "Cnidaria-Siphonophorae",
                             "Cnidaria-Other", 
                             "Ctenophora-Cydippida", 
                             "Ctenophora-Other",
                             "Tunicata-Copelata", "Tunicata-Salpida", "Unassigned Metazoa", "Other Invertebrates")

taxa_colors <- c("#fc996c", "#ffce5c","#fdfb9b", 
                 "#047de9", "#0344b7", 
                 "#fa9db8", "#fc5d7b",
                 "#96fac6","#1ec38c", 
                  "#82A4E3", "#d9d9d9")

met_asv_plot <- met_asv %>%
  ggplot(aes(y=fct_rev(depth), x=sobs)) +
  geom_col(aes(group = depth, fill = TAXA), color = "black", width = 0.78, linewidth = 0.25, alpha=1) +
  labs(title=NULL,
       y="Depth (m)",
       x="Observed ASVs") +
  scale_fill_manual(values = taxa_colors,
                   limits = taxa_sorted) + 
  guides(fill = guide_legend(title = "Invertebrates"),
         color = "none") + theme_custom_paper() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10))

met_asv_plot

ggsave("./plots-final/met_obs_taxa_barplot_panel.pdf", height = 5, width = 10, units = "in", dpi=300)

met_relabun_asv_plot <- make_taxabar_asv_relabun_collapse(met_asv)
met_relabun_asv_plot

ggsave("./plots-final/met_obs_taxa_relabun_panel.pdf", height = 5, width = 10, units = "in", dpi=300)

head(met_asv)
top_met <- met_asv %>% group_by(depth) %>%
  mutate(sum_obs = sum(sobs)) %>%
  mutate(RelativeAbundance = (sobs / sum_obs) * 100, na.rm = TRUE) %>%
  mutate(depth = as.factor(depth)) %>%
  ungroup() %>%
  group_by(depth, TAXA) %>%
  summarise(sum_RelativeAbundance = sum(RelativeAbundance, na.rm = TRUE), .groups = "drop") %>%
#  arrange(depth, desc(sum_RelativeAbundance)) %>%
  mutate(TAXA = fct_reorder(TAXA, sum_RelativeAbundance, .desc = FALSE)) %>%
  ungroup() %>%
  group_by(depth) %>%
  slice_max(order_by = sum_RelativeAbundance, n = 5, with_ties = FALSE) %>%
  ungroup()

top_met %>% group_by(depth) %>% mutate(sum = sum(sum_RelativeAbundance)) %>% select(-TAXA, -sum_RelativeAbundance) %>% unique()

top_met %>% group_by(depth) %>% 
  filter(TAXA != "Unassigned Metazoa" & TAXA != "Other Invertebrates") %>% mutate(sum = sum(sum_RelativeAbundance)) %>% select(-TAXA, -sum_RelativeAbundance) %>% unique()

top_met %>% group_by(depth) %>% mutate(sum = sum(sum_RelativeAbundance)) %>% 
  filter(TAXA == "Unassigned Metazoa" ) %>% select(-TAXA, -sum) %>% unique()

top_met_pub <- top_met %>% ggplot(aes(y = fct_rev(depth), x = sum_RelativeAbundance)) +
    geom_col(aes(fill = TAXA), color = "black", width = 0.78, linewidth = 0.25) +
    labs(title = NULL,
         y = "Depth (m)",
         x = "Relative Proportion (%)") +
  scale_x_continuous(limits = c(0, 100)) + 
    scale_fill_manual(values = taxa_colors,
                      limits = taxa_sorted) +
    theme_custom_paper()# Use a manually sorted order for the legend

top_met_pub

```

```{r fish-asv-taxa-scan, eval = TRUE, message = FALSE, warning = FALSE}

# fix formatting
head(fish_relabun)
dim(fish_relabun) # 485 x 30

# summarize the cleaned dataframe by Kingdom Phylum, and Class, which will help define groupings for renaming and plotting
summary_df <- fish_relabun %>% 
  group_by(Class, Order, Family, Genus) %>%
  summarise(count = n())

unique(fish_relabun$Order)

rename_taxa_fish_order <- function(df){
    df_out <- 
      df %>%
      mutate(ORDER = Order) %>%
      mutate(TAXA = case_when(
      is.na(Phylum) ~ "Unassigned Metazoa",
      is.na(Class) ~ "Unassigned Metazoa",
      is.na(Order) ~ "Unassigned Actinopterygii",
      TRUE ~ Order))
}


fish_taxa <- rename_taxa_fish_order(fish_relabun)
head(fish_taxa)
unique(fish_taxa$TAXA)

df_summarized_fish <- fish_taxa %>%
  filter(Abundance > 0) %>%
  mutate(depth = as.factor(depth)) %>%
  group_by(sample, depth, TAXA) %>%
  summarise(n_OTU = n_distinct(OTU)) 

# check data
head(df_summarized_fish)
print(df_summarized_fish)

taxa_sorted <- sort(unique(df_summarized_fish$TAXA))
print(taxa_sorted)

rename_taxa_fish_family <- function(df){
    df_out <- 
      df %>%
#      mutate(FAMILY = paste(Order, Family, sep = "-")) %>%
      mutate(TAXA = case_when(
      is.na(Phylum) ~ "Unassigned Metazoa",
      is.na(Class) ~ "Unassigned Metazoa",
      is.na(Order) ~ "Unassigned Actinopterygii",
      TRUE ~ Family))
}

taxa_colors <- c("#f4c6e5", "#e886c8", "#DC469F",
                 "#fcada4", "#fa5340",
                 "#fa8016",
                 "#9CDC46", 
                 "#56C4F0", "#0c62fb", 
                 "#ffe9a1", "#fac116", 
                 "#fb7285", "#73eaff",
                 "#a1f1d6", "#37d49f", "#116b4c", "#97d7c1","#5db843","#93e77b" ,
                 "#c31e56", "#1ea9c3",
                 "#d5d2f8", "#948ced", "#564ae3", "#2b1ec3",
                 "#910096")

fish_taxa <- rename_taxa_fish_family(fish_relabun)

df_summarized_fish <- fish_taxa %>%
  filter(Abundance > 0) %>%
  mutate(depth = as.factor(depth)) %>%
  group_by(sample, depth, TAXA) %>%
  summarise(n_OTU = n_distinct(OTU)) 

# check data
head(df_summarized_fish)
print(df_summarized_fish)

unique(df_summarized_fish$TAXA)

fish_asv <- fish_taxa %>%
  filter(Abundance > 0) %>%
  mutate(depth = as.factor(depth)) %>%
  group_by(depth, OTU, TAXA) %>%
  summarise(Abund = sum(Abundance)) %>%
  ungroup() %>%
  group_by(depth, TAXA) %>%
  mutate(sobs = specnumber(Abund)) %>%
  select(-c(OTU, Abund)) %>%
  unique() %>%
  group_by(TAXA) %>%
  mutate(sum_obs = sum(sobs)) %>%
  arrange(depth, desc(sum_obs)) %>%
  mutate(TAXA = fct_reorder(TAXA,
                            sum_obs, .desc = FALSE)) 

fish_asv$TAXA <- fct_relevel(fish_asv$TAXA, "Derichthyidae", "Nemichthyidae", "Serrivomeridae",
                             "Bathylagidae", "Microstomatidae",
                             "Alepisauridae", 
                             "Melamphaidae", 
                             "Balaenopteridae", "Delphinidae", 
                             "Moridae", "Phycidae",
                             "Myctophidae", 
                             "Alepocephalidae", 
                             "Ammodytidae", "Caristiidae", "Coryphaenidae", "Scombridae", "Stromateidae", "Zoarcidae",
                             "Eurypharyngidae",
                             "Gempylidae", 
                             "Gonostomatidae", "Phosichthyidae", "Sternoptychidae", "Stomiidae", "Molidae"
                             )


taxa_sorted <- c("Derichthyidae", "Nemichthyidae", "Serrivomeridae",
                             "Bathylagidae", "Microstomatidae",
                             "Alepisauridae", 
                             "Melamphaidae", 
                             "Balaenopteridae", "Delphinidae", 
                             "Moridae", "Phycidae",
                             "Myctophidae", 
                             "Alepocephalidae", 
                             "Ammodytidae", "Caristiidae", "Coryphaenidae", "Scombridae", "Stromateidae", "Zoarcidae",
                             "Eurypharyngidae",
                             "Gempylidae", 
                             "Gonostomatidae", "Phosichthyidae", "Sternoptychidae", "Stomiidae", "Molidae")

fish_asv_plot <- fish_asv %>%
  ggplot(aes(y=fct_rev(depth), x=sobs)) +
  geom_col(aes(group = depth, fill = TAXA), color = "black", width = 0.8, linewidth = 0.5, alpha=1) +
  labs(title=NULL,
       y="Depth (m)",
       x="Observed ASVs") +
  scale_fill_manual(values = taxa_colors,
                   limits = taxa_sorted) + 
  guides(fill = guide_legend(title = "Vertebrates"),
         color = "none") + theme_custom_paper() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10))

fish_asv_plot

ggsave("./plots-final/fish_obs_taxa_family_barplot_panel.pdf", height = 5, width = 12, units = "in", dpi=300)

# I don't want to plot something with 26 groups especially since most groups have few ASVs. Let's combine.
plot_check <- fish_taxa %>% select(OTU, TAXA, Abundance) %>%
    mutate(RelativeAbundance = (Abundance / sum(Abundance)) * 100, na.rm = TRUE) %>%
    ungroup() %>%
    group_by(TAXA) %>%
    summarise(sum_RelativeAbundance = sum(RelativeAbundance, na.rm = TRUE), .groups = "drop") %>%
    arrange(sum_RelativeAbundance)

# filter out low relative abundance (< 1%) for plotting purposes
taxa_list <- plot_check %>% filter(sum_RelativeAbundance < 1)
taxa_list
taxa_sorted <- sort(unique(taxa_list$TAXA))
taxa_sorted

fish_asv_low_abun <- fish_asv %>%
    select(TAXA, sobs) %>%
    group_by(TAXA) %>%
    summarise(taxa_obs = sum(sobs)) %>%
    ungroup() %>%
    mutate(relabun = taxa_obs / sum(taxa_obs) * 100) %>% 
    arrange(relabun) %>% filter(relabun < 1)

fish_asv_low_abun <- fish_asv_low_abun$TAXA

fish_asv1 <- fish_asv %>% mutate(TAXA = case_when(
  TAXA %in% fish_asv_low_abun ~ "Other Vertebrates",
  TRUE ~ TAXA
)) %>%
  group_by(depth, TAXA) %>%
  mutate(sobs_new = sum(sobs))

unique(fish_asv1$TAXA)
head(fish_asv1, n = 30)

taxa_colors <- c("#d5d2f8", "#9790ee", 
                "#a1f1d6", "#f5eb8e","#9CDC46",
                "#5db843", "#116b4c", 
                  "#56C4F0", "#0c62fb", "#034dd1","#fb7285", "#d9d9d9")

fish_asv1$TAXA <- fct_relevel(fish_asv1$TAXA, "Nemichthyidae", "Serrivomeridae",
                             "Melamphaidae", 
                             "Myctophidae", 
                             "Alepocephalidae", 
                             "Ammodytidae", "Coryphaenidae", 
                             "Gonostomatidae", "Sternoptychidae", "Stomiidae", "Molidae",
                             "Other Vertebrates"
                             )

taxa_sorted <- c("Nemichthyidae", "Serrivomeridae",
                             "Melamphaidae", 
                             "Myctophidae", 
                             "Alepocephalidae", 
                             "Ammodytidae", "Coryphaenidae", 
                             "Gonostomatidae", "Sternoptychidae", "Stomiidae", "Molidae",
                             "Other Vertebrates"
                             )


fish_relabun_asv_plot <- make_taxabar_asv_relabun_collapse(fish_asv1)
fish_relabun_asv_plot

ggsave("./plots-final/fish_obs_taxa_family_relabun_panel.pdf", height = 5, width = 14, units = "in", dpi=300)

fish_asv_plot <- fish_asv1 %>% select(depth, TAXA, sobs_new) %>%
  unique() %>%
  ggplot(aes(y=fct_rev(depth), x=sobs_new)) +
  geom_col(aes(group = depth, fill = TAXA), color = "black", width = 0.78, linewidth = 0.25, alpha=1) +
  labs(title=NULL,
       y="Depth (m)",
       x="Observed ASVs") +
  scale_fill_manual(values = taxa_colors,
                   limits = taxa_sorted) + 
  guides(fill = guide_legend(title = "Vertebrates"),
         color = "none") + theme_custom_paper() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10))

fish_asv_plot

ggsave("./plots-final/fish_obs_taxa_family_barplot_panel_simplified.pdf", height = 5, width = 12, units = "in", dpi=300)

head(fish_asv1)

top_fish <- fish_asv1 %>% group_by(depth) %>%
  mutate(sum_obs = sum(sobs)) %>%
  mutate(RelativeAbundance = (sobs / sum_obs) * 100, na.rm = TRUE) %>%
  mutate(depth = as.factor(depth)) %>%
  ungroup() %>%
  group_by(depth, TAXA) %>%
  summarise(sum_RelativeAbundance = sum(RelativeAbundance, na.rm = TRUE), .groups = "drop") %>%
#  arrange(depth, desc(sum_RelativeAbundance)) %>%
  mutate(TAXA = fct_reorder(TAXA, sum_RelativeAbundance, .desc = FALSE)) %>%
  ungroup() %>%
  group_by(depth) %>%
  slice_max(order_by = sum_RelativeAbundance, n = 5, with_ties = FALSE) %>%
  ungroup()

top_fish

top_fish %>% group_by(depth) %>% mutate(sum = sum(sum_RelativeAbundance)) %>% select(-TAXA, -sum_RelativeAbundance) %>% unique()

top_fish_pub <- top_fish %>% ggplot(aes(y = fct_rev(depth), x = sum_RelativeAbundance)) +
    geom_col(aes(fill = TAXA), color = "black", width = 0.78, linewidth = 0.25) +
    labs(title = NULL,
         y = "Depth (m)",
         x = "Relative Proportion (%)") +
  scale_x_continuous(limits = c(0, 100)) + 
    scale_fill_manual(values = taxa_colors,
                      limits = taxa_sorted) +
    theme_custom_paper()# Use a manually sorted order for the legend

top_fish_pub

```

```{r save-load-asv-files, eval = TRUE, message = FALSE, warning = FALSE}

# save files to avoid redoing work
save(prot_asv, met_asv, fish_asv, fish_asv1, file = "./phyloseq/for_plotting_taxa_asv.RData")

load(file = "./phyloseq/for_plotting_taxa_asv.RData", verbose = T)

```

```{r combined-asv-proportion, eval = TRUE, message = FALSE, warning = FALSE}

## Relative Proportion (%)
prot_relabun_asv_pub <- prot_relabun_asv_plot + labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Protists") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))

prot_relabun_asv_pub

met_relabun_asv_pub <- met_relabun_asv_plot + labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Invertebrates") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))
met_relabun_asv_pub

fish_relabun_asv_pub <- fish_relabun_asv_plot + labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Vertebrates") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))

fish_relabun_asv_pub


(prot_relabun_asv_pub + met_relabun_asv_pub + fish_relabun_asv_pub) + plot_annotation(tag_levels = "A", tag_suffix = '.') + 
  plot_layout(guides = 'collect') & 
  theme(plot.margin = unit(c(t = 1, r = 1, b = 1, l = 1), "lines"),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        panel.spacing = unit(5, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "bottom", 
        legend.spacing.x = unit(7, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(1, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))

ggsave("./plots-final/alleuk_asv_relabun_barplot_pub.pdf", height = 120, width = 180, units = "mm", dpi=300)

```

```{r combined-asv-observed, eval = TRUE, message = FALSE, warning = FALSE}

prot_asv_pub <- prot_asv_plot + labs(x = "Observed ASVs",
       y = "Depth (m)", 
       title = "Protists") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))

prot_asv_pub


met_asv_pub <- met_asv_plot + labs(x = "Observed ASVs",
       y = "Depth (m)", 
       title = "Invertebrates") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))
met_asv_pub

fish_asv_pub <- fish_asv_plot + labs(x = "Observed ASVs",
       y = "Depth (m)", 
       title = "Vertebrates") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))

fish_asv_pub

```

```{r combined-asv-plots, eval = TRUE, message = FALSE, warning = FALSE}

prot_asv_pub <- prot_asv_plot + labs(x = "Observed ASVs",
       y = "Depth (m)", 
       title = "Protists") + 
  theme(legend.position = "none") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))

prot_asv_pub

met_asv_pub <- met_asv_plot + labs(x = "Observed ASVs",
       y = "Depth (m)", 
       title = "Invertebrates") + 
  theme(legend.position = "none") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))
met_asv_pub

fish_asv_pub <- fish_asv_plot + labs(x = "Observed ASVs",
       y = "Depth (m)", 
       title = "Vertebrates") + 
  theme(legend.position = "none") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))

fish_asv_pub

```

```{r combined-top-asv-proportion eval = TRUE, message = FALSE, warning = FALSE}

top_prot_plot_pub <- top_prot_pub + labs(x = "Observed ASVs",
       y = "Depth (m)", 
       title = "Protists") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))

top_prot_plot_pub


top_met_plot_pub <- top_met_pub + labs(x = "Observed ASVs",
       y = "Depth (m)", 
       title = "Invertebrates") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))
top_met_plot_pub

top_fish_plot_pub <- top_fish_pub + labs(x = "Observed ASVs",
       y = "Depth (m)", 
       title = "Vertebrates") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2))
top_fish_plot_pub


```

```{r asv-figure-for-pub eval = TRUE, message = FALSE, warning = FALSE}

(prot_asv_pub + met_asv_pub + fish_asv_pub) / (prot_relabun_asv_pub + met_relabun_asv_pub + fish_relabun_asv_pub) + 
    plot_layout(guides = 'collect') + plot_annotation(tag_levels = "A", tag_suffix = '.')  & 
  theme(plot.margin = unit(c(t = 1, r = 1, b = 1, l = 1), "lines"),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        panel.spacing = unit(3, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "bottom", 
        legend.spacing.x = unit(7, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(1, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size = 6),
        axis.title = element_text(size = 8))

ggsave("./plots-final/alleuk_asv_relabun_barplot_pub.pdf", height = 180, width = 180, units = "mm", dpi=300)

(prot_asv_pub + met_asv_pub + fish_asv_pub) / (top_prot_plot_pub + top_met_plot_pub + top_fish_plot_pub) + 
  plot_layout(guides = 'collect') + plot_annotation(tag_levels = "A", tag_suffix = '.')  & 
  theme(plot.margin = unit(c(t = 1, r = 1, b = 1, l = 1), "lines"),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        panel.spacing = unit(3, "mm"),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "bottom", 
        legend.spacing.x = unit(7, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(1, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size = 6),
        axis.title = element_text(size = 8))

ggsave("./plots-final/alleuk_asv_relabun_barplot_pub2.pdf", height = 180, width = 180, units = "mm", dpi=300)

# publication figure was created by combining these because the legend for the top ASVs are wonky. I replaced the relative proportion with the top ASV proportion in the publication figure.

```

```{r alpha-stats-anova, eval = TRUE, message = FALSE, warning = FALSE}

# Metazoa
head(alpha_div_indice_df)
met_stats <- alpha_div_indice_df %>% 
  filter(Group == "Metazoa") %>%
  as.data.frame()

head(met_stats)
class(met_stats)
dim(met_stats)

# extract Metazoa data out

# set up dataframe
rownames(met_stats) <- met_stats$sample
met_stats$depth <- as.factor(met_stats$depth)
met_stats$deployment <- as.factor(met_stats$deployment)
head(met_stats)

# Observed
res_aov <- aov(sobs ~ depth, data = met_stats)
summary(res_aov)
hist(res_aov$residuals)
tukey <- TukeyHSD(x = res_aov, ordered = TRUE)
tukey
tukey_met_obs <- tukey[["depth"]] %>% as.data.frame()
tukey_met_obs
colnames(tukey_met_obs)[4] <- "p.adj"
filter(tukey_met_obs, p.adj < 0.05)


# Shannon
res_aov <- aov(shannon ~ depth, data = met_stats)
summary(res_aov)
hist(res_aov$residuals)

tukey <- TukeyHSD(x = res_aov, ordered = TRUE)
tukey
tukey_met_sha <- tukey[["depth"]] %>% as.data.frame()
tukey_met_sha
colnames(tukey_met_sha)[4] <- "p.adj"
filter(tukey_met_sha, p.adj < 0.05)

# Evenness
res_aov <- aov(evenness ~ depth, data = met_stats)
summary(res_aov)
hist(res_aov$residuals)

tukey <- TukeyHSD(x = res_aov, ordered = TRUE)
tukey
tukey_met_even <- tukey[["depth"]] %>% as.data.frame()
tukey_met_even
colnames(tukey_met_even)[4] <- "p.adj"
filter(tukey_met_even, p.adj < 0.05)



# Protist
head(alpha_div_indice_df)
prot_stats <- alpha_div_indice_df %>% 
  filter(Group == "Protists") %>%
  as.data.frame()

head(prot_stats)
class(prot_stats)
dim(prot_stats)

# extract Protist data out

# set up dataframe
rownames(prot_stats) <- prot_stats$sample
prot_stats$depth <- as.factor(prot_stats$depth)
prot_stats$deployment <- as.factor(prot_stats$deployment)
head(prot_stats)

# Observed
res_aov <- aov(sobs ~ depth, data = prot_stats)
summary(res_aov)
hist(res_aov$residuals)
tukey <- TukeyHSD(x = res_aov, ordered = TRUE)
tukey
tukey_prot_obs <- tukey[["depth"]] %>% as.data.frame()
tukey_prot_obs
colnames(tukey_prot_obs)[4] <- "p.adj"
filter(tukey_prot_obs, p.adj < 0.05)

# Shannon
res_aov <- aov(shannon ~ depth, data = prot_stats)
summary(res_aov)
hist(res_aov$residuals)

tukey <- TukeyHSD(x = res_aov, ordered = TRUE)
tukey
tukey_prot_sha <- tukey[["depth"]] %>% as.data.frame()
tukey_prot_sha
colnames(tukey_prot_sha)[4] <- "p.adj"
filter(tukey_prot_sha, p.adj < 0.05)

# Evenness
res_aov <- aov(evenness ~ depth, data = prot_stats)
summary(res_aov)
hist(res_aov$residuals)

tukey <- TukeyHSD(x = res_aov, ordered = TRUE)
tukey
tukey_prot_even <- tukey[["depth"]] %>% as.data.frame()
tukey_prot_even
colnames(tukey_prot_even)[4] <- "p.adj"
filter(tukey_prot_even, p.adj < 0.05)



# Fish
head(alpha_div_indice_df)
fish_stats <- alpha_div_indice_df %>% 
  filter(Group == "Fish") %>%
  as.data.frame()

head(fish_stats)
class(fish_stats)
dim(fish_stats)

# extract Fish data out

# set up dataframe
rownames(fish_stats) <- fish_stats$sample
fish_stats$depth <- as.factor(fish_stats$depth)
fish_stats$deployment <- as.factor(fish_stats$deployment)
head(fish_stats)

# Observed
res_aov <- aov(sobs ~ depth, data = fish_stats)
summary(res_aov)
hist(res_aov$residuals)
tukey <- TukeyHSD(x = res_aov, ordered = TRUE)
tukey
tukey_fish_obs <- tukey[["depth"]] %>% as.data.frame()
tukey_fish_obs
colnames(tukey_fish_obs)[4] <- "p.adj"
filter(tukey_fish_obs, p.adj < 0.05)

# Shannon
res_aov <- aov(shannon ~ depth, data = fish_stats)
summary(res_aov)
hist(res_aov$residuals)
  
tukey <- TukeyHSD(x = res_aov, ordered = TRUE)
tukey
tukey_fish_sha <- tukey[["depth"]] %>% as.data.frame()
tukey_fish_sha
colnames(tukey_fish_sha)[4] <- "p.adj"
filter(tukey_fish_sha, p.adj < 0.05)

# Evenness
res_aov <- aov(evenness ~ depth, data = fish_stats)
summary(res_aov)
hist(res_aov$residuals)

tukey <- TukeyHSD(x = res_aov, ordered = TRUE)
tukey
tukey_fish_even <- tukey[["depth"]] %>% as.data.frame()
tukey_fish_even
colnames(tukey_fish_even)[4] <- "p.adj"
filter(tukey_fish_even, p.adj < 0.05)

```


# 3. Beta Diversity 
## 3.1 Relative Abundance
```{r relabun-setup, eval = TRUE, message = FALSe, warning = FALSE}

# functions
make_taxabar_relabun_agg <- function(df) {
  df %>%
    group_by(depth) %>%
    mutate(RelativeAbundance = (Abundance / sum(Abundance)) * 100, na.rm = TRUE) %>%
    mutate(depth = as.factor(depth)) %>%
    ungroup() %>%
    group_by(depth, TAXA) %>%
    summarise(sum_RelativeAbundance = sum(RelativeAbundance), na.rm = TRUE, .groups = "drop") %>%
    arrange(depth, desc(sum_RelativeAbundance)) %>%
    mutate(TAXA = fct_reorder(TAXA, sum_RelativeAbundance, .desc = FALSE)) %>%
    ggplot(aes(y = fct_rev(depth), x = sum_RelativeAbundance)) +
    geom_col(aes(fill = TAXA), color = "black", width = 0.75, linewidth = 0.25) +
    labs(title = NULL,
         y = "Depth (m)",
         x = "Relative Abundance (%)") +
    scale_fill_manual(values = taxa_colors,
                        limits = taxa_sorted) + theme_custom_paper()
}

make_taxabar_relabun_collapse <- function(df) {
  df %>%
    group_by(depth, deployment) %>%
    mutate(RelativeAbundance = (Abundance / sum(Abundance)) * 100, na.rm = TRUE) %>%
    mutate(depth = as.factor(depth)) %>%
    ungroup() %>%
    group_by(depth, deployment, TAXA) %>%
    summarise(sum_RelativeAbundance = sum(RelativeAbundance, na.rm = TRUE), .groups = "drop") %>%
    arrange(depth, desc(sum_RelativeAbundance)) %>%
    mutate(TAXA = fct_reorder(TAXA, sum_RelativeAbundance, .desc = FALSE)) %>%
    ggplot(aes(y = fct_rev(depth), x = sum_RelativeAbundance)) +
    geom_col(aes(fill = TAXA), color = "black", width = 0.8, linewidth = 0.5) +
    labs(title = NULL,
         y = "Depth (m)",
         x = "Relative Abundance (%)") +
    facet_wrap(. ~ deployment) + 
    scale_fill_manual(values = taxa_colors,
                        limits = taxa_sorted) +
    theme_custom_paper()# Use a manually sorted order for the legend
}

```

```{r relabun-plots-agg, eval = TRUE, message = FALSE, warning = FALSE}

unique(prot_taxa2$TAXA)

prot_taxa_abun_check <- prot_taxa2 %>% select(TAXA, Abundance) %>%
  mutate(sumabun = sum(Abundance)) %>%
  group_by(TAXA) %>%
  mutate(relabun = Abundance / sumabun) %>%
  summarise(sum_RelativeAbundance = sum(relabun) * 100, na.rm = TRUE, .groups = "drop")

head(prot_taxa_abun_check)

# I will move all TAXA that is < 1 % into "Other Eukaryotes

group_low_abun_taxa <- prot_taxa_abun_check %>% filter(sum_RelativeAbundance < 1) 
head(group_low_abun_taxa)
group_low_abun_taxa = group_low_abun_taxa$TAXA
group_low_abun_taxa

prot_taxa_relabun <- prot_taxa2 %>%
    mutate(TAXA = case_when(
      TAXA %in% group_low_abun_taxa ~ "Other Protists",
      TRUE ~ TAXA))

taxa_sorted <- c("Alveolata-Apicomplexa", "Alveolata-Ciliates",
                             "Alveolata-Dinoflagellates", 
                             "Alveolata-Syndiniales", 
                             "Chlorophyta", 
                             "Excavata",
                             "Haptophyta",
                             "Rhizaria-Radiolaria",
                 "Stramenopiles-Diatoms", "Stramenopiles-MAST", "Stramenopiles-Other", "Other Protists")



taxa_colors <- c("#a1c2fd", "#56C4F0", "#399dff", "#0344b7",
                 "#9CDC46","#efdf48", "#ff9aa5",
                 "#7474ff",
                 "#009a4d","#1ec38c", "#90eebf", "#d9d9d9")

head(prot_taxa_relabun)
dim(prot_taxa_relabun)
unique(prot_taxa_relabun$TAXA) # 12 taxa

prot_taxa_relabun$TAXA <- fct_relevel(prot_taxa_relabun$TAXA, "Other Protists", after = Inf)

prot_relabun_agg <- make_taxabar_relabun_agg(prot_taxa_relabun) + 
  theme(legend.position = "bottom") +
      labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Protists") + 
  guides(fill = guide_legend(title = NULL,
                             nrow = 6,
                             override.aes = list(stroke = 1)))
    
prot_relabun_agg 

ggsave("./plots-final/prot_relabun_agg_barplot.pdf", height = 5, width = 3, units = "in", dpi=300)


prot_relabun_deploy <- make_taxabar_relabun_collapse(prot_taxa_relabun) + 
  theme(legend.position = "right") +
      labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Protists") + 
  guides(fill = guide_legend(title = NULL,
                             ncol = 1,
                             override.aes = list(stroke = 1)))
    
prot_relabun_deploy 

length(unique(prot_taxa_relabun$OTU))

ggsave("./plots-final/prot_relabun_deploy_barplot.pdf", height = 4, width = 9, units = "in", dpi=300)

# Invertebrates

met_taxa_abun_check <- met_taxa_order3 %>% select(TAXA, Abundance) %>%
  mutate(sumabun = sum(Abundance)) %>%
  group_by(TAXA) %>%
  mutate(relabun = Abundance / sumabun) %>%
  summarise(sum_RelativeAbundance = sum(relabun) * 100, na.rm = TRUE, .groups = "drop")

head(met_taxa_abun_check)

# I will move all TAXA that is < 1 % into "Other Eukaryotes

group_low_abun_taxa <- met_taxa_abun_check %>% filter(sum_RelativeAbundance < 1) 
head(group_low_abun_taxa)
group_low_abun_taxa = group_low_abun_taxa$TAXA
group_low_abun_taxa

met_taxa_relabun <- met_taxa_order3 %>%
  mutate(TAXA = case_when(
    TAXA %in% group_low_abun_taxa ~ "Other Invertebrates",
    TRUE ~ TAXA))

met_taxa_relabun$TAXA <- fct_relevel(met_taxa_relabun$TAXA, "Arthropoda-Calanoida", "Arthropoda-Cyclopoida",
                             "Cnidaria-Siphonophorae",
                             "Cnidaria-Other", 
                             "Ctenophora-Cydippida", 
                             "Tunicata-Copelata", 
                             "Tunicata-Salpida", "Other Invertebrates")

taxa_sorted <- c("Arthropoda-Calanoida", "Arthropoda-Cyclopoida",
                             "Cnidaria-Siphonophorae",
                             "Cnidaria-Other", 
                             "Ctenophora-Cydippida", 
                             "Tunicata-Copelata", 
                             "Tunicata-Salpida", "Other Invertebrates")

taxa_colors <- c("#fc996c", "#ffce5c",
                 "#047de9", "#0344b7", 
                 "#fa9db8", 
                 "#96fac6","#26a33a",
                 "#d9d9d9")


met_relabun_agg <- make_taxabar_relabun_agg(met_taxa_relabun) + 
  labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Invertebrates") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 2,
                             override.aes = list(stroke = 1)))
met_relabun_agg

met_relabun_deploy <- make_taxabar_relabun_collapse(met_taxa_relabun) + 
  labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Invertebrates") + 
  theme(legend.position = "right") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 1,
                             override.aes = list(stroke = 1)))
met_relabun_deploy

ggsave("./plots-final/met_relabun_deploy_barplot.pdf", height = 4, width = 9, units = "in", dpi=300)

length(unique(met_taxa_relabun$OTU))


# let's assess the unassigned portions
unassigned_check <- filter(met_taxa_order, TAXA == "Arthropoda-Other" | TAXA == "Unassigned Metazoa") %>% select(sample, OTU, Abundance, depth, Phylum, Order, TAXA)
dim(unassigned_check)
unassigned_check <- unassigned_check %>% filter(Order %in% c("Unassigned", "uncultured"))
dim(unassigned_check)
head(unassigned_check)
tail(unassigned_check)
unassigned_check$Order %>% unique()

# sum_seqs
n_seqs <- met_taxa_order %>% select(sample, depth, n_seqs) %>%
  unique() %>%
  group_by(depth) %>%
  mutate(sum_seqs = sum(n_seqs))

head(n_seqs)

#let's see what % of sequences were recovered
# Set the option to disable scientific notation
options(scipen = 999)

taxa_assigned_check <- taxa_assigned %>% select(OTU, Organism, Order) %>%
  left_join(unassigned_check, by = "OTU")  %>% left_join(n_seqs, by = "sample") %>%
  select(OTU, Order = Order.x, sample, Abundance, depth = depth.x, TAXA, sum_seqs) %>%
  group_by(depth) %>%
  mutate(RelativeAbundance = (Abundance / sum_seqs) * 100, na.rm = TRUE) %>%
  select(-c(sample, Abundance))

total_added <- taxa_assigned_check %>% 
  group_by(depth) %>%
  summarize(totaladded = sum(RelativeAbundance))

total_added_bytaxa <- taxa_assigned_check %>% 
  group_by(depth, Order) %>%
  summarize(taxa_added = sum(RelativeAbundance))

taxa_assigned_plot <- taxa_assigned %>% select(OTU, Organism, Order) %>%
  left_join(unassigned_check, by = "OTU")  %>% left_join(n_seqs, by = "sample") %>%
  select(OTU, Order = Order.x, sample, Abundance, depth = depth.x, sum_seqs)

head(taxa_assigned_plot)
tail(taxa_assigned_plot)
taxa_assigned_plot$Order %>% unique() %>% sort()

taxa_assigned_plot1 <- taxa_assigned_plot %>%
    mutate(Phylum = case_when(
      Order == "Amphipoda" ~ "Arthropoda",
      Order == "Calanoida" ~ "Arthropoda",
      Order == "Copelata" ~ "Tunicata",
      Order == "Cyclopoida" ~ "Arthropoda",
      Order == "Decapoda" ~ "Arthropoda",
      Order == "Doliolida" ~ "Tunicata",
      Order == "Enoplida" ~ "Nematoda",
      Order == "Harpacticoida" ~ "Arthropoda",
      Order == "Leptothecata" ~ "Cnidaria",
      Order == "Mormonilloida" ~ "Arthropoda",
      Order == "Phyllodocida" ~ "Annelida",
      Order == "Ploima" ~ "Rotifera",
      Order == "Salpida" ~ "Tunicata",
      Order == "Scalpellomorpha" ~ "Arthropoda",
      Order == "Siphonophorae" ~ "Cnidaria",
      Order == "Spionida" ~ "Annelida",
      TRUE ~ Order))

taxa_assigned_plot1$Phylum %>% unique() %>% sort()

taxa_assigned_plot2 <- silva_met_rename_order(taxa_assigned_plot1)
taxa_assigned_plot2$TAXA %>% unique() %>% sort()
taxa_assigned_plot3 <- rename_met_forplots(taxa_assigned_plot2)
taxa_assigned_plot3$TAXA %>% unique() %>% sort()

taxa_sorted <- c("Arthropoda-Calanoida", "Arthropoda-Cyclopoida",
                             "Arthropoda-Other", 
                             "Cnidaria-Siphonophorae",
                             "Cnidaria-Other", 
                             "Tunicata-Copelata", "Tunicata-Salpida", "Other Invertebrates")

taxa_colors <- c("#fc996c", "#ffce5c","#fdfb9b", 
                 "#047de9", "#0344b7", 
                 "#96fac6","#1ec38c", 
                  "#d9d9d9")

assigned <- taxa_assigned_plot3 %>%
  group_by(depth) %>%
    mutate(RelativeAbundance = (Abundance / sum_seqs) * 100, na.rm = TRUE) %>%
    mutate(depth = as.factor(depth)) %>%
    ungroup() %>%
    group_by(depth, TAXA) %>%
    summarise(sum_RelativeAbundance = sum(RelativeAbundance), na.rm = TRUE, .groups = "drop") %>%
    arrange(depth, desc(sum_RelativeAbundance)) %>%
#    mutate(TAXA = fct_reorder(TAXA, sum_RelativeAbundance, .desc = FALSE)) %>%
    ggplot(aes(y = fct_rev(depth), x = sum_RelativeAbundance)) +
    geom_col(aes(fill = TAXA), color = "black", width = 0.75, linewidth = 0.25) +
    labs(title = NULL,
         y = "Depth (m)",
         x = "Relative Abundance (%)") +
    scale_fill_manual(values = taxa_colors,
                        limits = taxa_sorted) + 
   scale_x_continuous(limits = c(0, 100)) + theme_custom_paper()

assigned

assigned <- assigned + labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Invertebrates - Assigned") + 
  theme(legend.position = "right") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 1,
                             override.aes = list(stroke = 1)))

assigned

met_taxa_abun_check_unassigned <- met_taxa_order %>% select(TAXA, Abundance) %>%
  mutate(sumabun = sum(Abundance)) %>%
  group_by(TAXA) %>%
  mutate(relabun = Abundance / sumabun) %>%
  summarise(sum_RelativeAbundance = sum(relabun) * 100, na.rm = TRUE, .groups = "drop")

head(met_taxa_abun_check_unassigned)

met_taxa_relabun_unassign <- silva_met_rename_order(met_taxa_order)
met_taxa_relabun_unassign$TAXA %>% unique() %>% sort()
met_taxa_relabun_unassign <- rename_met_forplots(met_taxa_relabun_unassign)
met_taxa_relabun_unassign$TAXA %>% unique() %>% sort()

met_taxa_relabun_unassign <- met_taxa_relabun_unassign %>%
  mutate(TAXA = case_when(
    Phylum == "Arthropoda" & Order == "Unassigned" ~ "Unassigned Metazoa",
    TRUE ~ TAXA))

unique(met_taxa_relabun_unassign$TAXA) %>% sort()

met_taxa_relabun_unassign$TAXA <- fct_relevel(met_taxa_relabun_unassign$TAXA, "Arthropoda-Calanoida", "Arthropoda-Cyclopoida", "Arthropoda-Other",
                             "Cnidaria-Siphonophorae",
                             "Cnidaria-Other", 
                             "Ctenophora-Cydippida", "Ctenophora-Other",
                             "Tunicata-Copelata", 
                             "Tunicata-Salpida", "Unassigned Metazoa", "Other Invertebrates")

taxa_sorted <- c("Arthropoda-Calanoida", "Arthropoda-Cyclopoida", "Arthropoda-Other",
                             "Cnidaria-Siphonophorae",
                             "Cnidaria-Other", 
                             "Ctenophora-Cydippida", "Ctenophora-Other",
                             "Tunicata-Copelata", 
                             "Tunicata-Salpida",  "Unassigned Metazoa", "Other Invertebrates")

taxa_colors <- c("#fc996c", "#ffce5c","#fdfb9b", 
                 "#047de9", "#0344b7", 
                 "#fa9db8", "#fc5d7b",
                 "#96fac6","#1ec38c", 
                  "#82A4E3", "#d9d9d9")


met_relabun_agg_unassign <- make_taxabar_relabun_agg(met_taxa_relabun_unassign) + 
  labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Invertebrates - Unassigned") + 
  theme(legend.position = "right") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 1,
                             override.aes = list(stroke = 1)))
met_relabun_agg_unassign

met_relabun_agg_unassign + assigned +
  plot_layout(guides = 'collect') &
  theme(plot.margin = unit(c(t = 0.5, r = 0.5, b = 0.5, l = 0.5), "lines"),
        panel.spacing = unit(5, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "right", 
        legend.spacing.x = unit(4, "mm"), 
        legend.margin = margin(t = 200, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(1, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))

ggsave("./plots-final/unassigned_relabun_ponel_barplot.pdf", height = 3, width = 5.5, units = "in", dpi=300)

plot_check <- fish_taxa %>% select(OTU, TAXA, Abundance) %>%
    mutate(RelativeAbundance = (Abundance / sum(Abundance)) * 100, na.rm = TRUE) %>%
    ungroup() %>%
    group_by(TAXA) %>%
    summarise(sum_RelativeAbundance = sum(RelativeAbundance, na.rm = TRUE), .groups = "drop") %>%
    arrange(sum_RelativeAbundance)

# filter out low relative abundance (< 1%) for plotting purposes
taxa_list <- plot_check %>% filter(sum_RelativeAbundance < 1)
taxa_list
taxa_sorted <- sort(unique(taxa_list$TAXA))
taxa_sorted

rename_taxa_fish_plots <- function(df){
      df %>%
      mutate(TAXA = case_when(
      is.na(Phylum) ~ "Unassigned Metazoa",
      is.na(Class) ~ "Unassigned Metazoa",
      is.na(Order) ~ "Unassigned Actinopterygii",
      Family %in% taxa_sorted ~ "Other Vertebrates",
      TRUE ~ Family))
}

fish_taxa_relabun <- rename_taxa_fish_plots(fish_relabun)
head(fish_taxa_relabun)

unique(fish_taxa_relabun$TAXA)

head(fish_taxa_relabun)
dim(fish_taxa_relabun)
unique(fish_taxa_relabun$TAXA) # 10 taxa

fish_taxa_relabun$TAXA <- fct_relevel(fish_taxa_relabun$TAXA, "Nemichthyidae", "Serrivomeridae",
                             "Melamphaidae", 
                             "Myctophidae", 
                             "Alepocephalidae", 
                             "Gonostomatidae", "Sternoptychidae", 
                             "Stomiidae", 
                             "Molidae", "Other Vertebrates")


taxa_sorted <- c("Nemichthyidae", "Serrivomeridae",
                             "Melamphaidae", 
                             "Myctophidae", 
                             "Alepocephalidae", 
                             "Gonostomatidae", "Sternoptychidae", 
                             "Stomiidae", 
                             "Molidae", "Other Vertebrates")


taxa_colors <- c("#d5d2f8", "#9790ee", 
                "#a1f1d6","#f5eb8e",
                 "#9CDC46", 
                  "#56C4F0", "#0c62fb", "#034dd1","#fb7285", "#d9d9d9")

fish_relabun_agg <- make_taxabar_relabun_agg(fish_taxa_relabun) + 
  labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Vertebrates") + 
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = NULL,
                             nrow = 5,
                             override.aes = list(stroke = 1)))

fish_relabun_agg

ggsave("./plots-final/fish_relabun_agg_barplot.pdf", height = 5, width = 3, units = "in", dpi=300)

fish_relabun_deploy <- make_taxabar_relabun_collapse(fish_taxa_relabun) + 
  labs(x = "Relative Abundance (%)",
       y = "Depth (m)", 
       title = "Vertebrates") + 
  theme(legend.position = "right") +
  guides(fill = guide_legend(title = NULL,
                             ncol = 1,
                             override.aes = list(stroke = 1)))

fish_relabun_deploy
ggsave("./plots-final/fish_relabun_deploy_barplot.pdf", height = 4, width = 9, units = "in", dpi=300)

length(unique(fish_taxa_relabun$OTU))

# combined

panel2 <- prot_relabun_agg + met_relabun_agg + fish_relabun_agg + 
  plot_annotation(tag_levels = "A", tag_suffix = '.') + 
  plot_layout(guides = 'collect') &
  theme(plot.margin = unit(c(t = 0.5, r = 1.5, b = 0.5, l = 1), "lines"),
        panel.spacing = unit(10, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.background = element_blank(),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "bottom", 
        legend.spacing.x = unit(4, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(1, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))

panel2

ggsave("./plots-final/alleuk_relabun_barplot_pub.pdf", height = 90, width = 180, units = "mm", dpi=300)


panel3 <- prot_relabun_deploy / met_relabun_deploy / fish_relabun_deploy + 
  plot_annotation(tag_levels = "A", tag_suffix = '.') + 
  plot_layout(guides = 'collect') &
  theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(6, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.position = "right", 
        legend.margin = margin(t = 10, r = 20, b = 50, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))

panel3

ggsave("./plots-final/alleuk_relabun_barplot_pub_deploy.pdf", height = 200, width = 180, units = "mm", dpi=300)

```

### 3.2 Ordination
```{r pca, eval = TRUE, message = FALSE, warning = FALSE}

depth_colors <- c("#C3E9CE", "#60CEAC", "#3497A9",  "#395D9C", "#413D7B", "#2E1E3C")

# check dataframes
head(rare_prot)
dim(rare_prot)

length(unique(rare_prot$sample))

rare_prot_dist <- rare_prot %>%
  select(sample, OTU, Abundance) %>% 
  pivot_wider(names_from = "OTU", values_from = "Abundance", values_fill = 0) %>% column_to_rownames(var = "sample") %>% data.frame()

# check dataframes
head(rare_met)
dim(rare_met)

length(unique(rare_met$sample))

rare_met_dist <- rare_met %>%
  select(sample, OTU, Abundance) %>% 
  pivot_wider(names_from = "OTU", values_from = "Abundance", values_fill = 0) %>% column_to_rownames(var = "sample") %>% data.frame()

head(rare_fish)
dim(rare_fish)

length(unique(rare_fish$sample))

rare_fish_dist <- rare_fish %>%
  select(sample, OTU, Abundance) %>% 
  pivot_wider(names_from = "OTU", values_from = "Abundance", values_fill = 0) %>% column_to_rownames(var = "sample") %>% data.frame()


head(rare_prot_dist)
rare_prot_dist_clr <- clr_lite(rare_prot_dist, samples_are = "rows", method = "const", replicates = 1) #We are imputing zeroes using the 'const' method 
#write.csv(rare_prot_dist_clr, file = "test.csv")
#Essentially, we replace zeroes with 65% of the next lowest value - see Lubbe et al 2021. 

head(rare_prot_dist_clr)
pca_prot_clr <- rda(rare_prot_dist_clr)

dist_prot_clr <- vegdist(rare_prot_dist_clr, method = "euclidean")

head(summary(pca_prot_clr))

unconstrained_eig <- pca_prot_clr$CA$eig/pca_prot_clr$tot.chi*100

expl_var <- unconstrained_eig
barplot(expl_var[1:20], col = rep('black', length (unconstrained_eig)),
         las = 2, ylab = '% variation')

# set env paraproters
rare_prot_env <- rare_prot %>%
  select(sample, OTU, Abundance) %>% 
  pivot_wider(names_from = "OTU", values_from = "Abundance", values_fill = 0) %>%  
  inner_join(., metadata_18s, by = "sample") %>%
  select(sample, depth, deployn, temp, oxy, sal, fluor) %>% 
  data.frame()
head(rare_prot_env)
dim(rare_prot_env)

prot.scrs <- as.data.frame(scores(pca_prot_clr, choices = c(1:5), display = "sites"))
prot.scrs
prot.scrs <- cbind(prot.scrs, Depth = rare_prot_env$depth)
prot.scrs <- cbind(prot.scrs, Deployment = rare_prot_env$deployn)

prot_pca_plot <- 
  ggplot(data = prot.scrs, aes(x = PC1, y = PC2)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, color = "#525252", linetype = "dotted") +
  geom_point(aes(fill = as.factor(Depth), shape = as.factor(Deployment)), size = 2, stroke = 0.5, alpha = 0.9) + 
  ylab(paste0('PC2 ', round(unconstrained_eig[2],2),'%')) +
  xlab(paste0('PC1 ', round(unconstrained_eig[1],2),'%')) +
  labs(title = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) + 
  scale_fill_manual(values = depth_colors) + 
    guides(fill = guide_legend(title="Depth (m)",
                             override.aes = list(shape = 21,
                                                 alpha = 1,
                                                 size = 2)),
         shape = guide_legend(title = "CTD Cast")) +
  theme_custom_paper()

prot_pca_plot

ggsave("./plots-final/beta_diversity_pca_prot.pdf", height = 60, width = 80, units = "mm", dpi=300)

prot.scrs.df <- prot.scrs %>% group_by(Depth, Deployment) %>%
  summarize(
    count = n(),
    mean = mean(PC1, na.rm = TRUE),
    sd = sd(PC1, na.rm = TRUE)
  )

pc_prot_plot <- prot.scrs.df %>%
  ggplot(aes(y = fct_rev(as.factor(Deployment)), x = mean)) +
  geom_bar(aes(fill = as.factor(Depth)), color = "black", position = position_dodge(), stat = "identity", linewidth = 0.5, alpha = 0.9) + 
  geom_errorbar(aes(xmin=mean-sd, xmax = mean+sd), width = .2, position = position_dodge(.9)) + 
  labs(title = NULL, x = "PC1", y = "Deployment") + 
  facet_grid(Depth~., scales = "free") +
  scale_fill_manual(values = depth_colors) + 
    guides(fill = "none") + 
  theme_custom_paper() + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        strip.text = element_text(size = 6),
        strip.background.y = element_rect(fill = "white"))

pc_prot_plot

ggsave("./plots-final/beta_diversity_pca_axes_prot.pdf", height = 120, width = 80, units = "mm", dpi=300)

prot.sp <- as.data.frame(scores(pca_prot_clr, choices = c(1:2), display = "species"))
prot.sp
dim(prot.sp)
head(prot_taxa2)
prot_taxa_filtered <- prot_taxa2 %>% select(OTU, Supergroup, Division, Subdivision, TAXA) %>% unique() %>% data.frame()
dim(prot_taxa_filtered)
head(prot.sp)
prot.sp <- cbind(prot.sp, OTU = rownames(prot.sp), TAXA = prot_taxa_filtered$TAXA, Supergroup = prot_taxa_filtered$Supergroup, Division = prot_taxa_filtered$Division, Subdivision = prot_taxa_filtered$Subdivision)

prot_sorted <- c("Alveolata-Apicomplexa", "Alveolata-Ciliates",
                             "Alveolata-Dinoflagellates", 
                             "Alveolata-Other", 
                             "Alveolata-Syndiniales", 
                             "Chlorophyta", 
                             "Cryptophyta", "Excavata",
                             "Haptophyta", "Rhizaria-Cercozoa", 
                             "Rhizaria-Other", 
                             "Rhizaria-Radiolaria", "Rhodophyta",
                 "Stramenopiles-Diatoms", "Stramenopiles-MAST", "Stramenopiles-Other", "Other Protists")

prot_colors <- c("#a1c2fd", "#56C4F0", "#399dff","#0b62fb", "#0344b7",
                 "#9CDC46","#dafa0f","#efdf48", "#ff9d3a",
                 "#ceceff", "#a7a7ff","#7474ff",
                 "#ff9aa5",
                 "#009a4d","#1ec38c", "#90eebf","#d9d9d9")



prot.sp.top <- prot.sp %>% slice_max(order_by = abs(PC1), n = 25, with_ties = FALSE)

top_plot <- prot.sp.top %>%
  ggplot(aes(x = PC1, y = PC2)) +
#  geom_point(data = prot.scrs, aes(fill = Depth), color = "black", shape = 21, size = 2, stroke = 0.25, alpha = 0.66) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2, color = TAXA), arrow = arrow(length = unit(0.1, "cm"), type = "closed"), linewidth = 0.5, alpha = 0.9) +
  xlab(paste0('PC1 ', round(unconstrained_eig[1],2),'%')) +
  ylab(paste0('PC2 ', round(unconstrained_eig[2],2),'%')) +
  labs(title = NULL) + 
#  facet_wrap(~Depth, scales = "free") +
  scale_shape_manual(values = c(21, 23, 24)) +
#  scale_fill_manual(values = depth_colors)) + 
  scale_color_manual(values = prot_colors,
                    limits = prot_sorted) + 
  guides(color = guide_legend(title = NULL,
                              ncol = 2)) + 
  theme_custom_paper() + 
  theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "bottom", 
        legend.spacing.x = unit(4, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(2, "mm"),
        legend.key.width = unit(3, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))


top_plot

ggsave("./plots-final/beta_diversity_pca_prot_top25.pdf", height = 100, width = 80, units = "mm", dpi=300)

rare_met_dist_clr <- clr_lite(rare_met_dist, samples_are = "rows", method = "const", replicates = 1)
head(rare_met_dist_clr)
pca_met_clr <- rda(rare_met_dist_clr)

dist_met_clr <- vegdist(rare_met_dist_clr, method = "euclidean")

head(summary(pca_met_clr))

unconstrained_eig <- pca_met_clr$CA$eig/pca_met_clr$tot.chi*100

expl_var <- unconstrained_eig
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig)),
         las = 2, ylab = '% variation')

# set env parameters
rare_met_env <- rare_met %>%
  select(sample, OTU, Abundance) %>% 
  pivot_wider(names_from = "OTU", values_from = "Abundance", values_fill = 0) %>%  
  inner_join(., metadata_18s, by = "sample") %>%
  select(depth, deployn, temp, oxy, sal, fluor) %>% 
  data.frame()
head(rare_met_env)
dim(rare_met_env)

met.scrs <- as.data.frame(scores(pca_met_clr, choices = c(1:5), display = "sites"))
met.scrs
met.scrs <- cbind(met.scrs, Depth = rare_met_env$depth)
met.scrs <- cbind(met.scrs, Deployment = rare_met_env$deployn)

met_pca_plot <- 
  ggplot(data = met.scrs, aes(x = PC1, y = PC2)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, color = "#525252", linetype = "dotted") +
  geom_point(aes(fill = as.factor(Depth), shape = as.factor(Deployment)), size = 2, stroke = 0.5, alpha = 0.9) + 
  ylab(paste0('PC2 ', round(unconstrained_eig[2],2),'%')) +
  xlab(paste0('PC1 ', round(unconstrained_eig[1],2),'%')) +
  labs(title = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) + 
  scale_fill_manual(values = depth_colors) + 
    guides(fill = guide_legend(title="Depth (m)",
                             override.aes = list(shape = 21,
                                                 alpha = 1,
                                                 size = 2)),
         shape = guide_legend(title = "CTD Cast")) +
  theme_custom_paper()

met_pca_plot

ggsave("./plots-final/beta_diversity_pca_met.pdf", height = 60, width = 80, units = "mm", dpi=300)


met.scrs.df <- met.scrs %>% group_by(Depth, Deployment) %>%
  summarize(
    count = n(),
    mean = mean(PC1, na.rm = TRUE),
    sd = sd(PC1, na.rm = TRUE)
  )

pc_met_plot <- met.scrs.df %>%
  ggplot(aes(y = fct_rev(as.factor(Deployment)), x = mean)) +
  geom_bar(aes(fill = as.factor(Depth)), color = "black", position = position_dodge(), stat = "identity", size = 2, linewidth = 0.5, alpha = 0.9) + 
  geom_errorbar(aes(xmin=mean-sd, xmax = mean+sd), width = .2, position = position_dodge(.9)) + 
  labs(title = NULL, x = "PC1", y = "Deployment") + 
  facet_grid(Depth~., scales = "free") +
  scale_fill_manual(values = depth_colors) + 
    guides(fill = "none") + 
  theme_custom_paper() + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        strip.text = element_text(size = 6),
        strip.background.y = element_rect(fill = "white"))

pc_met_plot

ggsave("./plots-final/beta_diversity_pca_axes_met.pdf", height = 120, width = 80, units = "mm", dpi=300)

met.sp <- as.data.frame(scores(pca_met_clr, choices = c(1:2), display = "species"))
met.sp
dim(met.sp)
met_taxa_filtered <- met_taxa_relabun %>% select(OTU, Phylum, Order, Genus, Species, TAXA) %>% unique() %>% data.frame()
dim(met_taxa_filtered)
head(met.sp)
met.sp <- cbind(met.sp, OTU = rownames(met.sp), TAXA = met_taxa_filtered$TAXA)

met.sp.top <- met.sp %>% slice_max(order_by = abs(PC1), n = 25, with_ties = FALSE)

met_sorted <- c("Arthropoda-Calanoida", "Arthropoda-Cyclopoida",
                             "Cnidaria-Siphonophorae",
                             "Cnidaria-Other", 
                             "Ctenophora-Cydippida", 
                             "Tunicata-Copelata", "Tunicata-Salpida", "Other Invertebrates")

met_colors <- c("#fc996c", "#ffce5c",
                 "#047de9", "#0344b7", 
                 "#fa9db8",
                 "#96fac6","#1ec38c", 
                 "#d9d9d9")

top_plot <- met.sp.top %>%
  ggplot(aes(x = PC1, y = PC2)) +
#  geom_point(aes(fill = TAXA), color = "black", shape = 21, size = 2, stroke = 0.25, alpha = 0.66) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2, color = TAXA), arrow = arrow(length = unit(0.12, "cm"), type = "closed"), linewidth = 0.5, alpha = 0.9) +
  xlab(paste0('PC1 ', round(unconstrained_eig[1],2),'%')) +
  ylab(paste0('PC2 ', round(unconstrained_eig[2],2),'%')) +
  labs(title = NULL) + 
#  facet_wrap(~Depth, scales = "free") +
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = met_colors,
                    limits = met_sorted) + 
  guides(color = guide_legend(title = NULL,
                              ncol = 2)) + 
  theme_custom_paper() + 
  theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "bottom", 
        legend.spacing.x = unit(4, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(2, "mm"),
        legend.key.width = unit(3, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))


top_plot

ggsave("./plots-final/beta_diversity_pca_met_top25.pdf", height = 100, width = 80, units = "mm", dpi=300)

rare_fish_dist_clr <- clr_lite(rare_fish_dist, samples_are = "rows", method = "const", replicates = 1)
head(rare_fish_dist_clr)
write.csv(rare_fish_dist_clr, file = "test.csv")
pca_fish_clr <- rda(rare_fish_dist_clr)

dist_fish_clr <- vegdist(rare_fish_dist_clr, method = "euclidean")

head(summary(pca_fish_clr))

unconstrained_eig <- pca_fish_clr$CA$eig/pca_fish_clr$tot.chi*100

expl_var <- unconstrained_eig
barplot (expl_var[1:20], col = rep('black', length (unconstrained_eig)),
         las = 2, ylab = '% variation')

# set env parameters
rare_fish_env <- rare_fish %>%
  select(sample, OTU, Abundance) %>% 
  pivot_wider(names_from = "OTU", values_from = "Abundance", values_fill = 0) %>%  
  inner_join(., metadata_18s, by = "sample") %>%
  select(depth, deployn, temp, oxy, sal, fluor) %>% 
  data.frame()
head(rare_fish_env)
dim(rare_fish_env)

fish.scrs <- as.data.frame(scores(pca_fish_clr, choices = c(1:5), display = "sites"))
fish.scrs
fish.scrs <- cbind(fish.scrs, Depth = rare_fish_env$depth)
fish.scrs <- cbind(fish.scrs, Deployment = rare_fish_env$deployn)

head(fish.scrs)

fish_pca_plot <- 
#  ggplot(data = fish.scrs[-60,], aes(x = PC1, y = PC2)) +
  ggplot(data = fish.scrs, aes(x = PC1, y = PC2)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, color = "#525252", linetype = "dotted") +
  geom_point(aes(fill = as.factor(Depth), shape = as.factor(Deployment)), size = 2, stroke = 0.5, alpha = 0.9) + 
  ylab(paste0('PC2 ', round(unconstrained_eig[2],2),'%')) +
  xlab(paste0('PC1 ', round(unconstrained_eig[1],2),'%')) +
  labs(title = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) + 
  scale_fill_manual(values = depth_colors) + 
    guides(fill = guide_legend(title="Depth (m)",
                             override.aes = list(shape = 21,
                                                 alpha = 1,
                                                 size = 2)),
         shape = guide_legend(title = "CTD Cast")) + theme_custom_paper()

fish_pca_plot

ggsave("./plots-final/beta_diversity_pca_fish.pdf", height = 60, width = 80, units = "mm", dpi=300)

fish.scrs.df <- fish.scrs %>% group_by(Depth, Deployment) %>%
  summarize(
    count = n(),
    mean = mean(PC1, na.rm = TRUE),
    sd = sd(PC1, na.rm = TRUE)
  )

pc_fish_plot <- fish.scrs.df %>%
  ggplot(aes(y = fct_rev(as.factor(Deployment)), x = mean)) +
  geom_bar(aes(fill = as.factor(Depth)), color = "black", position = position_dodge(), stat = "identity", size = 2, linewidth = 0.5, alpha = 0.9) + 
  geom_errorbar(aes(xmin=mean-sd, xmax = mean+sd), width = .2, position = position_dodge(.9)) + 
  labs(title = NULL, x = "PC1", y = "Deployment") + 
  facet_grid(Depth~., scales = "free") +
  scale_fill_manual(values = depth_colors) + 
    guides(fill = "none") + 
  theme_custom_paper() + 
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        strip.text = element_text(size = 6),
        strip.background.y = element_rect(fill = "white"))

pc_fish_plot

ggsave("./plots-final/beta_diversity_pca_axes_fish.pdf", height = 120, width = 80, units = "mm", dpi=300)


fish.sp <- as.data.frame(scores(pca_fish_clr, choices = c(1:2), display = "species"))
fish.sp
dim(fish.sp)
head(fish_taxa_relabun)
unique(fish_taxa_relabun$TAXA)
fish_taxa_filtered <- fish_taxa_relabun %>% select(OTU, Phylum, Order, Genus, Species, TAXA) %>% unique() %>% data.frame()
dim(fish_taxa_filtered)
unique(fish_taxa_filtered$TAXA)
head(fish.sp)
fish.sp <- cbind(fish.sp, OTU = rownames(fish.sp), TAXA = fish_taxa_filtered$TAXA)

fish.sp.top <- fish.sp %>% slice_max(order_by = abs(PC1), n = 25, with_ties = FALSE)
unique(fish.sp.top$TAXA)

fish_sorted <- c("Nemichthyidae", "Serrivomeridae",
                             "Melamphaidae", 
                             "Myctophidae", 
                             "Alepocephalidae", 
                             "Gonostomatidae", "Sternoptychidae", 
                             "Stomiidae", 
                             "Molidae", "Other Vertebrates         ")


fish_colors <- c("#d5d2f8", "#9790ee", 
                "#a1f1d6","#f5eb8e",
                 "#9CDC46", 
                  "#56C4F0", "#0c62fb", "#034dd1","#fb7285", "#d9d9d9")

top_plot <- fish.sp.top %>%
  ggplot(aes(x = PC1, y = PC2)) +
#  geom_point(aes(fill = TAXA), color = "black", shape = 21, size = 2, stroke = 0.25, alpha = 0.66) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2, color = TAXA), arrow = arrow(length = unit(0.12, "cm"), type = "closed"), linewidth = 0.5, alpha = 0.9) +
  xlab(paste0('PC1 ', round(unconstrained_eig[1],2),'%')) +
  ylab(paste0('PC2 ', round(unconstrained_eig[2],2),'%')) +
  labs(title = NULL) + 
#  facet_wrap(~Depth, scales = "free") +
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = fish_colors,
                    limits = fish_sorted) + 
    guides(color = guide_legend(title = NULL,
                              ncol = 2)) + 
  theme_custom_paper() + 
  theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "bottom", 
        legend.spacing.x = unit(4, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(2, "mm"),
        legend.key.width = unit(3, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))


top_plot

ggsave("./plots-final/beta_diversity_pca_fish_top25.pdf", height = 60, width = 80, units = "mm", dpi=300)

# combined

prot_pca_plot <- prot_pca_plot + ggtitle("Protists")
met_pca_plot <- met_pca_plot + ggtitle("Invertebrates")
fish_pca_plot <- fish_pca_plot + ggtitle("Vertebrates")

panel <- prot_pca_plot + met_pca_plot + fish_pca_plot + 
  plot_annotation(tag_levels = "A", tag_suffix = '.') + 
  plot_layout(guides = 'collect') & theme(legend.position = "right", legend.spacing.y = unit(0, "mm"), legend.margin = margin(3, 3, 3, 3), legend.key.size = unit(3, 'mm'))

panel

ggsave("./plots-final/beta_diversity_pca_all.pdf", height = 65, width = 180, units = "mm", dpi=300)
#ggsave("./plots-final/beta_diversity_pca_fish_filtered.pdf", height = 65, width = 180, units = "mm", dpi=300)


pc_prot_plot <- pc_prot_plot + ggtitle("Protists")
pc_met_plot <- pc_met_plot + ggtitle("Invertebrates")
pc_fish_plot <- pc_fish_plot + ggtitle("Vertebrates")

pc_prot_plot + pc_met_plot + pc_fish_plot
ggsave("./plots-final/beta_diversity_pca_axes_all.pdf", height = 120, width = 180, units = "mm", dpi=300)

```

## 3.3 PERMANOVA

```{r beta-stats-euc-adonis, eval = TRUE, message = FALSE, warning = FALSE}

## metazoans
set.seed(100)

# Adonis test

# note: The R-square value is the important statistic for interpreting the effect size. It is the percent variation that is explained by the variable and the p value indicates significance.

# extract rownames
sample_name <- as.data.frame(unique(rare_prot$sample))
colnames(sample_name) <- "sample"
head(sample_name)
class(sample_name)

prot_sd <- left_join(sample_name, metadata_18s, by = "sample")
head(prot_sd)
dim(prot_sd)

adonis_prot <- adonis2(dist_prot_clr ~ depth, data = prot_sd, permutations = 999)
adonis_prot

posthoc_prot <- pairwise.adonis2(dist_prot_clr ~ depth, data = prot_sd, nperm = 999)
posthoc_prot

adonis_prot <- adonis2(dist_prot_clr ~ deployment, data = prot_sd, permutations = 999)
adonis_prot

posthoc_prot <- pairwise.adonis2(dist_prot_clr ~ deployment, data = prot_sd, nperm = 999)
posthoc_prot

# I think there are deployment differences but it's hard to tell based on this. 
head(prot_sd)
prot_sd_10 <- prot_sd %>% filter(depth == "10")
prot_sd_100 <- prot_sd %>% filter(depth == "100")
prot_sd_300 <- prot_sd %>% filter(depth == "300")
prot_sd_500 <- prot_sd %>% filter(depth == "500")
prot_sd_800 <- prot_sd %>% filter(depth == "800")
prot_sd_1000 <- prot_sd %>% filter(depth == "1000")

# Using match to find the indices of the row names in sample_names
indices_10 <- match(prot_sd_10$sample, rownames(rare_prot_dist_clr))
indices_100 <- match(prot_sd_100$sample, rownames(rare_prot_dist_clr))
indices_300 <- match(prot_sd_300$sample, rownames(rare_prot_dist_clr))
indices_500 <- match(prot_sd_500$sample, rownames(rare_prot_dist_clr))
indices_800 <- match(prot_sd_800$sample, rownames(rare_prot_dist_clr))
indices_1000 <- match(prot_sd_1000$sample, rownames(rare_prot_dist_clr))

# Subsetting the dataframe using these indices
rare_prot_dist_clr_10 <- rare_prot_dist_clr[indices_10, ]
rare_prot_dist_clr_100 <- rare_prot_dist_clr[indices_100, ]
rare_prot_dist_clr_300 <- rare_prot_dist_clr[indices_300, ]
rare_prot_dist_clr_500 <- rare_prot_dist_clr[indices_500, ]
rare_prot_dist_clr_800 <- rare_prot_dist_clr[indices_800, ]
rare_prot_dist_clr_1000 <- rare_prot_dist_clr[indices_1000, ]

dist_prot_clr_10 <- vegdist(rare_prot_dist_clr_10, method = "euclidean")
dist_prot_clr_100 <- vegdist(rare_prot_dist_clr_100, method = "euclidean")
dist_prot_clr_300 <- vegdist(rare_prot_dist_clr_300, method = "euclidean")
dist_prot_clr_500 <- vegdist(rare_prot_dist_clr_500, method = "euclidean")
dist_prot_clr_800 <- vegdist(rare_prot_dist_clr_800, method = "euclidean")
dist_prot_clr_1000 <- vegdist(rare_prot_dist_clr_1000, method = "euclidean")

set.seed(123)
adonis_prot <- adonis2(dist_prot_clr_10 ~ deployment, data = prot_sd_10, permutations = 999)
adonis_prot

posthoc_prot <- pairwise.adonis2(dist_prot_clr_10 ~ deployment, data = prot_sd_10, nperm = 999)
posthoc_prot

set.seed(123)
adonis_prot <- adonis2(dist_prot_clr_100 ~ deployment, data = prot_sd_100, permutations = 999)
adonis_prot

posthoc_prot <- pairwise.adonis2(dist_prot_clr_100 ~ deployment, data = prot_sd_100, nperm = 999)
posthoc_prot

set.seed(123)
adonis_prot <- adonis2(dist_prot_clr_300 ~ deployment, data = prot_sd_300, permutations = 999)
adonis_prot

posthoc_prot <- pairwise.adonis2(dist_prot_clr_300 ~ deployment, data = prot_sd_300, nperm = 999)
posthoc_prot

set.seed(123)
adonis_prot <- adonis2(dist_prot_clr_500 ~ deployment, data = prot_sd_500, permutations = 999)
adonis_prot

posthoc_prot <- pairwise.adonis2(dist_prot_clr_500 ~ deployment, data = prot_sd_500, nperm = 999)
posthoc_prot

set.seed(123)
adonis_prot <- adonis2(dist_prot_clr_800 ~ deployment, data = prot_sd_800, permutations = 999)
adonis_prot

posthoc_prot <- pairwise.adonis2(dist_prot_clr_800 ~ deployment, data = prot_sd_800, nperm = 999)
posthoc_prot

set.seed(123)
adonis_prot <- adonis2(dist_prot_clr_1000 ~ deployment, data = prot_sd_1000, permutations = 999)
adonis_prot

posthoc_prot <- pairwise.adonis2(dist_prot_clr_1000 ~ deployment, data = prot_sd_1000, nperm = 999)
posthoc_prot

# extract rownames
sample_name <- as.data.frame(unique(rare_met$sample))
colnames(sample_name) <- "sample"
head(sample_name)
class(sample_name)
head(metadata_18s)

met_sd <- left_join(sample_name, metadata_18s, by = "sample")
head(met_sd)
dim(met_sd)

adonis_met <- adonis2(dist_met_clr ~ depth*deployment, data = met_sd, permutations = 999)
adonis_met
posthoc_met <- pairwise.adonis2(dist_met_clr ~ depth, data = met_sd, nperm = 999)
posthoc_met

posthoc_met <- pairwise.adonis2(dist_met_clr ~ deployment, data = met_sd, nperm = 999)
posthoc_met

# I think there are deployment differences but it's hard to tell based on this. 
head(met_sd)
met_sd_10 <- met_sd %>% filter(depth == "10")
met_sd_100 <- met_sd %>% filter(depth == "100")
met_sd_300 <- met_sd %>% filter(depth == "300")
met_sd_500 <- met_sd %>% filter(depth == "500")
met_sd_800 <- met_sd %>% filter(depth == "800")
met_sd_1000 <- met_sd %>% filter(depth == "1000")

# Using match to find the indices of the row names in sample_names
indices_10 <- match(met_sd_10$sample, rownames(rare_met_dist_clr))
indices_100 <- match(met_sd_100$sample, rownames(rare_met_dist_clr))
indices_300 <- match(met_sd_300$sample, rownames(rare_met_dist_clr))
indices_500 <- match(met_sd_500$sample, rownames(rare_met_dist_clr))
indices_800 <- match(met_sd_800$sample, rownames(rare_met_dist_clr))
indices_1000 <- match(met_sd_1000$sample, rownames(rare_met_dist_clr))

# Subsetting the dataframe using these indices
rare_met_dist_clr_10 <- rare_met_dist_clr[indices_10, ]
rare_met_dist_clr_100 <- rare_met_dist_clr[indices_100, ]
rare_met_dist_clr_300 <- rare_met_dist_clr[indices_300, ]
rare_met_dist_clr_500 <- rare_met_dist_clr[indices_500, ]
rare_met_dist_clr_800 <- rare_met_dist_clr[indices_800, ]
rare_met_dist_clr_1000 <- rare_met_dist_clr[indices_1000, ]

dist_met_clr_10 <- vegdist(rare_met_dist_clr_10, method = "euclidean")
dist_met_clr_100 <- vegdist(rare_met_dist_clr_100, method = "euclidean")
dist_met_clr_300 <- vegdist(rare_met_dist_clr_300, method = "euclidean")
dist_met_clr_500 <- vegdist(rare_met_dist_clr_500, method = "euclidean")
dist_met_clr_800 <- vegdist(rare_met_dist_clr_800, method = "euclidean")
dist_met_clr_1000 <- vegdist(rare_met_dist_clr_1000, method = "euclidean")

set.seed(123)
adonis_met <- adonis2(dist_met_clr_10 ~ deployment, data = met_sd_10, permutations = 999)
adonis_met

posthoc_met <- pairwise.adonis2(dist_met_clr_10 ~ deployment, data = met_sd_10, nperm = 999)
posthoc_met

set.seed(123)
adonis_met <- adonis2(dist_met_clr_100 ~ deployment, data = met_sd_100, permutations = 999)
adonis_met

posthoc_met <- pairwise.adonis2(dist_met_clr_100 ~ deployment, data = met_sd_100, nperm = 999)
posthoc_met

set.seed(123)
adonis_met <- adonis2(dist_met_clr_300 ~ deployment, data = met_sd_300, permutations = 999)
adonis_met

posthoc_met <- pairwise.adonis2(dist_met_clr_300 ~ deployment, data = met_sd_300, nperm = 999)
posthoc_met

set.seed(123)
adonis_met <- adonis2(dist_met_clr_500 ~ deployment, data = met_sd_500, permutations = 999)
adonis_met

posthoc_met <- pairwise.adonis2(dist_met_clr_500 ~ deployment, data = met_sd_500, nperm = 999)
posthoc_met

set.seed(123)
adonis_met <- adonis2(dist_met_clr_800 ~ deployment, data = met_sd_800, permutations = 999)
adonis_met

posthoc_met <- pairwise.adonis2(dist_met_clr_800 ~ deployment, data = met_sd_800, nperm = 999)
posthoc_met

set.seed(123)
adonis_met <- adonis2(dist_met_clr_1000 ~ deployment, data = met_sd_1000, permutations = 999)
adonis_met

posthoc_met <- pairwise.adonis2(dist_met_clr_1000 ~ deployment, data = met_sd_1000, nperm = 999)
posthoc_met

# extract rownames
sample_name <- as.data.frame(unique(rare_fish$sample))
colnames(sample_name) <- "sample"
head(sample_name)
class(sample_name)

fish_sd <- left_join(sample_name, metadata_12s, by = "sample")
head(fish_sd)
dim(fish_sd)

adonis_fish <- adonis2(dist_fish_clr ~ deployment * depth, data = fish_sd)
adonis_fish
adonis_fish <- adonis2(dist_fish_clr ~ depth, data = fish_sd)
adonis_fish
adonis_fish <- adonis2(dist_fish_clr ~ deployment, data = fish_sd)
adonis_fish

posthoc_fish <- pairwise.adonis2(dist_fish_clr ~ depth*deployment, data = fish_sd, nperm = 999)
posthoc_fish
posthoc_fish <- pairwise.adonis2(dist_fish_clr ~ depth, data = fish_sd, nperm = 999)
posthoc_fish
posthoc_fish <- pairwise.adonis2(dist_fish_clr ~ deployment, data = fish_sd, nperm = 999)
posthoc_fish
##

# I think there are deployment differences but it's hard to tell based on this. 
head(fish_sd)
fish_sd_10 <- fish_sd %>% filter(depth == "10")
fish_sd_100 <- fish_sd %>% filter(depth == "100")
fish_sd_300 <- fish_sd %>% filter(depth == "300")
fish_sd_500 <- fish_sd %>% filter(depth == "500")
fish_sd_800 <- fish_sd %>% filter(depth == "800")
fish_sd_1000 <- fish_sd %>% filter(depth == "1000")

# Using match to find the indices of the row names in sample_names
indices_10 <- match(fish_sd_10$sample, rownames(rare_fish_dist_clr))
indices_100 <- match(fish_sd_100$sample, rownames(rare_fish_dist_clr))
indices_300 <- match(fish_sd_300$sample, rownames(rare_fish_dist_clr))
indices_500 <- match(fish_sd_500$sample, rownames(rare_fish_dist_clr))
indices_800 <- match(fish_sd_800$sample, rownames(rare_fish_dist_clr))
indices_1000 <- match(fish_sd_1000$sample, rownames(rare_fish_dist_clr))

# Subsetting the dataframe using these indices
rare_fish_dist_clr_10 <- rare_fish_dist_clr[indices_10, ]
rare_fish_dist_clr_100 <- rare_fish_dist_clr[indices_100, ]
rare_fish_dist_clr_300 <- rare_fish_dist_clr[indices_300, ]
rare_fish_dist_clr_500 <- rare_fish_dist_clr[indices_500, ]
rare_fish_dist_clr_800 <- rare_fish_dist_clr[indices_800, ]
rare_fish_dist_clr_1000 <- rare_fish_dist_clr[indices_1000, ]

dist_fish_clr_10 <- vegdist(rare_fish_dist_clr_10, method = "euclidean")
dist_fish_clr_100 <- vegdist(rare_fish_dist_clr_100, method = "euclidean")
dist_fish_clr_300 <- vegdist(rare_fish_dist_clr_300, method = "euclidean")
dist_fish_clr_500 <- vegdist(rare_fish_dist_clr_500, method = "euclidean")
dist_fish_clr_800 <- vegdist(rare_fish_dist_clr_800, method = "euclidean")
dist_fish_clr_1000 <- vegdist(rare_fish_dist_clr_1000, method = "euclidean")

set.seed(123)
adonis_fish <- adonis2(dist_fish_clr_10 ~ deployment, data = fish_sd_10, permutations = 999)
adonis_fish

posthoc_fish <- pairwise.adonis2(dist_fish_clr_10 ~ deployment, data = fish_sd_10, nperm = 999)
posthoc_fish

set.seed(123)
adonis_fish <- adonis2(dist_fish_clr_100 ~ deployment, data = fish_sd_100, permutations = 999)
adonis_fish

posthoc_fish <- pairwise.adonis2(dist_fish_clr_100 ~ deployment, data = fish_sd_100, nperm = 999)
posthoc_fish

set.seed(123)
adonis_fish <- adonis2(dist_fish_clr_300 ~ deployment, data = fish_sd_300, permutations = 999)
adonis_fish

posthoc_fish <- pairwise.adonis2(dist_fish_clr_300 ~ deployment, data = fish_sd_300, nperm = 999)
posthoc_fish

set.seed(123)
adonis_fish <- adonis2(dist_fish_clr_500 ~ deployment, data = fish_sd_500, permutations = 999)
adonis_fish

posthoc_fish <- pairwise.adonis2(dist_fish_clr_500 ~ deployment, data = fish_sd_500, nperm = 999)
posthoc_fish

set.seed(123)
adonis_fish <- adonis2(dist_fish_clr_800 ~ deployment, data = fish_sd_800, permutations = 999)
adonis_fish

posthoc_fish <- pairwise.adonis2(dist_fish_clr_800 ~ deployment, data = fish_sd_800, nperm = 999)
posthoc_fish

set.seed(123)
adonis_fish <- adonis2(dist_fish_clr_1000 ~ deployment, data = fish_sd_1000, permutations = 999)
adonis_fish

posthoc_fish <- pairwise.adonis2(dist_fish_clr_1000 ~ deployment, data = fish_sd_1000, nperm = 999)
posthoc_fish

```

```{r beta-stats-euc-betadispr, eval = TRUE, message = FALSE, warning = FALSE}

# In ecological studies, you might use betadisper to determine whether the variability in species composition is similar across different habitat types before running PERMANOVA to compare the centroids of these habitats.
#Protists 
# depth
bd_prot <- betadisper(dist_prot_clr, prot_sd$depth, type = "median")
anova(bd_prot)
permutest(bd_prot, pairwise = TRUE)

plot(bd_prot, hull = FALSE, ellipse = TRUE)

bd_prot_scrs <- as.data.frame(scores(bd_prot, choices = c(1:5), display = "sites"))
bd_prot_scrs
bd_prot_scrs <- cbind(bd_prot_scrs, Depth = rare_prot_env$depth)
bd_prot_scrs <- cbind(bd_prot_scrs, Deployment = rare_prot_env$deployn)

prot_bd_plot <- 
  ggplot(data = bd_prot_scrs, aes(x = PCoA1, y = PCoA2, color = as.factor(Depth), fill = as.factor(Depth))) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, color = "#525252", linetype = "dotted") +
  geom_point(aes(fill = as.factor(Depth), shape = as.factor(Deployment)), color = "black", size = 4, stroke = 1, alpha = 0.9) + 
  stat_ellipse(type = "t") + 
  ylab(paste0('PCoA2 ', round(unconstrained_eig[2],2),'%')) +
  xlab(paste0('PCoA1 ', round(unconstrained_eig[1],2),'%')) +
  labs(title = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) + 
  scale_fill_manual(values = depth_colors) + 
  scale_color_manual(values = depth_colors) + 
  guides(color = "none",
         fill = guide_legend(title="Depth (m)",
                             override.aes = list(shape = 21,
                                                 alpha = 1)),
         shape = guide_legend(title = "CTD Cast")) +
  theme_custom_paper()

prot_bd_plot

boxplot(bd_prot)


#interaction
prot_sd_1 <- prot_sd %>%
  mutate(depth_deploy = paste0(depth, "_", deployment))

bd_prot <- betadisper(dist_prot_clr, prot_sd_1$depth_deploy, type = "median")
anova(bd_prot)
permutest(bd_prot, pairwise = TRUE)

boxplot(bd_prot)
bd_prot$distances %>% data.frame()


#Metazoa 
# depth
bd_met <- betadisper(dist_met_clr, met_sd$depth, type = "median")
anova(bd_met)
permutest(bd_met, pairwise = TRUE)

plot(bd_met, hull = FALSE, ellipse = TRUE)

bd_met_scrs <- as.data.frame(scores(bd_met, choices = c(1:5), display = "sites"))
bd_met_scrs
bd_met_scrs <- cbind(bd_met_scrs, Depth = rare_met_env$depth)
bd_met_scrs <- cbind(bd_met_scrs, Deployment = rare_met_env$deployn)

met_bd_plot <- 
  ggplot(data = bd_met_scrs, aes(x = PCoA1, y = PCoA2, color = as.factor(Depth))) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, color = "#525252", linetype = "dotted") +
  geom_point(aes(fill = as.factor(Depth), shape = as.factor(Deployment)), color = "black", size = 4, stroke = 1, alpha = 0.9) + 
  ylab(paste0('PCoA2 ', round(unconstrained_eig[2],2),'%')) +
  xlab(paste0('PCoA1 ', round(unconstrained_eig[1],2),'%')) +
  labs(title = NULL) + 
  stat_ellipse(type = "t") + 
  scale_shape_manual(values = c(21, 23, 24)) + 
  scale_color_manual(values = depth_colors) + 
  scale_fill_manual(values = depth_colors) + 
  guides(color = "none",
         fill = guide_legend(title="Depth (m)",
                             override.aes = list(shape = 21,
                                                 alpha = 1)),
         shape = guide_legend(title = "CTD Cast")) +
  theme_custom_paper()

met_bd_plot

#Fish 
# depth
bd_fish <- betadisper(dist_fish_clr, fish_sd$depth, type = "median")
anova(bd_fish)
permutest(bd_fish, pairwise = TRUE)

plot(bd_fish, hull = FALSE, ellipse = TRUE)

bd_fish_scrs <- as.data.frame(scores(bd_fish, choices = c(1:5), display = "sites"))
bd_fish_scrs
bd_fish_scrs <- cbind(bd_fish_scrs, Depth = rare_fish_env$depth)
bd_fish_scrs <- cbind(bd_fish_scrs, Deployment = rare_fish_env$deployn)

fish_bd_plot <- 
  ggplot(data = bd_fish_scrs, aes(x = PCoA1, y = PCoA2, color = as.factor(Depth))) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, color = "#525252", linetype = "dotted") +
  geom_point(aes(fill = as.factor(Depth), shape = as.factor(Deployment)), color = "black", size = 4, stroke = 1, alpha = 0.9) + 
  ylab(paste0('PCoA2 ', round(unconstrained_eig[2],2),'%')) +
  xlab(paste0('PCoA1 ', round(unconstrained_eig[1],2),'%')) +
  stat_ellipse(type = "t") + 
  labs(title = NULL) + 
  scale_shape_manual(values = c(21, 23, 24)) + 
  scale_fill_manual(values = depth_colors) + 
  scale_color_manual(values = depth_colors) + 
  guides(color = "none",
         fill = guide_legend(title="Depth (m)",
                             override.aes = list(shape = 21,
                                                 alpha = 1)),
         shape = guide_legend(title = "CTD Cast")) +
  theme_custom_paper()

fish_bd_plot


```

```{r pca-filtered, eval = TRUE, message = FALSE, warning = FALSE}

rare_prot_dist_clr_10
rare_prot_dist_clr_100
rare_prot_dist_clr_300
rare_prot_dist_clr_500
rare_prot_dist_clr_800
rare_prot_dist_clr_1000

pca_prot_clr_10 <- rda(rare_prot_dist_clr_10)

head(summary(pca_prot_clr_10))

unconstrained_eig10 <- pca_prot_clr_10$CA$eig/pca_prot_clr_10$tot.chi*100

expl_var <- unconstrained_eig10
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig10)),
         las = 2, ylab = '% variation')



pca_prot_clr_100 <- rda(rare_prot_dist_clr_100)

head(summary(pca_prot_clr_100))

unconstrained_eig100 <- pca_prot_clr_100$CA$eig/pca_prot_clr_100$tot.chi*100

expl_var <- unconstrained_eig100
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig100)),
         las = 2, ylab = '% variation')


pca_prot_clr_300 <- rda(rare_prot_dist_clr_300)

head(summary(pca_prot_clr_300))

unconstrained_eig300 <- pca_prot_clr_300$CA$eig/pca_prot_clr_300$tot.chi*100

expl_var <- unconstrained_eig300
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig300)),
         las = 2, ylab = '% variation')



pca_prot_clr_500 <- rda(rare_prot_dist_clr_500)

head(summary(pca_prot_clr_500))

unconstrained_eig500 <- pca_prot_clr_500$CA$eig/pca_prot_clr_500$tot.chi*100

expl_var <- unconstrained_eig500
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig500)),
         las = 2, ylab = '% variation')



pca_prot_clr_800 <- rda(rare_prot_dist_clr_800)

head(summary(pca_prot_clr_800))

unconstrained_eig800 <- pca_prot_clr_800$CA$eig/pca_prot_clr_800$tot.chi*100

expl_var <- unconstrained_eig800
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig800)),
         las = 2, ylab = '% variation')


pca_prot_clr_1000 <- rda(rare_prot_dist_clr_1000)

head(summary(pca_prot_clr_1000))

unconstrained_eig1000 <- pca_prot_clr_1000$CA$eig/pca_prot_clr_1000$tot.chi*100

expl_var <- unconstrained_eig1000
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig1000)),
         las = 2, ylab = '% variation')


prot.sp10 <- as.data.frame(scores(pca_prot_clr_10, choices = c(1:2), display = "species"))
prot.sp10$Depth <- "10m"
head(prot.sp10)
tail(prot.sp10)
prot.sp100 <- as.data.frame(scores(pca_prot_clr_100, choices = c(1:2), display = "species"))
prot.sp100$Depth <- "100m"
head(prot.sp100)
tail(prot.sp100)
prot.sp300 <- as.data.frame(scores(pca_prot_clr_300, choices = c(1:2), display = "species"))
prot.sp300$Depth <- "300m"
head(prot.sp300)
tail(prot.sp300)
prot.sp500 <- as.data.frame(scores(pca_prot_clr_500, choices = c(1:2), display = "species"))
prot.sp500$Depth <- "500m"
head(prot.sp500)
tail(prot.sp500)
prot.sp800 <- as.data.frame(scores(pca_prot_clr_800, choices = c(1:2), display = "species"))
prot.sp800$Depth <- "800m"
head(prot.sp800)
tail(prot.sp800)
prot.sp1000 <- as.data.frame(scores(pca_prot_clr_1000, choices = c(1:2), display = "species"))
prot.sp1000$Depth <- "1000m"
head(prot.sp1000)
tail(prot.sp1000)
prot.sp <- rbind(prot.sp10, prot.sp100, prot.sp300, prot.sp500, prot.sp800, prot.sp1000)
head(prot.sp)
tail(prot.sp)

head(prot_taxa2)
prot_taxa_filtered <- prot_taxa_relabun %>% select(OTU, Supergroup, Division, Subdivision, TAXA) %>% unique() %>% data.frame()
dim(prot_taxa_filtered)

head(prot.sp)
prot.sp <- cbind(prot.sp, OTU = rownames(prot.sp), TAXA = prot_taxa_filtered$TAXA, Supergroup = prot_taxa_filtered$Supergroup, Division = prot_taxa_filtered$Division, Subdivision = prot_taxa_filtered$Subdivision)
head(prot.sp)
tail(prot.sp)
dim(prot.sp)

prot.sp.top <- prot.sp %>% group_by(Depth) %>% slice_max(order_by = abs(PC1), n = 10, with_ties = FALSE)
dim(prot.sp.top)
prot.sp.top$Depth <- fct_relevel(prot.sp.top$Depth, "10m", "100m", "300m", "500m", "800m", "1000m")

prot.site10 <- as.data.frame(scores(pca_prot_clr_10, choices = c(1:2), display = "sites"))
prot.site10$Depth <- "10m"
head(prot.site10)
tail(prot.site10)
prot.site100 <- as.data.frame(scores(pca_prot_clr_100, choices = c(1:2), display = "sites"))
prot.site100$Depth <- "100m"
head(prot.site100)
tail(prot.site100)
prot.site300 <- as.data.frame(scores(pca_prot_clr_300, choices = c(1:2), display = "sites"))
prot.site300$Depth <- "300m"
head(prot.site300)
tail(prot.site300)
prot.site500 <- as.data.frame(scores(pca_prot_clr_500, choices = c(1:2), display = "sites"))
prot.site500$Depth <- "500m"
head(prot.site500)
tail(prot.site500)
prot.site800 <- as.data.frame(scores(pca_prot_clr_800, choices = c(1:2), display = "sites"))
prot.site800$Depth <- "800m"
head(prot.site800)
tail(prot.site800)
prot.site1000 <- as.data.frame(scores(pca_prot_clr_1000, choices = c(1:2), display = "sites"))
prot.site1000$Depth <- "1000m"
head(prot.site1000)
tail(prot.site1000)
prot.site.df <- rbind(prot.site10, prot.site100, prot.site300, prot.site500, prot.site800, prot.site1000)
head(prot.site.df)
tail(prot.site.df)

# add deployemnts
deploy_df <- prot_taxa_relabun %>% select(sample, deployment) 
head(deploy_df)
prot.site.df$sample <- rownames(prot.site.df) %>% unique()
head(prot.site.df)
prot.site <- left_join(prot.site.df, deploy_df, by = "sample") %>% unique()
head(prot.site)

prot.site$Depth <- fct_relevel(prot.site$Depth, "10m", "100m", "300m", "500m", "800m", "1000m") 

top_plot <- prot.sp.top %>%
  ggplot(aes(x = PC1, y = PC2)) +
  geom_point(data = prot.site, color = "black", stroke = 0.5, size = 2, alpha = 1, aes(shape = deployment)) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2, color = TAXA, alpha = 0.75), arrow = arrow(length = unit(0.15, "cm"), type = "closed"), linewidth = 0.5, alpha = 0.75) +
  geom_hline(yintercept = 0, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 0, color = "#525252", linetype = "dotted", linewidth = 0.5) +
  labs(title = NULL) + 
  facet_wrap(~Depth, scales = "free") +
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = prot_colors,
                    limits = prot_sorted) + 
  guides(fill = guide_legend(title = NULL),
         color = guide_legend(title = NULL),
         shape = guide_legend(title = "CTD Cast")) +
  theme_custom_paper() + 
  theme(plot.margin = unit(c(t = 0, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.border = element_rect(linewidth = 1),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "none", 
        legend.spacing.x = unit(4, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(2, "mm"),
        legend.key.width = unit(3, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))


top_plot

ggsave("./plots-final/beta_diversity_pca_top_prot10.pdf", height = 140, width = 180, units = "mm", dpi=300)

(prot_relabun_deploy + labs(title = NULL)) / top_plot +  
  plot_layout(heights = c(1.5, 2)) + 
  plot_annotation(tag_levels = "A", tag_suffix = '.') + 
  plot_layout(guides = 'collect') &
  theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.position = "right", 
        legend.margin = margin(t = 30, r = 20, b = 35, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))

ggsave("./plots-final/beta_diversity_relabun_pca_prot.pdf", height = 180, width = 180, units = "mm", dpi=300)

### Met
rare_met_dist_clr_10
rare_met_dist_clr_100
rare_met_dist_clr_300
rare_met_dist_clr_500
rare_met_dist_clr_800
rare_met_dist_clr_1000

pca_met_clr_10 <- rda(rare_met_dist_clr_10)

head(summary(pca_met_clr_10))

unconstrained_eig10 <- pca_met_clr_10$CA$eig/pca_met_clr_10$tot.chi*100

expl_var <- unconstrained_eig10
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig10)),
         las = 2, ylab = '% variation')


pca_met_clr_100 <- rda(rare_met_dist_clr_100)

head(summary(pca_met_clr_100))

unconstrained_eig100 <- pca_met_clr_100$CA$eig/pca_met_clr_100$tot.chi*100

expl_var <- unconstrained_eig100
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig100)),
         las = 2, ylab = '% variation')


pca_met_clr_300 <- rda(rare_met_dist_clr_300)

head(summary(pca_met_clr_300))

unconstrained_eig300 <- pca_met_clr_300$CA$eig/pca_met_clr_300$tot.chi*100

expl_var <- unconstrained_eig300
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig300)),
         las = 2, ylab = '% variation')



pca_met_clr_500 <- rda(rare_met_dist_clr_500)

head(summary(pca_met_clr_500))

unconstrained_eig500 <- pca_met_clr_500$CA$eig/pca_met_clr_500$tot.chi*100

expl_var <- unconstrained_eig500
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig500)),
         las = 2, ylab = '% variation')



pca_met_clr_800 <- rda(rare_met_dist_clr_800)

head(summary(pca_met_clr_800))

unconstrained_eig800 <- pca_met_clr_800$CA$eig/pca_met_clr_800$tot.chi*100

expl_var <- unconstrained_eig800
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig800)),
         las = 2, ylab = '% variation')


pca_met_clr_1000 <- rda(rare_met_dist_clr_1000)

head(summary(pca_met_clr_1000))

unconstrained_eig1000 <- pca_met_clr_1000$CA$eig/pca_met_clr_1000$tot.chi*100

expl_var <- unconstrained_eig1000
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig1000)),
         las = 2, ylab = '% variation')


met.sp10 <- as.data.frame(scores(pca_met_clr_10, choices = c(1:2), display = "species"))
met.sp10$Depth <- "10m"
head(met.sp10)
tail(met.sp10)
met.sp100 <- as.data.frame(scores(pca_met_clr_100, choices = c(1:2), display = "species"))
met.sp100$Depth <- "100m"
head(met.sp100)
tail(met.sp100)
met.sp300 <- as.data.frame(scores(pca_met_clr_300, choices = c(1:2), display = "species"))
met.sp300$Depth <- "300m"
head(met.sp300)
tail(met.sp300)
met.sp500 <- as.data.frame(scores(pca_met_clr_500, choices = c(1:2), display = "species"))
met.sp500$Depth <- "500m"
head(met.sp500)
tail(met.sp500)
met.sp800 <- as.data.frame(scores(pca_met_clr_800, choices = c(1:2), display = "species"))
met.sp800$Depth <- "800m"
head(met.sp800)
tail(met.sp800)
met.sp1000 <- as.data.frame(scores(pca_met_clr_1000, choices = c(1:2), display = "species"))
met.sp1000$Depth <- "1000m"
head(met.sp1000)
tail(met.sp1000)
met.sp <- rbind(met.sp10, met.sp100, met.sp300, met.sp500, met.sp800, met.sp1000)
head(met.sp)
tail(met.sp)

head(met_taxa_relabun)
met_taxa_filtered <- met_taxa_relabun %>% select(OTU, TAXA) %>% unique() %>% data.frame()
dim(met_taxa_filtered)

head(met.sp)
met.sp <- cbind(met.sp, OTU = rownames(met.sp), TAXA = met_taxa_filtered$TAXA)
head(met.sp)
tail(met.sp)
dim(met.sp)

met.sp.top <- met.sp %>% group_by(Depth) %>% slice_max(order_by = abs(PC1), n = 10, with_ties = FALSE)
dim(met.sp.top)
met.sp.top$Depth <- fct_relevel(met.sp.top$Depth, "10m", "100m", "300m", "500m", "800m", "1000m")


met.site10 <- as.data.frame(scores(pca_met_clr_10, choices = c(1:2), display = "sites"))
met.site10$Depth <- "10m"
head(met.site10)
tail(met.site10)
met.site100 <- as.data.frame(scores(pca_met_clr_100, choices = c(1:2), display = "sites"))
met.site100$Depth <- "100m"
head(met.site100)
tail(met.site100)
met.site300 <- as.data.frame(scores(pca_met_clr_300, choices = c(1:2), display = "sites"))
met.site300$Depth <- "300m"
head(met.site300)
tail(met.site300)
met.site500 <- as.data.frame(scores(pca_met_clr_500, choices = c(1:2), display = "sites"))
met.site500$Depth <- "500m"
head(met.site500)
tail(met.site500)
met.site800 <- as.data.frame(scores(pca_met_clr_800, choices = c(1:2), display = "sites"))
met.site800$Depth <- "800m"
head(met.site800)
tail(met.site800)
met.site1000 <- as.data.frame(scores(pca_met_clr_1000, choices = c(1:2), display = "sites"))
met.site1000$Depth <- "1000m"
head(met.site1000)
tail(met.site1000)
met.site.df <- rbind(met.site10, met.site100, met.site300, met.site500, met.site800, met.site1000)
head(met.site.df)
tail(met.site.df)

# add deployemnts
deploy_df <- met_taxa_relabun %>% select(sample, deployment) 
head(deploy_df)
met.site.df$sample <- rownames(met.site.df) %>% unique()
head(met.site.df)
met.site <- left_join(met.site.df, deploy_df, by = "sample")
head(met.site)
tail(met.site)

met.site$Depth <- fct_relevel(met.site$Depth, "10m", "100m", "300m", "500m", "800m", "1000m")

top_plot <- met.sp.top %>%
  ggplot(aes(x = PC1, y = PC2)) +
  geom_point(data = met.site, color = "black", stroke = 0.25, size = 2, alpha = 0.5, aes(shape = deployment)) +  
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2, color = TAXA, alpha = 0.75), arrow = arrow(length = unit(0.15, "cm"), type = "closed"), linewidth = 0.5, alpha = 0.75) +
  geom_hline(yintercept = 0, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 0, color = "#525252", linetype = "dotted", linewidth = 0.5) +
  labs(title = NULL) + 
  facet_wrap(~Depth, scales = "free") +
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = met_colors,
                    limits = met_sorted) + 
  scale_fill_manual(values = depth_colors) + 
  guides(fill = guide_legend(title = NULL),
         color = guide_legend(title = NULL),
         shape = guide_legend(title = "CTD Cast")) +
  theme_custom_paper() + 
  theme(plot.margin = unit(c(t = 0, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.border = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "right", 
        legend.spacing.x = unit(4, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(2, "mm"),
        legend.key.width = unit(3, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))


top_plot

ggsave("./plots-final/beta_diversity_pca_top_met10.pdf", height = 140, width = 180, units = "mm", dpi=300)

(met_relabun_deploy + labs(title = NULL)) / top_plot +  
  plot_layout(heights = c(1.5, 2)) + 
  plot_annotation(tag_levels = "A", tag_suffix = '.') + 
  plot_layout(guides = 'collect') &
  theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.position = "right", 
        legend.margin = margin(t = 10, r = 20, b = 50, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))

ggsave("./plots-final/beta_diversity_relabun_pca_met.pdf", height = 180, width = 180, units = "mm", dpi=300)


### fish
rare_fish_dist_clr_10
rare_fish_dist_clr_100
rare_fish_dist_clr_300
rare_fish_dist_clr_500
rare_fish_dist_clr_800
rare_fish_dist_clr_1000

pca_fish_clr_10 <- rda(rare_fish_dist_clr_10)

head(summary(pca_fish_clr_10))

unconstrained_eig10 <- pca_fish_clr_10$CA$eig/pca_fish_clr_10$tot.chi*100

expl_var <- unconstrained_eig10
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig10)),
         las = 2, ylab = '% variation')


pca_fish_clr_100 <- rda(rare_fish_dist_clr_100)

head(summary(pca_fish_clr_100))

unconstrained_eig100 <- pca_fish_clr_100$CA$eig/pca_fish_clr_100$tot.chi*100

expl_var <- unconstrained_eig100
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig100)),
         las = 2, ylab = '% variation')

pca_fish_clr_300 <- rda(rare_fish_dist_clr_300)

head(summary(pca_fish_clr_300))

unconstrained_eig300 <- pca_fish_clr_300$CA$eig/pca_fish_clr_300$tot.chi*100

expl_var <- unconstrained_eig300
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig300)),
         las = 2, ylab = '% variation')

pca_fish_clr_500 <- rda(rare_fish_dist_clr_500)

head(summary(pca_fish_clr_500))

unconstrained_eig500 <- pca_fish_clr_500$CA$eig/pca_fish_clr_500$tot.chi*100

expl_var <- unconstrained_eig500
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig500)),
         las = 2, ylab = '% variation')

pca_fish_clr_800 <- rda(rare_fish_dist_clr_800)

head(summary(pca_fish_clr_800))

unconstrained_eig800 <- pca_fish_clr_800$CA$eig/pca_fish_clr_800$tot.chi*100

expl_var <- unconstrained_eig800
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig800)),
         las = 2, ylab = '% variation')

pca_fish_clr_1000 <- rda(rare_fish_dist_clr_1000)

head(summary(pca_fish_clr_1000))

unconstrained_eig1000 <- pca_fish_clr_1000$CA$eig/pca_fish_clr_1000$tot.chi*100

expl_var <- unconstrained_eig1000
barplot(expl_var[1:20], col = rep('black', length(unconstrained_eig1000)),
         las = 2, ylab = '% variation')

fish.sp10 <- as.data.frame(scores(pca_fish_clr_10, choices = c(1:2), display = "species"))
fish.sp10$Depth <- "10m"
head(fish.sp10)
tail(fish.sp10)
fish.sp100 <- as.data.frame(scores(pca_fish_clr_100, choices = c(1:2), display = "species"))
fish.sp100$Depth <- "100m"
head(fish.sp100)
tail(fish.sp100)
fish.sp300 <- as.data.frame(scores(pca_fish_clr_300, choices = c(1:2), display = "species"))
fish.sp300$Depth <- "300m"
head(fish.sp300)
tail(fish.sp300)
fish.sp500 <- as.data.frame(scores(pca_fish_clr_500, choices = c(1:2), display = "species"))
fish.sp500$Depth <- "500m"
head(fish.sp500)
tail(fish.sp500)
fish.sp800 <- as.data.frame(scores(pca_fish_clr_800, choices = c(1:2), display = "species"))
fish.sp800$Depth <- "800m"
head(fish.sp800)
tail(fish.sp800)
fish.sp1000 <- as.data.frame(scores(pca_fish_clr_1000, choices = c(1:2), display = "species"))
fish.sp1000$Depth <- "1000m"
head(fish.sp1000)
tail(fish.sp1000)
fish.sp <- rbind(fish.sp10, fish.sp100, fish.sp300, fish.sp500, fish.sp800, fish.sp1000)
head(fish.sp)
tail(fish.sp)

head(fish_taxa_relabun)
unique(fish_taxa_relabun$TAXA)
fish_taxa_filtered <- fish_taxa_relabun %>% select(OTU, TAXA) %>% unique() %>% data.frame()
dim(fish_taxa_filtered)
unique(fish_taxa_filtered$TAXA)

head(fish.sp)
fish.sp <- cbind(fish.sp, OTU = rownames(fish.sp), TAXA = fish_taxa_filtered$TAXA)
head(fish.sp)
tail(fish.sp)
dim(fish.sp)

fish.sp.top <- fish.sp %>% group_by(Depth) %>% slice_max(order_by = abs(PC1), n = 10, with_ties = FALSE)
dim(fish.sp.top)
fish.sp.top$Depth <- fct_relevel(fish.sp.top$Depth, "10m", "100m", "300m", "500m", "800m", "1000m")
unique(fish.sp.top$TAXA)

fish.sp.top <- fish.sp.top %>%
  mutate(TAXA = case_when(
    TAXA == "Other Vertebrates" ~ "Other Vertebrates         ",
    TRUE ~ TAXA))

fish.site10 <- as.data.frame(scores(pca_fish_clr_10, choices = c(1:2), display = "sites"))
fish.site10$Depth <- "10m"
head(fish.site10)
tail(fish.site10)
fish.site100 <- as.data.frame(scores(pca_fish_clr_100, choices = c(1:2), display = "sites"))
fish.site100$Depth <- "100m"
head(fish.site100)
tail(fish.site100)
fish.site300 <- as.data.frame(scores(pca_fish_clr_300, choices = c(1:2), display = "sites"))
fish.site300$Depth <- "300m"
head(fish.site300)
tail(fish.site300)
fish.site500 <- as.data.frame(scores(pca_fish_clr_500, choices = c(1:2), display = "sites"))
fish.site500$Depth <- "500m"
head(fish.site500)
tail(fish.site500)
fish.site800 <- as.data.frame(scores(pca_fish_clr_800, choices = c(1:2), display = "sites"))
fish.site800$Depth <- "800m"
head(fish.site800)
tail(fish.site800)
fish.site1000 <- as.data.frame(scores(pca_fish_clr_1000, choices = c(1:2), display = "sites"))
fish.site1000$Depth <- "1000m"
head(fish.site1000)
tail(fish.site1000)
fish.site.df <- rbind(fish.site10, fish.site100, fish.site300, fish.site500, fish.site800, fish.site1000)
head(fish.site.df)
tail(fish.site.df)

# add deployemnts
deploy_df <- fish_taxa_relabun %>% select(sample, deployment) 
head(deploy_df)
fish.site.df$sample <- rownames(fish.site.df) %>% unique()
head(fish.site.df)
fish.site <- left_join(fish.site.df, deploy_df, by = "sample")
head(fish.site)
tail(fish.site)

fish.site$Depth <- fct_relevel(fish.site$Depth, "10m", "100m", "300m", "500m", "800m", "1000m")

top_plot <- fish.sp.top %>%
  ggplot(aes(x = PC1, y = PC2)) +
  geom_point(data = fish.site, color = "black", size = 2, alpha = 0.5, aes(shape = deployment)) + 
  geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2, color = TAXA, alpha = 0.75), arrow = arrow(length = unit(0.15, "cm"), type = "closed"), linewidth = 0.5, alpha = 0.75) +
  geom_hline(yintercept = 0, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 0, color = "#525252", linetype = "dotted", linewidth = 0.5) +
  labs(title = NULL) + 
  facet_wrap(~Depth, scales = "free") +
  scale_shape_manual(values = c(21, 23, 24)) +
  scale_color_manual(values = fish_colors,
                    limits = fish_sorted) + 
  guides(shape = guide_legend(title = "CTD Cast"),
         color = guide_legend(title = "Vertebrates",
                              ncol = 1)) +
  theme_custom_paper() + 
  theme(plot.margin = unit(c(t = 0, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.border = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.position = "right", 
        legend.spacing.x = unit(4, "mm"), 
        legend.margin = margin(t = -4, r = 0, b = 0, l = 0), 
        legend.key.size = unit(2, 'mm'), 
        legend.key.height = unit(2, "mm"),
        legend.key.width = unit(3, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.25, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))


top_plot

ggsave("./plots-final/beta_diversity_pca_top_fish10.pdf", height = 140, width = 180, units = "mm", dpi=300)


(fish_relabun_deploy + labs(title = NULL)) / top_plot +  
  plot_layout(heights = c(1.5, 2)) + 
  plot_annotation(tag_levels = "A", tag_suffix = '.') + 
  plot_layout(guides = 'collect') &
  theme(plot.margin = unit(c(t = 0.25, r = 0.25, b = 0.25, l = 0.25), "lines"),
        panel.spacing = unit(2, "mm"),
        panel.background = element_rect(linewidth = 0.5),
        plot.title = element_text(size = 8),
        plot.tag = element_text(size = 8),
        legend.text = element_text(size = 6, margin = margin(l = 1)),
        legend.position = "right", 
        legend.margin = margin(t = 20, r = 25, b = 20, l = 0), 
        legend.key.size = unit(2.5, 'mm'), 
        legend.key.height = unit(2.5, "mm"),
        legend.key.spacing.x = unit(1, "mm"),
        legend.key.spacing.y = unit(0.5, "mm"),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))

ggsave("./plots-final/beta_diversity_relabun_pca_fish.pdf", height = 180, width = 180, units = "mm", dpi=300)


```

```{r beta-stats-betapart, eval = TRUE, message = FALSE, warning = FALSE}

# I need to create an absence/presence dataframe

rare_prot_df <- left_join(rare_prot, metadata_18s, by = "sample")
rare_prot_df <- rare_prot_df %>% select(depth, OTU, Abundance) %>%
  group_by(depth, OTU) %>%
   summarize(total = sum(Abundance)) %>%
   pivot_wider(names_from = "OTU", values_from = "total", values_fill = 0) %>% column_to_rownames(var = "depth") %>% data.frame()

rare_prot_dist_ap <- rare_prot_df %>%
  mutate_all(~ ifelse(. > 0, 1, .))

prot_bp_core <- betapart.core(rare_prot_dist_ap) # The basic calculations for all these multiple-site measures and pairwise dissimilarity matrices can be computed using the function betapart.core, which returns an object of class betapart. This is useful for large datasets as the consuming calculations are done only once, and its result can then be used for computing many indices
prot_betapair_j <- beta.pair(prot_bp_core, index.family = "jaccard") # yields 3 distance matrices accounting for the spatial turnover and the nestedness components of beta-diversity.
prot_betamulti_j <- beta.multi(prot_bp_core, index.family = "jaccard") # yields the spatial turnover and the nestedness components of overall dissimilarity, and the sum of both components, total dissimilarity. 

# how can species assemblages be different?
# One is species replacement (i.e. turnover), which consists in the substitution of species in one site by different species in the other site. The second way is species loss (or gain), which implies the elimination (or addition) of species in only one of the sites, and leads to the poorest assemblage being a strict subset of the richest one (a pattern called nestedness). 

prot_turnover <- prot_betapair_j$beta.jtu # value of the turnover component, measured as turnover fraction of Jaccard dissimilarity. species replacement - substitution of species in one site by different species in the other site. 0 = no turnover and 1 = complete turnover.
prot_nestedness <- prot_betapair_j$beta.jne # A value of 0 indicates no nestedness component (i.e., any dissimilarity is due entirely to turnover), whereas values closer to 1 suggest a high degree of nestedness, with one community being nearly a subset of another. High values indicate that the species composition of one community largely nests within the composition of another, typically observed in cases of environmental gradients or disturbances that reduce species richness without promoting replacements.
prot_betadiv <- prot_betapair_j$beta.jac 


head(rare_met)
head(metadata_18s)

rare_met_df <- left_join(rare_met, metadata_18s, by = "sample")
rare_met_df <- rare_met_df %>% select(depth, OTU, Abundance) %>%
  group_by(depth, OTU) %>%
    summarize(total = sum(Abundance)) %>%
    pivot_wider(names_from = "OTU", values_from = "total", values_fill = 0) %>% column_to_rownames(var = "depth") %>% data.frame()

rare_met_dist_ap <- rare_met_df %>%
  mutate_all(~ ifelse(. > 0, 1, .))

met_bp_core <- betapart.core(rare_met_dist_ap)
met_betapair_j <- beta.pair(met_bp_core, index.family = "jaccard")
met_betamulti_j <- beta.multi(met_bp_core, index.family = "jaccard")

met_turnover <- met_betapair_j$beta.jtu
met_nestedness <- met_betapair_j$beta.jne
met_betadiv <- met_betapair_j$beta.jac

head(rare_fish)
head(metadata_12s)

rare_fish_df <- left_join(rare_fish, metadata_12s, by = "sample")
rare_fish_df <- rare_fish_df %>% select(depth, OTU, Abundance) %>%
  group_by(depth, OTU) %>%
    summarize(total = sum(Abundance)) %>%
    pivot_wider(names_from = "OTU", values_from = "total", values_fill = 0) %>% column_to_rownames(var = "depth") %>% data.frame()

rare_fish_dist_ap <- rare_fish_df %>%
  mutate_all(~ ifelse(. > 0, 1, .))

fish_bp_core <- betapart.core(rare_fish_dist_ap)
fish_betapair_j <- beta.pair(fish_bp_core, index.family = "jaccard")
fish_betamulti_j <- beta.multi(fish_bp_core, index.family = "jaccard")

fish_turnover <- fish_betapair_j$beta.jtu
fish_nestedness <- fish_betapair_j$beta.jne
fish_betadiv <- fish_betapair_j$beta.jac


```

```{r beta-stats-euler, eval = TRUE, message = FALSE, warning = FALSE}

prot_taxa_relabun$TAXA <- fct_relevel(prot_taxa_relabun$TAXA, "Other Protists", after = Inf)
taxa_sorted <- c("Alveolata-Apicomplexa", "Alveolata-Ciliates",
                             "Alveolata-Dinoflagellates", 
                             "Alveolata-Other", 
                             "Alveolata-Syndiniales", 
                             "Chlorophyta", 
                             "Cryptophyta", "Excavata",
                             "Haptophyta", "Rhizaria-Cercozoa", 
                             "Rhizaria-Other", 
                             "Rhizaria-Radiolaria", "Rhodophyta",
                 "Stramenopiles-Diatoms", "Stramenopiles-MAST", "Stramenopiles-Other", "Other Protists")

rare_prot_euler <- prot_taxa_relabun
unique(rare_prot_euler$TAXA)

# let's annotate this with taxa from prot_taxa2
rare_prot_euler <- rare_prot_euler %>% select(depth, OTU, Abundance) %>%
  group_by(depth, OTU) %>%
  summarize(total = sum(Abundance)) %>%
  ungroup() %>%
  pivot_wider(names_from = "depth", values_from = "total", values_fill = 0) %>% column_to_rownames(var = "OTU") %>% data.frame() %>%
  mutate_all(~ ifelse(. > 0, 1, .))

head(rare_prot_euler)
# let's add back columns
rare_prot_euler$OTU <- rownames(rare_prot_euler)
head(rare_prot_euler)

head(prot_taxa_relabun)
prot_taxonomy <- prot_taxa_relabun %>% select(OTU, TAXA) %>% unique()
dim(prot_taxonomy)
head(prot_taxonomy)

# let's combine these
rare_prot_euler <- left_join(rare_prot_euler, prot_taxonomy, by = "OTU") %>% column_to_rownames(var = "OTU") %>% data.frame()
head(rare_prot_euler)

colnames(rare_prot_euler) <- c("10m", "100m", "300m", "500m", "800m", "1000m", "Taxa")
rare_prot_euler <- rare_prot_euler %>% select("1000m", "800m", "500m", "300m", "100m", "10m", "Taxa")
head(rare_prot_euler)
depths <- colnames(rare_prot_euler)[1:6]
depths

taxa_colors <- c("#a1c2fd", "#56C4F0", "#399dff","#0b62fb", #"#0344b7",
                 "#9CDC46",
                 #"#dafa0f",
                 "#efdf48", "#ff9d3a",
                # "#ceceff", "#a7a7ff",
                "#7474ff",
               #  "#ff9aa5",
                 "#009a4d","#1ec38c", "#90eebf","#d9d9d9")

prot_upset <- ComplexUpset::upset(rare_prot_euler, depths, 
                                  stripes = "white",
                    sort_sets = "FALSE",
                    min_size = 50,
                    name = "", 
                    height_ratio = 0.7,
                    set_sizes = FALSE,
                    wrap = TRUE,
                    matrix=(intersection_matrix(
                      geom=geom_point(
                        size=1),
                      segment=geom_segment(
                        linewidth=0.25),
                      outline_color=list(
                        active='black',
                        inactive='grey70'))),
                    base_annotations=list(
                      "Intersection Size" = intersection_size(counts = FALSE,
                                                              mapping = aes(fill = Taxa), 
                                                              color = "black", linewidth = 0.1) + 
                        scale_fill_manual(values = taxa_colors) + 
                        ylab("# of ASVs") + xlab(NULL)),
                    themes = list(default = theme_custom_upset(), 
                                  intersections_matrix = theme_custom_upset()))

prot_upset

ggsave("./plots-final/prot_upset.pdf", plot = prot_upset, height = 80, width = 180, units = "mm", dpi=300)


met_taxa_relabun1 <- met_taxa_order3 %>%
  mutate(TAXA = case_when(
 #   TAXA == "Arthropoda-Other" ~ "Other Invertebrates",
    TAXA == "Ctenophora-Other" ~ "Other Invertebrates",
    TAXA == "Tunicata-Other" ~ "Other Invertebrates",
    TRUE ~ TAXA))


met_taxa_relabun1$TAXA <- fct_relevel(met_taxa_relabun1$TAXA, "Arthropoda-Calanoida", "Arthropoda-Cyclopoida", "Arthropoda-Other",
                             "Cnidaria-Siphonophorae",
                             "Cnidaria-Other", 
                             "Ctenophora-Cydippida", 
                             "Tunicata-Copelata", 
                             "Tunicata-Salpida", "Unassigned Metazoa", "Other Invertebrates")

taxa_sorted <- c("Arthropoda-Calanoida", "Arthropoda-Cyclopoida", "Arthropoda-Other",
                             "Cnidaria-Siphonophorae",
                             "Cnidaria-Other", 
                             "Ctenophora-Cydippida", 
                             "Tunicata-Copelata", 
                             "Tunicata-Salpida", "Unassigned Metazoa", "Other Invertebrates")

rare_met_euler <- met_taxa_relabun1
unique(rare_met_euler$TAXA)

# let's annotate this with taxa from met_taxa2
rare_met_euler <- rare_met_euler %>% select(depth, OTU, Abundance) %>%
  group_by(depth, OTU) %>%
  summarize(total = sum(Abundance)) %>%
  ungroup() %>%
  pivot_wider(names_from = "depth", values_from = "total", values_fill = 0) %>% column_to_rownames(var = "OTU") %>% data.frame() %>%
  mutate_all(~ ifelse(. > 0, 1, .))

head(rare_met_euler)
# let's add back columns
rare_met_euler$OTU <- rownames(rare_met_euler)
head(rare_met_euler)

head(met_taxa_relabun1)
met_taxonomy <- met_taxa_relabun1 %>% select(OTU, TAXA) %>% unique()
dim(met_taxonomy)
head(met_taxonomy)

# let's combine these
rare_met_euler <- left_join(rare_met_euler, met_taxonomy, by = "OTU") %>% column_to_rownames(var = "OTU") %>% data.frame()
head(rare_met_euler)

colnames(rare_met_euler) <- c("10m", "100m", "300m", "500m", "800m", "1000m", "Taxa")
rare_met_euler <- rare_met_euler %>% select("1000m", "800m", "500m", "300m", "100m", "10m", "Taxa")
head(rare_met_euler)
depths <- colnames(rare_met_euler)[1:6]
depths

taxa_colors <- c("#fc996c", "#ffce5c","#fdfb9b", 
                 "#047de9", "#0344b7", 
                 "#fa9db8",
                 "#96fac6","#26a33a",  "#82A4E3",
                 "#d9d9d9")


met_upset <- ComplexUpset::upset(rare_met_euler, depths, 
                                  stripes = "white",
                    sort_sets = "FALSE",
                    min_size = 3,
                    name = "", 
                    height_ratio = 0.7,
                    set_sizes = FALSE,
                    wrap = TRUE,
                    matrix=(intersection_matrix(
                      geom=geom_point(
                        size=1),
                      segment=geom_segment(
                        linewidth=0.25),
                      outline_color=list(
                        active='black',
                        inactive='grey70'))),
                    base_annotations=list(
                      "Intersection Size" = intersection_size(counts = FALSE,
                                                              mapping = aes(fill = Taxa), 
                                                              color = "black", linewidth = 0.1) + 
                        scale_fill_manual(values = taxa_colors,
                                          limits = taxa_sorted) + 
                        ylab("# of ASVs") + xlab(NULL)),
                    themes = list(default = theme_custom_upset(), 
                                  intersections_matrix = theme_custom_upset()))

met_upset

ggsave("./plots-final/met_upset.pdf", plot = met_upset, height = 80, width = 180, units = "mm", dpi=300)


fish_taxa_relabun1 <- fish_taxa_relabun %>%
  mutate(TAXA = case_when(
    TAXA == "Other Vertebrates" ~ "Other Vertebrates         ",
    TRUE ~ TAXA))


fish_taxa_relabun1$TAXA <- fct_relevel(fish_taxa_relabun1$TAXA, "Nemichthyidae", "Serrivomeridae",
                             "Melamphaidae", 
                             "Myctophidae", 
                             "Alepocephalidae", 
                             "Gonostomatidae", "Sternoptychidae", 
                             "Stomiidae", 
                             "Molidae", "Other Vertebrates         ")


taxa_sorted <- c("Nemichthyidae", "Serrivomeridae",
                             "Melamphaidae", 
                             "Myctophidae", 
                             "Alepocephalidae", 
                             "Gonostomatidae", "Sternoptychidae", 
                             "Stomiidae", 
                             "Molidae", "Other Vertebrates         ")

rare_fish_euler <- fish_taxa_relabun1
unique(rare_fish_euler$TAXA)

# let's annotate this with taxa from fish_taxa2
rare_fish_euler <- rare_fish_euler %>% select(depth, OTU, Abundance) %>%
  group_by(depth, OTU) %>%
  summarize(total = sum(Abundance)) %>%
  ungroup() %>%
  pivot_wider(names_from = "depth", values_from = "total", values_fill = 0) %>% column_to_rownames(var = "OTU") %>% data.frame() %>%
  mutate_all(~ ifelse(. > 0, 1, .))

head(rare_fish_euler)
# let's add back columns
rare_fish_euler$OTU <- rownames(rare_fish_euler)
head(rare_fish_euler)

head(fish_taxa_relabun1)
fish_taxonomy <- fish_taxa_relabun1 %>% select(OTU, TAXA) %>% unique()
dim(fish_taxonomy)
head(fish_taxonomy)

# let's combine these
rare_fish_euler <- left_join(rare_fish_euler, fish_taxonomy, by = "OTU") %>% column_to_rownames(var = "OTU") %>% data.frame()
head(rare_fish_euler)

colnames(rare_fish_euler) <- c("10m", "100m", "300m", "500m", "800m", "1000m", "Taxa")
rare_fish_euler <- rare_fish_euler %>% select("1000m", "800m", "500m", "300m", "100m", "10m", "Taxa")
head(rare_fish_euler)
depths <- colnames(rare_fish_euler)[1:6]
depths

taxa_colors <- c("#d5d2f8", "#9790ee", 
                "#a1f1d6","#f5eb8e",
                 "#9CDC46", 
                  "#56C4F0", "#0c62fb", "#034dd1","#fb7285", "#d9d9d9")


fish_upset <- ComplexUpset::upset(rare_fish_euler, depths, 
                                  stripes = "white",
                    sort_sets = "FALSE",
                    min_size = 1,
                    name = "", 
                    height_ratio = 0.7,
                    set_sizes = FALSE,
                    wrap = TRUE,
                    matrix=(intersection_matrix(
                      geom=geom_point(
                        size=1),
                      segment=geom_segment(
                        linewidth=0.25),
                      outline_color=list(
                        active='black',
                        inactive='grey70'))),
                    base_annotations=list(
                      "Intersection Size" = intersection_size(counts = FALSE,
                                                              mapping = aes(fill = Taxa), 
                                                              color = "black", linewidth = 0.1) + 
                        scale_fill_manual(values = taxa_colors) + 
                        ylab("# of ASVs") + xlab(NULL)),
                    themes = list(default = theme_custom_upset(), 
                                  intersections_matrix = theme_custom_upset()))
fish_upset

ggsave("./plots-final/fish_upset.pdf", plot = fish_upset, height = 30, width = 80, units = "mm", dpi=300)


## Combined
prot_upset / met_upset / fish_upset +
  plot_annotation(tag_levels = "A", tag_suffix = '.') + 
  plot_layout(guides = 'collect')
  
ggsave("./plots-final/all_upset.pdf", height = 160, width = 180, units = "mm", dpi=300)

```

```{r save-euler-inputs, eval = TRUE, message = FALSE, warning = FALSE}

save(rare_prot_euler, rare_met_euler, rare_fish_euler, file = "./phyloseq/euler_inputs.RData")

load(file = "./phyloseq/euler_inputs.RData", verbose = T)

```

```{r save-euler-analyses, eval = TRUE, message = FALSE, warning = FALSE}

# clean up dataframes
head(rare_prot_euler)
colnames(rare_prot_euler)
prot_euler_df <- rare_prot_euler
prot_euler_df$ASV <- rownames(prot_euler_df)
rownames(prot_euler_df) <- NULL
prot_euler_df <- prot_euler_df %>% select(ASV, Taxa, "10m", "100m", "300m", "500m", "800m", "1000m")
head(prot_euler_df)

# clean up dataframes
head(rare_met_euler)
colnames(rare_met_euler)
met_euler_df <- rare_met_euler
met_euler_df$ASV <- rownames(met_euler_df)
rownames(met_euler_df) <- NULL
met_euler_df <- met_euler_df %>% select(ASV, Taxa, "10m", "100m", "300m", "500m", "800m", "1000m")
head(met_euler_df)

# clean up dataframes
head(rare_fish_euler)
colnames(rare_fish_euler)
fish_euler_df <- rare_fish_euler
fish_euler_df$ASV <- rownames(fish_euler_df)
rownames(fish_euler_df) <- NULL
fish_euler_df <- fish_euler_df %>% select(ASV, Taxa, "10m", "100m", "300m", "500m", "800m", "1000m")
head(fish_euler_df)


# let's extract the ASVs we think are performing DVM
head(prot_euler_df)
# let's fix column names
colnames(prot_euler_df)[c(1, 3:8)] <- c("OTU", "d10", "d100", "d300", "d500", "d800", "d1000")
prot_euler_df %>% filter(d10 == 1 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 0) %>% count()
prot_euler_df %>% filter(d10 == 0 & d100 == 1 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 0) %>% count()
prot_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 1 & d500 == 0 & d800 == 0 & d1000 == 0) %>% count()
prot_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 1 & d800 == 0 & d1000 == 0) %>% count()
prot_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 1 & d1000 == 0) %>% count()
prot_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 1) %>% count()

prot_euler_df %>% filter(d10 == 1 & d100 == 1 & d300 == 1 & d500 == 1 & d800 == 1 & d1000 == 1) %>% count()

297 + 686 + 722 + 682 + 593 + 609 # 3589 unique ASVs
prot_euler_df %>% count() # 6461
3589 / 6462 * 100 # 55.5%%
6461 - 3589 # 2872 shared (including cosmopolitan)
2872 / 6461 * 100 #44.45132% (shared including cosmoplitan) 
(2872-136) / 6461 * 100 # 42.35% are shared
136 / 6461 * 100 # 2.10% (cosmopolitan)


# extract ASV & TAXA
#dvm_prot_asv <- dvm_prot_df %>% select(OTU, Taxa)
#head(dvm_prot_asv)

# let's extract the ASVs we think are performing DVM
head(met_euler_df)
# let's fix column names
colnames(met_euler_df)[c(1, 3:8)] <- c("OTU", "d10", "d100", "d300", "d500", "d800", "d1000")
met_euler_df %>% filter(d10 == 1 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 0) %>% count()
met_euler_df %>% filter(d10 == 0 & d100 == 1 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 0) %>% count()
met_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 1 & d500 == 0 & d800 == 0 & d1000 == 0) %>% count()
met_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 1 & d800 == 0 & d1000 == 0) %>% count()
met_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 1 & d1000 == 0) %>% count()
met_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 1) %>% count()

met_euler_df %>% filter(d10 == 1 & d100 == 1 & d300 == 1 & d500 == 1 & d800 == 1 & d1000 == 1) %>% count()

16 + 31 + 38 + 33 + 57 + 98 # 273 unique ASVs
met_euler_df %>% count() # 397
273 / 397 * 100 # 68.8%
397 - 273 # 124 shared
124 / 397 * 100 #31.2%
(124-11) / 397 * 100 # 28.46% are shared
11 / 397 * 100 # 2.77%

dvm_met_df1 <- met_euler_df %>% filter(d10 == 1 & d300 == 1 & d500 == 1 & d800 == 1 & d1000 == 1)
dvm_met_df2 <- met_euler_df %>% filter(d100 == 1 & d300 == 1 & d500 == 1 & d800 == 1 & d1000 == 1)
dvm_met_df <- rbind(dvm_met_df1, dvm_met_df2) %>% unique()
# extract ASV & TAXA
dvm_met_asv <- dvm_met_df %>% select(OTU, Taxa)
head(dvm_met_asv)

# create relative abundance plot
head(met_taxa_relabun)
dvm_met_relabun <- left_join(dvm_met_asv, met_taxa_relabun, by = "OTU")
head(dvm_met_relabun)

cast_colors <- c("#3399ff", "#ffb400", "#9080ff")
diel_colors <- c("#FFC857", "#4B3F72")  

dvm_met_relabun <- dvm_met_relabun %>%
  filter(TAXA != "Other Invertebrates") %>% select(OTU, depth, diel, TAXA, Abundance)
  
dvm_met_taxa <- dvm_met_relabun %>% group_by(depth, OTU) %>%
  mutate(RelativeAbundance = (Abundance / sum(Abundance)) * 100, na.rm = TRUE) %>%
  ungroup() %>%
#  group_by(depth, deployment, OTU) %>%
  group_by(depth, diel, OTU) %>%
  summarise(sum_RelativeAbundance = sum(RelativeAbundance, na.rm = TRUE), .groups = "keep") %>%
  ungroup()

# let's get a list of OTUs & TAXA
met_asv_taxa <- met_relabun_rename %>% select(OTU, Phylum, Class, Order, Family, Genus, Species) %>% unique() %>% as.data.frame()
head(met_asv_taxa)
dvm_met_plot_df <- left_join(dvm_met_taxa, met_asv_taxa, by = "OTU")
head(dvm_met_plot_df)

dvm_met_plot <- dvm_met_plot_df %>% 
  ggplot(aes(y = depth, x = sum_RelativeAbundance)) +
  geom_point(aes(fill = diel, color = diel), alpha = 0.66, shape = 21, size = 1.5, stroke = 0.25) + 
  geom_path(aes(group = diel, color = diel), alpha = 0.66, linewidth = 1) +
  scale_y_reverse() + 
  scale_color_manual(values = diel_colors) + 
  scale_fill_manual(values = diel_colors) + 
  labs(x = "Relative Abundance (%)",
       y = "Depth (m)",
       title = NULL) +
  facet_wrap(~ Phylum + Order + OTU, nrow = 5) + 
  theme_custom_paper() +
  theme(plot.title = element_text(size = 8),
        plot.margin = unit(c(t = 0, r = 1, b = -1, l = 1), "mm"),
        plot.title.position = "panel",
        plot.background = element_rect(linewidth = 0.5),
        panel.background = element_rect(linewidth = 0.5),
        panel.spacing.x = unit(2, "mm"),
        panel.spacing.y = unit(1, "mm"),
        legend.position = "bottom", 
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.key.size = unit(4, 'mm'), 
        strip.text.x = element_text(size = 5),
        strip.background = element_rect(color = NULL),
        strip.clip = "off",
        strip.text = element_text(margin=margin(t = 1.5, b= 1.5)),
        strip.background.x = element_blank(),
        axis.text = element_text(hjust = 1, vjust = 1, size = 6),
        axis.title = element_text(size = 6)) + 
  guides(fill = "none",
         color = guide_legend(title = "Diel")) 

dvm_met_plot

ggsave("./plots-final/alleuk_met_dvm_pub.pdf", height = 10, width = 6, units = "in", dpi=300)

# let's extract the ASVs we think are performing DVM
head(fish_euler_df)
# let's fix column names
colnames(fish_euler_df)[c(1, 3:8)] <- c("OTU", "d10", "d100", "d300", "d500", "d800", "d1000")

fish_euler_df %>% filter(d10 == 1 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 0) %>% count()
fish_euler_df %>% filter(d10 == 0 & d100 == 1 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 0) %>% count()
fish_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 1 & d500 == 0 & d800 == 0 & d1000 == 0) %>% count()
fish_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 1 & d800 == 0 & d1000 == 0) %>% count()
fish_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 1 & d1000 == 0) %>% count()
fish_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 1) %>% count()

fish_euler_df %>% filter(d10 == 1 & d100 == 1 & d300 == 1 & d500 == 1 & d800 == 1 & d1000 == 1) %>% count()

71 + 14 + 18 + 104 + 36 + 34 # 277 unique ASVs
fish_euler_df %>% count() # 315
277 / 315 * 100 # 87.9%
315 - 277 # 38 shared (including cosmo)
38 / 315 * 100 # 12.1%
(38-2) / 315 * 100 # 11.43% are shared
2 / 315 * 100 # 0.63%

dvm_fish_df1 <- fish_euler_df %>% filter(d10 == 1 & d100 == 1 & d300 == 1 & d500 == 1 & d800 == 1 & d1000 == 1)
dvm_fish_df2 <- fish_euler_df %>% filter(d10 == 1 & d300 == 1 & d500 == 1 & d800 == 1)
dvm_fish_df3 <- fish_euler_df %>% filter(d10 == 1 & d100 == 1 & d500 == 1 & d800 == 1 & d1000 == 1)
dvm_fish_df4 <- fish_euler_df %>% filter(d10 == 1 & d100 == 1 & d300 == 1 & d500 == 1 & d1000 == 1)
dvm_fish_df5 <- fish_euler_df %>% filter(d300 == 1 & d500 == 1 & d800 == 1 & d1000 == 1)
dvm_fish_df <- rbind(dvm_fish_df1, dvm_fish_df2, dvm_fish_df3, dvm_fish_df4, dvm_fish_df5) %>% unique()
head(dvm_fish_df)

# check 
#dvm_fish_df <- fish_euler_df %>% filter(d10 == 0 & d100 == 0 & d300 == 0 & d500 == 1 & d800 == 0 & d1000 == 0)
#dvm_fish_df <- fish_euler_df %>% filter(d10 == 1 & d100 == 0 & d300 == 0 & d500 == 0 & d800 == 0 & d1000 == 0)

# extract ASV & TAXA
dvm_fish_asv <- dvm_fish_df %>% select(OTU, Taxa) %>% filter(Taxa != "Other Vertebrates         ")
head(dvm_fish_asv)

# create relative abundance plot
head(fish_taxa_relabun)
dvm_fish_relabun <- left_join(dvm_fish_asv, fish_taxa_relabun, by = "OTU")
head(dvm_fish_relabun)
  
dvm_fish_relabun <- dvm_fish_relabun %>%
  filter(TAXA != "Other Invertebrates") %>% select(OTU, depth, diel, deployment, TAXA, Abundance)
  
dvm_fish_taxa <- dvm_fish_relabun %>% group_by(depth, OTU) %>%
  mutate(RelativeAbundance = (Abundance / sum(Abundance)) * 100, na.rm = TRUE) %>%
  ungroup() %>%
  group_by(depth, diel, OTU) %>%
  summarise(sum_RelativeAbundance = sum(RelativeAbundance, na.rm = TRUE), .groups = "drop") %>%
  ungroup()

# let's get a list of OTUs & TAXA
fish_asv_taxa <- fish_relabun %>% select(OTU, Phylum, Class, Order, Family, Genus, Species) %>% unique() %>% as.data.frame()
head(fish_asv_taxa)
dvm_fish_plot_df <- left_join(dvm_fish_taxa, fish_asv_taxa, by = "OTU")
head(dvm_fish_plot_df)

dvm_fish_plot <- dvm_fish_plot_df %>% 
  ggplot(aes(y = depth, x = sum_RelativeAbundance)) +
  geom_point(aes(fill = diel, color = diel), alpha = 0.66, shape = 21, size = 1.5, stroke = 0.25) + 
  geom_path(aes(group = diel, color = diel), alpha = 0.66, linewidth = 1) +
#  geom_point(aes(fill = deployment, color = deployment), alpha = 0.66, shape = 21, size = 2, stroke = 0.25) + 
  scale_y_reverse() + 
  scale_color_manual(values = diel_colors) + 
  scale_fill_manual(values = diel_colors) + 
  labs(x = "Relative Abundance (%)",
       y = "Depth (m)",
       title = NULL) +
#  facet_wrap(~Genus + Species + OTU, ncol = 10) + 
  facet_wrap(~ Family + Species + OTU, nrow = 2) + 
  theme_custom_paper() +
  theme(plot.title = element_text(size = 8),
        plot.margin = unit(c(t = 0, r = 1, b = -1, l = 1), "mm"),
        plot.title.position = "panel",
        plot.background = element_rect(linewidth = 0.5),
        panel.background = element_rect(linewidth = 0.5),
        panel.spacing.x = unit(2, "mm"),
        panel.spacing.y = unit(1, "mm"),
        legend.position = "bottom", 
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6, margin = margin(l = 2)),
        legend.key.size = unit(4, 'mm'), 
        strip.text.x = element_text(size = 5),
        strip.background.x = element_blank(),
        strip.clip = "off",
        strip.text=element_text(margin=margin(t = 1.5, b= 1.5)),
        axis.text = element_text(hjust = 1, vjust = 1, size = 6),
        axis.title = element_text(size = 6)) + 
  guides(fill = "none",
         color = guide_legend(title = "Diel")) 

dvm_fish_plot

#ggsave("./plots-final/alleuk_fish_dvm_pub_500m.pdf", height = 300, width = 200, units = "mm", dpi=300)
#ggsave("./plots-final/alleuk_fish_dvm_pub_0m.pdf", height = 300, width = 200, units = "mm", dpi=300)
ggsave("./plots-final/alleuk_fish_dvm_pub.pdf", height = 5, width = 6, units = "in", dpi=300)


```

```{r}


head(prot_taxa_relabun)

# let's get the unique # of ASVs here
length(unique(prot_taxa_relabun$OTU)) # 6461

head(prot_taxa_relabun)

test <- prot_taxa_relabun %>%
  group_by(depth) %>%
  mutate(RelativeAbundance = (Abundance / sum(Abundance)) * 100, na.rm = TRUE) %>%
  mutate(depth = as.factor(depth)) %>%
  ungroup() %>%
  group_by(depth, OTU) %>%
  mutate(sum_RelativeAbundance = sum(RelativeAbundance), na.rm = TRUE, .groups = "drop") %>%
  select(OTU, depth, sum_RelativeAbundance, TAXA) %>% unique()


taxa_interest <- c("Alveolata-Apicomplexa", "Alveolata-Dinoflagellates", "Alveolata-Syndiniales", "Chlorophyta", "Rhizaria-Radiolaria", "Stramenopiles-Diatoms", "Stramenopiles-MAST", "Stramenopiles-Other")

taxa_colors <- c("#a1c2fd", "#399dff", "#0344b7",
                 "#9CDC46",
                 "#7474ff",
                 "#009a4d","#1ec38c", "#90eebf", "transparent")

prot_dotplot_test <- test %>% filter(TAXA %in% taxa_interest) %>%
  filter(sum_RelativeAbundance > 0.1) %>%
  mutate(TAXA_new = case_when(
    sum_RelativeAbundance < 1 ~ "Low Abundance < 1%",
    TRUE ~ TAXA
  ))

taxa_sorted <- c("Alveolata-Apicomplexa", "Alveolata-Dinoflagellates", "Alveolata-Syndiniales", "Chlorophyta", "Rhizaria-Radiolaria", "Stramenopiles-Diatoms", "Stramenopiles-MAST", "Stramenopiles-Other","Low Abundance < 1%")

prot_dotplot_test <- 
  prot_dotplot_test %>% arrange(depth, TAXA_new, sum_RelativeAbundance)
head(prot_dotplot_test)  

dotplot <- ggplot(prot_dotplot_test, aes(y = fct_rev(depth), (OTU))) + 
  geom_jitter(aes(size = sum_RelativeAbundance, color = TAXA, fill = TAXA_new, group = TAXA_new), shape = 21, alpha = 0.75, height = 0.2, stroke = 0.5) +
  labs(title = NULL,
       x = "ASV",
       y = "Depth (m)") + 
  scale_color_manual(values = taxa_colors,
                    limits = taxa_sorted) +
  scale_fill_manual(values = taxa_colors,
                    limits = taxa_sorted) +
  guides(color = "none",
    size = guide_legend(title = "Relative Abundance"),
         fill = guide_legend(title="Taxa",
                             order = 1,
                             override.aes = list(shape = 21, 
                                                 alpha = 1,
                                                 stroke = 0.5))) + 
  theme_custom_paper() + 
  theme(panel.background = element_rect(linewidth = 0.5),
        panel.grid.major = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 8),
        axis.ticks.x = element_blank())

dotplot

ggsave("./plots-final/jitter_test_topASVs.pdf", height = 80, width = 180, units = "mm", dpi=300)

head(prot_dotplot_test)

stats <- test %>% 
  filter(sum_RelativeAbundance >= 1) %>%
  group_by(depth, TAXA) %>% 
  mutate(n = n()) %>% select(-OTU, - sum_RelativeAbundance) %>% unique() %>%
  arrange(depth, TAXA) %>% print(n = 30)

stats1 <- test %>% 
  filter(sum_RelativeAbundance >= 1) %>% filter(TAXA != "Other Protists") %>%
  group_by(depth, TAXA) %>% 
  mutate(part_abun = sum(sum_RelativeAbundance)) %>%
  mutate(n = n()) %>% select(-OTU, - sum_RelativeAbundance) %>% unique() %>%
  arrange(depth, TAXA) %>% print(n = 30)

stats1 %>% group_by(depth) %>%
  mutate(sum = sum(part_abun)) %>% 
  mutate(sum_n = sum(n)) %>%
  select(depth, sum, sum_n) %>% unique()

unique(stats1$TAXA)

taxa_sorted <- c("Alveolata-Apicomplexa", "Alveolata-Dinoflagellates", "Alveolata-Syndiniales", "Chlorophyta", "Rhizaria-Radiolaria", "Stramenopiles-Diatoms", "Stramenopiles-MAST", "Stramenopiles-Other")

taxa_colors <- c("#a1c2fd", "#399dff", "#0344b7",
                 "#9CDC46",
                 "#7474ff",
                 "#009a4d","#1ec38c", "#90eebf")


barplot1 <- stats1 %>% arrange(depth, desc(n)) %>%
  mutate(TAXA = fct_reorder(TAXA, n, .desc = FALSE)) %>%
  ggplot(aes(y = fct_rev(depth), x = n)) +
  geom_col(aes(fill = TAXA), color = "black", width = 0.75, linewidth = 0.25) +
    labs(title = NULL,
         y = "Depth (m)",
         x = "Observed ASVs") +
    scale_fill_manual(values = taxa_colors,
                        limits = taxa_sorted) + theme_custom_paper() + 
  theme(legend.position = "none",
        panel.background = element_rect(linewidth = 0.5),
        panel.grid.major = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 8))

barplot1

barplot2 <- stats1 %>% arrange(depth, desc(part_abun)) %>%
  mutate(TAXA = fct_reorder(TAXA, part_abun, .desc = FALSE)) %>%
  ggplot(aes(y = fct_rev(depth), x = part_abun)) +
  geom_col(aes(fill = TAXA), color = "black", width = 0.75, linewidth = 0.25) +
    labs(title = NULL,
         y = "Depth (m)",
         x = "Relative Abundance (%)") +
    scale_fill_manual(values = taxa_colors,
                        limits = taxa_sorted) + theme_custom_paper() + 
  theme(legend.position = "none",
        panel.background = element_rect(linewidth = 0.5),
        panel.grid.major = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 8))

barplot2

(barplot1 + barplot2) / dotplot + plot_layout(guides = "collect") + plot_annotation(tag_levels = "A", tag_suffix = '.') &
    theme(
      plot.margin = unit(c(t = 0.5, r = 1.5, b = 0.5, l = 1.5), "lines"),
      panel.background = element_rect(linewidth = 0.5),
      panel.spacing = unit(10, "mm"),
      panel.grid.major = element_blank(),
      plot.tag = element_text(size = 8),
      legend.title = element_text(size = 8),
      legend.text = element_text(size = 6, margin = margin(l = 2)),
      legend.key.size = unit(3, 'mm'), 
      legend.key.height = unit(3, "mm"),
      axis.text.y = element_text(size = 8),
      axis.title = element_text(size = 8))

ggsave("./plots-final/test_evenness_panel.pdf", height = 120, width = 180, units = "mm", dpi=300)


```

